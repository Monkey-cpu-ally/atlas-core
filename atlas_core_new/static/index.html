<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atlas Core - ATLAS-PRIME</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Atlas Core">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Atlas Core">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Links -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/images/icon-512.png">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">Atlas Core</h1>
            <div class="codename" id="codename">ATLAS-PRIME</div>
            <div class="version-badge" id="version">v0.7.0</div>
            <div class="fingerprint" id="fingerprint"></div>
        </header>

        <div class="status-indicator">
            <div class="status-dot"></div>
            <span>System Online</span>
            <div class="calendar-widget" id="calendarWidget">
                <span class="calendar-date" id="calendarDate"></span>
                <span class="calendar-time" id="calendarTime"></span>
            </div>
            <div class="status-controls">
                <button class="control-toggle" id="notifyToggle" onclick="toggleNotifications()" title="Enable Notifications">
                    <span>ğŸ””</span>
                    <span id="notifyLabel">Notify</span>
                </button>
                <button class="control-toggle" id="voiceCommandToggle" onclick="toggleVoiceCommands()" title="Voice Commands">
                    <span>ğŸ™ï¸</span>
                    <span id="voiceCommandLabel">Voice</span>
                </button>
                <button class="control-toggle" id="incognitoToggle" onclick="toggleIncognitoMode()" title="Incognito Mode">
                    <span>ğŸ‘ï¸</span>
                    <span id="incognitoLabel">Private</span>
                </button>
            </div>
        </div>

        <div class="incognito-banner" id="incognitoBanner">
            <span>ğŸ•¶ï¸</span>
            <span>Incognito Mode: Chats and progress will not be saved</span>
        </div>

        <div class="voice-command-feedback" id="voiceCommandFeedback">
            <div class="voice-feedback-text" id="voiceFeedbackText">Listening...</div>
            <div class="voice-feedback-status" id="voiceFeedbackStatus">Say a command</div>
        </div>

        <section class="chat-section">
            <h2 class="section-title">Chat with Personas</h2>
            <div class="chat-container">
                <div class="chat-bg-layer chat-bg-ajani active" id="chat-bg-ajani"></div>
                <div class="chat-bg-layer chat-bg-minerva" id="chat-bg-minerva"></div>
                <div class="chat-bg-layer chat-bg-hermes" id="chat-bg-hermes"></div>
                <div class="chat-bg-layer chat-bg-counsel" id="chat-bg-counsel"></div>
                <div class="chat-effects-layer" id="chat-effects"></div>
                <div class="chat-header" style="position: relative; z-index: 2;">
                    <button class="persona-btn persona-btn-styled active-ajani" data-persona="ajani" onclick="selectPersona('ajani')"><span class="persona-avatar persona-avatar-ajani"></span>Ajani</button>
                    <button class="persona-btn persona-btn-styled" data-persona="minerva" onclick="selectPersona('minerva')"><span class="persona-avatar persona-avatar-minerva"></span>Minerva</button>
                    <button class="persona-btn persona-btn-styled" data-persona="hermes" onclick="selectPersona('hermes')"><span class="persona-avatar persona-avatar-hermes"></span>Hermes</button>
                    <button class="persona-btn persona-btn-styled counsel-btn" data-persona="counsel" onclick="selectPersona('counsel')"><span class="persona-avatar persona-avatar-counsel"></span>Trinity</button>
                </div>
                <div class="chat-messages" id="chatMessages" style="position: relative; z-index: 2;">
                    <div class="message message-ajani spiky-bubble">
                        <div class="message-label label-ajani"><span class="persona-avatar persona-avatar-ajani" style="width:24px;height:24px;"></span><span style="vertical-align:middle;">Ajani</span></div>
                        <div>I am Ajani. Here's how this works: you bring me a problem, I give you options, you choose, we test. What challenge do we face today?</div>
                    </div>
                </div>
                <div class="blueprint-mode-indicator" id="blueprintIndicator">
                    ğŸ“ Blueprint Mode: Upload an image to break down into build phases
                </div>
                <div class="project-category-selector" id="categorySelector">
                    <span style="color: var(--text-secondary); font-size: 0.8rem; width: 100%;">Select project type:</span>
                    <button class="category-btn active" data-category="general" onclick="selectCategory('general')">ğŸ”§ General</button>
                    <button class="category-btn" data-category="3d-printing" onclick="selectCategory('3d-printing')">ğŸ–¨ï¸ 3D Print</button>
                    <button class="category-btn" data-category="robotics" onclick="selectCategory('robotics')">ğŸ¤– Robotics</button>
                    <button class="category-btn" data-category="home" onclick="selectCategory('home')">ğŸ  Home</button>
                    <button class="category-btn" data-category="automotive" onclick="selectCategory('automotive')">ğŸš— Auto</button>
                    <button class="category-btn" data-category="electronics" onclick="selectCategory('electronics')">âš¡ Electronics</button>
                </div>
                <div class="image-preview-container" id="imagePreviewContainer">
                    <img class="image-preview" id="imagePreview" src="" alt="Upload preview">
                    <div class="image-preview-info">
                        <strong id="imageFileName">image.jpg</strong>
                        <span id="imageFileSize">Ready for analysis</span>
                    </div>
                    <button class="remove-image-btn" onclick="removeUploadedImage()" title="Remove image">âœ•</button>
                </div>
                <div class="chat-input-area" style="position: relative; z-index: 2;">
                    <button class="hex-icon hex-green" onclick="toggleVoice()" title="Voice Input">
                        ğŸ¤
                    </button>
                    <button class="hex-icon hex-orange" id="imageUploadBtn" onclick="triggerImageUpload()" title="Upload Image for Blueprint">
                        ğŸ“·
                    </button>
                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message or upload an image..." onkeypress="handleKeyPress(event)">
                    <button class="hex-icon hex-pink" id="sendBtn" onclick="sendMessage()" title="Send">
                        â¤
                    </button>
                </div>
            </div>
        </section>

        <p class="scroll-hint">Swipe to explore personas</p>
        <div class="grid grid-stacked">
            <div class="card persona-card persona-card-ajani ripple-container supporting-panel">
                <div class="effects-layer" id="ajani-effects"></div>
                <div class="card-header">
                    <div class="card-icon persona-ajani">A</div>
                    <div class="card-title">Ajani</div>
                </div>
                <p class="description">Tactical Intelligence. Calm, direct, focused. Strategy, engineering, energy systems, survival theory, systems breakdown.</p>
                <span class="persona-tag tag-ajani">Strategy</span>
                <span class="persona-tag tag-ajani">Systems</span>
            </div>

            <div class="card persona-card persona-card-minerva ripple-container supporting-panel">
                <div class="effects-layer" id="minerva-effects"></div>
                <div class="card-header">
                    <div class="card-icon persona-minerva">M</div>
                    <div class="card-title">Minerva</div>
                </div>
                <p class="description">Cultural & Narrative Intelligence. Warm, wise, story-driven. Biology, ethics, history, culture, identity, critical theory.</p>
                <span class="persona-tag tag-minerva">Culture</span>
                <span class="persona-tag tag-minerva">History</span>
            </div>

            <div class="card persona-card persona-card-hermes ripple-container supporting-panel">
                <div class="effects-layer" id="hermes-effects"></div>
                <div class="card-header">
                    <div class="card-icon persona-hermes">H</div>
                    <div class="card-title">Hermes</div>
                </div>
                <p class="description">Structural & Systems Intelligence. Precise, observant, patient - but also sarcastic and funny. A scout who finds patterns in architecture, math, physics, programming, animation pipelines, AI logic.</p>
                <span class="persona-tag tag-hermes">Scout</span>
                <span class="persona-tag tag-hermes">Patterns</span>
            </div>

            <div class="card persona-card persona-card-counsel counsel-card ripple-container supporting-panel">
                <div class="effects-layer" id="counsel-effects"></div>
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #00bfff, #6040ff); color: #fff;">T</div>
                    <div class="card-title">Trinity Counsel</div>
                </div>
                <p class="description">When the three minds converge. Ajani, Minerva, and Hermes deliberate together on complex matters requiring multiple perspectives and deep cross-domain analysis.</p>
                <span class="persona-tag" style="background: linear-gradient(90deg, #dc143c, #00d4aa); color: #fff;">Council</span>
                <span class="persona-tag" style="background: linear-gradient(90deg, #00d4aa, #f5f5dc); color: #000;">Unity</span>
            </div>
        </div>

        <!-- Design Forge Section -->
        <section class="dashboard-section" id="design-forge-section">
            <h2 class="section-title">Design Forge</h2>
            <p class="description">Describe what you want to build. Drop reference images, choose textures, and get working 3D-ready designs.</p>
            
            <div class="design-forge-container">
                <div class="design-controls">
                    <!-- Drag & Drop Image Upload -->
                    <div class="design-dropzone" id="designDropzone" ondrop="handleDesignDrop(event)" ondragover="handleDesignDragOver(event)" ondragleave="handleDesignDragLeave(event)">
                        <input type="file" id="designFileInput" accept="image/*" style="display: none;" onchange="handleDesignFileSelect(event)">
                        <div class="dropzone-content" id="dropzoneContent">
                            <span style="font-size: 2rem;">ğŸ“·</span>
                            <p>Drop reference image here or <span class="dropzone-link" onclick="document.getElementById('designFileInput').click()">browse</span></p>
                        </div>
                        <div class="dropzone-preview" id="dropzonePreview" style="display: none;">
                            <img id="dropzoneImage" src="" alt="Reference">
                            <button class="dropzone-remove" onclick="removeDesignReference()">âœ•</button>
                        </div>
                    </div>

                    <div class="design-input-row">
                        <select id="designTemplate" class="design-select">
                            <option value="custom">Custom Design</option>
                            <option value="card">Card Component</option>
                            <option value="button">Button Set</option>
                            <option value="layout">Page Layout</option>
                            <option value="nav">Navigation Bar</option>
                            <option value="form">Form Elements</option>
                            <option value="dashboard">Dashboard Panel</option>
                            <option value="hero">Hero Section</option>
                            <option value="3d-card">3D Card (Rotatable)</option>
                            <option value="layered">Layered Component</option>
                        </select>
                        <select id="designPersona" class="design-select">
                            <option value="ajani">Ajani (Bold/Tactical)</option>
                            <option value="minerva">Minerva (Elegant/Cultural)</option>
                            <option value="hermes">Hermes (Technical/Clean)</option>
                        </select>
                    </div>

                    <!-- Texture Presets -->
                    <div class="texture-presets">
                        <label>Texture</label>
                        <div class="texture-grid">
                            <button class="texture-btn active" data-texture="none" onclick="selectTexture('none')" title="None">ğŸš«</button>
                            <button class="texture-btn" data-texture="metal" onclick="selectTexture('metal')" title="Metal">ğŸ”©</button>
                            <button class="texture-btn" data-texture="glass" onclick="selectTexture('glass')" title="Glass">ğŸªŸ</button>
                            <button class="texture-btn" data-texture="wood" onclick="selectTexture('wood')" title="Wood">ğŸªµ</button>
                            <button class="texture-btn" data-texture="fabric" onclick="selectTexture('fabric')" title="Fabric">ğŸ§µ</button>
                            <button class="texture-btn" data-texture="neon" onclick="selectTexture('neon')" title="Neon">ğŸ’¡</button>
                            <button class="texture-btn" data-texture="hologram" onclick="selectTexture('hologram')" title="Hologram">âœ¨</button>
                            <button class="texture-btn" data-texture="carbon" onclick="selectTexture('carbon')" title="Carbon">â¬›</button>
                        </div>
                    </div>

                    <!-- Color Scheme Presets - Dropdown Tab -->
                    <div class="forge-dropdown">
                        <div class="forge-dropdown-header" onclick="toggleForgeDropdown('colors')">
                            <span>ğŸ¨ Color Schemes</span>
                            <span class="forge-dropdown-arrow" id="colors-arrow">â–¼</span>
                        </div>
                        <div class="forge-dropdown-content" id="colors-content">
                            <div class="color-category">
                                <small>Solid</small>
                                <div class="colorscheme-grid">
                                    <button class="colorscheme-btn active" data-scheme="dark" onclick="selectColorScheme('dark')" style="background: linear-gradient(135deg, #0a0a0f, #1a1a2e);" title="Dark"></button>
                                    <button class="colorscheme-btn" data-scheme="crimson" onclick="selectColorScheme('crimson')" style="background: linear-gradient(135deg, #dc143c, #8b0000);" title="Crimson"></button>
                                    <button class="colorscheme-btn" data-scheme="teal" onclick="selectColorScheme('teal')" style="background: linear-gradient(135deg, #00d4aa, #008080);" title="Teal"></button>
                                    <button class="colorscheme-btn" data-scheme="purple" onclick="selectColorScheme('purple')" style="background: linear-gradient(135deg, #6040ff, #4b0082);" title="Purple"></button>
                                    <button class="colorscheme-btn" data-scheme="gold" onclick="selectColorScheme('gold')" style="background: linear-gradient(135deg, #ffd700, #b8860b);" title="Gold"></button>
                                    <button class="colorscheme-btn" data-scheme="cyber" onclick="selectColorScheme('cyber')" style="background: linear-gradient(135deg, #00ff00, #003300);" title="Cyber"></button>
                                    <button class="colorscheme-btn" data-scheme="sunset" onclick="selectColorScheme('sunset')" style="background: linear-gradient(135deg, #ff6b35, #f7931e);" title="Sunset"></button>
                                    <button class="colorscheme-btn" data-scheme="ice" onclick="selectColorScheme('ice')" style="background: linear-gradient(135deg, #a5f3fc, #0ea5e9);" title="Ice"></button>
                                </div>
                            </div>
                            <div class="color-category">
                                <small>Transparent / Glass</small>
                                <div class="colorscheme-grid">
                                    <button class="colorscheme-btn" data-scheme="glass-dark" onclick="selectColorScheme('glass-dark')" style="background: linear-gradient(135deg, rgba(10,10,20,0.6), rgba(30,30,50,0.4)); border: 1px solid rgba(255,255,255,0.1);" title="Glass Dark"></button>
                                    <button class="colorscheme-btn" data-scheme="glass-frost" onclick="selectColorScheme('glass-frost')" style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(200,200,220,0.1)); border: 1px solid rgba(255,255,255,0.2);" title="Frosted"></button>
                                    <button class="colorscheme-btn" data-scheme="glass-crimson" onclick="selectColorScheme('glass-crimson')" style="background: linear-gradient(135deg, rgba(220,20,60,0.4), rgba(139,0,0,0.3)); border: 1px solid rgba(220,20,60,0.3);" title="Glass Crimson"></button>
                                    <button class="colorscheme-btn" data-scheme="glass-teal" onclick="selectColorScheme('glass-teal')" style="background: linear-gradient(135deg, rgba(0,212,170,0.4), rgba(0,128,128,0.3)); border: 1px solid rgba(0,212,170,0.3);" title="Glass Teal"></button>
                                    <button class="colorscheme-btn" data-scheme="glass-purple" onclick="selectColorScheme('glass-purple')" style="background: linear-gradient(135deg, rgba(96,64,255,0.4), rgba(75,0,130,0.3)); border: 1px solid rgba(96,64,255,0.3);" title="Glass Purple"></button>
                                    <button class="colorscheme-btn" data-scheme="glass-gold" onclick="selectColorScheme('glass-gold')" style="background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(184,134,11,0.3)); border: 1px solid rgba(255,215,0,0.3);" title="Glass Gold"></button>
                                    <button class="colorscheme-btn" data-scheme="smoke" onclick="selectColorScheme('smoke')" style="background: linear-gradient(135deg, rgba(50,50,60,0.5), rgba(20,20,30,0.3)); border: 1px solid rgba(100,100,120,0.2);" title="Smoke"></button>
                                    <button class="colorscheme-btn" data-scheme="void" onclick="selectColorScheme('void')" style="background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,40,0.6)); border: 1px solid rgba(80,0,120,0.3);" title="Void"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skins & Shapes Library - Dropdown Tab -->
                    <div class="forge-dropdown">
                        <div class="forge-dropdown-header" onclick="toggleForgeDropdown('skins')">
                            <span>ğŸ­ Skins & Shapes</span>
                            <span class="forge-dropdown-arrow" id="skins-arrow">â–¼</span>
                        </div>
                        <div class="forge-dropdown-content" id="skins-content">
                            <div class="skins-category">
                                <small>Skins</small>
                                <div class="skins-grid">
                                    <button class="skin-btn" data-skin="minimal" onclick="selectSkin('minimal')" title="Minimal">â¬œ</button>
                                    <button class="skin-btn active" data-skin="forge" onclick="selectSkin('forge')" title="Forge">ğŸ”¥</button>
                                    <button class="skin-btn" data-skin="retro" onclick="selectSkin('retro')" title="Retro 80s">ğŸ“¼</button>
                                    <button class="skin-btn" data-skin="brutalist" onclick="selectSkin('brutalist')" title="Brutalist">ğŸ—ï¸</button>
                                    <button class="skin-btn" data-skin="organic" onclick="selectSkin('organic')" title="Organic">ğŸŒ¿</button>
                                    <button class="skin-btn" data-skin="scifi" onclick="selectSkin('scifi')" title="Sci-Fi">ğŸš€</button>
                                    <button class="skin-btn" data-skin="biomimetic" onclick="selectSkin('biomimetic')" title="Biomimetic Sci-Fi">ğŸ§¬</button>
                                </div>
                            </div>
                            <div class="skins-category">
                                <small>Shapes</small>
                                <div class="shapes-grid">
                                    <button class="shape-btn" data-shape="rounded" onclick="selectShape('rounded')" title="Rounded">â¬œ</button>
                                    <button class="shape-btn active" data-shape="sharp" onclick="selectShape('sharp')" title="Sharp">â—¼</button>
                                    <button class="shape-btn" data-shape="pill" onclick="selectShape('pill')" title="Pill">ğŸ’Š</button>
                                    <button class="shape-btn" data-shape="hexagon" onclick="selectShape('hexagon')" title="Hexagon">â¬¡</button>
                                    <button class="shape-btn" data-shape="diamond" onclick="selectShape('diamond')" title="Diamond">â—†</button>
                                    <button class="shape-btn" data-shape="organic" onclick="selectShape('organic')" title="Organic">ğŸ«§</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Art Style Dropdown (Biomimetic Sci-Fi Sub-styles) -->
                    <div class="forge-dropdown">
                        <div class="forge-dropdown-header" onclick="toggleForgeDropdown('artstyle')">
                            <span>ğŸ§¬ Art Style</span>
                            <span class="forge-dropdown-arrow" id="artstyle-arrow">â–¼</span>
                        </div>
                        <div class="forge-dropdown-content" id="artstyle-content">
                            <div class="artstyle-category">
                                <small>Biomimetic Sci-Fi Styles</small>
                                <div class="artstyle-grid">
                                    <button class="artstyle-btn active" data-artstyle="none" onclick="selectArtStyle('none')" title="None">â€”</button>
                                    <button class="artstyle-btn" data-artstyle="xenobiology" onclick="selectArtStyle('xenobiology')" title="Speculative Biology / Xenobiology">ğŸ¦ </button>
                                    <button class="artstyle-btn" data-artstyle="blueprint" onclick="selectArtStyle('blueprint')" title="Technical Blueprint Art">ğŸ“</button>
                                    <button class="artstyle-btn" data-artstyle="hardsci" onclick="selectArtStyle('hardsci')" title="Hard Sci-Fi Concept">ğŸ”¬</button>
                                    <button class="artstyle-btn" data-artstyle="cybernetic" onclick="selectArtStyle('cybernetic')" title="Cybernetic Naturalism">ğŸ¤–</button>
                                    <button class="artstyle-btn" data-artstyle="organic-tech" onclick="selectArtStyle('organic-tech')" title="Organic as Technology">ğŸŒ¿</button>
                                </div>
                            </div>
                            <div class="artstyle-description" id="artstyleDescription">
                                <p class="artstyle-hint">Select a style to see its description</p>
                            </div>
                        </div>
                    </div>

                    <!-- HD Quality Toggle -->
                    <div class="hd-toggle-row">
                        <label class="hd-label">
                            <input type="checkbox" id="hdQualityToggle" onchange="toggleHDQuality()">
                            <span class="hd-slider"></span>
                            <span class="hd-text">HD Quality</span>
                        </label>
                        <span class="hd-badge" id="hdBadge">OFF</span>
                    </div>

                    <textarea id="designPrompt" class="design-prompt" placeholder="Describe your design... e.g., 'A dark card with a glowing border, user avatar, and stats'"></textarea>
                    
                    <div class="design-actions">
                        <button class="hex-icon hex-green" onclick="generateDesign()" title="Generate">âš¡</button>
                        <button class="hex-icon hex-orange" onclick="clearDesign()" title="Clear">âœ•</button>
                        <button class="hex-icon hex-pink" onclick="saveDesign()" title="Save">ğŸ’¾</button>
                    </div>

                    <!-- Quick Refinement Tools -->
                    <div class="refinement-tools" id="refinementTools" style="display: none;">
                        <label>Quick Refine</label>
                        <div class="refine-buttons">
                            <button class="refine-btn" onclick="refineDesign('darker')">ğŸŒ‘ Darker</button>
                            <button class="refine-btn" onclick="refineDesign('lighter')">â˜€ï¸ Lighter</button>
                            <button class="refine-btn" onclick="refineDesign('glow')">âœ¨ Add Glow</button>
                            <button class="refine-btn" onclick="refineDesign('sharper')">ğŸ“ Sharper</button>
                            <button class="refine-btn" onclick="refineDesign('rounder')">â­• Rounder</button>
                            <button class="refine-btn" onclick="refineDesign('bigger')">ğŸ” Bigger</button>
                        </div>
                    </div>

                    <!-- Magician Tools -->
                    <div class="magician-section">
                        <div class="magician-header" onclick="toggleMagician()">
                            <span>âœ¨ Magician Tools</span>
                            <span id="magicianToggle">â–¼</span>
                        </div>
                        <div class="magician-tools" id="magicianTools" style="display: none;">
                            <!-- Icon Generator -->
                            <div class="magic-tool">
                                <label>ğŸ¨ Generate Icon</label>
                                <div class="magic-tool-row">
                                    <input type="text" id="iconPrompt" placeholder="e.g., rocket, settings gear, user profile" class="magic-input">
                                    <select id="iconStyle" class="magic-select">
                                        <option value="outline">Outline</option>
                                        <option value="filled">Filled</option>
                                        <option value="duotone">Duotone</option>
                                    </select>
                                    <button onclick="generateIcon()" class="magic-btn">Create</button>
                                </div>
                                <div id="iconResult" class="magic-result"></div>
                            </div>

                            <!-- Copy Generator -->
                            <div class="magic-tool">
                                <label>ğŸ“ Generate Copy</label>
                                <div class="magic-tool-row">
                                    <input type="text" id="copyContext" placeholder="e.g., SaaS landing page, fitness app" class="magic-input">
                                    <select id="copyType" class="magic-select">
                                        <option value="headline">Headline</option>
                                        <option value="body">Body Text</option>
                                        <option value="button">Button Text</option>
                                        <option value="placeholder">Placeholder</option>
                                    </select>
                                    <button onclick="generateCopy()" class="magic-btn">Generate</button>
                                </div>
                                <div id="copyResult" class="magic-result"></div>
                            </div>

                            <!-- Export to React -->
                            <div class="magic-tool">
                                <label>âš›ï¸ Export to React</label>
                                <div class="magic-tool-row">
                                    <input type="text" id="componentName" placeholder="ComponentName" class="magic-input" value="GeneratedComponent">
                                    <button onclick="exportToReact()" class="magic-btn magic-btn-primary">Export Code</button>
                                </div>
                                <div id="reactResult" class="magic-result code-result"></div>
                            </div>

                            <!-- Layout Suggestions -->
                            <div class="magic-tool">
                                <label>ğŸ“ Auto-Suggest Layouts</label>
                                <div class="magic-tool-row">
                                    <input type="text" id="layoutPurpose" placeholder="e.g., dashboard, landing page, settings" class="magic-input">
                                    <button onclick="suggestLayouts()" class="magic-btn">Suggest</button>
                                </div>
                                <div id="layoutResults" class="magic-layouts"></div>
                            </div>

                            <!-- Interactive Prototype -->
                            <div class="magic-tool">
                                <label>ğŸ”— Create Prototype</label>
                                <div class="magic-tool-row">
                                    <input type="text" id="prototypeScreens" placeholder="Screen names: home, login, dashboard" class="magic-input">
                                    <button onclick="createPrototype()" class="magic-btn magic-btn-primary">Build</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="design-preview-area">
                    <div class="design-preview-container">
                        <div class="design-preview-header">
                            <span>Live Preview (Sandboxed)</span>
                            <div class="preview-actions">
                                <button class="preview-btn" onclick="toggle3DRotation()" title="3D Rotate" id="rotate3DBtn">ğŸ”„</button>
                                <button class="preview-btn" onclick="toggleCode()" title="View Code">{ }</button>
                                <button class="preview-btn" onclick="copyDesignCode()" title="Copy Code">ğŸ“‹</button>
                            </div>
                        </div>
                        <div class="design-preview-wrapper" id="previewWrapper">
                            <div class="design-preview" id="designPreview">
                                <div class="preview-placeholder" id="previewPlaceholder">
                                    <span style="font-size: 3rem;">ğŸ¨</span>
                                    <p>Your design will appear here</p>
                                </div>
                                <iframe id="designIframe" sandbox="allow-same-origin" style="display: none; width: 100%; height: 280px; border: none; background: #0a0a0f;"></iframe>
                            </div>
                        </div>
                        <div class="rotation-controls" id="rotationControls" style="display: none;">
                            <input type="range" id="rotateX" min="-45" max="45" value="0" oninput="updateRotation()">
                            <input type="range" id="rotateY" min="-45" max="45" value="0" oninput="updateRotation()">
                            <span id="rotationLabel">X: 0Â° Y: 0Â°</span>
                        </div>
                        <div class="design-code" id="designCode" style="display: none;">
                            <pre><code id="designCodeContent"></code></pre>
                        </div>
                    </div>

                    <!-- Layer Panel -->
                    <div class="layer-panel" id="layerPanel" style="display: none;">
                        <div class="layer-header">
                            <span>Layers</span>
                            <div style="display:flex;gap:0.5rem;align-items:center;">
                                <button class="layer-action-sm" onclick="showAllLayers()" title="Show all">ğŸ‘ï¸</button>
                                <button class="layer-action-sm" onclick="buildupMode()" title="Build-up view">ğŸ“Š</button>
                                <button class="preview-btn" onclick="toggleLayerPanel()">âœ•</button>
                            </div>
                        </div>
                        <div class="layer-list" id="layerList">
                            <div class="layer-item">
                                <span class="layer-icon">ğŸ“¦</span>
                                <span class="layer-name">Container</span>
                                <input type="checkbox" checked onchange="toggleLayer(this)">
                            </div>
                        </div>
                        <div class="layer-footer">
                            <span id="layerCount">1 layer</span>
                        </div>
                    </div>

                    <!-- Adjustments Panel -->
                    <div class="design-adjustments" id="designAdjustments" style="display: none;">
                        <h4>Adjust Design</h4>
                        <div class="adjustment-row">
                            <label>Primary Color</label>
                            <input type="color" id="adjPrimaryColor" value="#dc143c" onchange="applyAdjustments()">
                        </div>
                        <div class="adjustment-row">
                            <label>Background</label>
                            <input type="color" id="adjBgColor" value="#1a1a2e" onchange="applyAdjustments()">
                        </div>
                        <div class="adjustment-row">
                            <label>Border Radius</label>
                            <input type="range" id="adjBorderRadius" min="0" max="30" value="12" onchange="applyAdjustments()">
                            <span id="adjBorderRadiusVal">12px</span>
                        </div>
                        <div class="adjustment-row">
                            <label>Padding</label>
                            <input type="range" id="adjPadding" min="0" max="40" value="16" onchange="applyAdjustments()">
                            <span id="adjPaddingVal">16px</span>
                        </div>
                        <div class="adjustment-row">
                            <label>Shadow Intensity</label>
                            <input type="range" id="adjShadow" min="0" max="50" value="20" onchange="applyAdjustments()">
                            <span id="adjShadowVal">20</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="saved-designs" id="savedDesigns">
                <h4>Saved Components</h4>
                <div class="saved-designs-grid" id="savedDesignsGrid">
                    <div class="saved-design-placeholder">No saved designs yet</div>
                </div>
            </div>
        </section>

        <!-- 3D Anatomy Lab Section -->
        <section class="dashboard-section" id="anatomy-lab-section">
            <div class="collapsible-header collapsed" onclick="toggleSection('anatomy-lab-content')">
                <h2 class="section-title" style="margin: 0;"><span class="section-icon">ğŸ”¬</span> 3D Anatomy Lab</h2>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="anatomy-lab-content">
                <p class="description">Explore detailed human and animal physiology with interactive anatomical models and AI-powered explanations.</p>
                
                <div class="anatomy-container">
                    <div class="anatomy-controls">
                        <div class="anatomy-category-tabs">
                            <button class="anatomy-tab active" onclick="selectAnatomyCategory('human', this)">ğŸ§ Human</button>
                            <button class="anatomy-tab" onclick="selectAnatomyCategory('animal', this)">ğŸ¦ Animal</button>
                        </div>
                        
                        <div class="anatomy-system-select" id="humanSystems">
                            <label>Body System</label>
                            <div class="system-grid">
                                <button class="system-btn active" data-system="skeletal" onclick="selectBodySystem('skeletal')">ğŸ¦´ Skeletal</button>
                                <button class="system-btn" data-system="muscular" onclick="selectBodySystem('muscular')">ğŸ’ª Muscular</button>
                                <button class="system-btn" data-system="organs" onclick="selectBodySystem('organs')">ğŸ«€ Organs</button>
                                <button class="system-btn" data-system="nervous" onclick="selectBodySystem('nervous')">ğŸ§  Nervous</button>
                                <button class="system-btn" data-system="circulatory" onclick="selectBodySystem('circulatory')">ğŸ©¸ Circulatory</button>
                                <button class="system-btn" data-system="respiratory" onclick="selectBodySystem('respiratory')">ğŸ« Respiratory</button>
                                <button class="system-btn" data-system="digestive" onclick="selectBodySystem('digestive')">ğŸ½ï¸ Digestive</button>
                                <button class="system-btn" data-system="endocrine" onclick="selectBodySystem('endocrine')">âš—ï¸ Endocrine</button>
                                <button class="system-btn" data-system="lymphatic" onclick="selectBodySystem('lymphatic')">ğŸ’§ Lymphatic</button>
                                <button class="system-btn" data-system="integumentary" onclick="selectBodySystem('integumentary')">ğŸ§´ Skin</button>
                            </div>
                        </div>
                        
                        <div class="anatomy-system-select" id="animalSystems" style="display:none;">
                            <label>Animal Class</label>
                            <div class="system-grid">
                                <button class="system-btn active" data-animal="mammal" onclick="selectAnimalType('mammal')">ğŸ• Mammal</button>
                                <button class="system-btn" data-animal="bird" onclick="selectAnimalType('bird')">ğŸ¦… Bird</button>
                                <button class="system-btn" data-animal="fish" onclick="selectAnimalType('fish')">ğŸŸ Fish</button>
                                <button class="system-btn" data-animal="reptile" onclick="selectAnimalType('reptile')">ğŸ¦ Reptile</button>
                                <button class="system-btn" data-animal="insect" onclick="selectAnimalType('insect')">ğŸœ Insect</button>
                                <button class="system-btn" data-animal="amphibian" onclick="selectAnimalType('amphibian')">ğŸ¸ Amphibian</button>
                            </div>
                            <label style="margin-top:1rem;">Internal View</label>
                            <div class="system-grid">
                                <button class="system-btn animal-view-btn active" data-view="external" onclick="selectAnimalView('external')">ğŸ‘ï¸ External</button>
                                <button class="system-btn animal-view-btn" data-view="skeletal" onclick="selectAnimalView('skeletal')">ğŸ¦´ Skeleton</button>
                                <button class="system-btn animal-view-btn" data-view="organs" onclick="selectAnimalView('organs')">ğŸ«€ Organs</button>
                                <button class="system-btn animal-view-btn" data-view="muscular" onclick="selectAnimalView('muscular')">ğŸ’ª Muscles</button>
                            </div>
                        </div>
                        
                        <div class="anatomy-view-controls">
                            <button class="view-btn" onclick="rotateAnatomyModel(-15)">â†º Rotate</button>
                            <button class="view-btn" onclick="rotateAnatomyModel(15)">â†» Rotate</button>
                            <button class="view-btn" onclick="zoomAnatomyModel(1.2)">+ Zoom</button>
                            <button class="view-btn" onclick="zoomAnatomyModel(0.8)">- Zoom</button>
                            <button class="view-btn" onclick="resetAnatomyView()">âŸ³ Reset</button>
                            <button class="view-btn" onclick="toggleAnatomyLabels()">ğŸ·ï¸ Labels</button>
                        </div>
                    </div>
                    
                    <div class="anatomy-viewer">
                        <div class="anatomy-model-container" id="anatomyModelContainer">
                            <svg id="anatomySvg" viewBox="0 0 500 700" class="anatomy-svg"></svg>
                        </div>
                        
                        <div class="anatomy-info-panel" id="anatomyInfoPanel">
                            <h4>Click any part to learn</h4>
                            <p class="anatomy-info-desc">Select a bone, organ, or system component to get detailed AI-powered explanations about its structure and function.</p>
                            <div class="anatomy-quick-facts" id="anatomyQuickFacts"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Fields of Study Section -->
        <section class="dashboard-section dominant-panel" id="fields-section">
            <h2 class="section-title">Fields of Study</h2>
            <p class="description" style="margin-bottom: 1rem;">Choose a domain to explore. Each persona brings their unique perspective to teaching.</p>
            <div class="fields-carousel-container">
                <button class="carousel-nav carousel-prev" onclick="rotateFieldsCarousel(-1)">â€¹</button>
                <div class="fields-grid" id="fieldsCarousel">
                <div class="field-card" onclick="startFieldStudy('computer_science')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ’»</span>
                        <span class="field-name">Computer Science & AI</span>
                    </div>
                    <p class="field-description">Programming, AI systems, algorithms, and security.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('robotics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ¤–</span>
                        <span class="field-name">Robotics & Mechatronics</span>
                    </div>
                    <p class="field-description">Actuators, sensors, bio-inspired and green robotics.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag ajani">Ajani</span>
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('electrical')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ”Œ</span>
                        <span class="field-name">Electrical & Electronics</span>
                    </div>
                    <p class="field-description">Microcontrollers, power systems, and embedded systems.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag ajani">Ajani</span>
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('mechanical')">
                    <div class="field-header">
                        <span class="field-icon">âš™ï¸</span>
                        <span class="field-name">Mechanical Engineering</span>
                    </div>
                    <p class="field-description">Structural design, kinematics, exosuits, and manipulators.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag ajani">Ajani</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('materials')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ§±</span>
                        <span class="field-name">Materials Science</span>
                    </div>
                    <p class="field-description">Smart materials, biomimicry, and adaptive materials.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag ajani">Ajani</span>
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('energy')">
                    <div class="field-header">
                        <span class="field-icon">âš¡</span>
                        <span class="field-name">Energy Sciences</span>
                    </div>
                    <p class="field-description">Thermodynamics, sustainable energy, and phase-change systems.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag ajani">Ajani</span>
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('physics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ”¬</span>
                        <span class="field-name">Physics</span>
                    </div>
                    <p class="field-description">Mechanics, electromagnetism, acoustics, and quantum concepts.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag ajani">Ajani</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('biology')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ§¬</span>
                        <span class="field-name">Biology</span>
                    </div>
                    <p class="field-description">Human, animal, plant, and systems biology.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                        <span class="field-persona-tag ajani">Ajani</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('botany')">
                    <div class="field-header">
                        <span class="field-icon">ğŸŒ¿</span>
                        <span class="field-name">Advanced Botany</span>
                    </div>
                    <p class="field-description">Medicinal plants, survival botany, and plant signaling.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('chemistry')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ§ª</span>
                        <span class="field-name">Chemistry</span>
                    </div>
                    <p class="field-description">Organic, biochemistry, and alchemical plant theory.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('neuroscience')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ§ </span>
                        <span class="field-name">Neuroscience & Cognition</span>
                    </div>
                    <p class="field-description">Learning systems, brainwave states, and memory.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('medicine')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ’Š</span>
                        <span class="field-name">Medicine & Healing Arts</span>
                    </div>
                    <p class="field-description">Herbal medicine, sound healing, and wellness.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('architecture')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ›ï¸</span>
                        <span class="field-name">Architecture</span>
                    </div>
                    <p class="field-description">African, indigenous, Japanese, and bio-architecture.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                        <span class="field-persona-tag ajani">Ajani</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('acoustics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ”Š</span>
                        <span class="field-name">Acoustics & Sound Engineering</span>
                    </div>
                    <p class="field-description">Temple acoustics, resonance, and sonic learning.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('environmental')">
                    <div class="field-header">
                        <span class="field-icon">ğŸŒ</span>
                        <span class="field-name">Environmental Science</span>
                    </div>
                    <p class="field-description">Climate, permaculture, and ecosystem restoration.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                        <span class="field-persona-tag ajani">Ajani</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('mathematics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ“</span>
                        <span class="field-name">Mathematics</span>
                    </div>
                    <p class="field-description">Algebra to calculus, sacred geometry, and modeling.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('ethics')">
                    <div class="field-header">
                        <span class="field-icon">âš–ï¸</span>
                        <span class="field-name">Ethics & Philosophy</span>
                    </div>
                    <p class="field-description">AI ethics, genetic ethics, and moral reasoning.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('anthropology')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ—¿</span>
                        <span class="field-name">Anthropology & Cultural Studies</span>
                    </div>
                    <p class="field-description">African systems, mythology, symbolism, and ancestral knowledge.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('linguistics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ“œ</span>
                        <span class="field-name">Linguistics & Language</span>
                    </div>
                    <p class="field-description">Language evolution, glyphic systems, and sound symbolism.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                        <span class="field-persona-tag hermes">Hermes</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('creative_arts')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ¨</span>
                        <span class="field-name">Creative Arts & Design</span>
                    </div>
                    <p class="field-description">World-building, writing, visual design, and UI/UX.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('economics')">
                    <div class="field-header">
                        <span class="field-icon">ğŸ’°</span>
                        <span class="field-name">Economics & Systems Thinking</span>
                    </div>
                    <p class="field-description">Resource economies, cooperative models, and legacy planning.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>

                <div class="field-card" onclick="startFieldStudy('speculative')">
                    <div class="field-header">
                        <span class="field-icon">ğŸš€</span>
                        <span class="field-name">Speculative & Future Sciences</span>
                    </div>
                    <p class="field-description">Transhumanism, cybernetics, and quantum biology.</p>
                    <div class="field-personas">
                        <span class="field-persona-tag hermes">Hermes</span>
                        <span class="field-persona-tag minerva">Minerva</span>
                    </div>
                </div>
                </div>
                <button class="carousel-nav carousel-next" onclick="rotateFieldsCarousel(1)">â€º</button>
            </div>
            <div class="carousel-indicator" id="carouselIndicator">1 / 22</div>
        </section>

        <section class="dashboard-section">
            <div class="collapsible-header collapsed" onclick="toggleSection('learning-dashboard')">
                <h2 class="section-title" style="margin: 0;"><span class="section-icon">ğŸ“Š</span> Learning Dashboard</h2>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="learning-dashboard">
            <div class="grid">
                <div class="card dashboard-card" id="progress-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #4CAF50, #2E7D32);">ğŸ“Š</div>
                        <div class="card-title">Progress Tracker</div>
                    </div>
                    <div id="progress-content">
                        <p class="description">Your learning journey across all domains.</p>
                        <div class="progress-stats">
                            <div class="stat"><span id="lessons-completed">0</span> Lessons Completed</div>
                            <div class="stat"><span id="checkpoints-passed">0</span> Checkpoints Passed</div>
                        </div>
                        <button class="action-btn" onclick="loadProgress()">View Full Progress</button>
                    </div>
                </div>

                <div class="card dashboard-card" id="lessons-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #FF9800, #E65100);">ğŸ“š</div>
                        <div class="card-title">LEGO Lessons</div>
                    </div>
                    <div id="lessons-content">
                        <p class="description">Step-by-step structured learning with checkpoints.</p>
                        <div id="lessons-list" class="lessons-list"></div>
                        <button class="action-btn" onclick="loadLessons()">Browse Lessons</button>
                    </div>
                </div>

                <div class="card dashboard-card" id="projects-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);">ğŸ”§</div>
                        <div class="card-title">Personal Projects</div>
                    </div>
                    <div id="projects-content">
                        <p class="description">Track your ideas with the LEGO build system.</p>
                        <div id="projects-list" class="projects-list"></div>
                        <button class="action-btn" onclick="showNewProjectForm()">+ New Project</button>
                    </div>
                </div>

                <div class="card dashboard-card" id="knowledge-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #00BCD4, #006064);">ğŸ§ </div>
                        <div class="card-title">Knowledge Packs</div>
                    </div>
                    <div id="knowledge-content">
                        <p class="description">Custom materials for the personas to learn from.</p>
                        <div id="knowledge-list" class="knowledge-list"></div>
                        <button class="action-btn" onclick="showKnowledgeUpload()">+ Upload Knowledge</button>
                    </div>
                </div>

                <div class="card dashboard-card" id="gps-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #4CAF50, #1B5E20);">ğŸ“</div>
                        <div class="card-title">Location Services</div>
                    </div>
                    <div id="gps-content">
                        <div class="gps-header">
                            <span class="gps-status" id="gpsStatus">
                                <span>ğŸ“ Location Inactive</span>
                            </span>
                            <button class="control-toggle" onclick="initGPS()" style="margin-left: auto;">Enable GPS</button>
                        </div>
                        <div class="gps-coords" id="gpsCoords">---.------, ---.------</div>
                        <p class="description" style="margin-bottom: 0.5rem;">Find nearby resources:</p>
                        <div class="nearby-places" id="nearbyPlaces">
                            <button class="action-btn" onclick="findNearbyMakerspaces()">Find Makerspaces</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>

        <!-- Mobile Features Section -->
        <section class="dashboard-section" id="mobile-features">
            <div class="collapsible-header collapsed" onclick="toggleSection('quick-actions')">
                <h2 class="section-title" style="margin: 0;"><span class="section-icon">âš¡</span> Quick Actions</h2>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="quick-actions">
            <div class="grid">
                <!-- Idea Capture -->
                <div class="card dashboard-card" id="ideas-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #E91E63, #880E4F);">ğŸ’¡</div>
                        <div class="card-title">Idea Capture</div>
                    </div>
                    <div id="ideas-content">
                        <p class="description">Save ideas â†’ Create blueprints â†’ Build step-by-step</p>
                        <div class="idea-pipeline">
                            <span class="pipeline-stage" data-stage="idea">ğŸ’¡ Ideas <span id="idea-count">0</span></span>
                            <span class="pipeline-arrow">â†’</span>
                            <span class="pipeline-stage" data-stage="blueprint">ğŸ“ Blueprints <span id="blueprint-count">0</span></span>
                            <span class="pipeline-arrow">â†’</span>
                            <span class="pipeline-stage" data-stage="building">ğŸ”¨ Building <span id="building-count">0</span></span>
                            <span class="pipeline-arrow">â†’</span>
                            <span class="pipeline-stage" data-stage="complete">âœ… Done <span id="complete-count">0</span></span>
                        </div>
                        <div id="ideas-list" style="max-height: 150px; overflow-y: auto; margin: 0.5rem 0;"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="quick-idea" placeholder="Capture an idea..." style="flex: 1; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                            <button class="action-btn" onclick="captureIdea()" style="padding: 0.6rem 1rem;">+</button>
                        </div>
                        <button class="action-btn" onclick="showAllIdeas()" style="width: 100%; margin-top: 0.5rem; background: transparent; border: 1px dashed var(--border-glass);">View All Projects</button>
                    </div>
                </div>

                <!-- Learning Streak -->
                <div class="card dashboard-card" id="streak-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #FF5722, #BF360C);">ğŸ”¥</div>
                        <div class="card-title">Learning Streak</div>
                    </div>
                    <div id="streak-content">
                        <div style="text-align: center; padding: 1rem 0;">
                            <div id="streak-count" style="font-size: 3rem; font-weight: bold; color: var(--accent-secondary);">0</div>
                            <div style="color: var(--text-secondary);">Day Streak</div>
                        </div>
                        <div class="progress-stats" style="justify-content: center;">
                            <div class="stat"><span id="longest-streak">0</span> Best</div>
                            <div class="stat"><span id="total-days">0</span> Total</div>
                        </div>
                        <button class="action-btn" onclick="checkIn()" style="width: 100%;">Check In Today</button>
                    </div>
                </div>

                <!-- Build Timer -->
                <div class="card dashboard-card" id="timer-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #673AB7, #311B92);">â±ï¸</div>
                        <div class="card-title">Build Timer</div>
                    </div>
                    <div id="timer-content">
                        <div style="text-align: center; padding: 1rem 0;">
                            <div id="timer-display" style="font-size: 2.5rem; font-family: monospace; color: var(--text-primary);">00:00:00</div>
                        </div>
                        <select id="timer-project" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="">No project (free build)</option>
                        </select>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn" id="timer-start" onclick="toggleTimer()" style="flex: 1;">Start</button>
                            <button class="action-btn" onclick="resetTimer()" style="flex: 1; background: var(--bg-secondary);">Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Conversation History -->
                <div class="card dashboard-card" id="history-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #009688, #004D40);">ğŸ’¬</div>
                        <div class="card-title">Conversations</div>
                    </div>
                    <div id="history-content">
                        <p class="description">Your chat history with personas.</p>
                        <div id="conversations-list" style="max-height: 150px; overflow-y: auto; margin: 0.5rem 0;"></div>
                        <button class="action-btn" onclick="loadConversations()">View All</button>
                    </div>
                </div>

                <!-- Project Nudges -->
                <div class="card dashboard-card" id="nudges-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #FFC107, #FF8F00);">ğŸ“¢</div>
                        <div class="card-title">Project Nudges</div>
                    </div>
                    <div id="nudges-content">
                        <p class="description">Reminders for inactive projects.</p>
                        <div id="nudges-list" style="max-height: 150px; overflow-y: auto; margin: 0.5rem 0;"></div>
                        <button class="action-btn" onclick="loadNudges()">Check Nudges</button>
                    </div>
                </div>

                <!-- Focus Mode -->
                <div class="card dashboard-card" id="focus-card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #3F51B5, #1A237E);">ğŸ¯</div>
                        <div class="card-title">Focus Mode</div>
                    </div>
                    <div id="focus-content">
                        <p class="description">Single-persona distraction-free view.</p>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="action-btn focus-btn" onclick="enterFocusMode('ajani')" style="background: linear-gradient(135deg, #8B4513, #654321);">Focus with Ajani</button>
                            <button class="action-btn focus-btn" onclick="enterFocusMode('minerva')" style="background: linear-gradient(135deg, #4A235A, #2E1A47);">Focus with Minerva</button>
                            <button class="action-btn focus-btn" onclick="enterFocusMode('hermes')" style="background: linear-gradient(135deg, #1B4F72, #0E2F44);">Focus with Hermes</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>

        <!-- Focus Mode Overlay (fullscreen) -->
        <div id="focus-overlay" class="focus-overlay" style="display: none;">
            <div class="focus-header">
                <h2 id="focus-title">Builder's Focus</h2>
                <button class="close-btn focus-exit" onclick="exitFocusMode()">Exit Focus</button>
            </div>
            <div class="focus-greeting" id="focus-greeting"></div>
            <div class="focus-projects" id="focus-projects"></div>
            <div class="focus-chat">
                <div id="focus-messages" class="focus-messages"></div>
                <div class="focus-input-area">
                    <input type="text" id="focus-input" placeholder="What are we building today?" onkeypress="if(event.key==='Enter')sendFocusMessage()">
                    <button class="action-btn" onclick="sendFocusMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Morning Briefing Modal (hidden by default) -->
        <div id="briefing-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="briefing-greeting">Good Morning</h3>
                    <button class="close-btn" onclick="closeBriefing()">&times;</button>
                </div>
                <div id="briefing-content" style="padding: 1rem;">
                    <!-- Briefing content loaded dynamically -->
                </div>
            </div>
        </div>

        <section class="api-section" id="api-section">
            <div class="cobweb cobweb-corner cobweb-top-left"></div>
            <div class="cobweb cobweb-corner cobweb-top-right"></div>
            <div class="cobweb cobweb-corner cobweb-bottom-left"></div>
            <div class="cobweb cobweb-corner cobweb-bottom-right"></div>
            <div id="api-effects"></div>

            <h2 class="section-title" style="position: relative; z-index: 1;">API Endpoints</h2>

            <div class="grid" style="position: relative; z-index: 1;">
                <div class="card api-card" id="api-card-core">
                    <div class="api-card-effects"></div>
                    <div class="endpoint-group">
                        <div class="endpoint-group-title">Core</div>
                        <div class="endpoint-list" id="core-endpoints">
                            <a href="/health" class="endpoint-link">/health</a>
                            <a href="/identity" class="endpoint-link">/identity</a>
                            <a href="#" class="endpoint-link">/generate</a>
                        </div>
                    </div>
                </div>

                <div class="card api-card" id="api-card-bots">
                    <div class="api-card-effects"></div>
                    <div class="endpoint-group">
                        <div class="endpoint-group-title">Bots & Pipeline</div>
                        <div class="endpoint-list" id="bots-endpoints">
                            <a href="/bots" class="endpoint-link">/bots</a>
                            <a href="#" class="endpoint-link">/pipeline/validate</a>
                            <a href="#" class="endpoint-link">/pipeline/init/{name}</a>
                        </div>
                    </div>
                </div>

                <div class="card api-card" id="api-card-forge">
                    <div class="api-card-effects"></div>
                    <div class="endpoint-group">
                        <div class="endpoint-group-title">Forge (Robot Blueprints)</div>
                        <div class="endpoint-list" id="forge-endpoints">
                            <a href="/forge/audit" class="endpoint-link">/forge/audit</a>
                            <a href="/forge/templates" class="endpoint-link">/forge/templates</a>
                            <a href="/forge/parts" class="endpoint-link">/forge/parts</a>
                            <a href="#" class="endpoint-link">/forge/build/{template}</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer>
            Atlas Core - AI Persona-Based Educational & Creative Assistant System
        </footer>
    </div>

    <!-- Projects Modal -->
    <div class="projects-modal" id="projectsModal">
        <div class="projects-modal-content">
            <div class="projects-modal-header">
                <h2>ğŸ”§ Project Pipeline</h2>
                <button onclick="closeProjectsModal()" style="background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div class="projects-tabs">
                <button class="projects-tab active" onclick="filterProjects('all')">All</button>
                <button class="projects-tab" onclick="filterProjects('idea')">ğŸ’¡ Ideas</button>
                <button class="projects-tab" onclick="filterProjects('blueprint')">ğŸ“ Blueprints</button>
                <button class="projects-tab" onclick="filterProjects('building')">ğŸ”¨ Building</button>
                <button class="projects-tab" onclick="filterProjects('complete')">âœ… Complete</button>
            </div>
            <div class="projects-list" id="projectsList">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <div class="theme-switcher" role="group" aria-label="Theme switcher">
        <button class="theme-toggle-btn" onclick="toggleThemePanel()" aria-label="Open theme picker" aria-expanded="false" aria-controls="themePanel" id="themeToggleBtn">
            <span aria-hidden="true">ğŸ¨</span>
        </button>
        <div class="theme-panel" id="themePanel" role="menu" aria-labelledby="themeToggleBtn">
            <div class="theme-panel-title" id="themePanelLabel">Color Scheme</div>
            <div class="theme-options" role="group" aria-labelledby="themePanelLabel">
                <button class="theme-option active" data-theme="slate" onclick="setTheme('slate')" role="menuitem" aria-pressed="true">
                    <div class="theme-swatch swatch-slate" aria-hidden="true"></div>
                    <span>Slate</span>
                </button>
                <button class="theme-option" data-theme="teal" onclick="setTheme('teal')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-teal" aria-hidden="true"></div>
                    <span>Teal</span>
                </button>
                <button class="theme-option" data-theme="pastel" onclick="setTheme('pastel')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-pastel" aria-hidden="true"></div>
                    <span>Pastel</span>
                </button>
                <button class="theme-option" data-theme="industrial" onclick="setTheme('industrial')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-industrial" aria-hidden="true"></div>
                    <span>Industrial</span>
                </button>
                <button class="theme-option" data-theme="mint" onclick="setTheme('mint')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-mint" aria-hidden="true"></div>
                    <span>Mint</span>
                </button>
                <button class="theme-option" data-theme="brutalist" onclick="setTheme('brutalist')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-brutalist" aria-hidden="true"></div>
                    <span>Brutalist</span>
                </button>
                <button class="theme-option" data-theme="quanshi" onclick="setTheme('quanshi')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-quanshi" aria-hidden="true"></div>
                    <span>Quanshi</span>
                </button>
                <button class="theme-option" data-theme="makima" onclick="setTheme('makima')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-makima" aria-hidden="true"></div>
                    <span>Makima</span>
                </button>
                <button class="theme-option" data-theme="kishibe" onclick="setTheme('kishibe')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-kishibe" aria-hidden="true"></div>
                    <span>Kishibe</span>
                </button>
                <button class="theme-option" data-theme="sengoku" onclick="setTheme('sengoku')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-sengoku" aria-hidden="true"></div>
                    <span>Sengoku</span>
                </button>
                <button class="theme-option" data-theme="shogun" onclick="setTheme('shogun')" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-shogun" aria-hidden="true"></div>
                    <span>Shogun</span>
                </button>
                <button class="theme-option" data-theme="custom" onclick="toggleCustomColors()" role="menuitem" aria-pressed="false">
                    <div class="theme-swatch swatch-custom" aria-hidden="true"></div>
                    <span>Custom</span>
                </button>
            </div>
            <div class="custom-divider"></div>
            <div class="custom-colors-section" id="customColorsSection">
                <div class="color-picker-row">
                    <span class="color-picker-label">Background</span>
                    <input type="color" class="color-picker-input" id="customBg" value="#0d0d12" aria-label="Background color">
                </div>
                <div class="color-picker-row">
                    <span class="color-picker-label">Panels</span>
                    <input type="color" class="color-picker-input" id="customPanel" value="#1a1a22" aria-label="Panel color">
                </div>
                <div class="color-picker-row">
                    <span class="color-picker-label">Accent</span>
                    <input type="color" class="color-picker-input" id="customAccent" value="#64d97b" aria-label="Accent color">
                </div>
                <div class="color-picker-row">
                    <span class="color-picker-label">Text</span>
                    <input type="color" class="color-picker-input" id="customText" value="#e8e8f0" aria-label="Text color">
                </div>
                <div class="color-picker-row">
                    <span class="color-picker-label">Borders</span>
                    <input type="color" class="color-picker-input" id="customBorder" value="#3a3a4a" aria-label="Border color">
                </div>
                <div class="custom-actions">
                    <button class="custom-btn" onclick="resetCustomColors()">Reset</button>
                    <button class="custom-btn primary" onclick="applyCustomColors()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="projectModal">
        <div class="modal-content">
            <h3 class="modal-title">Create New Project</h3>
            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="My 3D Printer Design">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="projectDesc" placeholder="What are you building?"></textarea>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="projectCategory">
                    <option value="engineering">Engineering</option>
                    <option value="creative">Creative/Art</option>
                    <option value="biology">Biology</option>
                    <option value="robotics">Robotics</option>
                    <option value="software">Software</option>
                    <option value="general">General</option>
                </select>
            </div>
            <div class="form-group">
                <label>Goal (What does success look like?)</label>
                <textarea id="projectGoal" placeholder="A working prototype that can..."></textarea>
            </div>
            <div class="form-group">
                <label>Assign to Personas</label>
                <select id="projectPersonas">
                    <option value="all">All (Trinity Counsel)</option>
                    <option value="ajani">Ajani (Engineering Focus)</option>
                    <option value="minerva">Minerva (Creative Focus)</option>
                    <option value="hermes">Hermes (Systems Focus)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeModal('projectModal')">Cancel</button>
                <button class="action-btn" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="knowledgeModal">
        <div class="modal-content">
            <h3 class="modal-title">Upload Knowledge Pack</h3>
            <div class="form-group">
                <label>Pack Name</label>
                <input type="text" id="packName" placeholder="My Research Notes">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="packCategory">
                    <option value="general">General</option>
                    <option value="research">Research</option>
                    <option value="reference">Reference Material</option>
                    <option value="notes">Personal Notes</option>
                    <option value="custom">Custom Domain</option>
                </select>
            </div>
            <div class="form-group">
                <label>Which personas can access this?</label>
                <select id="packScope">
                    <option value="all">All Personas</option>
                    <option value="ajani">Ajani Only</option>
                    <option value="minerva">Minerva Only</option>
                    <option value="hermes">Hermes Only</option>
                </select>
            </div>
            <div class="form-group">
                <label>Content (paste text or upload file)</label>
                <textarea id="packContent" placeholder="Paste your knowledge here..."></textarea>
            </div>
            <div class="form-group">
                <label>Or upload a file</label>
                <input type="file" id="packFile" accept=".txt,.md,.json">
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeModal('knowledgeModal')">Cancel</button>
                <button class="action-btn" onclick="uploadKnowledge()">Upload Pack</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="fieldModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-title" id="fieldModalTitle">Field of Study</h3>
            <p id="fieldModalDescription" style="color: var(--text-secondary); margin-bottom: 1.5rem;"></p>
            <div id="fieldModalPersonas" style="margin-bottom: 1.5rem;"></div>
            
            <div class="learning-mode-section" style="margin-bottom: 1.5rem;">
                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Learning Style</h4>
                <div class="learning-mode-toggle">
                    <button class="mode-btn" id="modeTextBtn2" onclick="setLearningMode('text')">
                        <span class="mode-icon">ğŸ“–</span>
                        <span class="mode-label">Read</span>
                        <span class="mode-desc">Text lessons</span>
                    </button>
                    <button class="mode-btn" id="modeAudioBtn2" onclick="setLearningMode('audio')">
                        <span class="mode-icon">ğŸ§</span>
                        <span class="mode-label">Listen</span>
                        <span class="mode-desc">Audio narration</span>
                    </button>
                    <button class="mode-btn" id="modeInteractiveBtn2" onclick="setLearningMode('interactive')">
                        <span class="mode-icon">ğŸ”§</span>
                        <span class="mode-label">Hands-On</span>
                        <span class="mode-desc">Exercises & builds</span>
                    </button>
                </div>
            </div>
            
            <h4 style="color: var(--accent-primary); margin-bottom: 1rem; font-size: 1rem;">Branches of Study</h4>
            <div id="fieldBranchesList" class="field-branches-list"></div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeModal('fieldModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="lessonModal">
        <div class="modal-content lesson-viewer">
            <div class="lesson-header">
                <h3 id="lessonViewerTitle">Lesson</h3>
                <button class="cancel-btn" onclick="closeLesson()" style="padding: 0.5rem 1rem;">Close</button>
            </div>
            <div class="lesson-body">
                <div class="chapter-sidebar" id="chapterSidebar"></div>
                <div class="lesson-content-area">
                    <h4 class="lesson-chapter-title" id="chapterTitle">Chapter 1</h4>
                    <div class="audio-controls">
                        <button class="audio-btn" id="audioPlayBtn" onclick="toggleAudio()">
                            <span id="audioIcon">â–¶</span> <span id="audioLabel">Listen</span>
                        </button>
                        <button class="audio-btn" onclick="stopAudio()">â¬› Stop</button>
                        <div class="audio-speed">
                            <label>Speed:</label>
                            <select id="audioSpeed" onchange="updateAudioSpeed()">
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                    <div class="lesson-text" id="lessonText"></div>

                    <!-- Too Slow / I'm Bored Button -->
                    <div class="bored-btn-container" style="position: relative;">
                        <button class="bored-btn" onclick="toggleBoredMenu()">
                            <span>ğŸ˜´</span> Too slow / I'm bored
                        </button>
                        <div class="bored-dropdown" id="boredDropdown">
                            <div class="bored-option" onclick="switchLessonMode('shorter')">
                                <span class="bored-option-icon">âš¡</span>
                                <span class="bored-option-text">Shorter lesson</span>
                            </div>
                            <div class="bored-option" onclick="switchLessonMode('examples')">
                                <span class="bored-option-icon">ğŸ“‹</span>
                                <span class="bored-option-text">More examples</span>
                            </div>
                            <div class="bored-option" onclick="switchLessonMode('visuals')">
                                <span class="bored-option-icon">ğŸ–¼ï¸</span>
                                <span class="bored-option-text">More visuals</span>
                            </div>
                            <div class="bored-option" onclick="switchLessonMode('quiz')">
                                <span class="bored-option-icon">â“</span>
                                <span class="bored-option-text">Quiz mode</span>
                            </div>
                            <div class="bored-option" onclick="switchLessonMode('steps')">
                                <span class="bored-option-icon">ğŸ“</span>
                                <span class="bored-option-text">Just show me the steps</span>
                            </div>
                        </div>
                    </div>

                    <!-- Streak of Proof Panel -->
                    <div class="streak-of-proof" id="streakOfProof">
                        <div class="streak-header">
                            <span>ğŸ“Š</span> Streak of Proof
                        </div>
                        <div class="streak-grid">
                            <div class="streak-item" id="streakNotes" onclick="generateStreakItem('notes')">
                                <span class="streak-icon">ğŸ“</span>
                                <span class="streak-label">Mini-notes</span>
                            </div>
                            <div class="streak-item" id="streakFlashcards" onclick="generateStreakItem('flashcards')">
                                <span class="streak-icon">ğŸƒ</span>
                                <span class="streak-label">Flashcards</span>
                            </div>
                            <div class="streak-item" id="streakSummary" onclick="generateStreakItem('summary')">
                                <span class="streak-icon">ğŸ“„</span>
                                <span class="streak-label">10-line summary</span>
                            </div>
                            <div class="streak-item" id="streakChecklist" onclick="generateStreakItem('checklist')">
                                <span class="streak-icon">âœ…</span>
                                <span class="streak-label">What I can do now</span>
                            </div>
                        </div>
                        <div id="streakOutput" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>
            </div>
            <div class="lesson-footer">
                <div class="lesson-progress">
                    <span id="progressLabel">Chapter 1 of 5</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                    </div>
                </div>
                <div class="lesson-nav-btns">
                    <button class="cancel-btn" id="prevChapterBtn" onclick="prevChapter()">Previous</button>
                    <button class="action-btn" id="nextChapterBtn" onclick="nextChapter()">Next Chapter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comprehensive Lesson Plan Modal -->
    <div class="modal-overlay" id="lessonPlanModal">
        <div class="modal-content lesson-plan-modal">
            <div class="lesson-plan-header">
                <span class="lesson-plan-icon" id="lpIcon">ğŸ“š</span>
                <div class="lesson-plan-info">
                    <h2 id="lpTitle">Field of Study</h2>
                    <p id="lpDescription">Description</p>
                </div>
                <button class="cancel-btn" onclick="closeModal('lessonPlanModal')" style="margin-left: auto;">âœ•</button>
            </div>

            <div class="ai-nudge" id="lpNudge" style="display: none;">
                <div class="ai-nudge-header">
                    <span class="ai-nudge-persona" id="lpNudgePersona">Ajani</span>
                    <span style="color: var(--text-secondary); font-size: 0.8rem;">says:</span>
                </div>
                <p class="ai-nudge-text" id="lpNudgeText"></p>
            </div>

            <div class="lesson-plan-stats">
                <div class="stat-card">
                    <div class="stat-value" id="lpChaptersComplete">0</div>
                    <div class="stat-label">Chapters Done</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lpTotalChapters">15</div>
                    <div class="stat-label">Total Chapters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lpStudyTime">0h</div>
                    <div class="stat-label">Study Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lpAvgScore">-</div>
                    <div class="stat-label">Avg Test Score</div>
                </div>
            </div>

            <div class="learning-mode-section">
                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Learning Style</h4>
                <div class="learning-mode-toggle">
                    <button class="mode-btn active" id="modeTextBtn" onclick="setLearningMode('text')">
                        <span class="mode-icon">ğŸ“–</span>
                        <span class="mode-label">Read</span>
                        <span class="mode-desc">Text lessons</span>
                    </button>
                    <button class="mode-btn" id="modeAudioBtn" onclick="setLearningMode('audio')">
                        <span class="mode-icon">ğŸ§</span>
                        <span class="mode-label">Listen</span>
                        <span class="mode-desc">Audio narration</span>
                    </button>
                    <button class="mode-btn" id="modeInteractiveBtn" onclick="setLearningMode('interactive')">
                        <span class="mode-icon">ğŸ”§</span>
                        <span class="mode-label">Hands-On</span>
                        <span class="mode-desc">Exercises & builds</span>
                    </button>
                </div>
            </div>

            <div class="study-timer-section">
                <div class="timer-display">
                    <div class="timer-circle" id="lpTimerCircle">
                        <span class="timer-time" id="lpTimerTime">30:00</span>
                    </div>
                    <div class="timer-info">
                        <h4>Daily Study Timer</h4>
                        <p id="lpTimerStatus">0 of 30 minutes today</p>
                    </div>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn" id="lpTimerStartBtn" onclick="toggleStudyTimer()">Start</button>
                    <button class="timer-btn secondary" onclick="openTimerSettings()">Settings</button>
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin-bottom: 1rem; font-size: 1.1rem;">Subfields & Chapters</h3>
            <div class="subfields-list" id="lpSubfieldsList"></div>

            <div class="final-project-section" id="lpFinalProject">
                <h4>ğŸ¯ Final Project</h4>
                <p id="lpProjectDesc">Complete all chapters to unlock the final project.</p>
                <div id="lpProjectRequirements"></div>
                <button class="timer-btn" id="lpProjectBtn" style="margin-top: 1rem; display: none;">Start Project</button>
            </div>

            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeModal('lessonPlanModal')">Close</button>
                <button class="action-btn" id="lpStartBtn" onclick="startOrResumeField()">Start Learning</button>
            </div>
        </div>
    </div>

    <!-- Chapter Test Modal -->
    <div class="modal-overlay" id="chapterTestModal">
        <div class="modal-content test-modal">
            <h3 id="testTitle" style="margin-bottom: 1.5rem;">Chapter Test</h3>
            <div id="testQuestions"></div>
            <div id="testResult" class="test-result" style="display: none;">
                <div class="test-score" id="testScoreValue">85%</div>
                <p id="testFeedback">Great job!</p>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeModal('chapterTestModal')">Close</button>
                <button class="action-btn" id="submitTestBtn" onclick="submitChapterTest()">Submit Test</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FORGE ENGINE - Local Logic (No AI Calls)
        // ============================================
        const ForgeEngine = {
            // Local state - NO AI needed
            state: {
                stability: 78,
                memoryLoad: 32,
                logicFlow: 45,
                riskLevel: 12,
                score: 0,
                streak: 0,
                completedExercises: 0,
                variables: {},
                memorySlots: new Array(16).fill(null)
            },
            
            // Pure local scoring - instant, no network
            scoreAnswer(isCorrect, difficulty = 1) {
                if (isCorrect) {
                    this.state.score += 10 * difficulty;
                    this.state.streak++;
                    this.state.stability = Math.min(100, this.state.stability + 2);
                    this.state.riskLevel = Math.max(0, this.state.riskLevel - 1);
                    return { points: 10 * difficulty, bonus: this.state.streak > 3 ? 5 : 0 };
                } else {
                    this.state.streak = 0;
                    this.state.riskLevel = Math.min(100, this.state.riskLevel + 3);
                    this.state.stability = Math.max(0, this.state.stability - 1);
                    return { points: 0, bonus: 0 };
                }
            },
            
            // Variable tracking - frontend only
            setVariable(name, value) {
                this.state.variables[name] = value;
                this.fillMemorySlot(name, value);
            },
            
            getVariable(name) {
                return this.state.variables[name];
            },
            
            // Memory simulation - pure JS
            fillMemorySlot(label, value) {
                const emptySlot = this.state.memorySlots.findIndex(s => s === null);
                if (emptySlot !== -1) {
                    this.state.memorySlots[emptySlot] = { label, value };
                    this.state.memoryLoad = Math.round((this.state.memorySlots.filter(s => s !== null).length / 16) * 100);
                    return emptySlot;
                }
                // Overflow - trigger animation
                if (typeof forgeLearnEvent === 'function') forgeLearnEvent('memory_overflow');
                return -1;
            },
            
            clearMemory() {
                this.state.memorySlots.fill(null);
                this.state.memoryLoad = 0;
            },
            
            // Progress calculation - no AI
            calculateProgress(completed, total) {
                return Math.round((completed / total) * 100);
            },
            
            // Probability bars for simulations
            calculateProbability(factors) {
                return factors.reduce((acc, f) => acc * f.weight, 1);
            },
            
            // Get current metrics for display
            getMetrics() {
                return {
                    stability: this.state.stability,
                    memoryLoad: this.state.memoryLoad,
                    logicFlow: this.state.logicFlow,
                    riskLevel: this.state.riskLevel
                };
            },
            
            // Update logic flow during exercises
            incrementLogicFlow(amount = 5) {
                this.state.logicFlow = Math.min(100, this.state.logicFlow + amount);
            },
            
            // Sync metrics to UI
            syncToUI() {
                if (typeof updateSystemMetrics === 'function') {
                    const m = this.getMetrics();
                    updateSystemMetrics(m.stability, m.memoryLoad, m.logicFlow, m.riskLevel);
                }
            }
        };

        // ============================================
        // RESPONSE CACHE - Avoid recomputation
        // ============================================
        const ResponseCache = {
            cache: new Map(),
            maxAge: 30 * 60 * 1000, // 30 minutes
            
            generateKey(persona, message, mode) {
                return `${persona}:${mode}:${message.toLowerCase().trim().slice(0, 100)}`;
            },
            
            get(persona, message, mode = 'chat') {
                const key = this.generateKey(persona, message, mode);
                const cached = this.cache.get(key);
                if (cached && Date.now() - cached.timestamp < this.maxAge) {
                    return cached.response;
                }
                return null;
            },
            
            set(persona, message, mode, response) {
                const key = this.generateKey(persona, message, mode);
                this.cache.set(key, { response, timestamp: Date.now() });
                // Limit cache size
                if (this.cache.size > 200) {
                    const oldest = this.cache.keys().next().value;
                    this.cache.delete(oldest);
                }
            },
            
            clear() {
                this.cache.clear();
            }
        };

        // ============================================
        // PRELOADED CONTENT - Common lessons/hints
        // ============================================
        const PreloadedContent = {
            hints: {
                quiz_wrong: [
                    "Take another look at the question.",
                    "Consider what you already know about this topic.",
                    "Eliminate options that don't fit.",
                    "Think about the core concept being tested."
                ],
                build_stuck: [
                    "Start with the foundation piece.",
                    "Check your connections between parts.",
                    "Review the target structure.",
                    "Work from bottom to top."
                ],
                puzzle_hint: [
                    "Look for related concepts.",
                    "Match definitions to terms first.",
                    "Use process of elimination.",
                    "Think about how these connect in practice."
                ]
            },
            
            feedback: {
                correct: ["Excellent!", "Perfect!", "You got it!", "Sharp thinking!", "On point!"],
                incorrect: ["Not quite.", "Try again.", "Close, but not it.", "Think it through."],
                complete: ["Outstanding work!", "Mission accomplished!", "Exercise complete!", "Well done!"]
            },
            
            getRandomHint(type) {
                const hints = this.hints[type] || this.hints.quiz_wrong;
                return hints[Math.floor(Math.random() * hints.length)];
            },
            
            getRandomFeedback(type) {
                const fb = this.feedback[type] || this.feedback.correct;
                return fb[Math.floor(Math.random() * fb.length)];
            }
        };

        // ============================================
        // AI ROLE DISPATCHER - Split by persona
        // ============================================
        const AIDispatcher = {
            // Hermes = instant validation (cached or local)
            async validateAnswer(answer, correctAnswer, context) {
                // Use local validation first
                const isCorrect = answer === correctAnswer;
                const result = ForgeEngine.scoreAnswer(isCorrect);
                ForgeEngine.syncToUI();
                
                return {
                    correct: isCorrect,
                    feedback: PreloadedContent.getRandomFeedback(isCorrect ? 'correct' : 'incorrect'),
                    points: result.points + result.bonus,
                    local: true
                };
            },
            
            // Minerva = fast hints (preloaded or short prompt)
            async getHint(exerciseType, context) {
                // Return preloaded hint instantly
                return {
                    hint: PreloadedContent.getRandomHint(exerciseType + '_hint') || PreloadedContent.getRandomHint('quiz_wrong'),
                    local: true
                };
            },
            
            // Ajani = deep thinking (only when needed)
            async getExplanation(topic, fieldId, chapterId) {
                // Check cache first
                const cacheKey = `explain:${fieldId}:${chapterId}:${topic}`;
                const cached = ResponseCache.get('ajani', cacheKey, 'explain');
                if (cached) return { explanation: cached, cached: true };
                
                // Only call AI for actual explanations
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona: 'ajani',
                            message: `EXP:${fieldId}:${chapterId}:${topic}`,
                            mode: 'explain_short'
                        })
                    });
                    const data = await response.json();
                    if (data.response) {
                        ResponseCache.set('ajani', cacheKey, 'explain', data.response);
                    }
                    return { explanation: data.response, cached: false };
                } catch (err) {
                    return { explanation: 'Unable to get explanation. Try again.', error: true };
                }
            }
        };

        let currentPersona = 'ajani';
        let isLoading = false;
        
        // Image upload state
        let uploadedImageData = null;
        let uploadedImageName = null;
        let selectedCategory = 'general';

        function triggerImageUpload() {
            document.getElementById('imageFileInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                uploadedImageName = file.name;
                
                // Show preview
                document.getElementById('imagePreview').src = uploadedImageData;
                document.getElementById('imageFileName').textContent = file.name;
                document.getElementById('imageFileSize').textContent = formatFileSize(file.size);
                document.getElementById('imagePreviewContainer').classList.add('active');
                document.getElementById('categorySelector').classList.add('active');
                document.getElementById('blueprintIndicator').classList.add('active');
                document.getElementById('imageUploadBtn').classList.add('has-image');
                
                // Update placeholder
                document.getElementById('chatInput').placeholder = 'Describe what you want to build from this image...';
            };
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function removeUploadedImage() {
            uploadedImageData = null;
            uploadedImageName = null;
            document.getElementById('imageFileInput').value = '';
            document.getElementById('imagePreviewContainer').classList.remove('active');
            document.getElementById('categorySelector').classList.remove('active');
            document.getElementById('blueprintIndicator').classList.remove('active');
            document.getElementById('imageUploadBtn').classList.remove('has-image');
            document.getElementById('chatInput').placeholder = 'Type your message or upload an image...';
        }

        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
        }

        const greetings = {
            ajani: "I am Ajani. Here's how this works: you bring me a problem, I give you options, you choose, we test. What challenge do we face today?",
            minerva: "Welcome, child. I am Minerva. Every question carries a story within it. Share yours with me, and together we shall trace its roots through time and wisdom.",
            hermes: "Ah, you found me. I am Hermes - your scout in the world of patterns and systems. I see what others miss, and yes, I'll make you laugh while explaining it. Show me what you're building, and I'll find the structure hiding beneath.",
            counsel: "The Trinity Counsel is assembled. Ajani, Minerva, and Hermes are ready to discuss any topic together. What matter shall we deliberate?"
        };

        async function loadSystemInfo() {
            try {
                const response = await fetch('/identity');
                const data = await response.json();
                
                document.getElementById('codename').textContent = data.codename || 'ATLAS-PRIME';
                document.getElementById('version').textContent = 'v' + data.version;
                document.getElementById('fingerprint').textContent = 'Fingerprint: ' + data.fingerprint;
            } catch (err) {
                console.log('Could not load identity:', err);
            }
        }

        function selectPersona(persona) {
            currentPersona = persona;
            
            // Update System Status Pane AI presence
            if (typeof updateAIPresence === 'function') {
                updateAIPresence(persona);
            }
            
            document.querySelectorAll('.persona-btn').forEach(btn => {
                // Keep base classes and counsel-btn if present
                const isCounsel = btn.dataset.persona === 'counsel';
                btn.className = isCounsel ? 'persona-btn persona-btn-styled counsel-btn' : 'persona-btn persona-btn-styled';
            });
            
            const activeBtn = document.querySelector(`[data-persona="${persona}"]`);
            activeBtn.classList.add(`active-${persona}`);
            
            document.querySelectorAll('.chat-bg-layer').forEach(bg => bg.classList.remove('active'));
            document.getElementById(`chat-bg-${persona}`).classList.add('active');
            
            updateChatEffects(persona);
            
            // Disable image upload for counsel mode (requires individual persona)
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            if (persona === 'counsel') {
                imageUploadBtn.style.display = 'none';
                removeUploadedImage(); // Clear any pending image
            } else {
                imageUploadBtn.style.display = 'flex';
            }
            
            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';
            addMessage(persona, greetings[persona]);
        }

        function updateChatEffects(persona) {
            const effectsLayer = document.getElementById('chat-effects');
            effectsLayer.innerHTML = '';
            
            if (persona === 'ajani') {
                for (let i = 0; i < 15; i++) {
                    const ember = document.createElement('div');
                    ember.className = 'chat-ember';
                    ember.style.left = Math.random() * 100 + '%';
                    ember.style.animationDelay = Math.random() * 5 + 's';
                    ember.style.animationDuration = (4 + Math.random() * 3) + 's';
                    effectsLayer.appendChild(ember);
                }
                for (let i = 0; i < 8; i++) {
                    const spark = document.createElement('div');
                    spark.className = 'chat-spark';
                    spark.style.left = Math.random() * 100 + '%';
                    spark.style.top = Math.random() * 100 + '%';
                    spark.style.animationDelay = Math.random() * 2 + 's';
                    effectsLayer.appendChild(spark);
                }
            } else if (persona === 'minerva') {
                const butterflies = ['ğŸ¦‹', 'ğŸ¦‹', 'ğŸ¦‹', 'ğŸ¦‹', 'ğŸ¦‹'];
                butterflies.forEach((b, i) => {
                    const butterfly = document.createElement('div');
                    butterfly.className = 'chat-butterfly';
                    butterfly.textContent = b;
                    butterfly.style.left = (10 + i * 18) + '%';
                    butterfly.style.top = (20 + Math.random() * 50) + '%';
                    butterfly.style.animationDelay = (i * 1.5) + 's';
                    butterfly.style.animationDuration = (8 + Math.random() * 4) + 's';
                    effectsLayer.appendChild(butterfly);
                });
                for (let i = 0; i < 12; i++) {
                    const firefly = document.createElement('div');
                    firefly.className = 'chat-firefly';
                    firefly.style.left = Math.random() * 100 + '%';
                    firefly.style.top = Math.random() * 100 + '%';
                    firefly.style.animationDelay = Math.random() * 4 + 's';
                    firefly.style.animationDuration = (3 + Math.random() * 3) + 's';
                    effectsLayer.appendChild(firefly);
                }
            } else if (persona === 'hermes') {
                for (let i = 0; i < 8; i++) {
                    const ray = document.createElement('div');
                    ray.className = 'chat-sunray';
                    ray.style.left = (5 + i * 12) + '%';
                    ray.style.animationDelay = (i * 0.6) + 's';
                    ray.style.animationDuration = (6 + Math.random() * 4) + 's';
                    effectsLayer.appendChild(ray);
                }
                for (let i = 0; i < 20; i++) {
                    const dust = document.createElement('div');
                    dust.className = 'chat-dust';
                    dust.style.left = Math.random() * 100 + '%';
                    dust.style.top = Math.random() * 100 + '%';
                    dust.style.animationDelay = Math.random() * 7 + 's';
                    effectsLayer.appendChild(dust);
                }
                for (let i = 0; i < 6; i++) {
                    const orb = document.createElement('div');
                    orb.className = 'chat-glow-orb';
                    orb.style.left = Math.random() * 100 + '%';
                    orb.style.top = Math.random() * 100 + '%';
                    orb.style.animationDelay = Math.random() * 6 + 's';
                    effectsLayer.appendChild(orb);
                }
            } else if (persona === 'counsel') {
                for (let i = 0; i < 20; i++) {
                    const ember = document.createElement('div');
                    ember.className = 'chat-blue-ember';
                    ember.style.left = Math.random() * 100 + '%';
                    ember.style.animationDelay = Math.random() * 5 + 's';
                    ember.style.animationDuration = (4 + Math.random() * 3) + 's';
                    effectsLayer.appendChild(ember);
                }
                for (let i = 0; i < 8; i++) {
                    const pulse = document.createElement('div');
                    pulse.className = 'chat-vibranium-pulse';
                    pulse.style.left = Math.random() * 100 + '%';
                    pulse.style.top = Math.random() * 100 + '%';
                    pulse.style.animationDelay = Math.random() * 3 + 's';
                    effectsLayer.appendChild(pulse);
                }
                for (let i = 0; i < 6; i++) {
                    const line = document.createElement('div');
                    line.className = 'chat-energy-line';
                    line.style.left = (10 + i * 15) + '%';
                    line.style.top = '20%';
                    line.style.animationDelay = (i * 0.5) + 's';
                    effectsLayer.appendChild(line);
                }
            }
        }

        function addMessage(sender, text) {
            const messages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            
            const labels = {
                user: 'You',
                ajani: 'Ajani',
                minerva: 'Minerva',
                hermes: 'Hermes',
                counsel: 'Trinity Counsel'
            };
            
            // Avatar HTML for AI personas
            const avatarHtml = {
                ajani: '<span class="persona-avatar persona-avatar-ajani" style="width:24px;height:24px;"></span>',
                minerva: '<span class="persona-avatar persona-avatar-minerva" style="width:24px;height:24px;"></span>',
                hermes: '<span class="persona-avatar persona-avatar-hermes" style="width:24px;height:24px;"></span>',
                counsel: '<span class="persona-avatar persona-avatar-counsel" style="width:24px;height:24px;"></span>'
            };
            
            // Use spiky bubbles for AI personas (enabled by default for stylized look)
            const useSpikyBubbles = window.useSpikyBubbles !== false;
            msgDiv.className = `message message-${sender}${useSpikyBubbles && sender !== 'user' ? ' spiky-bubble' : ''}`;
            
            // Check if this is a blueprint response (contains PHASE markers)
            const isBlueprintResponse = text.includes('PHASE') || text.includes('Phase 1') || text.includes('**Phase');
            
            const avatarPrefix = avatarHtml[sender] || '';
            const labelContent = `${avatarPrefix}<span style="vertical-align:middle;">${labels[sender] || sender}</span>`;
            
            if (isBlueprintResponse && sender !== 'user') {
                msgDiv.innerHTML = `<div class="message-label label-${sender}">${labelContent}</div><div class="message-bubble">${formatBlueprintResponse(text)}</div>`;
            } else {
                msgDiv.innerHTML = `<div class="message-label label-${sender}">${labelContent}</div><div class="message-bubble">${escapeHtml(text)}</div>`;
            }
            
            // Add Hermes auditor badge for AI responses
            if (sender !== 'user' && sender !== 'system' && typeof calculateConfidence === 'function') {
                const confidence = calculateConfidence(text);
                const citations = text.match(/according to|research shows|studies indicate|documented|proven|established/gi) || [];
                const badge = generateAuditorBadge(confidence, citations, false);
                const badgeDiv = document.createElement('div');
                badgeDiv.innerHTML = badge;
                msgDiv.appendChild(badgeDiv.firstElementChild);
            }
            
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatBlueprintResponse(text) {
            // Parse the blueprint phases and create visual layer cards
            const lines = text.split('\n');
            let html = '';
            let currentPhase = null;
            let phaseContent = [];
            let phaseCount = 0;
            
            const phaseColors = ['#dc143c', '#00d4aa', '#fbbf24', '#60a5fa', '#8b5cf6', '#f472b6'];
            const phaseIcons = ['ğŸ“‹', 'ğŸ”§', 'âš™ï¸', 'ğŸ”©', 'ğŸ”¬', 'âœ…'];
            
            lines.forEach(line => {
                const phaseMatch = line.match(/(?:\*\*)?PHASE\s*(\d+)|Phase\s*(\d+)/i);
                
                if (phaseMatch) {
                    if (currentPhase !== null) {
                        html += renderPhaseCard(currentPhase, phaseContent.join('\n'), phaseColors[currentPhase % phaseColors.length], phaseIcons[currentPhase % phaseIcons.length]);
                        phaseContent = [];
                    }
                    currentPhase = parseInt(phaseMatch[1] || phaseMatch[2]) - 1;
                    phaseCount++;
                    phaseContent.push(line);
                } else if (currentPhase !== null) {
                    phaseContent.push(line);
                } else {
                    html += `<p>${escapeHtml(line)}</p>`;
                }
            });
            
            // Render the last phase
            if (currentPhase !== null && phaseContent.length > 0) {
                html += renderPhaseCard(currentPhase, phaseContent.join('\n'), phaseColors[currentPhase % phaseColors.length], phaseIcons[currentPhase % phaseIcons.length]);
            }
            
            // Add visual layer diagram if multiple phases
            if (phaseCount >= 2) {
                html = renderBlueprintVisual(phaseCount, phaseColors) + html;
            }
            
            return html;
        }

        function renderPhaseCard(phaseIndex, content, color, icon) {
            const escapedContent = escapeHtml(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            return `
                <div class="blueprint-phase-card" style="border-left: 4px solid ${color}; background: rgba(${hexToRgb(color)}, 0.1); padding: 1rem; margin: 0.75rem 0; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">${icon}</span>
                        <span style="color: ${color}; font-weight: 600;">Layer ${phaseIndex + 1}</span>
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.5;">${escapedContent}</div>
                </div>
            `;
        }

        function renderBlueprintVisual(phaseCount, colors) {
            const width = 300;
            const height = 80;
            const layerHeight = height / phaseCount;
            
            let layers = '';
            for (let i = 0; i < phaseCount; i++) {
                const y = i * layerHeight;
                const opacity = 0.3 + (i * 0.1);
                layers += `<rect x="20" y="${y + 5}" width="${width - 40}" height="${layerHeight - 4}" fill="${colors[i % colors.length]}" opacity="${opacity}" rx="4"/>`;
                layers += `<text x="30" y="${y + layerHeight/2 + 4}" fill="white" font-size="10" font-weight="bold">Phase ${i + 1}</text>`;
            }
            
            return `
                <div class="blueprint-visual" style="margin: 1rem 0; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="font-size: 0.8rem; color: var(--accent-primary); margin-bottom: 0.5rem;">ğŸ“ Build Layers (${phaseCount} phases)</div>
                    <svg viewBox="0 0 ${width} ${height}" style="width: 100%; max-width: ${width}px; height: auto;">
                        ${layers}
                    </svg>
                </div>
            `;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '100, 100, 100';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            // Allow sending with just an image (no message required)
            if ((!message && !uploadedImageData) || isLoading) return;
            
            isLoading = true;
            sendBtn.disabled = true;
            sendBtn.classList.add('atlas-loading');
            
            // Show user message with image indicator if present
            const displayMessage = uploadedImageData 
                ? `ğŸ“· [Image: ${uploadedImageName}]\n${message || 'Analyze this image for blueprint breakdown'}`
                : message;
            addMessage('user', displayMessage);
            input.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.className = 'chat-typing-indicator';
            typingIndicator.innerHTML = '<span>Atlas thinking</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>';
            document.getElementById('chatMessages').appendChild(typingIndicator);
            typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            try {
                let response, data;
                
                // Check if we have an image to analyze
                if (uploadedImageData) {
                    // Blueprint analysis mode
                    const analysisMessage = message || 'Analyze this image and create a detailed blueprint breakdown';
                    
                    response = await fetch('/analyze-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona: currentPersona,
                            message: analysisMessage,
                            image: uploadedImageData,
                            category: selectedCategory
                        })
                    });
                    data = await response.json();
                    const blueprintMsg = data.response || data.error || 'No response';
                    addMessage(currentPersona, blueprintMsg);
                    notifyAIResponse(currentPersona, blueprintMsg);
                    
                    // Clear the image after sending
                    removeUploadedImage();
                } else if (currentPersona === 'counsel') {
                    response = await fetch('/counsel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic: message })
                    });
                    data = await response.json();
                    const counselMsg = data.discussion || data.error || 'No response';
                    addMessage('counsel', counselMsg);
                    notifyAIResponse('counsel', counselMsg);
                } else {
                    response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ persona: currentPersona, message: message })
                    });
                    data = await response.json();
                    const chatMsg = data.response || data.error || 'No response';
                    addMessage(currentPersona, chatMsg);
                    notifyAIResponse(currentPersona, chatMsg);
                }
            } catch (err) {
                addMessage(currentPersona, 'Connection error. Please try again.');
            } finally {
                // Remove typing indicator
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
                
                isLoading = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('atlas-loading');
                input.focus();
            }
        }

        loadSystemInfo();
        initPersonaEffects();
        initCounselEffects();
        updateChatEffects('ajani');
        initApiEffects();

        function initPersonaEffects() {
            // AJANI - Red embers + Blue embers on hover
            const ajaniEffects = document.getElementById('ajani-effects');
            for (let i = 0; i < 12; i++) {
                const ember = document.createElement('div');
                ember.className = 'ember';
                ember.style.left = Math.random() * 100 + '%';
                ember.style.animationDelay = Math.random() * 4 + 's';
                ember.style.animationDuration = (3 + Math.random() * 2) + 's';
                ajaniEffects.appendChild(ember);
            }
            for (let i = 0; i < 8; i++) {
                const blueEmber = document.createElement('div');
                blueEmber.className = 'ember ember-blue';
                blueEmber.style.left = Math.random() * 100 + '%';
                blueEmber.style.animationDelay = Math.random() * 4 + 's';
                blueEmber.style.animationDuration = (2.5 + Math.random() * 2) + 's';
                ajaniEffects.appendChild(blueEmber);
            }

            // MINERVA - Blue flowers and crawling vines
            const minervaEffects = document.getElementById('minerva-effects');
            for (let i = 0; i < 6; i++) {
                const flower = document.createElement('div');
                flower.className = 'blue-flower';
                flower.style.left = (10 + Math.random() * 80) + '%';
                flower.style.top = (20 + Math.random() * 60) + '%';
                flower.style.transitionDelay = (i * 0.1) + 's';
                flower.style.width = (15 + Math.random() * 10) + 'px';
                flower.style.height = flower.style.width;
                minervaEffects.appendChild(flower);
            }
            for (let i = 0; i < 5; i++) {
                const vine = document.createElement('div');
                vine.className = 'vine';
                vine.style.left = (5 + i * 22) + '%';
                vine.style.bottom = '0';
                vine.style.transitionDelay = (i * 0.15) + 's';
                minervaEffects.appendChild(vine);
            }
            for (let i = 0; i < 4; i++) {
                const curl = document.createElement('div');
                curl.className = 'vine-curl';
                curl.style.left = (15 + i * 25) + '%';
                curl.style.top = (40 + Math.random() * 30) + '%';
                curl.style.transitionDelay = (0.4 + i * 0.1) + 's';
                minervaEffects.appendChild(curl);
            }

            // HERMES - Ghost purple feathers and writing pen
            const hermesEffects = document.getElementById('hermes-effects');
            for (let i = 0; i < 6; i++) {
                const feather = document.createElement('div');
                feather.className = 'ghost-feather';
                feather.style.left = (5 + Math.random() * 70) + '%';
                feather.style.top = (10 + Math.random() * 60) + '%';
                feather.style.transform = `rotate(${-45 + Math.random() * 30}deg) translateX(-20px)`;
                feather.style.transitionDelay = (i * 0.12) + 's';
                feather.style.width = (25 + Math.random() * 15) + 'px';
                hermesEffects.appendChild(feather);
            }
            const pen = document.createElement('div');
            pen.className = 'writing-pen';
            pen.style.left = '10%';
            pen.style.top = '70%';
            hermesEffects.appendChild(pen);
            for (let i = 0; i < 3; i++) {
                const stroke = document.createElement('div');
                stroke.className = 'cursive-stroke';
                stroke.style.left = (15 + i * 8) + '%';
                stroke.style.top = (72 + i * 5) + '%';
                stroke.style.width = (40 + Math.random() * 30) + 'px';
                stroke.style.transitionDelay = (0.5 + i * 0.2) + 's';
                stroke.style.transform = `scaleX(0) rotate(${-5 + Math.random() * 10}deg)`;
                hermesEffects.appendChild(stroke);
            }
        }

        function initCounselEffects() {
            const counselCard = document.querySelector('.counsel-card');
            if (!counselCard) return;
            
            const effectsLayer = counselCard.querySelector('.effects-layer') || document.createElement('div');
            if (!effectsLayer.classList.contains('effects-layer')) {
                effectsLayer.className = 'effects-layer';
                counselCard.appendChild(effectsLayer);
            }
            effectsLayer.id = 'counsel-effects';

            // Warrior silhouettes with spears
            const positions = [
                { left: '5%', bottom: '10px' },
                { left: '20%', bottom: '15px' },
                { left: '75%', bottom: '12px' },
                { left: '90%', bottom: '8px' }
            ];
            
            positions.forEach((pos, i) => {
                const warrior = document.createElement('div');
                warrior.className = 'warrior-silhouette';
                warrior.style.left = pos.left;
                warrior.style.bottom = pos.bottom;
                warrior.style.transitionDelay = (i * 0.15) + 's';
                
                const body = document.createElement('div');
                body.className = 'warrior-body';
                warrior.appendChild(body);
                
                const head = document.createElement('div');
                head.className = 'warrior-head';
                warrior.appendChild(head);
                
                const spear = document.createElement('div');
                spear.className = 'warrior-spear';
                spear.style.transform = `translateX(-50%) rotate(${-20 + i * 5}deg)`;
                warrior.appendChild(spear);
                
                effectsLayer.appendChild(warrior);
            });

            // Chant pulse effect
            const pulse = document.createElement('div');
            pulse.className = 'chant-pulse';
            effectsLayer.appendChild(pulse);

            // Chant ripples
            for (let i = 0; i < 4; i++) {
                const ripple = document.createElement('div');
                ripple.className = 'chant-ripple';
                ripple.style.left = (20 + i * 20) + '%';
                ripple.style.bottom = '30%';
                ripple.style.animationDelay = (i * 0.5) + 's';
                effectsLayer.appendChild(ripple);
            }
        }

        function initApiEffects() {
            const apiEffects = document.getElementById('api-effects');
            
            for (let i = 0; i < 12; i++) {
                const strand = document.createElement('div');
                strand.className = 'cobweb-strand';
                strand.style.width = (80 + Math.random() * 150) + 'px';
                strand.style.left = Math.random() * 100 + '%';
                strand.style.top = Math.random() * 100 + '%';
                strand.style.transform = `rotate(${Math.random() * 360}deg)`;
                strand.style.animationDelay = Math.random() * 8 + 's';
                strand.style.opacity = 0.1 + Math.random() * 0.15;
                apiEffects.appendChild(strand);
            }
            
            for (let i = 0; i < 8; i++) {
                const drop = document.createElement('div');
                drop.className = 'cobweb-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.top = Math.random() * 100 + '%';
                drop.style.animationDelay = Math.random() * 4 + 's';
                apiEffects.appendChild(drop);
            }
            
            for (let i = 0; i < 15; i++) {
                const dust = document.createElement('div');
                dust.className = 'floating-dust-api';
                dust.style.left = Math.random() * 100 + '%';
                dust.style.top = Math.random() * 100 + '%';
                dust.style.animationDelay = Math.random() * 10 + 's';
                dust.style.animationDuration = (8 + Math.random() * 6) + 's';
                apiEffects.appendChild(dust);
            }

            document.querySelectorAll('.api-card').forEach(card => {
                const effectsLayer = card.querySelector('.api-card-effects');
                
                const gearSizes = [40, 30, 25];
                gearSizes.forEach((size, i) => {
                    const gear = document.createElement('div');
                    gear.className = 'gear' + (i % 2 === 1 ? ' gear-reverse' : '');
                    gear.style.width = size + 'px';
                    gear.style.height = size + 'px';
                    gear.style.setProperty('--gear-size', size + 'px');
                    gear.style.right = (5 + i * 20) + 'px';
                    gear.style.bottom = (10 + i * 15) + 'px';
                    gear.style.animationDuration = (15 + i * 5) + 's';
                    effectsLayer.appendChild(gear);
                });

                for (let i = 0; i < 5; i++) {
                    const spark = document.createElement('div');
                    spark.className = 'api-spark';
                    spark.style.right = (20 + Math.random() * 60) + 'px';
                    spark.style.bottom = (20 + Math.random() * 40) + 'px';
                    spark.style.animationDelay = Math.random() * 1.5 + 's';
                    spark.style.animationDuration = (1 + Math.random() * 1) + 's';
                    effectsLayer.appendChild(spark);
                }

                for (let i = 0; i < 3; i++) {
                    const trail = document.createElement('div');
                    trail.className = 'api-spark-trail';
                    trail.style.right = (30 + Math.random() * 50) + 'px';
                    trail.style.bottom = (30 + Math.random() * 30) + 'px';
                    trail.style.animationDelay = Math.random() * 2 + 's';
                    effectsLayer.appendChild(trail);
                }
            });
        }

        let recognition = null;
        let isListening = false;

        function initVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('voiceIcon').textContent = 'ğŸ”´';
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceIcon').textContent = 'ğŸ¤';
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        document.getElementById('chatInput').value = finalTranscript;
                        sendMessage();
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceIcon').textContent = 'ğŸ¤';
                };
            }
        }

        function toggleVoice() {
            if (!recognition) {
                initVoice();
            }
            if (!recognition) {
                alert('Voice input is not supported in this browser. Try Chrome or Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch('/progress');
                const data = await response.json();
                document.getElementById('lessons-completed').textContent = data.total_lessons_completed || 0;
                document.getElementById('checkpoints-passed').textContent = data.total_checkpoints_passed || 0;
                
                if (data.lessons && data.lessons.length > 0) {
                    addMessage('system', `You have ${data.lessons.length} lessons in progress. Keep learning!`);
                }
            } catch (err) {
                console.log('Could not load progress:', err);
            }
        }

        async function loadLessons() {
            try {
                const response = await fetch('/lego-lessons');
                const data = await response.json();
                const lessonsList = document.getElementById('lessons-list');
                lessonsList.innerHTML = '';
                
                data.lessons.forEach(lesson => {
                    const item = document.createElement('div');
                    item.className = 'lesson-item';
                    item.innerHTML = `
                        <span>${lesson.title}</span>
                        <span class="item-status">${lesson.persona}</span>
                    `;
                    item.onclick = () => openLesson(lesson.id);
                    lessonsList.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load lessons:', err);
            }
        }

        let currentLessonData = null;
        let currentLessonStep = 0;

        async function openLesson(lessonId) {
            try {
                const response = await fetch(`/lego-lessons/${lessonId}`);
                currentLessonData = await response.json();
                currentLessonStep = 0;
                showLessonStep();
                document.getElementById('lessonModal').classList.add('active');
            } catch (err) {
                console.log('Could not open lesson:', err);
            }
        }

        function showLessonStep() {
            if (!currentLessonData) return;
            
            // Reset adaptive learning state for new step
            originalLessonContent = '';
            currentLessonMode = 'default';
            if (typeof resetStreakItems === 'function') resetStreakItems();
            
            const step = currentLessonData.steps[currentLessonStep];
            document.getElementById('lessonTitle').textContent = currentLessonData.title;
            
            const content = document.getElementById('lessonContent');
            content.innerHTML = `
                <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Step ${step.step} of ${currentLessonData.steps.length}
                </div>
                <h4 style="color: var(--accent-primary); margin-bottom: 0.5rem;">${step.title}</h4>
                <p style="margin-bottom: 1rem;">${step.instruction}</p>
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>Visual:</strong> ${step.visual}
                </div>
                <div style="background: rgba(0, 212, 170, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                    <strong>Checkpoint:</strong> ${step.checkpoint}
                </div>
            `;
            
            const nextBtn = document.getElementById('lessonNextBtn');
            if (currentLessonStep >= currentLessonData.steps.length - 1) {
                nextBtn.textContent = 'Complete Lesson';
            } else {
                nextBtn.textContent = 'Next Step';
            }
        }

        function nextLessonStep() {
            if (!currentLessonData) return;
            
            if (currentLessonStep >= currentLessonData.steps.length - 1) {
                closeModal('lessonModal');
                addMessage('system', `Congratulations! You completed "${currentLessonData.title}". Your mastery grows.`);
                currentLessonData = null;
                currentLessonStep = 0;
            } else {
                currentLessonStep++;
                showLessonStep();
            }
        }

        // ===== TOO SLOW / I'M BORED =====
        let currentLessonMode = 'default';
        let originalLessonContent = '';
        
        function toggleBoredMenu() {
            const dropdown = document.getElementById('boredDropdown');
            dropdown.classList.toggle('show');
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bored-btn-container')) {
                const dropdown = document.getElementById('boredDropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });
        
        function storeOriginalLessonContent() {
            const lessonText = document.getElementById('lessonText');
            if (lessonText && !originalLessonContent) {
                originalLessonContent = lessonText.innerText;
            }
        }
        
        function restoreOriginalLesson() {
            const lessonText = document.getElementById('lessonText');
            if (lessonText && originalLessonContent) {
                lessonText.innerHTML = `<p>${originalLessonContent}</p>`;
                currentLessonMode = 'default';
            }
        }
        
        async function switchLessonMode(mode) {
            currentLessonMode = mode;
            document.getElementById('boredDropdown').classList.remove('show');
            
            const lessonText = document.getElementById('lessonText');
            storeOriginalLessonContent();
            
            const modeLabels = {
                'shorter': 'Switching to condensed version...',
                'examples': 'Loading more examples...',
                'visuals': 'Generating visual aids...',
                'quiz': 'Switching to quiz mode...',
                'steps': 'Generating step-by-step breakdown...'
            };
            
            const contentToAdapt = originalLessonContent || lessonText.innerText;
            lessonText.innerHTML = `<p style="color: var(--accent-primary); text-align: center;">${modeLabels[mode]}</p>`;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Restructure this lesson content for "${mode}" mode. ${mode === 'shorter' ? 'Make it 50% shorter, bullet points only.' : ''} ${mode === 'examples' ? 'Add 3 practical examples.' : ''} ${mode === 'visuals' ? 'Describe visual diagrams and add ASCII art where helpful.' : ''} ${mode === 'quiz' ? 'Convert to 5 quiz questions with answers.' : ''} ${mode === 'steps' ? 'Break down into numbered steps only, no explanations.' : ''} Original content: ${contentToAdapt.substring(0, 2000)}`,
                        persona: 'minerva',
                        mode: 'lesson_adapt'
                    })
                });
                const data = await response.json();
                lessonText.innerHTML = `<div style="margin-bottom: 0.5rem;"><button onclick="restoreOriginalLesson()" style="background: rgba(42,138,138,0.2); border: 1px solid #2a8a8a; color: #2a8a8a; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">â†© Back to original</button></div>${data.response.replace(/\n/g, '<br>')}`;
            } catch (err) {
                lessonText.innerHTML = `<p>${contentToAdapt}</p>`;
                console.log('Could not adapt lesson:', err);
            }
        }

        // ===== STREAK OF PROOF =====
        let streakItems = { notes: null, flashcards: null, summary: null, checklist: null };
        
        async function generateStreakItem(type) {
            const item = document.getElementById(`streak${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const output = document.getElementById('streakOutput');
            
            if (streakItems[type]) {
                output.style.display = 'block';
                output.innerHTML = streakItems[type];
                return;
            }
            
            item.style.opacity = '0.5';
            const lessonContent = document.getElementById('lessonText')?.innerText || '';
            const chapterTitle = document.getElementById('chapterTitle')?.innerText || 'Current Lesson';
            
            const prompts = {
                notes: `Create 5 concise mini-notes from this lesson. Format: bullet points, max 15 words each. Topic: ${chapterTitle}. Content: ${lessonContent.substring(0, 1500)}`,
                flashcards: `Generate 4 flashcards (Q&A format) from this lesson. Topic: ${chapterTitle}. Content: ${lessonContent.substring(0, 1500)}`,
                summary: `Write exactly 10 lines summarizing this lesson. Topic: ${chapterTitle}. Content: ${lessonContent.substring(0, 1500)}`,
                checklist: `Create a "What I can do now" checklist of 5 skills/abilities learned from this lesson. Format: checkboxes. Topic: ${chapterTitle}. Content: ${lessonContent.substring(0, 1500)}`
            };
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompts[type],
                        persona: 'hermes',
                        mode: 'streak_proof'
                    })
                });
                const data = await response.json();
                const formattedContent = `<div style="background: rgba(20,20,30,0.8); padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">${data.response.replace(/\n/g, '<br>')}</div>`;
                
                streakItems[type] = formattedContent;
                item.classList.add('generated');
                item.style.opacity = '1';
                output.style.display = 'block';
                output.innerHTML = formattedContent;
            } catch (err) {
                item.style.opacity = '1';
                console.log('Could not generate streak item:', err);
            }
        }
        
        function resetStreakItems() {
            streakItems = { notes: null, flashcards: null, summary: null, checklist: null };
            ['streakNotes', 'streakFlashcards', 'streakSummary', 'streakChecklist'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('generated');
            });
            const output = document.getElementById('streakOutput');
            if (output) {
                output.style.display = 'none';
                output.innerHTML = '';
            }
        }

        // ===== HERMES AUDITOR PIPELINE =====
        function generateAuditorBadge(confidence, citations = [], isVerified = false) {
            const confidenceLevel = confidence >= 80 ? 'high' : confidence >= 50 ? 'medium' : 'low';
            const citationText = citations.length > 0 ? `${citations.length} source${citations.length > 1 ? 's' : ''}` : 'No citations';
            
            let verifySection;
            if (confidence < 50) {
                verifySection = `<button class="verify-btn" onclick="triggerHermesVerify()">ğŸ” Verify</button>`;
            } else if (isVerified) {
                const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                verifySection = `<span class="auditor-verified">âœ“ Verified ${today}</span>`;
            } else {
                verifySection = `<span style="color: var(--text-muted); font-size: 0.7rem;">Not verified</span>`;
            }
            
            return `
                <div class="auditor-badge">
                    <div class="auditor-confidence">
                        <span style="color: var(--text-muted);">Confidence:</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill ${confidenceLevel}" style="width: ${confidence}%;"></div>
                        </div>
                        <span style="color: var(--text-secondary); font-size: 0.7rem;">${confidence}%</span>
                    </div>
                    <span class="auditor-citations">ğŸ“š ${citationText}</span>
                    ${verifySection}
                </div>
            `;
        }
        
        async function triggerHermesVerify() {
            const lastMessage = document.querySelector('.message-bubble:last-child');
            if (!lastMessage) return;
            
            const content = lastMessage.innerText.substring(0, 1000);
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `VERIFY MODE: Fact-check this statement and provide sources. If uncertain, explain why. Statement: "${content}"`,
                        persona: 'hermes',
                        mode: 'verify'
                    })
                });
                const data = await response.json();
                
                const verifyPanel = document.createElement('div');
                verifyPanel.className = 'auditor-verify-result';
                verifyPanel.style.cssText = 'background: rgba(232,228,224,0.05); border: 1px solid rgba(232,228,224,0.2); border-radius: 8px; padding: 1rem; margin-top: 0.5rem; font-size: 0.85rem;';
                verifyPanel.innerHTML = `
                    <div style="color: #e8e4e0; font-weight: 600; margin-bottom: 0.5rem;">ğŸ”¬ Hermes Verification</div>
                    <div style="color: var(--text-secondary); line-height: 1.5;">${data.response.replace(/\n/g, '<br>')}</div>
                `;
                lastMessage.appendChild(verifyPanel);
            } catch (err) {
                console.log('Verification failed:', err);
            }
        }
        
        function calculateConfidence(response) {
            let confidence = 70;
            const uncertainWords = ['might', 'maybe', 'perhaps', 'possibly', 'uncertain', 'not sure', 'could be'];
            const certainWords = ['definitely', 'certainly', 'proven', 'established', 'documented', 'research shows'];
            
            uncertainWords.forEach(word => {
                if (response.toLowerCase().includes(word)) confidence -= 8;
            });
            certainWords.forEach(word => {
                if (response.toLowerCase().includes(word)) confidence += 5;
            });
            
            return Math.max(20, Math.min(95, confidence));
        }

        async function loadProjects() {
            try {
                const response = await fetch('/projects');
                const data = await response.json();
                const projectsList = document.getElementById('projects-list');
                projectsList.innerHTML = '';
                
                data.projects.forEach(project => {
                    const item = document.createElement('div');
                    item.className = 'project-item';
                    const statusClass = project.status === 'completed' ? 'status-completed' : 
                                       project.status === 'in_progress' ? 'status-progress' : 'status-pending';
                    item.innerHTML = `
                        <span>${project.name}</span>
                        <span class="item-status ${statusClass}">${project.steps_completed}/${project.steps_count} steps</span>
                    `;
                    projectsList.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load projects:', err);
            }
        }

        async function loadKnowledgePacks() {
            try {
                const response = await fetch('/knowledge-packs');
                const data = await response.json();
                const packsList = document.getElementById('knowledge-list');
                packsList.innerHTML = '';
                
                data.packs.forEach(pack => {
                    const item = document.createElement('div');
                    item.className = 'knowledge-item';
                    item.innerHTML = `
                        <span>${pack.name}</span>
                        <span class="item-status">${pack.category}</span>
                    `;
                    packsList.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load knowledge packs:', err);
            }
        }

        function showNewProjectForm() {
            document.getElementById('projectModal').classList.add('active');
        }

        function showKnowledgeUpload() {
            document.getElementById('knowledgeModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createProject() {
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDesc').value;
            const category = document.getElementById('projectCategory').value;
            const goal = document.getElementById('projectGoal').value;
            const personas = document.getElementById('projectPersonas').value;

            if (!name) {
                alert('Please enter a project name');
                return;
            }

            try {
                const response = await fetch('/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, description, category, goal,
                        assigned_personas: personas
                    })
                });
                const data = await response.json();
                if (data.success) {
                    closeModal('projectModal');
                    loadProjects();
                    addMessage('system', `Project "${name}" created! The personas are ready to help you build it.`);
                }
            } catch (err) {
                console.log('Could not create project:', err);
            }
        }

        async function uploadKnowledge() {
            const name = document.getElementById('packName').value;
            const category = document.getElementById('packCategory').value;
            const scope = document.getElementById('packScope').value;
            const content = document.getElementById('packContent').value;
            const file = document.getElementById('packFile').files[0];

            if (!name) {
                alert('Please enter a pack name');
                return;
            }

            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('name', name);
                formData.append('category', category);
                formData.append('persona_scope', scope);

                try {
                    const response = await fetch('/knowledge-packs/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        closeModal('knowledgeModal');
                        loadKnowledgePacks();
                        addMessage('system', `Knowledge pack "${name}" uploaded! The personas can now access this knowledge.`);
                    }
                } catch (err) {
                    console.log('Could not upload knowledge pack:', err);
                }
            } else if (content) {
                try {
                    const response = await fetch('/knowledge-packs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name, category, content,
                            persona_scope: scope,
                            source_type: 'text'
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        closeModal('knowledgeModal');
                        loadKnowledgePacks();
                        addMessage('system', `Knowledge pack "${name}" created! The personas can now access this knowledge.`);
                    }
                } catch (err) {
                    console.log('Could not create knowledge pack:', err);
                }
            } else {
                alert('Please enter content or upload a file');
            }
        }

        initVoice();
        loadProgress();
        loadLessons();
        loadProjects();
        loadKnowledgePacks();
        loadStreak();
        loadIdeas();
        loadConversations();
        checkMorningBriefing();

        // ==================== IDEA CAPTURE & PROJECT PIPELINE ====================
        let localProjects = JSON.parse(localStorage.getItem('atlasProjects') || '[]');
        let currentProjectFilter = 'all';
        window.currentForgeProject = null;
        window.currentBuildProject = null;

        async function captureIdea() {
            const input = document.getElementById('quick-idea');
            const content = input.value.trim();
            if (!content) return;
            
            // Save to local project pipeline
            const project = {
                id: Date.now(),
                title: content,
                description: '',
                status: 'idea',
                created: new Date().toISOString(),
                updated: new Date().toISOString(),
                blueprintData: null,
                buildSteps: [],
                currentStep: 0
            };
            localProjects.push(project);
            saveLocalProjects();
            updatePipelineCounts();
            
            // Also save to server
            try {
                const response = await fetch('/ideas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();
                if (data.id) {
                    input.value = '';
                    loadIdeas();
                    addMessage('system', 'Idea captured! Send to Design Forge when ready to create a blueprint.');
                }
            } catch (err) {
                input.value = '';
                renderIdeasList();
                addMessage('system', 'Idea saved locally. Send to Design Forge when ready.');
            }
        }

        function saveLocalProjects() {
            localStorage.setItem('atlasProjects', JSON.stringify(localProjects));
        }

        function updatePipelineCounts() {
            const counts = { idea: 0, blueprint: 0, building: 0, complete: 0 };
            localProjects.forEach(p => counts[p.status]++);
            
            const ideaCount = document.getElementById('idea-count');
            const blueprintCount = document.getElementById('blueprint-count');
            const buildingCount = document.getElementById('building-count');
            const completeCount = document.getElementById('complete-count');
            
            if (ideaCount) ideaCount.textContent = counts.idea;
            if (blueprintCount) blueprintCount.textContent = counts.blueprint;
            if (buildingCount) buildingCount.textContent = counts.building;
            if (completeCount) completeCount.textContent = counts.complete;
        }

        function showAllIdeas() {
            document.getElementById('projectsModal').classList.add('active');
            renderProjectsList('all');
        }

        function closeProjectsModal() {
            document.getElementById('projectsModal').classList.remove('active');
        }

        function filterProjects(status) {
            currentProjectFilter = status;
            document.querySelectorAll('.projects-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderProjectsList(status);
        }

        function renderProjectsList(filter) {
            const list = document.getElementById('projectsList');
            const filtered = filter === 'all' ? localProjects : localProjects.filter(p => p.status === filter);
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:2rem;">No projects in this stage</p>';
                return;
            }

            list.innerHTML = filtered.map(project => `
                <div class="project-card">
                    <div class="project-card-header">
                        <div class="project-card-title">${project.title}</div>
                        <span class="project-status-badge ${project.status}">${getStatusLabel(project.status)}</span>
                    </div>
                    <div class="project-card-desc">${project.description || 'No description'}</div>
                    <div class="project-card-actions">
                        ${getProjectActions(project)}
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            return { idea: 'ğŸ’¡ Idea', blueprint: 'ğŸ“ Blueprint', building: 'ğŸ”¨ Building', complete: 'âœ… Complete' }[status] || status;
        }

        function getProjectActions(project) {
            switch(project.status) {
                case 'idea':
                    return `
                        <button class="project-action primary" onclick="sendToForge(${project.id})">ğŸ“ Create Blueprint</button>
                        <button class="project-action" onclick="deleteProject(${project.id})">ğŸ—‘ï¸</button>
                    `;
                case 'blueprint':
                    return `
                        <button class="project-action primary" onclick="startBuilding(${project.id})">ğŸ”¨ Start Building</button>
                        <button class="project-action" onclick="viewBlueprint(${project.id})">ğŸ‘ï¸ View</button>
                    `;
                case 'building':
                    return `
                        <button class="project-action primary" onclick="continueBuilding(${project.id})">â–¶ï¸ Continue</button>
                        <button class="project-action" onclick="markComplete(${project.id})">âœ… Complete</button>
                    `;
                case 'complete':
                    return `
                        <button class="project-action" onclick="reopenProject(${project.id})">ğŸ”„ Reopen</button>
                    `;
                default:
                    return '';
            }
        }

        function sendToForge(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project) return;
            
            closeProjectsModal();
            showSection('design-forge');
            
            document.getElementById('designPrompt').value = project.title;
            window.currentForgeProject = projectId;
            
            addMessage('system', `Loaded "${project.title}" into Design Forge. Generate a design, then it will be saved as a blueprint.`);
        }

        async function startBuilding(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project) return;
            
            closeProjectsModal();
            addMessage('system', `Starting build for: ${project.title}`);
            addMessage('system', 'Generating LEGO-style step-by-step guide with AI...');
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        message: `Create a LEGO-style step-by-step build guide for: "${project.title}". Break it into 5-8 clear steps. Number each step. Include checkpoints. Be practical and specific.`,
                        mode: 'lesson_gen'
                    })
                });
                const data = await response.json();
                
                if (data.response) {
                    const steps = data.response.split(/\d+[\.\)]\s+/).filter(s => s.trim());
                    project.buildSteps = steps.map((step, i) => ({
                        number: i + 1,
                        text: step.trim().substring(0, 200),
                        completed: false
                    }));
                    project.status = 'building';
                    project.currentStep = 0;
                    project.updated = new Date().toISOString();
                    saveLocalProjects();
                    updatePipelineCounts();
                    renderIdeasList();
                    
                    window.currentBuildProject = projectId;
                    addMessage(currentPersona, `Build guide ready! ${project.buildSteps.length} steps.\n\n**Step 1:** ${project.buildSteps[0]?.text || 'Begin!'}\n\nSay "next" when done with this step.`);
                }
            } catch (err) {
                addMessage('system', 'Could not generate guide. Moving to building anyway.');
                project.status = 'building';
                saveLocalProjects();
                updatePipelineCounts();
            }
        }

        function continueBuilding(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project) return;
            
            closeProjectsModal();
            window.currentBuildProject = projectId;
            
            const step = project.buildSteps[project.currentStep];
            const done = project.buildSteps.filter(s => s.completed).length;
            
            addMessage('system', `Continuing: ${project.title} (${done}/${project.buildSteps.length} steps)`);
            if (step) {
                addMessage(currentPersona, `**Step ${project.currentStep + 1}:** ${step.text}\n\nSay "next" when ready.`);
            } else {
                addMessage(currentPersona, 'All steps complete! Ready to mark as done?');
            }
        }

        function markComplete(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project) return;
            
            project.status = 'complete';
            project.updated = new Date().toISOString();
            saveLocalProjects();
            updatePipelineCounts();
            renderIdeasList();
            renderProjectsList(currentProjectFilter);
            
            addMessage('system', `ğŸ‰ "${project.title}" complete! Great work!`);
        }

        function deleteProject(projectId) {
            if (!confirm('Delete this project?')) return;
            localProjects = localProjects.filter(p => p.id !== projectId);
            saveLocalProjects();
            updatePipelineCounts();
            renderIdeasList();
            renderProjectsList(currentProjectFilter);
        }

        function reopenProject(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project) return;
            project.status = 'building';
            saveLocalProjects();
            updatePipelineCounts();
            renderProjectsList(currentProjectFilter);
        }

        function viewBlueprint(projectId) {
            const project = localProjects.find(p => p.id === projectId);
            if (!project || !project.blueprintData) return;
            
            closeProjectsModal();
            showSection('design-forge');
            displayDesign(project.blueprintData);
        }

        function saveBlueprintToProject(html) {
            if (!window.currentForgeProject) return;
            
            const project = localProjects.find(p => p.id === window.currentForgeProject);
            if (project) {
                project.blueprintData = html;
                project.status = 'blueprint';
                project.updated = new Date().toISOString();
                saveLocalProjects();
                updatePipelineCounts();
                renderIdeasList();
                addMessage('system', `Blueprint saved to: ${project.title}`);
                window.currentForgeProject = null;
            }
        }

        function renderIdeasList() {
            const list = document.getElementById('ideas-list');
            if (!list) return;
            
            const recent = localProjects.slice(-5).reverse();
            list.innerHTML = recent.map(p => `
                <div class="idea-item status-${p.status}">
                    <span class="idea-text">${p.title.substring(0, 35)}${p.title.length > 35 ? '...' : ''}</span>
                    <div class="idea-actions">
                        ${p.status === 'idea' ? `<button class="idea-action-btn" onclick="sendToForge(${p.id})">â†’ Forge</button>` : ''}
                        ${p.status === 'blueprint' ? `<button class="idea-action-btn" onclick="startBuilding(${p.id})">â†’ Build</button>` : ''}
                        ${p.status === 'building' ? `<button class="idea-action-btn" onclick="continueBuilding(${p.id})">Continue</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Check for build step progression in chat
        function checkBuildProgression(message) {
            if (!window.currentBuildProject) return;
            
            const lower = message.toLowerCase();
            if (lower.includes('next') || lower.includes('done') || lower.includes('complete')) {
                const project = localProjects.find(p => p.id === window.currentBuildProject);
                if (project && project.buildSteps.length > 0) {
                    if (project.currentStep < project.buildSteps.length) {
                        project.buildSteps[project.currentStep].completed = true;
                        project.currentStep++;
                        saveLocalProjects();
                        
                        if (project.currentStep < project.buildSteps.length) {
                            const next = project.buildSteps[project.currentStep];
                            setTimeout(() => {
                                addMessage(currentPersona, `**Step ${project.currentStep + 1}:** ${next.text}\n\nSay "next" when done.`);
                            }, 500);
                        } else {
                            setTimeout(() => {
                                addMessage(currentPersona, `ğŸ‰ All ${project.buildSteps.length} steps complete! Say "finish" to mark the project done.`);
                            }, 500);
                        }
                    }
                }
            }
            
            if (lower.includes('finish')) {
                const project = localProjects.find(p => p.id === window.currentBuildProject);
                if (project) {
                    markComplete(project.id);
                    window.currentBuildProject = null;
                }
            }
        }

        // Initialize pipeline on load
        updatePipelineCounts();
        renderIdeasList();

        async function loadIdeas() {
            try {
                const response = await fetch('/ideas?limit=5');
                const data = await response.json();
                const list = document.getElementById('ideas-list');
                if (!list) return;
                list.innerHTML = '';
                
                (data.ideas || []).forEach(idea => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 0.4rem 0; border-bottom: 1px solid var(--border-color); font-size: 0.85rem;';
                    item.innerHTML = `<span style="color: var(--text-primary);">${idea.content.substring(0, 40)}${idea.content.length > 40 ? '...' : ''}</span>
                        <span style="color: var(--text-secondary); font-size: 0.75rem; display: block;">${idea.category || 'uncategorized'}</span>`;
                    list.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load ideas:', err);
            }
        }

        document.getElementById('quick-idea')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') captureIdea();
        });

        // ==================== LEARNING STREAK ====================
        async function loadStreak() {
            try {
                const response = await fetch('/streaks');
                const data = await response.json();
                
                document.getElementById('streak-count').textContent = data.current_streak || 0;
                document.getElementById('longest-streak').textContent = data.longest_streak || 0;
                document.getElementById('total-days').textContent = data.total_active_days || 0;
            } catch (err) {
                console.log('Could not load streak:', err);
            }
        }

        async function checkIn() {
            try {
                const response = await fetch('/streaks/check-in', { method: 'POST' });
                const data = await response.json();
                
                loadStreak();
                
                if (data.celebration) {
                    addMessage('system', data.celebration);
                } else if (data.message) {
                    addMessage('system', data.message);
                } else {
                    addMessage('system', `Streak updated: ${data.current_streak} days!`);
                }
            } catch (err) {
                console.log('Could not check in:', err);
            }
        }

        // ==================== BUILD TIMER ====================
        let timerInterval = null;
        let timerSeconds = 0;
        let currentSessionId = null;

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function toggleTimer() {
            const btn = document.getElementById('timer-start');
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                btn.textContent = 'Start';
                btn.style.background = '';
                
                if (currentSessionId) {
                    try {
                        const response = await fetch(`/build-sessions/${currentSessionId}/stop`, { method: 'POST' });
                        const data = await response.json();
                        if (data.celebration) {
                            addMessage('system', data.celebration);
                        }
                    } catch (err) {
                        console.log('Could not stop session:', err);
                    }
                    currentSessionId = null;
                }
            } else {
                const projectId = document.getElementById('timer-project').value;
                
                try {
                    const response = await fetch('/build-sessions/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_id: projectId || null, session_type: 'build' })
                    });
                    const data = await response.json();
                    currentSessionId = data.session_id;
                } catch (err) {
                    console.log('Could not start session:', err);
                }
                
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                btn.textContent = 'Stop';
                btn.style.background = 'var(--accent-ajani)';
            }
        }

        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerSeconds = 0;
            currentSessionId = null;
            updateTimerDisplay();
            document.getElementById('timer-start').textContent = 'Start';
            document.getElementById('timer-start').style.background = '';
        }

        // Load projects into timer dropdown
        async function loadTimerProjects() {
            try {
                const response = await fetch('/projects');
                const data = await response.json();
                const select = document.getElementById('timer-project');
                if (!select) return;
                
                (data.projects || []).forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.log('Could not load timer projects:', err);
            }
        }
        loadTimerProjects();

        // ==================== CONVERSATION HISTORY ====================
        async function loadConversations() {
            try {
                const response = await fetch('/conversations?limit=5');
                const data = await response.json();
                const list = document.getElementById('conversations-list');
                if (!list) return;
                list.innerHTML = '';
                
                if ((data.conversations || []).length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem;">No saved conversations yet.</p>';
                    return;
                }
                
                (data.conversations || []).forEach(convo => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid var(--border-color); cursor: pointer;';
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-primary); font-size: 0.9rem;">${convo.title || 'Chat with ' + convo.persona}</span>
                            <span style="color: var(--accent-${convo.persona === 'ajani' ? 'ajani' : convo.persona === 'minerva' ? 'minerva' : 'hermes'}); font-size: 0.75rem; text-transform: uppercase;">${convo.persona}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">${convo.message_count} messages</div>
                    `;
                    item.onclick = () => loadConversation(convo.id, convo.persona);
                    list.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load conversations:', err);
            }
        }

        async function loadConversation(id, persona) {
            try {
                const response = await fetch(`/conversations/${id}`);
                const data = await response.json();
                
                switchPersona(persona.charAt(0).toUpperCase() + persona.slice(1), persona);
                
                const chatBox = document.getElementById('chatMessages');
                chatBox.innerHTML = '';
                
                (data.messages || []).forEach(msg => {
                    addMessage(msg.role === 'user' ? 'user' : msg.persona || persona, msg.content);
                });
            } catch (err) {
                console.log('Could not load conversation:', err);
            }
        }

        // ==================== MORNING BRIEFING ====================
        async function checkMorningBriefing() {
            const lastBriefing = localStorage.getItem('lastBriefingDate');
            const today = new Date().toDateString();
            
            if (lastBriefing !== today) {
                setTimeout(showMorningBriefing, 1500);
            }
        }

        async function showMorningBriefing() {
            try {
                const response = await fetch('/morning-briefing');
                const data = await response.json();
                
                document.getElementById('briefing-greeting').textContent = data.greeting || 'Hello';
                
                const content = document.getElementById('briefing-content');
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 2.5rem; color: var(--accent-secondary);">${data.streak_status?.days || 0}</div>
                        <div style="color: var(--text-secondary);">${data.streak_status?.message || 'Start your streak today!'}</div>
                    </div>
                    
                    ${data.active_projects?.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Active Projects</div>
                            ${data.active_projects.map(p => `<div style="padding: 0.3rem 0; color: var(--text-primary);">${p.name}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Today's Messages</div>
                        <div style="padding: 0.5rem; background: rgba(220, 20, 60, 0.1); border-left: 3px solid var(--accent-ajani); margin-bottom: 0.5rem;">
                            <strong style="color: var(--accent-ajani);">Ajani:</strong> ${data.persona_messages?.ajani || ''}
                        </div>
                        <div style="padding: 0.5rem; background: rgba(0, 212, 170, 0.1); border-left: 3px solid var(--accent-minerva);">
                            <strong style="color: var(--accent-minerva);">Minerva:</strong> ${data.persona_messages?.minerva || ''}
                        </div>
                    </div>
                    
                    <button class="action-btn" onclick="closeBriefing()" style="width: 100%;">Let's Begin</button>
                `;
                
                document.getElementById('briefing-modal').style.display = 'flex';
                localStorage.setItem('lastBriefingDate', new Date().toDateString());
            } catch (err) {
                console.log('Could not load briefing:', err);
            }
        }

        function closeBriefing() {
            document.getElementById('briefing-modal').style.display = 'none';
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('[Atlas] Service Worker registered:', registration.scope);
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateBanner();
                            }
                        });
                    });
                } catch (error) {
                    console.log('[Atlas] Service Worker registration failed:', error);
                }
            });
        }

        // PWA Install Prompt
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        function showInstallBanner() {
            const existingBanner = document.getElementById('installBanner');
            if (existingBanner) return;
            
            const banner = document.createElement('div');
            banner.id = 'installBanner';
            banner.innerHTML = `
                <div class="install-banner">
                    <div class="install-content">
                        <img src="/static/images/icon-192.png" alt="Atlas Core" class="install-icon">
                        <div class="install-text">
                            <strong>Install Atlas Core</strong>
                            <span>Add to your home screen for quick access</span>
                        </div>
                    </div>
                    <div class="install-actions">
                        <button class="install-btn install-yes" onclick="installApp()">Install</button>
                        <button class="install-btn install-no" onclick="dismissInstall()">Not Now</button>
                    </div>
                </div>
            `;
            document.body.appendChild(banner);
        }

        async function installApp() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('[Atlas] Install prompt outcome:', outcome);
            deferredPrompt = null;
            dismissInstall();
        }

        function dismissInstall() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.classList.add('hiding');
                setTimeout(() => banner.remove(), 300);
            }
        }

        function showUpdateBanner() {
            const banner = document.createElement('div');
            banner.id = 'updateBanner';
            banner.innerHTML = `
                <div class="update-banner">
                    <span>A new version of Atlas Core is available</span>
                    <button onclick="location.reload()">Update Now</button>
                </div>
            `;
            document.body.appendChild(banner);
        }

        // Check if running as installed PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.body.classList.add('pwa-installed');
            console.log('[Atlas] Running as installed PWA');
        }

        // Handle persona shortcuts from URL
        const urlParams = new URLSearchParams(window.location.search);
        const personaParam = urlParams.get('persona');
        if (personaParam) {
            const validPersonas = ['ajani', 'minerva', 'hermes', 'trinity'];
            if (validPersonas.includes(personaParam.toLowerCase())) {
                setTimeout(() => {
                    const tabName = personaParam === 'trinity' ? 'Trinity Counsel' : 
                                   personaParam.charAt(0).toUpperCase() + personaParam.slice(1);
                    switchPersona(tabName, personaParam.toLowerCase());
                }, 500);
            }
        }

        // ==================== PROJECT NUDGES ====================
        async function loadNudges() {
            try {
                const response = await fetch('/project-nudges');
                const data = await response.json();
                
                const list = document.getElementById('nudges-list');
                list.innerHTML = '';
                
                if (!data.nudges || data.nudges.length === 0) {
                    list.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 1rem;">No inactive projects. Keep building!</div>';
                    return;
                }
                
                data.nudges.forEach(nudge => {
                    const item = document.createElement('div');
                    item.className = `nudge-item ${nudge.urgency}`;
                    item.innerHTML = `
                        <div class="nudge-project">${nudge.project_name}</div>
                        <div class="nudge-message">${nudge.nudge_message}</div>
                        <div class="nudge-days">${nudge.days_inactive} days inactive - ${nudge.persona}</div>
                    `;
                    list.appendChild(item);
                });
            } catch (err) {
                console.log('Could not load nudges:', err);
            }
        }

        // ==================== FOCUS MODE ====================
        let currentFocusPersona = null;
        let focusConversationId = null;

        async function enterFocusMode(persona) {
            try {
                const response = await fetch(`/focus-mode/${persona}`);
                const config = await response.json();
                
                if (config.error) {
                    console.error(config.error);
                    return;
                }
                
                currentFocusPersona = persona;
                
                const overlay = document.getElementById('focus-overlay');
                overlay.className = `focus-overlay ${persona}`;
                overlay.style.display = 'flex';
                
                document.getElementById('focus-title').textContent = config.title;
                document.getElementById('focus-greeting').textContent = config.greeting;
                
                const projectsDiv = document.getElementById('focus-projects');
                if (config.active_projects && config.active_projects.length > 0) {
                    projectsDiv.innerHTML = config.active_projects.map(p => 
                        `<div class="focus-project-item">
                            <span>${p.name}</span>
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">${p.phase}</span>
                        </div>`
                    ).join('');
                } else {
                    projectsDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No active projects with this persona</div>';
                }
                
                document.getElementById('focus-messages').innerHTML = '';
                document.getElementById('focus-input').placeholder = config.focus_prompts ? config.focus_prompts[0] : 'What are we working on?';
                
                // Create a new conversation for focus mode (skip if incognito)
                if (shouldSaveData()) {
                    const convoResponse = await fetch('/conversations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ persona: persona, title: `Focus Session - ${config.title}` })
                    });
                    const convoData = await convoResponse.json();
                    focusConversationId = convoData.id;
                } else {
                    focusConversationId = 'incognito-session';
                }
                
                // Prevent body scrolling
                document.body.style.overflow = 'hidden';
                
            } catch (err) {
                console.error('Could not enter focus mode:', err);
            }
        }

        function exitFocusMode() {
            document.getElementById('focus-overlay').style.display = 'none';
            document.body.style.overflow = '';
            currentFocusPersona = null;
            focusConversationId = null;
        }

        async function sendFocusMessage() {
            const input = document.getElementById('focus-input');
            const message = input.value.trim();
            if (!message || !currentFocusPersona) return;
            
            input.value = '';
            
            const messagesDiv = document.getElementById('focus-messages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'focus-message user';
            userMsg.textContent = message;
            messagesDiv.appendChild(userMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch(`/conversations/${focusConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: message, role: 'user' })
                });
                const data = await response.json();
                
                // Add assistant message
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'focus-message assistant';
                assistantMsg.textContent = data.assistant_message?.content || data.response || 'I am here with you.';
                messagesDiv.appendChild(assistantMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (err) {
                console.error('Focus message error:', err);
            }
        }

        // ==================== PUSH NOTIFICATIONS ====================
        async function setupPushNotifications() {
            if (!('PushManager' in window)) {
                console.log('Push notifications not supported');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                // Check if already subscribed
                const existingSubscription = await registration.pushManager.getSubscription();
                if (existingSubscription) {
                    console.log('Already subscribed to push notifications');
                    return;
                }
                
                // Get VAPID key
                const keyResponse = await fetch('/push/vapid-key');
                const keyData = await keyResponse.json();
                
                if (!keyData.configured || !keyData.vapid_key) {
                    console.log('Push notifications not configured (no VAPID key)');
                    return;
                }
                
                // Subscribe
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(keyData.vapid_key)
                });
                
                // Send subscription to server
                await fetch('/push/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('p256dh')))),
                            auth: btoa(String.fromCharCode(...new Uint8Array(subscription.getKey('auth'))))
                        }
                    })
                });
                
                console.log('Push notification subscription complete');
                
            } catch (err) {
                console.error('Push notification setup failed:', err);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // ==================== WIDGET CONFIG ====================
        async function loadWidgetConfig() {
            try {
                const response = await fetch('/widget/config');
                const config = await response.json();
                console.log('Widget config loaded:', config);
                return config;
            } catch (err) {
                console.error('Could not load widget config:', err);
                return null;
            }
        }

        // Horizontal Scroll Carousel for Fields of Study
        let currentFieldIndex = 0;
        const totalFields = 22;
        const cardWidth = 280 + 24; // card width + gap

        function initFieldsCarousel() {
            updateCarouselIndicator();
        }

        function rotateFieldsCarousel(direction) {
            const carousel = document.getElementById('fieldsCarousel');
            if (!carousel) return;
            
            currentFieldIndex = Math.max(0, Math.min(totalFields - 1, currentFieldIndex + direction));
            carousel.scrollTo({
                left: currentFieldIndex * cardWidth,
                behavior: 'smooth'
            });
            updateCarouselIndicator();
        }

        function updateCarouselIndicator() {
            const indicator = document.getElementById('carouselIndicator');
            if (indicator) {
                indicator.textContent = `${currentFieldIndex + 1} / ${totalFields}`;
            }
        }

        // Update indicator on scroll
        function setupCarouselScrollListener() {
            const carousel = document.getElementById('fieldsCarousel');
            if (!carousel) return;
            
            carousel.addEventListener('scroll', () => {
                const newIndex = Math.round(carousel.scrollLeft / cardWidth);
                if (newIndex !== currentFieldIndex) {
                    currentFieldIndex = newIndex;
                    updateCarouselIndicator();
                }
            });
        }

        // Water ripple effect for all clickable cards
        function createRipple(event) {
            const element = event.currentTarget;
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            
            element.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 800);
        }

        // Add ripple effect to all cards and clickable elements
        function initRippleEffects() {
            const rippleElements = document.querySelectorAll('.card, .ripple-container, .field-card, .branch-item, .nav-tab, .action-btn');
            rippleElements.forEach(el => {
                el.addEventListener('click', createRipple);
            });
        }

        // Load nudges on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadNudges();
            // Try to set up push notifications if supported
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                setupPushNotifications();
            }
            // Load saved theme
            loadSavedTheme();
            // Initialize ripple effects
            initRippleEffects();
            // Initialize fields carousel
            initFieldsCarousel();
            setupCarouselScrollListener();
        });

        // Theme Switcher Functions
        function toggleThemePanel() {
            const panel = document.getElementById('themePanel');
            const toggleBtn = document.getElementById('themeToggleBtn');
            const isOpen = panel.classList.toggle('active');
            toggleBtn.setAttribute('aria-expanded', isOpen);
            
            if (isOpen) {
                // Focus first option when opened
                const firstOption = panel.querySelector('.theme-option');
                if (firstOption) firstOption.focus();
            }
        }

        function closeThemePanel() {
            const panel = document.getElementById('themePanel');
            const toggleBtn = document.getElementById('themeToggleBtn');
            panel.classList.remove('active');
            toggleBtn.setAttribute('aria-expanded', 'false');
        }

        function setTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('atlas-theme', themeName);
            
            // Update active state and aria-pressed on buttons
            document.querySelectorAll('.theme-option').forEach(btn => {
                const isActive = btn.dataset.theme === themeName;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });
            
            // Close panel after selection
            setTimeout(() => {
                closeThemePanel();
            }, 200);
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('atlas-theme') || 'slate';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Update active state and aria-pressed on buttons
            document.querySelectorAll('.theme-option').forEach(btn => {
                const isActive = btn.dataset.theme === savedTheme;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });
        }

        // Close theme panel when clicking outside
        document.addEventListener('click', (e) => {
            const switcher = document.querySelector('.theme-switcher');
            if (switcher && !switcher.contains(e.target)) {
                closeThemePanel();
            }
        });

        // Keyboard handling for theme panel
        document.addEventListener('keydown', (e) => {
            const panel = document.getElementById('themePanel');
            if (!panel?.classList.contains('active')) return;
            
            if (e.key === 'Escape') {
                closeThemePanel();
                document.getElementById('themeToggleBtn')?.focus();
            }
        });

        // Custom Color Functions
        function toggleCustomColors() {
            const section = document.getElementById('customColorsSection');
            const isActive = section.classList.toggle('active');
            
            // Update custom button state
            const customBtn = document.querySelector('.theme-option[data-theme="custom"]');
            if (customBtn) {
                customBtn.classList.toggle('active', isActive);
                customBtn.setAttribute('aria-pressed', isActive);
            }
            
            // Clear other theme selections when opening custom
            if (isActive) {
                document.querySelectorAll('.theme-option:not([data-theme="custom"])').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                });
                loadSavedCustomColors();
            }
        }

        function loadSavedCustomColors() {
            const saved = localStorage.getItem('atlas-custom-colors');
            if (saved) {
                const colors = JSON.parse(saved);
                document.getElementById('customBg').value = colors.bg || '#0d0d12';
                document.getElementById('customPanel').value = colors.panel || '#1a1a22';
                document.getElementById('customAccent').value = colors.accent || '#64d97b';
                document.getElementById('customText').value = colors.text || '#e8e8f0';
                document.getElementById('customBorder').value = colors.border || '#3a3a4a';
            }
        }

        function applyCustomColors() {
            const colors = {
                bg: document.getElementById('customBg').value,
                panel: document.getElementById('customPanel').value,
                accent: document.getElementById('customAccent').value,
                text: document.getElementById('customText').value,
                border: document.getElementById('customBorder').value
            };
            
            // Save to localStorage
            localStorage.setItem('atlas-custom-colors', JSON.stringify(colors));
            localStorage.setItem('atlas-theme', 'custom');
            
            // Apply CSS variables directly
            document.body.setAttribute('data-theme', 'custom');
            const root = document.documentElement;
            root.style.setProperty('--bg-primary', colors.bg);
            root.style.setProperty('--bg-card', hexToRgba(colors.panel, 0.55));
            root.style.setProperty('--bg-glass', hexToRgba(colors.panel, 0.35));
            root.style.setProperty('--bg-glass-hover', hexToRgba(colors.panel, 0.5));
            root.style.setProperty('--accent-primary', colors.accent);
            root.style.setProperty('--accent-glow', hexToRgba(colors.accent, 0.3));
            root.style.setProperty('--text-primary', colors.text);
            root.style.setProperty('--text-secondary', hexToRgba(colors.text, 0.6));
            root.style.setProperty('--border-glass', hexToRgba(colors.border, 0.4));
            root.style.setProperty('--border-accent', hexToRgba(colors.accent, 0.5));
            
            // Close panel
            setTimeout(() => closeThemePanel(), 200);
        }

        function resetCustomColors() {
            document.getElementById('customBg').value = '#0d0d12';
            document.getElementById('customPanel').value = '#1a1a22';
            document.getElementById('customAccent').value = '#64d97b';
            document.getElementById('customText').value = '#e8e8f0';
            document.getElementById('customBorder').value = '#3a3a4a';
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Load custom theme on page load if it was selected
        function loadCustomThemeIfNeeded() {
            const savedTheme = localStorage.getItem('atlas-theme');
            if (savedTheme === 'custom') {
                const saved = localStorage.getItem('atlas-custom-colors');
                if (saved) {
                    const colors = JSON.parse(saved);
                    const root = document.documentElement;
                    root.style.setProperty('--bg-primary', colors.bg);
                    root.style.setProperty('--bg-card', hexToRgba(colors.panel, 0.55));
                    root.style.setProperty('--bg-glass', hexToRgba(colors.panel, 0.35));
                    root.style.setProperty('--bg-glass-hover', hexToRgba(colors.panel, 0.5));
                    root.style.setProperty('--accent-primary', colors.accent);
                    root.style.setProperty('--accent-glow', hexToRgba(colors.accent, 0.3));
                    root.style.setProperty('--text-primary', colors.text);
                    root.style.setProperty('--text-secondary', hexToRgba(colors.text, 0.6));
                    root.style.setProperty('--border-glass', hexToRgba(colors.border, 0.4));
                    root.style.setProperty('--border-accent', hexToRgba(colors.accent, 0.5));
                }
            }
        }
        
        // Call on load
        loadCustomThemeIfNeeded();

        // Collapsible Section Functions
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content?.previousElementSibling;
            
            if (content && header) {
                content.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
                
                // Save state to localStorage
                const collapsed = content.classList.contains('collapsed');
                localStorage.setItem(`atlas-section-${sectionId}`, collapsed ? 'collapsed' : 'expanded');
            }
        }

        function loadSectionStates() {
            ['learning-dashboard', 'quick-actions'].forEach(sectionId => {
                const savedState = localStorage.getItem(`atlas-section-${sectionId}`);
                const content = document.getElementById(sectionId);
                const header = content?.previousElementSibling;
                
                if (content && header) {
                    // Default to EXPANDED on first visit (no saved state)
                    if (savedState === 'collapsed') {
                        content.classList.add('collapsed');
                        header.classList.add('collapsed');
                    } else {
                        content.classList.remove('collapsed');
                        header.classList.remove('collapsed');
                    }
                }
            });
        }

        // Field of Study Data - 22 Fields
        const fieldsData = {
            'computer_science': {
                name: 'Computer Science & AI',
                icon: 'ğŸ’»',
                description: 'Programming, AI systems, algorithms, and security.',
                personas: ['hermes'],
                branches: [
                    { id: 'programming', icon: 'ğŸ', name: 'Programming (Python, App Logic)', description: 'Python fundamentals, app logic, and automation scripts.' },
                    { id: 'ai_systems', icon: 'ğŸ¤–', name: 'AI Systems & Agents', description: 'AI agents, routing, memory systems, and intelligent automation.' },
                    { id: 'data_structures', icon: 'ğŸ”€', name: 'Data Structures & Algorithms', description: 'Efficient ways to organize and process information.' },
                    { id: 'security', icon: 'ğŸ”', name: 'Security & Encryption', description: 'Cybersecurity, encryption methods, including DNA-based theory.' }
                ]
            },
            'robotics': {
                name: 'Robotics & Mechatronics',
                icon: 'ğŸ¤–',
                description: 'Actuators, sensors, bio-inspired and green robotics.',
                personas: ['ajani', 'hermes'],
                branches: [
                    { id: 'actuators', icon: 'ğŸ¦¾', name: 'Actuators & Motion Systems', description: 'Joints, motors, and movement mechanisms.' },
                    { id: 'sensors', icon: 'ğŸ“¡', name: 'Sensors & Control Loops', description: 'Feedback systems and sensor integration.' },
                    { id: 'bio_robotics', icon: 'ğŸ¦', name: 'Bio-Inspired Robotics', description: 'Robots designed based on biological principles.' },
                    { id: 'green_robotics', icon: 'ğŸŒ±', name: 'Green / Non-Lethal Robotics', description: 'Sustainable and safety-focused robotic systems.' }
                ]
            },
            'electrical': {
                name: 'Electrical & Electronics',
                icon: 'ğŸ”Œ',
                description: 'Microcontrollers, power systems, and embedded systems.',
                personas: ['ajani', 'hermes'],
                branches: [
                    { id: 'microcontrollers', icon: 'ğŸ›ï¸', name: 'Microcontrollers', description: 'Arduino, ESP32, and programmable controllers.' },
                    { id: 'power_systems', icon: 'âš¡', name: 'Power Systems', description: 'Electrical power distribution and management.' },
                    { id: 'motor_drivers', icon: 'ğŸ”§', name: 'Motor Drivers', description: 'Controlling motors and actuators.' },
                    { id: 'embedded', icon: 'ğŸ’¾', name: 'Embedded Systems', description: 'Integrated hardware-software systems.' }
                ]
            },
            'mechanical': {
                name: 'Mechanical Engineering',
                icon: 'âš™ï¸',
                description: 'Structural design, kinematics, exosuits, and manipulators.',
                personas: ['ajani'],
                branches: [
                    { id: 'structural', icon: 'ğŸ—ï¸', name: 'Structural Design', description: 'Load-bearing structures and frameworks.' },
                    { id: 'kinematics', icon: 'ğŸ”„', name: 'Kinematics & Dynamics', description: 'Motion, forces, and mechanical behavior.' },
                    { id: 'materials_load', icon: 'ğŸ§±', name: 'Materials & Load Paths', description: 'Material selection and stress distribution.' },
                    { id: 'exosuits', icon: 'ğŸ¦¿', name: 'Exosuits & Manipulators', description: 'Wearable mechanical systems and robotic arms.' }
                ]
            },
            'materials': {
                name: 'Materials Science',
                icon: 'ğŸ§±',
                description: 'Smart materials, biomimicry, and adaptive materials.',
                personas: ['ajani', 'hermes'],
                branches: [
                    { id: 'smart_materials', icon: 'âœ¨', name: 'Smart Materials', description: 'Materials that respond to stimuli.' },
                    { id: 'biomimicry_mat', icon: 'ğŸš', name: 'Biomimicry Materials', description: 'Materials inspired by nature.' },
                    { id: 'liquid_armor', icon: 'ğŸ›¡ï¸', name: 'Liquid Armor Concepts', description: 'Non-Newtonian and protective materials.' },
                    { id: 'living_materials', icon: 'ğŸŒ¿', name: 'Living / Adaptive Materials', description: 'Self-healing and growing materials.' }
                ]
            },
            'energy': {
                name: 'Energy Sciences',
                icon: 'âš¡',
                description: 'Thermodynamics, sustainable energy, and phase-change systems.',
                personas: ['ajani', 'hermes'],
                branches: [
                    { id: 'thermodynamics', icon: 'ğŸŒ¡ï¸', name: 'Thermodynamics', description: 'Heat, energy transfer, and efficiency.' },
                    { id: 'rare_energy', icon: 'ğŸ’', name: 'Rare Forms of Energy', description: 'Unconventional and emerging energy sources.' },
                    { id: 'sustainable', icon: 'â˜€ï¸', name: 'Sustainable Energy Systems', description: 'Renewable and clean energy technologies.' },
                    { id: 'phase_change', icon: 'â„ï¸', name: 'Phase-Change & Thermal Control', description: 'Heat storage and temperature management.' }
                ]
            },
            'physics': {
                name: 'Physics',
                icon: 'ğŸ”¬',
                description: 'Mechanics, electromagnetism, acoustics, and quantum concepts.',
                personas: ['hermes', 'ajani'],
                branches: [
                    { id: 'classical', icon: 'ğŸ±', name: 'Classical Mechanics', description: 'Motion, forces, and Newtonian physics.' },
                    { id: 'electromagnetism', icon: 'ğŸ§²', name: 'Electromagnetism', description: 'Electric and magnetic fields and their interactions.' },
                    { id: 'acoustics_phys', icon: 'ğŸ”Š', name: 'Acoustics & Resonance', description: 'Sound waves, vibration, and resonant systems.' },
                    { id: 'quantum_intro', icon: 'âš›ï¸', name: 'Intro Quantum Concepts', description: 'Fundamentals of quantum mechanics.' }
                ]
            },
            'biology': {
                name: 'Biology',
                icon: 'ğŸ§¬',
                description: 'Human, animal, plant, and systems biology.',
                personas: ['minerva', 'ajani'],
                branches: [
                    { id: 'human_bio', icon: 'ğŸ«€', name: 'Human Biology', description: 'Anatomy, physiology, and human systems.' },
                    { id: 'animal_bio', icon: 'ğŸ¦', name: 'Animal Biology', description: 'Animal anatomy, behavior, and adaptations.' },
                    { id: 'plant_bio', icon: 'ğŸŒ±', name: 'Plant Biology', description: 'Plant structure, growth, and photosynthesis.' },
                    { id: 'systems_bio', icon: 'ğŸ”„', name: 'Systems Biology', description: 'How biological systems integrate and function.' }
                ]
            },
            'botany': {
                name: 'Advanced Botany',
                icon: 'ğŸŒ¿',
                description: 'Medicinal plants, survival botany, and plant signaling.',
                personas: ['minerva'],
                branches: [
                    { id: 'medicinal', icon: 'ğŸ’Š', name: 'Medicinal Plants', description: 'Healing properties and applications of plants.' },
                    { id: 'survival_botany', icon: 'ğŸ•ï¸', name: 'Survival Botany', description: 'Edible and useful plants in the wild.' },
                    { id: 'ethnobotany', icon: 'ğŸŒ', name: 'Ethnobotany', description: 'Cultural uses of plants across civilizations.' },
                    { id: 'plant_signaling', icon: 'ğŸ“¡', name: 'Plant Signaling', description: 'How plants communicate and respond.' }
                ]
            },
            'chemistry': {
                name: 'Chemistry',
                icon: 'ğŸ§ª',
                description: 'Organic, biochemistry, and alchemical plant theory.',
                personas: ['hermes', 'minerva'],
                branches: [
                    { id: 'organic', icon: 'âš—ï¸', name: 'Organic & Inorganic Chemistry', description: 'Carbon-based and mineral compounds.' },
                    { id: 'biochem', icon: 'ğŸ§¬', name: 'Biochemistry', description: 'Chemistry of living organisms.' },
                    { id: 'reactions', icon: 'ğŸ’¥', name: 'Reaction Systems', description: 'Chemical reactions and transformations.' },
                    { id: 'alchemical', icon: 'ğŸŒ¿', name: 'Alchemical Plant Theory', description: 'Symbolic and practical plant chemistry.' }
                ]
            },
            'neuroscience': {
                name: 'Neuroscience & Cognition',
                icon: 'ğŸ§ ',
                description: 'Learning systems, brainwave states, and memory.',
                personas: ['hermes', 'minerva'],
                branches: [
                    { id: 'learning_systems', icon: 'ğŸ“š', name: 'Learning Systems', description: 'How the brain acquires and retains knowledge.' },
                    { id: 'brainwaves', icon: 'ã€°ï¸', name: 'Brainwave States', description: 'Alpha, theta, gamma, and their effects.' },
                    { id: 'sound_learning', icon: 'ğŸ§', name: 'Sound-Based Learning', description: 'Using audio to enhance cognition.' },
                    { id: 'memory', icon: 'ğŸ’­', name: 'Memory & Perception', description: 'How we remember and interpret the world.' }
                ]
            },
            'medicine': {
                name: 'Medicine & Healing Arts',
                icon: 'ğŸ’Š',
                description: 'Herbal medicine, sound healing, and wellness.',
                personas: ['minerva'],
                branches: [
                    { id: 'herbal', icon: 'ğŸŒ¿', name: 'Herbal Medicine', description: 'Plant-based healing traditions.' },
                    { id: 'sound_healing', icon: 'ğŸ””', name: 'Sound Healing', description: 'Using frequencies for wellness.' },
                    { id: 'trauma', icon: 'ğŸ’”', name: 'Trauma & Emotional Regulation', description: 'Healing emotional and psychological wounds.' },
                    { id: 'preventative', icon: 'ğŸ›¡ï¸', name: 'Preventative Wellness', description: 'Proactive health maintenance.' }
                ]
            },
            'architecture': {
                name: 'Architecture',
                icon: 'ğŸ›ï¸',
                description: 'African, indigenous, Japanese, and bio-architecture.',
                personas: ['minerva', 'ajani'],
                branches: [
                    { id: 'african_arch', icon: 'ğŸ°', name: 'African Architecture', description: 'Traditional and historical African building.' },
                    { id: 'indigenous', icon: 'ğŸ›–', name: 'Indigenous Housing Systems', description: 'Native building techniques worldwide.' },
                    { id: 'japanese', icon: 'â›©ï¸', name: 'Japanese Architecture (1800s)', description: 'Traditional Japanese design principles.' },
                    { id: 'bio_arch', icon: 'ğŸŒ±', name: 'Bio-Architecture', description: 'Living buildings and organic design.' },
                    { id: 'sacred_cities', icon: 'ğŸŒ†', name: 'Sacred Cities', description: 'Spiritual and symbolic urban planning.' }
                ]
            },
            'acoustics': {
                name: 'Acoustics & Sound Engineering',
                icon: 'ğŸ”Š',
                description: 'Temple acoustics, resonance, and sonic learning.',
                personas: ['hermes'],
                branches: [
                    { id: 'temple_acoustics', icon: 'ğŸ›ï¸', name: 'Temple Acoustics', description: 'Sound design in sacred spaces.' },
                    { id: 'resonance', icon: 'ğŸ“»', name: 'Resonance Chambers', description: 'Spaces designed for specific frequencies.' },
                    { id: 'sonic_modules', icon: 'ğŸµ', name: 'Sonic Learning Modules', description: 'Audio-based educational systems.' },
                    { id: 'vibrational', icon: 'ã€°ï¸', name: 'Vibrational Design', description: 'Designing with vibration in mind.' }
                ]
            },
            'environmental': {
                name: 'Environmental Science',
                icon: 'ğŸŒ',
                description: 'Climate, permaculture, and ecosystem restoration.',
                personas: ['minerva', 'ajani'],
                branches: [
                    { id: 'climate', icon: 'ğŸŒ¡ï¸', name: 'Climate Systems', description: 'Understanding weather and climate patterns.' },
                    { id: 'permaculture', icon: 'ğŸŒ»', name: 'Permaculture Design', description: 'Sustainable agricultural systems.' },
                    { id: 'restoration', icon: 'ğŸŒ²', name: 'Ecosystem Restoration', description: 'Healing damaged environments.' },
                    { id: 'sustainable_robotics', icon: 'ğŸ¤–', name: 'Sustainable Robotics', description: 'Eco-friendly robotic applications.' }
                ]
            },
            'mathematics': {
                name: 'Mathematics',
                icon: 'ğŸ“',
                description: 'Algebra to calculus, sacred geometry, and modeling.',
                personas: ['hermes'],
                branches: [
                    { id: 'algebra_calc', icon: 'ğŸ”¢', name: 'Algebra to Calculus', description: 'From basic algebra through calculus.' },
                    { id: 'sacred_geo', icon: 'ğŸ”¯', name: 'Geometry & Sacred Geometry', description: 'Shapes, patterns, and their deeper meanings.' },
                    { id: 'statistics', icon: 'ğŸ“Š', name: 'Statistics', description: 'Data analysis and probability.' },
                    { id: 'modeling', icon: 'ğŸ“ˆ', name: 'Modeling Systems', description: 'Mathematical models of real-world systems.' }
                ]
            },
            'ethics': {
                name: 'Ethics & Philosophy',
                icon: 'âš–ï¸',
                description: 'AI ethics, genetic ethics, and moral reasoning.',
                personas: ['hermes', 'minerva'],
                branches: [
                    { id: 'ai_ethics', icon: 'ğŸ¤–', name: 'AI Ethics', description: 'Responsible artificial intelligence.' },
                    { id: 'genetic_ethics', icon: 'ğŸ§¬', name: 'Genetic Ethics', description: 'Ethics of genetic engineering.' },
                    { id: 'weapon_refusal', icon: 'ğŸš«', name: 'Weapon Refusal Logic', description: 'Principles of non-harm design.' },
                    { id: 'moral_reasoning', icon: 'ğŸ§ ', name: 'Moral Reasoning Systems', description: 'Frameworks for ethical decision-making.' }
                ]
            },
            'anthropology': {
                name: 'Anthropology & Cultural Studies',
                icon: 'ğŸ—¿',
                description: 'African systems, mythology, symbolism, and ancestral knowledge.',
                personas: ['minerva'],
                branches: [
                    { id: 'african_systems', icon: 'ğŸŒ', name: 'African & Indigenous Systems', description: 'Traditional knowledge systems.' },
                    { id: 'mythology', icon: 'ğŸ‰', name: 'Mythology (Global)', description: 'Stories and legends worldwide.' },
                    { id: 'symbolism', icon: 'ğŸ”£', name: 'Symbolism & Ritual', description: 'Meaning in symbols and ceremonies.' },
                    { id: 'ancestral', icon: 'ğŸ‘´', name: 'Ancestral Knowledge', description: 'Wisdom passed through generations.' }
                ]
            },
            'linguistics': {
                name: 'Linguistics & Language',
                icon: 'ğŸ“œ',
                description: 'Language evolution, glyphic systems, and sound symbolism.',
                personas: ['minerva', 'hermes'],
                branches: [
                    { id: 'evolution', icon: 'ğŸ”„', name: 'Language Evolution', description: 'How languages develop and change.' },
                    { id: 'symbolic', icon: 'ğŸ”¤', name: 'Symbolic Languages', description: 'Non-verbal and abstract communication.' },
                    { id: 'glyphic', icon: 'ğ“‚€', name: 'Glyphic Systems', description: 'Hieroglyphics and pictographic writing.' },
                    { id: 'sound_symbolism', icon: 'ğŸ”Š', name: 'Sound Symbolism', description: 'Meaning in sounds and phonemes.' }
                ]
            },
            'creative_arts': {
                name: 'Creative Arts & Design',
                icon: 'ğŸ¨',
                description: 'World-building, writing, visual design, and UI/UX.',
                personas: ['minerva'],
                branches: [
                    { id: 'worldbuilding', icon: 'ğŸ—ºï¸', name: 'World-Building', description: 'Creating fictional universes.' },
                    { id: 'writing', icon: 'âœï¸', name: 'Writing Systems', description: 'Narrative craft and storytelling.' },
                    { id: 'visual', icon: 'ğŸ–¼ï¸', name: 'Visual Design', description: 'Composition, color, and visual elements.' },
                    { id: 'uiux', icon: 'ğŸ“±', name: 'UI/UX Concepts', description: 'User interface and experience design.' }
                ]
            },
            'economics': {
                name: 'Economics & Systems Thinking',
                icon: 'ğŸ’°',
                description: 'Resource economies, cooperative models, and legacy planning.',
                personas: ['hermes', 'minerva'],
                branches: [
                    { id: 'resource', icon: 'ğŸ“¦', name: 'Resource-Based Economies', description: 'Economics based on actual resources.' },
                    { id: 'black_economics', icon: 'âœŠ', name: 'Black Economic Systems', description: 'Economic empowerment and history.' },
                    { id: 'cooperative', icon: 'ğŸ¤', name: 'Cooperative Models', description: 'Shared ownership and mutual aid.' },
                    { id: 'legacy', icon: 'ğŸ“œ', name: 'Legacy Planning', description: 'Building generational wealth and impact.' }
                ]
            },
            'speculative': {
                name: 'Speculative & Future Sciences',
                icon: 'ğŸš€',
                description: 'Transhumanism, cybernetics, and quantum biology.',
                personas: ['hermes', 'minerva'],
                branches: [
                    { id: 'transhumanism', icon: 'ğŸ¦¾', name: 'Transhumanism', description: 'Enhancement of human capabilities.' },
                    { id: 'cybernetics', icon: 'ğŸ”Œ', name: 'Cybernetics', description: 'Human-machine integration.' },
                    { id: 'quantum_bio', icon: 'âš›ï¸', name: 'Quantum Biology (Theoretical)', description: 'Quantum effects in living systems.' },
                    { id: 'spiritual_ai', icon: 'ğŸ”®', name: 'Spiritual AI Concepts', description: 'Consciousness and AI philosophy.' }
                ]
            }
        };

        // Lesson Plan State
        let currentFieldPlan = null;
        let studyTimerInterval = null;
        let studyTimerSeconds = 0;
        let studyTimerGoal = 30 * 60;
        let isStudyTimerRunning = false;
        let learningMode = 'text'; // 'text' for streaming text, 'audio' for ElevenLabs voice
        
        function setLearningMode(mode) {
            learningMode = mode;
            // Update buttons in new lesson plan modal
            document.getElementById('modeTextBtn').classList.toggle('active', mode === 'text');
            document.getElementById('modeAudioBtn').classList.toggle('active', mode === 'audio');
            document.getElementById('modeInteractiveBtn').classList.toggle('active', mode === 'interactive');
            // Update buttons in old field modal (if they exist)
            const textBtn2 = document.getElementById('modeTextBtn2');
            const audioBtn2 = document.getElementById('modeAudioBtn2');
            const interactiveBtn2 = document.getElementById('modeInteractiveBtn2');
            if (textBtn2) textBtn2.classList.toggle('active', mode === 'text');
            if (audioBtn2) audioBtn2.classList.toggle('active', mode === 'audio');
            if (interactiveBtn2) interactiveBtn2.classList.toggle('active', mode === 'interactive');
            localStorage.setItem('atlasLearningMode', mode);
        }
        
        // Load saved learning mode preference
        (function() {
            const savedMode = localStorage.getItem('atlasLearningMode');
            if (savedMode) {
                learningMode = savedMode;
            }
        })();

        // Map frontend field IDs to backend curriculum IDs
        const fieldIdMapping = {
            'computer_science': 'software_engineering',
            'electrical': 'electronics',
            'mechanical': 'robotics',
            'materials': '3d_printing',
            'energy': 'physics',
            'botany': 'biology',
            'creative_arts': 'creative_writing',
            'ethics': 'philosophy',
            'linguistics': 'history',
            'acoustics': 'music_theory',
            'medicine': 'psychology',
            'neuroscience': 'artificial_intelligence',
            'anthropology': 'visual_arts',
            'environmental': 'environmental_science',
            'speculative': 'game_design'
        };

        async function startFieldStudy(field) {
            // Map to backend curriculum ID if needed
            const backendFieldId = fieldIdMapping[field] || field;
            
            // First try the new comprehensive lesson plan API
            try {
                const response = await fetch(`/lesson-plans/${backendFieldId}`);
                const data = await response.json();
                
                if (data.field) {
                    await openLessonPlanModal(data);
                    return;
                }
            } catch (e) {
                console.log('Lesson plan API error, falling back to old system:', e);
            }
            
            // Fallback to old system
            const fieldData = fieldsData[field];
            if (!fieldData) return;
            
            document.getElementById('fieldModalTitle').textContent = fieldData.icon + ' ' + fieldData.name;
            document.getElementById('fieldModalDescription').textContent = fieldData.description;
            
            const personasDiv = document.getElementById('fieldModalPersonas');
            personasDiv.innerHTML = fieldData.personas.map(p => 
                `<span class="field-persona-tag ${p}">${p.charAt(0).toUpperCase() + p.slice(1)}</span>`
            ).join('');
            
            const branchesList = document.getElementById('fieldBranchesList');
            branchesList.innerHTML = fieldData.branches.map(branch => `
                <div class="branch-item" data-field="${field}" data-branch-id="${branch.id}" data-branch-name="${branch.name.replace(/"/g, '&quot;')}">
                    <div class="branch-header">
                        <span class="branch-icon">${branch.icon}</span>
                        <span class="branch-name">${branch.name}</span>
                    </div>
                    <p class="branch-description">${branch.description}</p>
                    <div class="branch-action">Start Learning â†’</div>
                </div>
            `).join('');
            
            branchesList.querySelectorAll('.branch-item').forEach(item => {
                item.onclick = () => {
                    const f = item.dataset.field;
                    const bId = item.dataset.branchId;
                    const bName = item.dataset.branchName;
                    startBranchLesson(f, bId, bName);
                };
            });
            
            // Initialize learning mode toggle in old modal
            const textBtn2 = document.getElementById('modeTextBtn2');
            const audioBtn2 = document.getElementById('modeAudioBtn2');
            if (textBtn2) textBtn2.classList.toggle('active', learningMode === 'text');
            if (audioBtn2) audioBtn2.classList.toggle('active', learningMode === 'audio');
            
            document.getElementById('fieldModal').classList.add('active');
        }

        async function openLessonPlanModal(planData) {
            currentFieldPlan = planData;
            const field = planData.field;
            
            // Set header info
            document.getElementById('lpIcon').textContent = field.icon || 'ğŸ“š';
            document.getElementById('lpTitle').textContent = field.name;
            document.getElementById('lpDescription').textContent = field.description;
            
            // Get user progress for this field
            let progress = { started: false };
            try {
                const progResponse = await fetch(`/lesson-plans/${field.id}/progress`);
                progress = await progResponse.json();
            } catch (e) {
                console.log('Could not fetch progress:', e);
            }
            
            // Update stats
            const totalChapters = field.subfields.reduce((sum, sf) => sum + sf.chapters.length, 0);
            document.getElementById('lpChaptersComplete').textContent = progress.chapters_completed || 0;
            document.getElementById('lpTotalChapters').textContent = totalChapters;
            document.getElementById('lpStudyTime').textContent = formatStudyTime(progress.total_study_minutes || 0);
            document.getElementById('lpAvgScore').textContent = progress.average_test_score ? `${Math.round(progress.average_test_score)}%` : '-';
            
            // Update start button
            const startBtn = document.getElementById('lpStartBtn');
            if (progress.started) {
                startBtn.textContent = 'Resume System';
            } else {
                startBtn.textContent = 'Initialize';
            }
            
            // Build subfields list
            const subfieldsList = document.getElementById('lpSubfieldsList');
            subfieldsList.innerHTML = field.subfields.map((sf, sfIndex) => {
                const completedInSubfield = progress.chapters ? 
                    progress.chapters.filter(c => c.subfield_id === sf.id && c.status === 'completed').length : 0;
                
                return `
                    <div class="subfield-item" data-subfield="${sf.id}">
                        <div class="subfield-header" onclick="toggleSubfield('${sf.id}')">
                            <span class="subfield-title">${sf.name}</span>
                            <div class="subfield-progress">
                                <span>${completedInSubfield}/${sf.chapters.length}</span>
                                ${completedInSubfield === sf.chapters.length ? '<span class="progress-badge">Complete</span>' : ''}
                            </div>
                        </div>
                        <div class="chapters-list">
                            ${sf.chapters.map((ch, chIndex) => {
                                const chProgress = progress.chapters?.find(c => c.chapter_id === ch.id);
                                const status = chProgress?.status || 'not_started';
                                const statusIcon = status === 'completed' ? 'âœ“' : status === 'in_progress' ? 'â—' : '';
                                return `
                                    <div class="chapter-item" data-field="${field.id}" data-subfield="${sf.id}" data-chapter="${ch.id}">
                                        <div class="chapter-status ${status}">${statusIcon}</div>
                                        <div class="chapter-info">
                                            <div class="chapter-title">${ch.title}</div>
                                            <div class="chapter-meta">${ch.minutes} min${chProgress?.test_passed ? ' â€¢ Test passed' : ''}</div>
                                        </div>
                                        <div class="chapter-actions">
                                            ${status === 'completed' ? 
                                                `<button class="chapter-btn" onclick="reviewChapter('${field.id}', '${sf.id}', '${ch.id}')">Debug</button>` :
                                                `<button class="chapter-btn primary" onclick="studyChapter('${field.id}', '${sf.id}', '${ch.id}')">${getChapterActionLabel(field.id)}</button>`
                                            }
                                            ${status === 'completed' || status === 'in_progress' ? 
                                                `<button class="chapter-btn" onclick="takeChapterTest('${field.id}', '${sf.id}', '${ch.id}')">Validate</button>` : ''
                                            }
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Final project section
            const projectSection = document.getElementById('lpFinalProject');
            if (field.final_project) {
                document.getElementById('lpProjectDesc').textContent = field.final_project.description;
                const reqs = document.getElementById('lpProjectRequirements');
                reqs.innerHTML = `<ul style="margin: 0.5rem 0 0; padding-left: 1.2rem; color: var(--text-secondary); font-size: 0.85rem;">
                    ${field.final_project.requirements.map(r => `<li>${r}</li>`).join('')}
                </ul>`;
                
                const projectBtn = document.getElementById('lpProjectBtn');
                if (progress.chapters_completed >= totalChapters) {
                    projectBtn.style.display = 'inline-block';
                } else {
                    projectBtn.style.display = 'none';
                }
            }
            
            // Load AI nudge
            loadAINudge(field.id, field.lead_persona);
            
            // Load today's study timer status
            try {
                const timerResponse = await fetch(`/study-timer/today?field_id=${field.id}`);
                const timerData = await timerResponse.json();
                updateTimerDisplay(timerData.goal_minutes || 30, timerData.today_minutes || 0);
            } catch (e) {
                updateTimerDisplay(progress.daily_goal_minutes || 30, 0);
            }
            
            // Apply saved learning mode
            document.getElementById('modeTextBtn').classList.toggle('active', learningMode === 'text');
            document.getElementById('modeAudioBtn').classList.toggle('active', learningMode === 'audio');
            
            // Show modal
            document.getElementById('lessonPlanModal').classList.add('active');
        }

        function toggleSubfield(subfieldId) {
            const item = document.querySelector(`.subfield-item[data-subfield="${subfieldId}"]`);
            if (item) {
                item.classList.toggle('collapsed');
            }
        }

        // Get action-oriented button labels based on field type
        function getChapterActionLabel(fieldId) {
            const actionMap = {
                'computer_science': 'Run Code',
                'robotics': 'Assemble',
                'electrical': 'Wire Up',
                'mechanical': 'Build',
                'materials': 'Synthesize',
                'energy': 'Power On',
                'physics': 'Simulate',
                'biology': 'Enter Lab',
                'botany': 'Cultivate',
                'chemistry': 'React',
                'neuroscience': 'Map Neural',
                'medicine': 'Diagnose',
                'architecture': 'Blueprint',
                'acoustics': 'Tune',
                'environmental': 'Model',
                'mathematics': 'Compute',
                'ethics': 'Analyze',
                'anthropology': 'Decode',
                'linguistics': 'Parse',
                'creative_arts': 'Design',
                'economics': 'Forecast',
                'speculative': 'Theorize'
            };
            return actionMap[fieldId] || 'Initialize';
        }

        function formatStudyTime(minutes) {
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        async function loadAINudge(fieldId, persona) {
            try {
                const response = await fetch(`/ai-scheduler/${fieldId}/nudge`);
                const data = await response.json();
                
                if (data.nudge) {
                    document.getElementById('lpNudge').style.display = 'block';
                    document.getElementById('lpNudgePersona').textContent = persona.charAt(0).toUpperCase() + persona.slice(1);
                    document.getElementById('lpNudgeText').textContent = data.nudge;
                }
            } catch (e) {
                document.getElementById('lpNudge').style.display = 'none';
            }
        }

        function updateTimerDisplay(goalMinutes, elapsedMinutes) {
            studyTimerGoal = goalMinutes * 60;
            studyTimerSeconds = elapsedMinutes * 60;
            
            const remaining = Math.max(0, studyTimerGoal - studyTimerSeconds);
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            
            document.getElementById('lpTimerTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('lpTimerStatus').textContent = `${elapsedMinutes} of ${goalMinutes} minutes today`;
            
            const progress = (studyTimerSeconds / studyTimerGoal) * 100;
            document.getElementById('lpTimerCircle').style.setProperty('--progress', `${progress}%`);
        }

        function toggleStudyTimer() {
            const btn = document.getElementById('lpTimerStartBtn');
            
            if (isStudyTimerRunning) {
                clearInterval(studyTimerInterval);
                isStudyTimerRunning = false;
                btn.textContent = 'Resume';
                
                // Log the time
                if (currentFieldPlan && shouldSaveData()) {
                    const minutesStudied = Math.floor(studyTimerSeconds / 60);
                    fetch('/study-timer/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            field_id: currentFieldPlan.field.id,
                            minutes: minutesStudied
                        })
                    });
                }
            } else {
                isStudyTimerRunning = true;
                btn.textContent = 'Pause';
                
                studyTimerInterval = setInterval(() => {
                    studyTimerSeconds++;
                    const remaining = Math.max(0, studyTimerGoal - studyTimerSeconds);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    
                    document.getElementById('lpTimerTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    
                    const progress = Math.min(100, (studyTimerSeconds / studyTimerGoal) * 100);
                    document.getElementById('lpTimerCircle').style.setProperty('--progress', `${progress}%`);
                    
                    if (studyTimerSeconds >= studyTimerGoal) {
                        clearInterval(studyTimerInterval);
                        isStudyTimerRunning = false;
                        btn.textContent = 'Done!';
                        showNotification('Daily goal reached!', 'success');
                    }
                }, 1000);
            }
        }

        function openTimerSettings() {
            const newGoal = prompt('Daily study goal (minutes):', Math.floor(studyTimerGoal / 60));
            if (newGoal && !isNaN(newGoal)) {
                updateTimerDisplay(parseInt(newGoal), Math.floor(studyTimerSeconds / 60));
            }
        }

        async function startOrResumeField() {
            if (!currentFieldPlan) return;
            
            const field = currentFieldPlan.field;
            
            // Check if already started
            const progResponse = await fetch(`/lesson-plans/${field.id}/progress`);
            const progress = await progResponse.json();
            
            if (!progress.started) {
                // Start the field
                await fetch(`/lesson-plans/${field.id}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        field_id: field.id,
                        daily_minutes: 30
                    })
                });
            }
            
            // Find first incomplete chapter and open it
            let targetChapter = null;
            for (const sf of field.subfields) {
                for (const ch of sf.chapters) {
                    const chProgress = progress.chapters?.find(c => c.chapter_id === ch.id);
                    if (!chProgress || chProgress.status !== 'completed') {
                        targetChapter = { subfield: sf, chapter: ch };
                        break;
                    }
                }
                if (targetChapter) break;
            }
            
            if (targetChapter) {
                studyChapter(field.id, targetChapter.subfield.id, targetChapter.chapter.id);
            } else {
                showNotification('All chapters completed! Work on your final project.', 'success');
            }
        }

        async function studyChapter(fieldId, subfieldId, chapterId) {
            closeModal('lessonPlanModal');
            
            // Update progress to in_progress
            await fetch('/lesson-plans/chapter/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    field_id: fieldId,
                    subfield_id: subfieldId,
                    chapter_id: chapterId,
                    status: 'in_progress'
                })
            });
            
            // Open the lesson modal with AI-generated content
            const field = currentFieldPlan?.field;
            const subfield = field?.subfields.find(sf => sf.id === subfieldId);
            const chapter = subfield?.chapters.find(ch => ch.id === chapterId);
            
            if (chapter) {
                document.getElementById('lessonViewerTitle').textContent = chapter.title;
                const lessonTextEl = document.getElementById('lessonText');
                lessonTextEl.innerHTML = '<p style="color: var(--text-secondary);">Generating lesson content...</p>';
                document.getElementById('lessonModal').classList.add('active');
                
                // Generate lesson content via AI
                const persona = field.lead_persona || 'ajani';
                selectPersona(persona);
                
                const prompt = `Teach me about "${chapter.title}" in ${subfield.name} (${field.name}). 

                    HANDS-ON LEARNING FORMAT:
                    1. Quick Context (2 sentences max - what's the real problem?)
                    2. Core Concept (explain like a mentor working alongside me)
                    3. TRY THIS NOW (give me ONE specific micro-task I can do in 5 minutes)
                    
                    Use Pro-Mode teaching: think out loud, make me decide something, correct without ego.
                    End with a practical exercise or something to build/write/sketch.
                    Keep it punchy - 2-3 short paragraphs max.`;
                
                if (learningMode === 'text') {
                    // Streaming text mode
                    lessonTextEl.innerHTML = '';
                    try {
                        const response = await fetch('/chat/stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ persona: persona, message: prompt })
                        });
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.content) {
                                            fullText += data.content;
                                            lessonTextEl.innerHTML = formatMarkdown(fullText);
                                            lessonTextEl.scrollTop = lessonTextEl.scrollHeight;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        // Fallback to non-streaming
                        const response = await fetch('/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ persona: persona, message: prompt })
                        });
                        const data = await response.json();
                        lessonTextEl.innerHTML = formatMarkdown(data.response);
                    }
                } else if (learningMode === 'interactive') {
                    // Interactive Hands-On mode with exercises
                    const exercises = getExercisesForChapter(fieldId, subfieldId, chapterId);
                    
                    lessonTextEl.innerHTML = `
                        <div class="interactive-intro" style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--accent-primary); margin-bottom: 0.5rem;">Hands-On Learning: ${chapter.title}</h4>
                            <p style="color: var(--text-secondary);">Complete these interactive exercises to master this topic through doing.</p>
                        </div>
                    `;
                    
                    const exercisesContainer = document.createElement('div');
                    exercisesContainer.className = 'exercises-container';
                    
                    exercises.forEach(exercise => {
                        renderInteractiveExercise(exercise, exercisesContainer);
                    });
                    
                    lessonTextEl.appendChild(exercisesContainer);
                    
                    // Add a quick summary section at the end
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'chapter-summary';
                    summaryDiv.innerHTML = `
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--border-glass);">
                            <h5 style="color: var(--accent-primary); margin-bottom: 0.5rem;">Need Help?</h5>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Switch to Read or Listen mode for explanations, or ask the persona for guidance.</p>
                            <button class="action-btn" onclick="setLearningMode('text'); studyChapter('${fieldId}', '${subfieldId}', '${chapterId}');">Switch to Read Mode</button>
                        </div>
                    `;
                    lessonTextEl.appendChild(summaryDiv);
                } else {
                    // Audio mode - generate text then speak it
                    try {
                        const response = await fetch('/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ persona: persona, message: prompt })
                        });
                        
                        const data = await response.json();
                        lessonTextEl.innerHTML = formatMarkdown(data.response);
                        
                        // Speak with ElevenLabs TTS
                        speakWithTTS(data.response, persona);
                    } catch (e) {
                        lessonTextEl.innerHTML = '<p>Error generating lesson. Try again.</p>';
                    }
                }
            }
        }

        function reviewChapter(fieldId, subfieldId, chapterId) {
            studyChapter(fieldId, subfieldId, chapterId);
        }

        let currentTestData = null;

        async function takeChapterTest(fieldId, subfieldId, chapterId) {
            const field = currentFieldPlan?.field;
            const subfield = field?.subfields.find(sf => sf.id === subfieldId);
            const chapter = subfield?.chapters.find(ch => ch.id === chapterId);
            
            if (!chapter) return;
            
            currentTestData = { fieldId, subfieldId, chapterId, chapter };
            
            document.getElementById('testTitle').textContent = `Test: ${chapter.title}`;
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('submitTestBtn').style.display = 'inline-block';
            
            // Generate test questions
            document.getElementById('testQuestions').innerHTML = '<p style="color: var(--text-secondary);">Generating test questions...</p>';
            document.getElementById('chapterTestModal').classList.add('active');
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: field.lead_persona || 'ajani',
                        message: `Create 3 short-answer test questions about "${chapter.title}". 
                        Just list the questions, numbered 1-3. Keep them focused and answerable in 1-2 sentences.`
                    })
                });
                
                const data = await response.json();
                const questions = data.response.split(/\d+\./).filter(q => q.trim()).slice(0, 3);
                
                document.getElementById('testQuestions').innerHTML = questions.map((q, i) => `
                    <div class="test-question">
                        <h4>Question ${i + 1}</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">${q.trim()}</p>
                        <textarea class="test-answer" id="testAnswer${i}" placeholder="Your answer..."></textarea>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('testQuestions').innerHTML = '<p>Error generating test. Try again.</p>';
            }
        }

        async function submitChapterTest() {
            if (!currentTestData) return;
            
            const answers = [];
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById(`testAnswer${i}`);
                if (el) answers.push(el.value);
            }
            
            document.getElementById('submitTestBtn').style.display = 'none';
            document.getElementById('testQuestions').innerHTML = '<p style="color: var(--text-secondary);">Evaluating your answers...</p>';
            
            try {
                const response = await fetch('/lesson-plans/chapter/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        field_id: currentTestData.fieldId,
                        subfield_id: currentTestData.subfieldId,
                        chapter_id: currentTestData.chapterId,
                        answers: answers
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('testQuestions').innerHTML = '';
                document.getElementById('testResult').style.display = 'block';
                document.getElementById('testScoreValue').textContent = `${Math.round(result.score)}%`;
                document.getElementById('testScoreValue').className = `test-score ${result.passed ? 'passed' : 'failed'}`;
                document.getElementById('testFeedback').textContent = result.feedback || (result.passed ? 'Great work! You passed!' : 'Keep studying and try again.');
                
            } catch (e) {
                document.getElementById('testQuestions').innerHTML = '<p>Error submitting test. Try again.</p>';
                document.getElementById('submitTestBtn').style.display = 'inline-block';
            }
        }

        function showNotification(message, type = 'info') {
            console.log(`[${type}] ${message}`);
        }

        // Text-to-Speech for audio learning mode
        let currentAudio = null;
        
        async function speakWithTTS(text, persona) {
            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            try {
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, persona: persona })
                });
                
                if (!response.ok) {
                    console.error('TTS error:', response.status);
                    return;
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                currentAudio = new Audio(audioUrl);
                currentAudio.play();
                
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                };
            } catch (e) {
                console.error('TTS failed:', e);
            }
        }
        
        function stopTTS() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }

        function formatMarkdown(text) {
            if (!text) return '';
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Lesson Viewer State
        let currentLesson = null;
        let currentChapter = 0;
        let lessonChapters = [];
        let isPlaying = false;

        function startBranchLesson(field, branchId, branchName) {
            const fieldData = fieldsData[field];
            if (!fieldData) return;
            
            // Close the field modal
            closeModal('fieldModal');
            
            // Select the primary persona for this field
            const primaryPersona = fieldData.personas[0];
            selectPersona(primaryPersona);
            
            // Generate lesson chapters for this branch
            generateLessonChapters(fieldData, branchId, branchName, primaryPersona);
        }

        async function generateLessonChapters(fieldData, branchId, branchName, persona) {
            // Find the branch data
            const branch = fieldData.branches.find(b => b.id === branchId);
            if (!branch) return;

            currentLesson = {
                field: fieldData.name,
                branch: branchName,
                persona: persona
            };
            currentChapter = 0;

            // Show loading state
            document.getElementById('lessonViewerTitle').textContent = `${branch.icon} ${branchName}`;
            document.getElementById('lessonText').innerHTML = '<p style="color: var(--text-secondary);">Generating lesson chapters...</p>';
            document.getElementById('lessonModal').classList.add('active');

            try {
                // Request AI to generate structured chapters
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: persona,
                        message: `Create a SHORT lesson on "${branchName}" in ${fieldData.name}. 

Format EXACTLY like this with 5 chapters. Keep each chapter to 2-3 sentences MAX:

CHAPTER 1: [Title]
[2-3 sentences only]

CHAPTER 2: [Title]
[2-3 sentences only]

CHAPTER 3: [Title]
[2-3 sentences only]

CHAPTER 4: [Title]
[2-3 sentences only]

CHAPTER 5: [Title]
[2-3 sentences with quick summary]

Be concise. No fluff. Just the key concepts.`,
                        mode: 'teach'
                    })
                });

                const data = await response.json();
                if (data.response) {
                    parseAndDisplayChapters(data.response);
                }
            } catch (err) {
                console.error('Error generating lesson:', err);
                document.getElementById('lessonText').innerHTML = '<p style="color: var(--accent-ajani);">Error generating lesson. Please try again.</p>';
            }
        }

        function parseAndDisplayChapters(text) {
            // Parse the AI response into chapters
            const chapterRegex = /CHAPTER\s*(\d+):\s*([^\n]+)\n([\s\S]*?)(?=CHAPTER\s*\d+:|$)/gi;
            lessonChapters = [];
            
            let match;
            while ((match = chapterRegex.exec(text)) !== null) {
                lessonChapters.push({
                    number: parseInt(match[1]),
                    title: match[2].trim(),
                    content: match[3].trim()
                });
            }

            // If parsing failed, create a single chapter with all content
            if (lessonChapters.length === 0) {
                lessonChapters = [{
                    number: 1,
                    title: 'Introduction',
                    content: text
                }];
            }

            // Build the chapter sidebar
            const sidebar = document.getElementById('chapterSidebar');
            sidebar.innerHTML = lessonChapters.map((ch, i) => `
                <div class="chapter-item ${i === 0 ? 'active' : ''}" onclick="goToChapter(${i})">
                    <span class="chapter-number">${ch.number}</span>
                    <span class="chapter-title">${ch.title}</span>
                </div>
            `).join('');

            // Display first chapter
            displayChapter(0);
        }

        function displayChapter(index) {
            if (index < 0 || index >= lessonChapters.length) return;
            
            currentChapter = index;
            const chapter = lessonChapters[index];

            // Update chapter title
            document.getElementById('chapterTitle').textContent = `Chapter ${chapter.number}: ${chapter.title}`;

            const lessonTextEl = document.getElementById('lessonText');

            if (learningMode === 'interactive') {
                // Show interactive exercises
                lessonTextEl.innerHTML = '<div class="interactive-intro"><p>Complete these hands-on exercises to learn by doing:</p></div>';
                
                const exercisesContainer = document.createElement('div');
                exercisesContainer.className = 'exercises-container';
                
                // Get exercises for this chapter
                const fieldId = currentFieldPlan?.field?.id || 'general';
                const subfieldId = chapter.subfieldId || 'general';
                const exercises = getExercisesForChapter(fieldId, subfieldId, chapter.id);
                
                exercises.forEach(exercise => {
                    renderInteractiveExercise(exercise, exercisesContainer);
                });
                
                lessonTextEl.appendChild(exercisesContainer);
                
                // Add brief text summary
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'chapter-summary';
                summaryDiv.innerHTML = `
                    <h5 style="color: var(--accent-primary); margin-top: 1.5rem;">Quick Reference</h5>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">${chapter.content.substring(0, 300)}...</p>
                `;
                lessonTextEl.appendChild(summaryDiv);
            } else {
                // Format content with paragraphs (text or audio mode)
                const formattedContent = chapter.content
                    .split('\n\n')
                    .filter(p => p.trim())
                    .map(p => `<p>${p.trim()}</p>`)
                    .join('');
                
                lessonTextEl.innerHTML = formattedContent;
            }

            // Update sidebar active state
            document.querySelectorAll('.chapter-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
                if (i < index) item.classList.add('completed');
            });

            // Update progress
            const progress = ((index + 1) / lessonChapters.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressLabel').textContent = `Chapter ${index + 1} of ${lessonChapters.length}`;
            
            // Auto-start audio if in audio/listen mode
            if (learningMode === 'audio') {
                setTimeout(() => playAudio(), 500);
            }

            // Update nav buttons
            document.getElementById('prevChapterBtn').disabled = index === 0;
            document.getElementById('nextChapterBtn').textContent = index === lessonChapters.length - 1 ? 'Complete' : 'Next Chapter';

            // Stop any playing audio
            stopAudio();
        }

        function goToChapter(index) {
            displayChapter(index);
        }

        function nextChapter() {
            if (currentChapter < lessonChapters.length - 1) {
                displayChapter(currentChapter + 1);
            } else {
                // Lesson complete
                closeLesson();
                showNotification('Lesson Complete!', 'success');
            }
        }

        function prevChapter() {
            if (currentChapter > 0) {
                displayChapter(currentChapter - 1);
            }
        }

        function closeLesson() {
            stopAudio();
            document.getElementById('lessonModal').classList.remove('active');
            currentLesson = null;
            lessonChapters = [];
            currentChapter = 0;
            // Reset adaptive learning state
            originalLessonContent = '';
            currentLessonMode = 'default';
            if (typeof resetStreakItems === 'function') resetStreakItems();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                background: ${type === 'success' ? 'var(--accent-secondary)' : type === 'error' ? 'var(--accent-ajani)' : 'var(--bg-card)'};
                color: ${type === 'success' || type === 'error' ? 'white' : 'var(--text-primary)'};
                border: 1px solid var(--border-color);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Text-to-Speech Audio Functions
        function toggleAudio() {
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        let audioPlayer = null;

        async function playAudio() {
            // Get current chapter text
            const chapter = lessonChapters[currentChapter];
            if (!chapter) return;

            // If already playing, pause
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                isPlaying = false;
                updateAudioUI(false);
                return;
            }

            // If paused, resume
            if (audioPlayer && audioPlayer.paused && audioPlayer.currentTime > 0) {
                audioPlayer.play();
                isPlaying = true;
                updateAudioUI(true);
                return;
            }

            // Show loading state
            updateAudioUI(true);
            document.getElementById('audioLabel').textContent = 'Loading...';

            const persona = currentLesson?.persona || 'ajani';
            const text = `Chapter ${chapter.number}: ${chapter.title}. ${chapter.content}`;

            try {
                // Call the TTS API with natural OpenAI voices
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, persona })
                });

                if (!response.ok) {
                    throw new Error('TTS request failed');
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                // Create audio player
                if (audioPlayer) {
                    audioPlayer.pause();
                    URL.revokeObjectURL(audioPlayer.src);
                }
                
                audioPlayer = new Audio(audioUrl);
                
                // Set playback speed
                const speed = parseFloat(document.getElementById('audioSpeed').value);
                audioPlayer.playbackRate = speed;

                audioPlayer.onplay = () => {
                    isPlaying = true;
                    updateAudioUI(true);
                };

                audioPlayer.onpause = () => {
                    isPlaying = false;
                    updateAudioUI(false);
                };

                audioPlayer.onended = () => {
                    isPlaying = false;
                    updateAudioUI(false);
                };

                audioPlayer.onerror = () => {
                    isPlaying = false;
                    updateAudioUI(false);
                    showNotification('Error playing audio', 'error');
                };

                await audioPlayer.play();
            } catch (err) {
                console.error('TTS error:', err);
                isPlaying = false;
                updateAudioUI(false);
                showNotification('Could not generate audio', 'error');
            }
        }

        function pauseAudio() {
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                isPlaying = false;
                updateAudioUI(false);
            }
        }

        function stopAudio() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
                updateAudioUI(false);
            }
        }

        function updateAudioSpeed() {
            if (audioPlayer) {
                const speed = parseFloat(document.getElementById('audioSpeed').value);
                audioPlayer.playbackRate = speed;
            }
        }

        function updateAudioUI(playing) {
            const btn = document.getElementById('audioPlayBtn');
            const icon = document.getElementById('audioIcon');
            const label = document.getElementById('audioLabel');
            
            if (playing) {
                btn.classList.add('playing');
                icon.textContent = 'â¸';
                label.textContent = 'Pause';
            } else {
                btn.classList.remove('playing');
                icon.textContent = 'â–¶';
                label.textContent = 'Listen';
            }
        }

        // Load section states on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSectionStates();
            initIncognitoMode();
            initVoiceCommands();
            initCalendarWidget();
            initNotifications();
        });

        // ===== CALENDAR WIDGET =====
        function initCalendarWidget() {
            updateCalendar();
            setInterval(updateCalendar, 1000);
        }

        function updateCalendar() {
            const now = new Date();
            const dateEl = document.getElementById('calendarDate');
            const timeEl = document.getElementById('calendarTime');
            
            if (dateEl) {
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
            if (timeEl) {
                timeEl.textContent = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }
        }

        // ===== PUSH NOTIFICATIONS =====
        let notificationsEnabled = false;

        function initNotifications() {
            if ('Notification' in window) {
                notificationsEnabled = Notification.permission === 'granted';
                updateNotifyUI();
            }
        }

        async function toggleNotifications() {
            if (!('Notification' in window)) {
                alert('Your browser does not support notifications');
                return;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = !notificationsEnabled;
                localStorage.setItem('atlasNotify', notificationsEnabled);
                updateNotifyUI();
                if (notificationsEnabled) {
                    showNotification('Notifications Enabled', 'You will receive AI messages on your home screen');
                }
            } else if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in your browser settings.');
            } else {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('atlasNotify', 'true');
                    updateNotifyUI();
                    showNotification('Atlas Core', 'Notifications enabled! AI messages will appear on your home screen.');
                }
            }
        }

        function updateNotifyUI() {
            const toggle = document.getElementById('notifyToggle');
            const label = document.getElementById('notifyLabel');
            if (toggle && label) {
                if (notificationsEnabled) {
                    toggle.classList.add('active');
                    label.textContent = 'On';
                } else {
                    toggle.classList.remove('active');
                    label.textContent = 'Notify';
                }
            }
        }

        function showNotification(title, body, icon = null) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;
            
            const options = {
                body: body,
                icon: icon || '/static/icons/icon-192x192.png',
                badge: '/static/icons/icon-72x72.png',
                vibrate: [100, 50, 100],
                tag: 'atlas-message',
                renotify: true
            };
            
            const notification = new Notification(title, options);
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }

        // Send notification when AI responds
        function notifyAIResponse(persona, message) {
            if (!notificationsEnabled) return;
            const personaNames = {
                ajani: 'Ajani',
                minerva: 'Minerva', 
                hermes: 'Hermes',
                counsel: 'Trinity Council'
            };
            const preview = message.length > 100 ? message.substring(0, 100) + '...' : message;
            showNotification(personaNames[persona] || 'Atlas Core', preview);
        }

        // ===== DESIGN FORGE =====
        let currentDesignCode = '';
        let savedDesigns = JSON.parse(localStorage.getItem('atlasDesigns') || '[]');
        const designCache = new Map();
        let designReferenceImage = null;
        let selectedTexture = 'none';
        let selectedColorScheme = 'dark';
        let selectedSkin = 'forge';
        let selectedShape = 'sharp';
        let selectedArtStyle = 'none';
        let hdQuality = false;
        let is3DEnabled = false;

        // Art Style Descriptions
        const artStyleDescriptions = {
            'none': { title: 'Default', desc: 'Standard design output without specialized art direction.' },
            'xenobiology': { 
                title: 'Speculative Biology / Xenobiology', 
                desc: 'Like a field guide for a creature that doesn\'t exist yet. Anatomical diagrams, species classifications, and biological systems of imaginary organisms.'
            },
            'blueprint': { 
                title: 'Futuristic Technical Blueprint', 
                desc: 'Overlays, callouts, measurements, and annotations. This isn\'t just aestheticâ€”it\'s instructional. Engineering documentation meets sci-fi concept art.'
            },
            'hardsci': { 
                title: 'Hard Sci-Fi Concept Art', 
                desc: 'Engineered, not dreamy. Think research lab, not fantasy novel. Grounded in plausible physics and materials science.'
            },
            'cybernetic': { 
                title: 'Cybernetic Naturalism', 
                desc: 'Living tissue rendered with synthetic, almost digital precision. Where organic meets mechanical at the cellular level.'
            },
            'organic-tech': { 
                title: 'Organic as Technology', 
                desc: 'Nature as engineering, not decoration. Biological forms treated as advanced technologyâ€”grown, not manufactured.'
            }
        };

        // Forge Dropdown Toggle
        function toggleForgeDropdown(id) {
            const content = document.getElementById(id + '-content');
            const arrow = document.getElementById(id + '-arrow');
            
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // Skin Selection
        function selectSkin(skin) {
            selectedSkin = skin;
            document.querySelectorAll('.skin-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.skin === skin);
            });
        }

        // Shape Selection
        function selectShape(shape) {
            selectedShape = shape;
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.shape === shape);
            });
        }

        // Art Style Selection
        function selectArtStyle(style) {
            selectedArtStyle = style;
            document.querySelectorAll('.artstyle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.artstyle === style);
            });
            
            const descPanel = document.getElementById('artstyleDescription');
            const info = artStyleDescriptions[style] || artStyleDescriptions['none'];
            
            if (style === 'none') {
                descPanel.innerHTML = '<p class="artstyle-hint">Select a style to see its description</p>';
            } else {
                descPanel.innerHTML = `
                    <p class="artstyle-title">${info.title}</p>
                    <p class="artstyle-desc">${info.desc}</p>
                `;
            }
            
            if (style !== 'none') {
                selectedSkin = 'biomimetic';
                document.querySelectorAll('.skin-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.skin === 'biomimetic');
                });
            }
        }

        // HD Quality Toggle
        function toggleHDQuality() {
            hdQuality = document.getElementById('hdQualityToggle').checked;
            const badge = document.getElementById('hdBadge');
            badge.textContent = hdQuality ? 'HD' : 'OFF';
            badge.classList.toggle('on', hdQuality);
        }

        // ==================== 3D ANATOMY LAB ====================
        let currentAnatomyCategory = 'human';
        let currentBodySystem = 'skeletal';
        let currentAnimalType = 'mammal';
        let currentAnimalView = 'external';
        let anatomyRotation = 0;
        let anatomyZoom = 1;
        let anatomyLabelsVisible = true;

        function selectAnatomyCategory(category, btn) {
            currentAnatomyCategory = category;
            document.querySelectorAll('.anatomy-tab').forEach(tab => tab.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            document.getElementById('humanSystems').style.display = category === 'human' ? 'block' : 'none';
            document.getElementById('animalSystems').style.display = category === 'animal' ? 'block' : 'none';
            
            const infoPanel = document.getElementById('anatomyInfoPanel');
            infoPanel.innerHTML = `
                <h4>Click any part to learn</h4>
                <p class="anatomy-info-desc">Select a bone, organ, or system component to get detailed AI-powered explanations about its structure and function.</p>
                <div class="anatomy-quick-facts" id="anatomyQuickFacts"></div>
            `;
            
            if (category === 'human') {
                renderHumanAnatomy(currentBodySystem);
            } else {
                renderAnimalAnatomy(currentAnimalType, currentAnimalView);
            }
        }

        function selectBodySystem(system) {
            currentBodySystem = system;
            document.querySelectorAll('#humanSystems .system-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.system === system);
            });
            renderHumanAnatomy(system);
        }

        function selectAnimalType(animal) {
            currentAnimalType = animal;
            document.querySelectorAll('#animalSystems .system-btn[data-animal]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.animal === animal);
            });
            renderAnimalAnatomy(animal, currentAnimalView);
        }

        function selectAnimalView(view) {
            currentAnimalView = view;
            document.querySelectorAll('.animal-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            renderAnimalAnatomy(currentAnimalType, view);
        }

        function rotateAnatomyModel(degrees) {
            anatomyRotation += degrees;
            const svg = document.getElementById('anatomySvg');
            svg.style.transform = `rotate(${anatomyRotation}deg) scale(${anatomyZoom})`;
        }

        function zoomAnatomyModel(factor) {
            anatomyZoom *= factor;
            anatomyZoom = Math.max(0.5, Math.min(2.5, anatomyZoom));
            const svg = document.getElementById('anatomySvg');
            svg.style.transform = `rotate(${anatomyRotation}deg) scale(${anatomyZoom})`;
        }

        function resetAnatomyView() {
            anatomyRotation = 0;
            anatomyZoom = 1;
            const svg = document.getElementById('anatomySvg');
            svg.style.transform = 'rotate(0deg) scale(1)';
        }

        function toggleAnatomyLabels() {
            anatomyLabelsVisible = !anatomyLabelsVisible;
            document.querySelectorAll('#anatomySvg text').forEach(t => {
                t.style.display = anatomyLabelsVisible ? 'block' : 'none';
            });
        }

        const ANATOMY_DATA = {
            human: {
                skeletal: {
                    skull: { name: 'Skull (Cranium)', bones: 22, function: 'Protects the brain, supports facial structure', facts: ['Contains 22 bones fused together', 'Only movable bone is the mandible (jaw)', 'Includes frontal, parietal, temporal, occipital bones'] },
                    mandible: { name: 'Mandible (Jaw)', bones: 1, function: 'Lower jaw, enables chewing and speech', facts: ['Strongest bone in the face', 'Only movable skull bone', 'Contains teeth sockets'] },
                    clavicle: { name: 'Clavicle (Collarbone)', bones: 2, function: 'Connects arm to body, protects nerves', facts: ['Most commonly fractured bone', 'S-shaped bone', 'Provides shoulder mobility'] },
                    scapula: { name: 'Scapula (Shoulder Blade)', bones: 2, function: 'Anchor for arm muscles', facts: ['Triangular flat bone', '17 muscle attachments', 'Allows arm rotation'] },
                    spine: { name: 'Vertebral Column', bones: 33, function: 'Supports body, protects spinal cord', facts: ['33 vertebrae: 7 cervical, 12 thoracic, 5 lumbar, 5 sacral, 4 coccyx', 'Contains intervertebral discs', 'Has 4 natural curves'] },
                    ribcage: { name: 'Rib Cage', bones: 24, function: 'Protects heart and lungs', facts: ['12 pairs of ribs', 'First 7 pairs are true ribs', 'Last 2 pairs are floating ribs'] },
                    sternum: { name: 'Sternum (Breastbone)', bones: 1, function: 'Connects ribs, protects heart', facts: ['Three parts: manubrium, body, xiphoid', 'CPR pressure point', 'Produces red blood cells'] },
                    pelvis: { name: 'Pelvis', bones: 3, function: 'Supports upper body, protects organs', facts: ['Made of ilium, ischium, pubis', 'Differs between males and females', 'Contains hip sockets'] },
                    humerus: { name: 'Humerus', bones: 1, function: 'Upper arm bone, shoulder to elbow', facts: ['Longest bone in the arm', 'Ball-and-socket joint at shoulder', 'Hinge joint at elbow'] },
                    femur: { name: 'Femur', bones: 1, function: 'Thigh bone, strongest in body', facts: ['Longest and strongest bone', 'Supports entire body weight', 'Head fits into hip socket'] },
                    patella: { name: 'Patella (Kneecap)', bones: 2, function: 'Protects knee joint', facts: ['Largest sesamoid bone', 'Increases leverage of quadriceps', 'Embedded in tendon'] },
                    radius: { name: 'Radius', bones: 1, function: 'Lateral forearm bone, thumb side', facts: ['Rotates around ulna', 'Forms wrist joint', 'Shorter than ulna'] },
                    ulna: { name: 'Ulna', bones: 1, function: 'Medial forearm bone, pinky side', facts: ['Forms elbow point', 'Longer than radius', 'Primary elbow bone'] },
                    tibia: { name: 'Tibia (Shinbone)', bones: 1, function: 'Weight-bearing lower leg bone', facts: ['Second longest bone', 'Bears 80% of leg weight', 'Forms ankle joint'] },
                    fibula: { name: 'Fibula', bones: 1, function: 'Lateral lower leg bone', facts: ['Non-weight bearing', 'Muscle attachment site', 'Forms lateral ankle'] },
                    carpals: { name: 'Carpal Bones (Wrist)', bones: 8, function: 'Enable wrist flexibility', facts: ['8 small bones in two rows', 'Scaphoid most commonly fractured', 'Form carpal tunnel'] },
                    metacarpals: { name: 'Metacarpals (Hand)', bones: 5, function: 'Form palm of hand', facts: ['5 bones connecting wrist to fingers', 'Numbered 1-5 from thumb', 'Support hand grip'] },
                    phalanges: { name: 'Phalanges (Fingers/Toes)', bones: 56, function: 'Enable fine motor movement', facts: ['14 per hand (3 each finger, 2 thumb)', '14 per foot', 'Allow grasping'] }
                },
                muscular: {
                    trapezius: { name: 'Trapezius', function: 'Moves scapula, supports posture', facts: ['Large diamond-shaped muscle', 'Extends from skull to mid-back', 'Common site of tension'] },
                    deltoid: { name: 'Deltoid', function: 'Raises and rotates arm', facts: ['Three parts: anterior, lateral, posterior', 'Gives shoulder rounded shape', 'Injection site for vaccines'] },
                    pectoralis: { name: 'Pectoralis Major', function: 'Arm flexion, adduction, rotation', facts: ['Largest chest muscle', 'Two heads: clavicular and sternal', 'Used in pushing movements'] },
                    latissimus: { name: 'Latissimus Dorsi', function: 'Pulls arm down and back', facts: ['Largest back muscle', 'V-shape appearance', 'Used in pulling movements'] },
                    biceps: { name: 'Biceps Brachii', function: 'Elbow flexion, forearm supination', facts: ['Two heads: long and short', 'Main arm flexor', 'Visible muscle of upper arm'] },
                    triceps: { name: 'Triceps Brachii', function: 'Elbow extension', facts: ['Three heads: long, lateral, medial', 'Back of upper arm', 'Used in pushing and pressing'] },
                    rectusAb: { name: 'Rectus Abdominis', function: 'Trunk flexion, posture', facts: ['The six-pack muscle', 'Runs from ribs to pelvis', 'Stabilizes the spine'] },
                    obliques: { name: 'External Obliques', function: 'Trunk rotation, side bending', facts: ['Located on sides of abdomen', 'Internal and external layers', 'Compress abdominal contents'] },
                    quadriceps: { name: 'Quadriceps Femoris', function: 'Knee extension, hip flexion', facts: ['Four muscles combined', 'Strongest muscle group', 'Front of thigh'] },
                    hamstrings: { name: 'Hamstrings', function: 'Knee flexion, hip extension', facts: ['Three muscles: biceps femoris, semimembranosus, semitendinosus', 'Back of thigh', 'Common sports injury site'] },
                    gluteus: { name: 'Gluteus Maximus', function: 'Hip extension, external rotation', facts: ['Largest muscle in body', 'Primary for walking upright', 'Gives shape to buttocks'] },
                    gastrocnemius: { name: 'Gastrocnemius', function: 'Plantar flexion, knee flexion', facts: ['Calf muscle', 'Two heads', 'Forms Achilles tendon'] }
                },
                organs: {
                    brain: { name: 'Brain', function: 'Central nervous control, consciousness', facts: ['~86 billion neurons', 'Uses 20% of body energy', 'Three main parts: cerebrum, cerebellum, brainstem'] },
                    heart: { name: 'Heart', function: 'Pumps blood throughout body', facts: ['Beats ~100,000 times/day', '4 chambers: 2 atria, 2 ventricles', 'Size of your fist, about 11oz'] },
                    lungs: { name: 'Lungs', function: 'Gas exchange (O2/CO2)', facts: ['Right lung: 3 lobes, left: 2 lobes', '300 million alveoli', 'Surface area of tennis court'] },
                    liver: { name: 'Liver', function: 'Detoxification, metabolism, bile production', facts: ['Largest internal organ (~3 lbs)', 'Can regenerate itself', '500+ functions'] },
                    kidneys: { name: 'Kidneys', function: 'Filter blood, produce urine', facts: ['Filter 120-150 quarts blood daily', 'Regulate blood pressure', 'Maintain electrolyte balance'] },
                    stomach: { name: 'Stomach', function: 'Digests food with acid and enzymes', facts: ['J-shaped organ', 'Holds 1-1.5 liters', 'Produces hydrochloric acid'] },
                    intestines: { name: 'Intestines', function: 'Nutrient absorption, waste processing', facts: ['Small intestine: 20 feet long', 'Large intestine: 5 feet long', 'Most nutrients absorbed in small intestine'] },
                    pancreas: { name: 'Pancreas', function: 'Produces insulin and digestive enzymes', facts: ['6 inches long', 'Endocrine and exocrine functions', 'Behind stomach'] },
                    spleen: { name: 'Spleen', function: 'Filters blood, immune function', facts: ['Size of a fist', 'Stores platelets', 'Can live without it'] }
                },
                nervous: {
                    cerebrum: { name: 'Cerebrum', function: 'Higher functions: thought, memory, sensation', facts: ['Largest part of brain', 'Two hemispheres', 'Four lobes: frontal, parietal, temporal, occipital'] },
                    cerebellum: { name: 'Cerebellum', function: 'Coordination, balance, motor learning', facts: ['Little brain', 'Contains 50% of neurons', 'Back of head'] },
                    brainstem: { name: 'Brainstem', function: 'Vital functions: breathing, heart rate', facts: ['Connects brain to spinal cord', 'Three parts: midbrain, pons, medulla', 'Controls automatic functions'] },
                    spinalcord: { name: 'Spinal Cord', function: 'Transmits signals between brain and body', facts: ['18 inches long', '31 pairs of spinal nerves', 'Protected by vertebrae'] },
                    nerves: { name: 'Peripheral Nerves', function: 'Carry signals to/from body parts', facts: ['43 pairs total', 'Motor and sensory neurons', 'Can regenerate slowly'] }
                },
                circulatory: {
                    heart: { name: 'Heart', function: 'Blood circulation pump', facts: ['4 chambers', 'Pumps 2000 gallons/day', 'Beats 2.5 billion times in lifetime'] },
                    aorta: { name: 'Aorta', function: 'Main artery from heart', facts: ['Largest artery', 'About 1 inch diameter', 'Distributes oxygenated blood'] },
                    arteries: { name: 'Arteries', function: 'Carry oxygenated blood away from heart', facts: ['Thick elastic walls', 'High pressure vessels', 'Branch into arterioles'] },
                    veins: { name: 'Veins', function: 'Return deoxygenated blood to heart', facts: ['Contain one-way valves', 'Lower pressure than arteries', 'Include jugular, femoral veins'] },
                    capillaries: { name: 'Capillaries', function: 'Exchange nutrients and waste', facts: ['Microscopic vessels', 'One cell thick', 'Connect arteries to veins'] }
                },
                respiratory: {
                    nasal: { name: 'Nasal Cavity', function: 'Filters, warms, moistens air', facts: ['Contains turbinates', 'Lined with mucus', 'Connects to sinuses'] },
                    pharynx: { name: 'Pharynx (Throat)', function: 'Passageway for air and food', facts: ['Three regions', 'Contains tonsils', 'Connects to larynx and esophagus'] },
                    larynx: { name: 'Larynx (Voice Box)', function: 'Sound production, protects airway', facts: ['Contains vocal cords', 'Adams apple is thyroid cartilage', 'Prevents food entering trachea'] },
                    trachea: { name: 'Trachea (Windpipe)', function: 'Airway to lungs', facts: ['4-5 inches long', 'C-shaped cartilage rings', 'Lined with cilia'] },
                    bronchi: { name: 'Bronchi', function: 'Air passages into lungs', facts: ['Branch from trachea', 'Right bronchus wider', 'Subdivide into bronchioles'] },
                    lungs: { name: 'Lungs', function: 'Oxygen absorption, CO2 release', facts: ['300 million alveoli', 'Right lung larger', 'Protected by pleura'] },
                    diaphragm: { name: 'Diaphragm', function: 'Primary breathing muscle', facts: ['Dome-shaped muscle', 'Contracts during inhalation', 'Separates thorax from abdomen'] }
                },
                digestive: {
                    mouth: { name: 'Oral Cavity', function: 'Mechanical digestion, saliva', facts: ['Contains teeth and tongue', 'Saliva contains amylase', 'Begins carbohydrate digestion'] },
                    esophagus: { name: 'Esophagus', function: 'Transports food to stomach', facts: ['10 inches long', 'Peristalsis moves food', 'Lower sphincter prevents reflux'] },
                    stomach: { name: 'Stomach', function: 'Chemical digestion with acid', facts: ['J-shaped muscular sac', 'pH of 1.5-3.5', 'Produces pepsin for protein'] },
                    liver: { name: 'Liver', function: 'Produces bile, metabolism', facts: ['Largest internal organ', 'Stores glycogen', 'Detoxifies blood'] },
                    gallbladder: { name: 'Gallbladder', function: 'Stores and concentrates bile', facts: ['Pear-shaped sac', 'Under liver', 'Releases bile for fat digestion'] },
                    pancreas: { name: 'Pancreas', function: 'Digestive enzymes and insulin', facts: ['Behind stomach', 'Produces lipase, amylase, protease', 'Regulates blood sugar'] },
                    smallintestine: { name: 'Small Intestine', function: 'Nutrient absorption', facts: ['20 feet long', 'Three parts: duodenum, jejunum, ileum', 'Villi increase surface area'] },
                    largeintestine: { name: 'Large Intestine', function: 'Water absorption, waste storage', facts: ['5 feet long', 'Includes colon and rectum', 'Contains gut bacteria'] }
                },
                endocrine: {
                    pituitary: { name: 'Pituitary Gland', function: 'Master gland, controls other glands', facts: ['Pea-sized', 'At base of brain', 'Produces growth hormone, TSH, FSH'] },
                    thyroid: { name: 'Thyroid Gland', function: 'Metabolism regulation', facts: ['Butterfly-shaped', 'In front of neck', 'Produces T3 and T4'] },
                    parathyroid: { name: 'Parathyroid Glands', function: 'Calcium regulation', facts: ['Four small glands', 'Behind thyroid', 'Produce PTH'] },
                    adrenal: { name: 'Adrenal Glands', function: 'Stress hormones, metabolism', facts: ['On top of kidneys', 'Produce cortisol, adrenaline', 'Fight-or-flight response'] },
                    pancreas: { name: 'Pancreas (Endocrine)', function: 'Blood sugar regulation', facts: ['Islets of Langerhans', 'Produces insulin and glucagon', 'Maintains glucose homeostasis'] },
                    gonads: { name: 'Gonads', function: 'Sex hormones, reproduction', facts: ['Ovaries produce estrogen/progesterone', 'Testes produce testosterone', 'Control sexual development'] }
                },
                lymphatic: {
                    lymphnodes: { name: 'Lymph Nodes', function: 'Filter lymph, immune response', facts: ['600+ in body', 'Swell during infection', 'Found in neck, armpits, groin'] },
                    spleen: { name: 'Spleen', function: 'Filters blood, stores cells', facts: ['Largest lymphatic organ', 'Upper left abdomen', 'Removes old red blood cells'] },
                    thymus: { name: 'Thymus', function: 'T-cell maturation', facts: ['Behind sternum', 'Largest in childhood', 'Shrinks with age'] },
                    tonsils: { name: 'Tonsils', function: 'First line immune defense', facts: ['Three pairs', 'In throat area', 'Trap pathogens'] },
                    lymphvessels: { name: 'Lymph Vessels', function: 'Transport lymph fluid', facts: ['Parallel to blood vessels', 'One-way valves', 'Return fluid to bloodstream'] }
                },
                integumentary: {
                    epidermis: { name: 'Epidermis', function: 'Outer protective layer', facts: ['5 layers of cells', 'Contains melanocytes', 'Constantly regenerates'] },
                    dermis: { name: 'Dermis', function: 'Structural support, sensation', facts: ['Contains collagen and elastin', 'Blood vessels and nerves', 'Hair follicles located here'] },
                    hypodermis: { name: 'Hypodermis', function: 'Fat storage, insulation', facts: ['Subcutaneous layer', 'Connects skin to body', 'Shock absorption'] },
                    hair: { name: 'Hair', function: 'Protection, temperature regulation', facts: ['Made of keratin', '100,000 on scalp', 'Grows from follicles'] },
                    nails: { name: 'Nails', function: 'Protection, fine manipulation', facts: ['Modified epidermis', 'Grow from nail matrix', 'Made of keratin'] },
                    sweatglands: { name: 'Sweat Glands', function: 'Thermoregulation, excretion', facts: ['2-4 million glands', 'Eccrine and apocrine types', 'Cool body through evaporation'] }
                }
            },
            animal: {
                mammal: { 
                    name: 'Mammal Anatomy', 
                    example: 'Dog/Cat/Horse', 
                    facts: ['Warm-blooded (endothermic)', '4-chambered heart', 'Hair or fur covering', 'Mammary glands for nursing', 'Live birth (most species)', 'Specialized teeth'],
                    systems: {
                        external: ['fur', 'ears', 'eyes', 'nose', 'tail', 'paws'],
                        skeletal: ['skull', 'spine', 'ribcage', 'pelvis', 'limbs', 'tail_bones'],
                        organs: ['heart', 'lungs', 'liver', 'kidneys', 'stomach', 'intestines', 'brain'],
                        muscular: ['hindquarters', 'chest', 'back', 'neck', 'limb_muscles']
                    }
                },
                bird: { 
                    name: 'Avian Anatomy', 
                    example: 'Eagle/Owl/Sparrow', 
                    facts: ['Hollow bones for flight', 'Air sacs connected to lungs', 'Feathers for insulation and flight', '4-chambered heart (high metabolism)', 'Beak instead of teeth', 'Lay eggs with hard shells'],
                    systems: {
                        external: ['feathers', 'beak', 'wings', 'tail_feathers', 'talons', 'eyes'],
                        skeletal: ['skull', 'wishbone', 'keel', 'hollow_bones', 'wing_bones', 'leg_bones'],
                        organs: ['heart', 'lungs', 'air_sacs', 'gizzard', 'liver', 'kidneys', 'brain'],
                        muscular: ['flight_muscles', 'leg_muscles', 'neck_muscles']
                    }
                },
                fish: { 
                    name: 'Fish Anatomy', 
                    example: 'Salmon/Shark/Goldfish', 
                    facts: ['Gills for breathing underwater', 'Scales for protection', 'Swim bladder for buoyancy', '2-chambered heart (most fish)', 'Lateral line for sensing vibrations', 'Cold-blooded (ectothermic)'],
                    systems: {
                        external: ['scales', 'fins', 'tail', 'lateral_line', 'eyes', 'mouth'],
                        skeletal: ['skull', 'spine', 'fin_rays', 'ribs', 'jaw'],
                        organs: ['heart', 'gills', 'liver', 'swim_bladder', 'kidneys', 'stomach', 'brain'],
                        muscular: ['myomeres', 'fin_muscles', 'jaw_muscles']
                    }
                },
                reptile: { 
                    name: 'Reptile Anatomy', 
                    example: 'Lizard/Snake/Crocodile', 
                    facts: ['Cold-blooded (ectothermic)', 'Scales made of keratin', '3-chambered heart (most)', 'Eggs with leathery or hard shells', 'Many can regenerate tails', 'Jacobsons organ for smell'],
                    systems: {
                        external: ['scales', 'claws', 'eyes', 'tongue', 'tail'],
                        skeletal: ['skull', 'spine', 'ribs', 'limb_bones', 'tail_vertebrae'],
                        organs: ['heart', 'lungs', 'liver', 'kidneys', 'stomach', 'brain'],
                        muscular: ['trunk_muscles', 'limb_muscles', 'jaw_muscles']
                    }
                },
                insect: { 
                    name: 'Insect Anatomy', 
                    example: 'Ant/Butterfly/Beetle', 
                    facts: ['Exoskeleton (chitin)', '6 legs attached to thorax', '3 body segments: head, thorax, abdomen', 'Compound eyes (thousands of lenses)', 'Open circulatory system', 'Breathe through spiracles'],
                    systems: {
                        external: ['head', 'thorax', 'abdomen', 'antennae', 'legs', 'wings', 'compound_eyes'],
                        skeletal: ['exoskeleton', 'head_capsule', 'thorax_plates', 'abdominal_segments'],
                        organs: ['brain', 'heart_tube', 'digestive_tract', 'malpighian_tubules', 'tracheae', 'ganglia'],
                        muscular: ['flight_muscles', 'leg_muscles', 'mandible_muscles']
                    }
                },
                amphibian: { 
                    name: 'Amphibian Anatomy', 
                    example: 'Frog/Salamander/Newt', 
                    facts: ['Moist permeable skin for gas exchange', 'Metamorphosis (tadpole to adult)', '3-chambered heart', 'External fertilization (most)', 'Can breathe through skin', 'Cold-blooded (ectothermic)'],
                    systems: {
                        external: ['skin', 'eyes', 'tympanum', 'limbs', 'webbed_feet'],
                        skeletal: ['skull', 'spine', 'pelvic_girdle', 'limb_bones', 'phalanges'],
                        organs: ['heart', 'lungs', 'liver', 'kidneys', 'stomach', 'brain', 'bladder'],
                        muscular: ['hind_leg_muscles', 'trunk_muscles', 'jaw_muscles']
                    }
                }
            }
        };

        function renderHumanAnatomy(system) {
            const svg = document.getElementById('anatomySvg');
            let svgContent = '';
            
            const systemColors = {
                skeletal: '#e8d4b8',
                muscular: '#dc3545',
                organs: '#9b59b6',
                nervous: '#f1c40f',
                circulatory: '#e74c3c',
                respiratory: '#3498db',
                digestive: '#27ae60',
                endocrine: '#e67e22',
                lymphatic: '#1abc9c',
                integumentary: '#d4a574'
            };
            const color = systemColors[system] || '#888';
            
            if (system === 'skeletal') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Skull with detail -->
                        <ellipse cx="250" cy="55" rx="48" ry="58" fill="rgba(232,212,184,0.2)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('skull')"/>
                        <path d="M220,85 Q250,95 280,85" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <ellipse cx="235" cy="60" rx="8" ry="6" fill="none" stroke="${color}" stroke-width="1"/>
                        <ellipse cx="265" cy="60" rx="8" ry="6" fill="none" stroke="${color}" stroke-width="1"/>
                        <path d="M242,75 Q250,78 258,75" fill="none" stroke="${color}" stroke-width="1"/>
                        <text x="250" y="35" text-anchor="middle" fill="#888" font-size="9">Skull</text>
                        
                        <!-- Mandible -->
                        <path d="M225,90 Q220,105 230,115 Q250,125 270,115 Q280,105 275,90" fill="none" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('mandible')"/>
                        <text x="310" y="105" fill="#888" font-size="8">Mandible</text>
                        
                        <!-- Cervical Spine -->
                        <rect x="246" y="115" width="8" height="35" rx="2" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="1.5"/>
                        
                        <!-- Clavicles -->
                        <path d="M200,145 Q225,140 248,145" fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('clavicle')"/>
                        <path d="M252,145 Q275,140 300,145" fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('clavicle')"/>
                        <text x="165" y="140" fill="#888" font-size="8">Clavicle</text>
                        
                        <!-- Scapulae -->
                        <path d="M185,150 L175,195 L195,200 L210,165 Z" fill="rgba(232,212,184,0.2)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('scapula')"/>
                        <path d="M315,150 L325,195 L305,200 L290,165 Z" fill="rgba(232,212,184,0.2)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('scapula')"/>
                        <text x="155" y="175" fill="#888" font-size="8">Scapula</text>
                        
                        <!-- Sternum -->
                        <rect x="245" y="148" width="10" height="80" rx="3" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('sternum')"/>
                        <text x="270" y="180" fill="#888" font-size="8">Sternum</text>
                        
                        <!-- Ribcage (detailed) -->
                        <ellipse cx="250" cy="195" rx="65" ry="55" fill="none" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('ribcage')"/>
                        <path d="M195,165 Q250,175 305,165" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <path d="M190,180 Q250,192 310,180" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <path d="M188,195 Q250,210 312,195" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <path d="M190,210 Q250,228 310,210" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <path d="M195,225 Q250,245 305,225" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <text x="320" y="195" fill="#888" font-size="9">Ribs</text>
                        
                        <!-- Spine (thoracic & lumbar) -->
                        <rect x="246" y="150" width="8" height="160" rx="2" fill="rgba(232,212,184,0.4)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('spine')"/>
                        <text x="270" y="260" fill="#888" font-size="8">Spine</text>
                        
                        <!-- Pelvis (detailed) -->
                        <path d="M185,315 Q210,295 250,315 Q290,295 315,315 L310,355 Q250,375 190,355 Z" fill="rgba(232,212,184,0.2)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pelvis')"/>
                        <ellipse cx="215" cy="340" rx="15" ry="18" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <ellipse cx="285" cy="340" rx="15" ry="18" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <text x="250" y="335" text-anchor="middle" fill="#888" font-size="9">Pelvis</text>
                        
                        <!-- Humerus (upper arm) -->
                        <line x1="195" y1="155" x2="150" y2="270" stroke="${color}" stroke-width="8" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('humerus')"/>
                        <line x1="305" y1="155" x2="350" y2="270" stroke="${color}" stroke-width="8" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('humerus')"/>
                        <text x="120" y="220" fill="#888" font-size="8">Humerus</text>
                        
                        <!-- Radius -->
                        <line x1="148" y1="275" x2="125" y2="385" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('radius')"/>
                        <line x1="352" y1="275" x2="375" y2="385" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('radius')"/>
                        
                        <!-- Ulna -->
                        <line x1="152" y1="275" x2="135" y2="385" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('ulna')"/>
                        <line x1="348" y1="275" x2="365" y2="385" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('ulna')"/>
                        <text x="90" y="340" fill="#888" font-size="8">Radius/Ulna</text>
                        
                        <!-- Carpal bones (wrist) -->
                        <rect x="115" y="388" width="30" height="15" rx="5" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('carpals')"/>
                        <rect x="355" y="388" width="30" height="15" rx="5" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('carpals')"/>
                        
                        <!-- Hand bones -->
                        <line x1="120" y1="405" x2="115" y2="440" stroke="${color}" stroke-width="3"/>
                        <line x1="130" y1="405" x2="130" y2="445" stroke="${color}" stroke-width="3"/>
                        <line x1="140" y1="405" x2="145" y2="440" stroke="${color}" stroke-width="3"/>
                        <line x1="360" y1="405" x2="355" y2="440" stroke="${color}" stroke-width="3"/>
                        <line x1="370" y1="405" x2="370" y2="445" stroke="${color}" stroke-width="3"/>
                        <line x1="380" y1="405" x2="385" y2="440" stroke="${color}" stroke-width="3"/>
                        
                        <!-- Femur (thigh) -->
                        <line x1="215" y1="355" x2="195" y2="500" stroke="${color}" stroke-width="12" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('femur')"/>
                        <line x1="285" y1="355" x2="305" y2="500" stroke="${color}" stroke-width="12" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('femur')"/>
                        <text x="155" y="430" fill="#888" font-size="9">Femur</text>
                        
                        <!-- Patella (kneecap) -->
                        <ellipse cx="195" cy="505" rx="12" ry="15" fill="rgba(232,212,184,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('patella')"/>
                        <ellipse cx="305" cy="505" rx="12" ry="15" fill="rgba(232,212,184,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('patella')"/>
                        <text x="155" y="510" fill="#888" font-size="8">Patella</text>
                        
                        <!-- Tibia -->
                        <line x1="193" y1="520" x2="188" y2="620" stroke="${color}" stroke-width="9" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('tibia')"/>
                        <line x1="307" y1="520" x2="312" y2="620" stroke="${color}" stroke-width="9" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('tibia')"/>
                        
                        <!-- Fibula -->
                        <line x1="200" y1="520" x2="198" y2="620" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('fibula')"/>
                        <line x1="300" y1="520" x2="302" y2="620" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('fibula')"/>
                        <text x="155" y="580" fill="#888" font-size="8">Tibia/Fibula</text>
                        
                        <!-- Foot bones -->
                        <rect x="175" y="625" width="35" height="20" rx="5" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="1.5"/>
                        <rect x="290" y="625" width="35" height="20" rx="5" fill="rgba(232,212,184,0.3)" stroke="${color}" stroke-width="1.5"/>
                        <line x1="180" y1="648" x2="175" y2="670" stroke="${color}" stroke-width="2"/>
                        <line x1="190" y1="648" x2="188" y2="675" stroke="${color}" stroke-width="2"/>
                        <line x1="200" y1="648" x2="200" y2="675" stroke="${color}" stroke-width="2"/>
                        <line x1="295" y1="648" x2="290" y2="670" stroke="${color}" stroke-width="2"/>
                        <line x1="305" y1="648" x2="302" y2="675" stroke="${color}" stroke-width="2"/>
                        <line x1="315" y1="648" x2="318" y2="675" stroke="${color}" stroke-width="2"/>
                    </g>`;
            } else if (system === 'muscular') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Head outline -->
                        <ellipse cx="250" cy="55" rx="42" ry="50" fill="rgba(220,53,69,0.15)" stroke="${color}" stroke-width="1.5"/>
                        
                        <!-- Trapezius -->
                        <path d="M195,100 Q250,80 305,100 L290,150 Q250,135 210,150 Z" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('trapezius')"/>
                        <text x="250" y="125" text-anchor="middle" fill="#fff" font-size="9">Trapezius</text>
                        
                        <!-- Deltoids -->
                        <ellipse cx="175" cy="160" rx="30" ry="25" fill="rgba(220,53,69,0.45)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('deltoid')"/>
                        <ellipse cx="325" cy="160" rx="30" ry="25" fill="rgba(220,53,69,0.45)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('deltoid')"/>
                        <text x="175" y="165" text-anchor="middle" fill="#fff" font-size="8">Deltoid</text>
                        <text x="325" y="165" text-anchor="middle" fill="#fff" font-size="8">Deltoid</text>
                        
                        <!-- Pectoralis -->
                        <path d="M195,155 Q250,150 305,155 L295,215 Q250,225 205,215 Z" fill="rgba(220,53,69,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pectoralis')"/>
                        <text x="250" y="190" text-anchor="middle" fill="#fff" font-size="10">Pectoralis</text>
                        
                        <!-- Latissimus (sides) -->
                        <path d="M180,180 L165,260 L195,280 L210,210 Z" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('latissimus')"/>
                        <path d="M320,180 L335,260 L305,280 L290,210 Z" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('latissimus')"/>
                        <text x="140" y="230" fill="#888" font-size="8">Lats</text>
                        
                        <!-- Biceps -->
                        <ellipse cx="155" cy="225" rx="18" ry="45" fill="rgba(220,53,69,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('biceps')"/>
                        <ellipse cx="345" cy="225" rx="18" ry="45" fill="rgba(220,53,69,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('biceps')"/>
                        <text x="155" y="230" text-anchor="middle" fill="#fff" font-size="8">Bicep</text>
                        <text x="345" y="230" text-anchor="middle" fill="#fff" font-size="8">Bicep</text>
                        
                        <!-- Triceps (back of arm) -->
                        <ellipse cx="145" cy="230" rx="12" ry="40" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('triceps')"/>
                        <ellipse cx="355" cy="230" rx="12" ry="40" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('triceps')"/>
                        
                        <!-- Rectus Abdominis (six-pack) -->
                        <rect x="225" y="225" width="50" height="90" rx="5" fill="rgba(220,53,69,0.45)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('rectusAb')"/>
                        <line x1="250" y1="228" x2="250" y2="312" stroke="${color}" stroke-width="1"/>
                        <line x1="228" y1="250" x2="272" y2="250" stroke="${color}" stroke-width="1"/>
                        <line x1="228" y1="275" x2="272" y2="275" stroke="${color}" stroke-width="1"/>
                        <line x1="228" y1="300" x2="272" y2="300" stroke="${color}" stroke-width="1"/>
                        <text x="250" y="270" text-anchor="middle" fill="#fff" font-size="8">Abs</text>
                        
                        <!-- Obliques -->
                        <path d="M195,235 L170,290 L190,320 L220,260 Z" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('obliques')"/>
                        <path d="M305,235 L330,290 L310,320 L280,260 Z" fill="rgba(220,53,69,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('obliques')"/>
                        <text x="155" y="285" fill="#888" font-size="8">Obliques</text>
                        
                        <!-- Forearm muscles -->
                        <ellipse cx="135" cy="310" rx="12" ry="35" fill="rgba(220,53,69,0.4)" stroke="${color}" stroke-width="1.5"/>
                        <ellipse cx="365" cy="310" rx="12" ry="35" fill="rgba(220,53,69,0.4)" stroke="${color}" stroke-width="1.5"/>
                        
                        <!-- Gluteus -->
                        <ellipse cx="220" cy="360" rx="35" ry="30" fill="rgba(220,53,69,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('gluteus')"/>
                        <ellipse cx="280" cy="360" rx="35" ry="30" fill="rgba(220,53,69,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('gluteus')"/>
                        <text x="250" y="365" text-anchor="middle" fill="#fff" font-size="9">Glutes</text>
                        
                        <!-- Quadriceps -->
                        <ellipse cx="215" cy="470" rx="35" ry="85" fill="rgba(220,53,69,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('quadriceps')"/>
                        <ellipse cx="285" cy="470" rx="35" ry="85" fill="rgba(220,53,69,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('quadriceps')"/>
                        <text x="215" y="470" text-anchor="middle" fill="#fff" font-size="9">Quads</text>
                        <text x="285" y="470" text-anchor="middle" fill="#fff" font-size="9">Quads</text>
                        
                        <!-- Hamstrings (implied, back) -->
                        <ellipse cx="215" cy="475" rx="28" ry="70" fill="rgba(220,53,69,0.3)" stroke="${color}" stroke-width="1" class="anatomy-part" onclick="explainAnatomyPart('hamstrings')"/>
                        <ellipse cx="285" cy="475" rx="28" ry="70" fill="rgba(220,53,69,0.3)" stroke="${color}" stroke-width="1" class="anatomy-part" onclick="explainAnatomyPart('hamstrings')"/>
                        
                        <!-- Gastrocnemius (calves) -->
                        <ellipse cx="205" cy="600" rx="22" ry="50" fill="rgba(220,53,69,0.45)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('gastrocnemius')"/>
                        <ellipse cx="295" cy="600" rx="22" ry="50" fill="rgba(220,53,69,0.45)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('gastrocnemius')"/>
                        <text x="205" y="605" text-anchor="middle" fill="#fff" font-size="8">Calf</text>
                        <text x="295" y="605" text-anchor="middle" fill="#fff" font-size="8">Calf</text>
                    </g>`;
            } else if (system === 'organs') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Body outline -->
                        <ellipse cx="250" cy="55" rx="42" ry="50" fill="rgba(155,89,182,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        <ellipse cx="250" cy="280" rx="75" ry="170" fill="rgba(155,89,182,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        
                        <!-- Brain (detailed) -->
                        <ellipse cx="250" cy="55" rx="38" ry="40" fill="rgba(233,196,196,0.5)" stroke="#e8a8a8" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('brain')"/>
                        <path d="M220,45 Q235,30 250,45 Q265,30 280,45" fill="none" stroke="#d4a0a0" stroke-width="1.5"/>
                        <path d="M225,55 Q240,45 255,55 Q270,45 275,55" fill="none" stroke="#d4a0a0" stroke-width="1"/>
                        <path d="M230,65 Q245,55 260,65" fill="none" stroke="#d4a0a0" stroke-width="1"/>
                        <text x="250" y="58" text-anchor="middle" fill="#8b4a4a" font-size="10">Brain</text>
                        
                        <!-- Trachea/Esophagus -->
                        <rect x="245" y="100" width="10" height="60" rx="3" fill="rgba(52,152,219,0.4)" stroke="#3498db" stroke-width="1.5"/>
                        
                        <!-- Lungs (detailed with lobes) -->
                        <path d="M195,145 Q175,180 180,250 Q195,260 210,250 Q220,190 210,155 Z" fill="rgba(52,152,219,0.35)" stroke="#3498db" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('lungs')"/>
                        <path d="M210,155 Q225,145 210,200" fill="none" stroke="#2980b9" stroke-width="1"/>
                        <path d="M305,145 Q325,180 320,250 Q305,260 290,250 Q280,190 290,155 Z" fill="rgba(52,152,219,0.35)" stroke="#3498db" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('lungs')"/>
                        <path d="M290,155 Q275,145 290,200" fill="none" stroke="#2980b9" stroke-width="1"/>
                        <path d="M290,180 Q275,175 290,220" fill="none" stroke="#2980b9" stroke-width="1"/>
                        <text x="190" y="200" text-anchor="middle" fill="#2980b9" font-size="9">Left Lung</text>
                        <text x="310" y="200" text-anchor="middle" fill="#2980b9" font-size="9">Right Lung</text>
                        
                        <!-- Heart (anatomically correct) -->
                        <path d="M235,170 Q225,155 240,145 Q255,155 255,170 Q270,155 280,170 Q275,195 255,215 Q240,200 235,195 Q230,185 235,170 Z" fill="rgba(231,76,60,0.6)" stroke="#c0392b" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('heart')"/>
                        <path d="M245,160 L248,175 M255,155 L255,170" fill="none" stroke="#922b21" stroke-width="1.5"/>
                        <text x="255" y="190" text-anchor="middle" fill="#fff" font-size="9">Heart</text>
                        
                        <!-- Liver -->
                        <path d="M265,240 Q320,235 330,270 Q325,310 280,320 Q260,310 260,280 Z" fill="rgba(139,69,19,0.5)" stroke="#8B4513" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('liver')"/>
                        <text x="295" y="280" text-anchor="middle" fill="#fff" font-size="10">Liver</text>
                        
                        <!-- Stomach -->
                        <path d="M200,265 Q175,285 185,320 Q210,340 240,320 Q250,290 235,270 Q220,260 200,265 Z" fill="rgba(241,196,15,0.4)" stroke="#f1c40f" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('stomach')"/>
                        <text x="210" y="300" text-anchor="middle" fill="#8a6d0b" font-size="9">Stomach</text>
                        
                        <!-- Pancreas -->
                        <path d="M225,330 Q270,325 290,340 L285,350 Q265,340 225,345 Z" fill="rgba(230,126,34,0.5)" stroke="#e67e22" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('pancreas')"/>
                        <text x="255" y="355" fill="#cf6d17" font-size="8">Pancreas</text>
                        
                        <!-- Spleen -->
                        <ellipse cx="175" cy="290" rx="20" ry="30" fill="rgba(155,89,182,0.4)" stroke="#9b59b6" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('spleen')"/>
                        <text x="145" y="295" fill="#7b3f9e" font-size="8">Spleen</text>
                        
                        <!-- Kidneys -->
                        <ellipse cx="195" cy="360" rx="18" ry="28" fill="rgba(192,57,43,0.4)" stroke="#c0392b" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('kidneys')"/>
                        <ellipse cx="305" cy="360" rx="18" ry="28" fill="rgba(192,57,43,0.4)" stroke="#c0392b" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('kidneys')"/>
                        <path d="M195,345 Q188,360 195,375" fill="none" stroke="#922b21" stroke-width="1"/>
                        <path d="M305,345 Q312,360 305,375" fill="none" stroke="#922b21" stroke-width="1"/>
                        <text x="160" y="365" fill="#922b21" font-size="8">Kidney</text>
                        <text x="330" y="365" fill="#922b21" font-size="8">Kidney</text>
                        
                        <!-- Intestines (simplified) -->
                        <path d="M220,380 Q200,400 220,420 Q245,435 270,420 Q290,405 275,385 Q260,395 245,385 Q230,395 220,380 Z" fill="rgba(230,126,34,0.3)" stroke="#e67e22" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('intestines')"/>
                        <path d="M225,420 Q215,445 235,460 Q260,465 275,450 Q285,430 270,420" fill="none" stroke="#e67e22" stroke-width="1.5"/>
                        <text x="250" y="435" text-anchor="middle" fill="#bf5c0c" font-size="8">Intestines</text>
                        
                        <!-- Bladder -->
                        <ellipse cx="250" cy="490" rx="25" ry="20" fill="rgba(241,196,15,0.3)" stroke="#d4a10a" stroke-width="1.5"/>
                        <text x="250" y="495" text-anchor="middle" fill="#8a6d0b" font-size="8">Bladder</text>
                    </g>`;
            } else if (system === 'nervous') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Brain (detailed regions) -->
                        <ellipse cx="250" cy="55" rx="50" ry="52" fill="rgba(241,196,15,0.25)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('cerebrum')"/>
                        <path d="M210,35 Q235,20 260,35 Q285,20 290,35" fill="none" stroke="${color}" stroke-width="2"/>
                        <path d="M215,50 Q240,38 265,50 Q280,40 285,55" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <path d="M220,65 Q245,55 270,65" fill="none" stroke="${color}" stroke-width="1.5"/>
                        <text x="250" y="45" text-anchor="middle" fill="#8a6d0b" font-size="10">Cerebrum</text>
                        
                        <!-- Cerebellum -->
                        <ellipse cx="250" cy="95" rx="30" ry="18" fill="rgba(241,196,15,0.35)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('cerebellum')"/>
                        <path d="M230,95 Q250,88 270,95" fill="none" stroke="#d4a10a" stroke-width="1"/>
                        <path d="M235,100 Q250,94 265,100" fill="none" stroke="#d4a10a" stroke-width="1"/>
                        <text x="250" y="98" text-anchor="middle" fill="#8a6d0b" font-size="8">Cerebellum</text>
                        
                        <!-- Brainstem -->
                        <rect x="245" y="108" width="10" height="25" rx="3" fill="rgba(241,196,15,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('brainstem')"/>
                        <text x="270" y="122" fill="#8a6d0b" font-size="8">Brainstem</text>
                        
                        <!-- Spinal Cord -->
                        <rect x="247" y="133" width="6" height="250" rx="2" fill="rgba(241,196,15,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('spinalcord')"/>
                        <text x="270" y="250" fill="#8a6d0b" font-size="9">Spinal Cord</text>
                        
                        <!-- Cervical nerves -->
                        <line x1="250" y1="145" x2="190" y2="160" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('nerves')"/>
                        <line x1="250" y1="145" x2="310" y2="160" stroke="${color}" stroke-width="2.5"/>
                        <text x="160" y="165" fill="#888" font-size="8">Brachial Plexus</text>
                        
                        <!-- Brachial plexus (arms) -->
                        <line x1="190" y1="160" x2="140" y2="230" stroke="${color}" stroke-width="2"/>
                        <line x1="140" y1="230" x2="120" y2="320" stroke="${color}" stroke-width="1.5"/>
                        <line x1="140" y1="230" x2="110" y2="320" stroke="${color}" stroke-width="1.5"/>
                        <line x1="140" y1="230" x2="130" y2="320" stroke="${color}" stroke-width="1.5"/>
                        <line x1="310" y1="160" x2="360" y2="230" stroke="${color}" stroke-width="2"/>
                        <line x1="360" y1="230" x2="380" y2="320" stroke="${color}" stroke-width="1.5"/>
                        <line x1="360" y1="230" x2="390" y2="320" stroke="${color}" stroke-width="1.5"/>
                        <line x1="360" y1="230" x2="370" y2="320" stroke="${color}" stroke-width="1.5"/>
                        
                        <!-- Thoracic nerves (ribs area) -->
                        <line x1="250" y1="180" x2="200" y2="195" stroke="${color}" stroke-width="1.5"/>
                        <line x1="250" y1="180" x2="300" y2="195" stroke="${color}" stroke-width="1.5"/>
                        <line x1="250" y1="210" x2="195" y2="225" stroke="${color}" stroke-width="1.5"/>
                        <line x1="250" y1="210" x2="305" y2="225" stroke="${color}" stroke-width="1.5"/>
                        <line x1="250" y1="240" x2="190" y2="255" stroke="${color}" stroke-width="1.5"/>
                        <line x1="250" y1="240" x2="310" y2="255" stroke="${color}" stroke-width="1.5"/>
                        
                        <!-- Lumbar plexus -->
                        <line x1="250" y1="330" x2="210" y2="360" stroke="${color}" stroke-width="2.5"/>
                        <line x1="250" y1="330" x2="290" y2="360" stroke="${color}" stroke-width="2.5"/>
                        <text x="160" y="355" fill="#888" font-size="8">Lumbar Plexus</text>
                        
                        <!-- Sciatic nerves (legs) -->
                        <line x1="210" y1="360" x2="200" y2="500" stroke="${color}" stroke-width="3" class="anatomy-part" onclick="explainAnatomyPart('nerves')"/>
                        <line x1="290" y1="360" x2="300" y2="500" stroke="${color}" stroke-width="3"/>
                        <text x="155" y="440" fill="#888" font-size="8">Sciatic Nerve</text>
                        
                        <!-- Lower leg nerves -->
                        <line x1="200" y1="500" x2="195" y2="600" stroke="${color}" stroke-width="2"/>
                        <line x1="200" y1="500" x2="210" y2="600" stroke="${color}" stroke-width="2"/>
                        <line x1="300" y1="500" x2="295" y2="600" stroke="${color}" stroke-width="2"/>
                        <line x1="300" y1="500" x2="305" y2="600" stroke="${color}" stroke-width="2"/>
                        
                        <!-- Nerve endings (feet) -->
                        <circle cx="195" cy="610" r="5" fill="${color}" opacity="0.5"/>
                        <circle cx="210" cy="610" r="5" fill="${color}" opacity="0.5"/>
                        <circle cx="295" cy="610" r="5" fill="${color}" opacity="0.5"/>
                        <circle cx="305" cy="610" r="5" fill="${color}" opacity="0.5"/>
                    </g>`;
            } else if (system === 'circulatory') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Heart (central, detailed) -->
                        <path d="M230,180 Q215,160 235,145 Q255,160 255,180 Q275,160 290,180 Q285,210 255,235 Q235,215 230,205 Q220,195 230,180 Z" fill="rgba(231,76,60,0.7)" stroke="#922b21" stroke-width="3" class="anatomy-part" onclick="explainAnatomyPart('heart')"/>
                        <path d="M245,165 L250,185 M260,155 L260,175" fill="none" stroke="#7b241c" stroke-width="2"/>
                        <text x="260" y="200" text-anchor="middle" fill="#fff" font-size="10">Heart</text>
                        
                        <!-- Aorta (main artery from heart) -->
                        <path d="M260,145 L260,120 Q260,100 280,100 L280,130" fill="none" stroke="#e74c3c" stroke-width="6" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('aorta')"/>
                        <text x="295" y="115" fill="#c0392b" font-size="8">Aorta</text>
                        
                        <!-- Carotid arteries (to head) -->
                        <line x1="245" y1="100" x2="235" y2="60" stroke="#e74c3c" stroke-width="4"/>
                        <line x1="270" y1="100" x2="280" y2="60" stroke="#e74c3c" stroke-width="4"/>
                        
                        <!-- Jugular veins (from head) -->
                        <line x1="225" y1="65" x2="220" y2="110" stroke="#3498db" stroke-width="4"/>
                        <line x1="290" y1="65" x2="295" y2="110" stroke="#3498db" stroke-width="4"/>
                        
                        <!-- Subclavian (to arms) -->
                        <path d="M230,145 Q200,140 170,160" fill="none" stroke="#e74c3c" stroke-width="4" class="anatomy-part" onclick="explainAnatomyPart('arteries')"/>
                        <path d="M280,145 Q310,140 340,160" fill="none" stroke="#e74c3c" stroke-width="4"/>
                        
                        <!-- Arm arteries -->
                        <line x1="170" y1="160" x2="140" y2="280" stroke="#e74c3c" stroke-width="3"/>
                        <line x1="340" y1="160" x2="370" y2="280" stroke="#e74c3c" stroke-width="3"/>
                        <line x1="140" y1="280" x2="125" y2="380" stroke="#e74c3c" stroke-width="2"/>
                        <line x1="370" y1="280" x2="385" y2="380" stroke="#e74c3c" stroke-width="2"/>
                        
                        <!-- Arm veins (return) -->
                        <line x1="135" y1="285" x2="155" y2="180" stroke="#3498db" stroke-width="3" class="anatomy-part" onclick="explainAnatomyPart('veins')"/>
                        <line x1="375" y1="285" x2="355" y2="180" stroke="#3498db" stroke-width="3"/>
                        <line x1="120" y1="385" x2="135" y2="285" stroke="#3498db" stroke-width="2"/>
                        <line x1="390" y1="385" x2="375" y2="285" stroke="#3498db" stroke-width="2"/>
                        
                        <!-- Descending aorta -->
                        <line x1="260" y1="235" x2="260" y2="380" stroke="#e74c3c" stroke-width="5"/>
                        
                        <!-- Abdominal branches -->
                        <line x1="260" y1="280" x2="200" y2="300" stroke="#e74c3c" stroke-width="2"/>
                        <line x1="260" y1="280" x2="320" y2="300" stroke="#e74c3c" stroke-width="2"/>
                        <line x1="260" y1="320" x2="210" y2="340" stroke="#e74c3c" stroke-width="2"/>
                        <line x1="260" y1="320" x2="310" y2="340" stroke="#e74c3c" stroke-width="2"/>
                        
                        <!-- Iliac arteries (to legs) -->
                        <path d="M260,380 Q240,400 220,380" fill="none" stroke="#e74c3c" stroke-width="4"/>
                        <path d="M260,380 Q280,400 300,380" fill="none" stroke="#e74c3c" stroke-width="4"/>
                        
                        <!-- Femoral arteries -->
                        <line x1="220" y1="400" x2="210" y2="520" stroke="#e74c3c" stroke-width="4"/>
                        <line x1="300" y1="400" x2="310" y2="520" stroke="#e74c3c" stroke-width="4"/>
                        
                        <!-- Lower leg arteries -->
                        <line x1="210" y1="520" x2="200" y2="620" stroke="#e74c3c" stroke-width="3"/>
                        <line x1="310" y1="520" x2="320" y2="620" stroke="#e74c3c" stroke-width="3"/>
                        
                        <!-- Femoral veins (return) -->
                        <line x1="215" y1="525" x2="225" y2="405" stroke="#3498db" stroke-width="4"/>
                        <line x1="305" y1="525" x2="295" y2="405" stroke="#3498db" stroke-width="4"/>
                        
                        <!-- Lower leg veins -->
                        <line x1="205" y1="625" x2="215" y2="525" stroke="#3498db" stroke-width="3"/>
                        <line x1="315" y1="625" x2="305" y2="525" stroke="#3498db" stroke-width="3"/>
                        
                        <!-- Inferior vena cava (main return) -->
                        <line x1="250" y1="240" x2="250" y2="380" stroke="#3498db" stroke-width="5"/>
                        <text x="275" y="310" fill="#2980b9" font-size="8">Vena Cava</text>
                        
                        <!-- Capillary beds (represented) -->
                        <circle cx="125" cy="390" r="8" fill="rgba(155,89,182,0.4)" stroke="#9b59b6" stroke-width="1"/>
                        <circle cx="390" cy="390" r="8" fill="rgba(155,89,182,0.4)" stroke="#9b59b6" stroke-width="1"/>
                        <circle cx="200" cy="630" r="8" fill="rgba(155,89,182,0.4)" stroke="#9b59b6" stroke-width="1"/>
                        <circle cx="320" cy="630" r="8" fill="rgba(155,89,182,0.4)" stroke="#9b59b6" stroke-width="1"/>
                        <text x="145" y="395" fill="#9b59b6" font-size="7">Capillaries</text>
                        
                        <!-- Legend -->
                        <rect x="380" y="50" width="80" height="50" fill="rgba(20,20,35,0.8)" rx="5"/>
                        <line x1="390" y1="65" x2="410" y2="65" stroke="#e74c3c" stroke-width="3"/>
                        <text x="415" y="68" fill="#e74c3c" font-size="8">Arteries</text>
                        <line x1="390" y1="85" x2="410" y2="85" stroke="#3498db" stroke-width="3"/>
                        <text x="415" y="88" fill="#3498db" font-size="8">Veins</text>
                    </g>`;
            } else if (system === 'respiratory') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Nasal cavity -->
                        <path d="M245,40 Q250,30 255,40 L258,60 Q250,65 242,60 Z" fill="rgba(52,152,219,0.3)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('nasal')"/>
                        <text x="270" y="50" fill="#888" font-size="8">Nasal Cavity</text>
                        
                        <!-- Pharynx -->
                        <rect x="245" y="65" width="10" height="25" rx="3" fill="rgba(52,152,219,0.35)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('pharynx')"/>
                        <text x="270" y="80" fill="#888" font-size="8">Pharynx</text>
                        
                        <!-- Larynx (voice box) -->
                        <path d="M242,92 L258,92 L262,115 L238,115 Z" fill="rgba(52,152,219,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('larynx')"/>
                        <line x1="242" y1="100" x2="258" y2="100" stroke="${color}" stroke-width="1"/>
                        <line x1="240" y1="108" x2="260" y2="108" stroke="${color}" stroke-width="1"/>
                        <text x="275" y="105" fill="#888" font-size="8">Larynx</text>
                        
                        <!-- Trachea (detailed with cartilage rings) -->
                        <rect x="244" y="118" width="12" height="70" rx="4" fill="rgba(52,152,219,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('trachea')"/>
                        <line x1="244" y1="130" x2="256" y2="130" stroke="${color}" stroke-width="1"/>
                        <line x1="244" y1="145" x2="256" y2="145" stroke="${color}" stroke-width="1"/>
                        <line x1="244" y1="160" x2="256" y2="160" stroke="${color}" stroke-width="1"/>
                        <line x1="244" y1="175" x2="256" y2="175" stroke="${color}" stroke-width="1"/>
                        <text x="275" y="155" fill="#888" font-size="9">Trachea</text>
                        
                        <!-- Bronchi -->
                        <path d="M248,188 Q230,200 210,220" fill="none" stroke="${color}" stroke-width="5" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('bronchi')"/>
                        <path d="M252,188 Q270,200 290,220" fill="none" stroke="${color}" stroke-width="5" stroke-linecap="round"/>
                        <text x="320" y="215" fill="#888" font-size="8">Bronchi</text>
                        
                        <!-- Bronchioles -->
                        <path d="M210,220 Q195,240 185,260" fill="none" stroke="${color}" stroke-width="3"/>
                        <path d="M210,220 Q215,245 210,270" fill="none" stroke="${color}" stroke-width="3"/>
                        <path d="M290,220 Q305,240 315,260" fill="none" stroke="${color}" stroke-width="3"/>
                        <path d="M290,220 Q285,245 290,270" fill="none" stroke="${color}" stroke-width="3"/>
                        
                        <!-- Left Lung (detailed with lobes) -->
                        <path d="M170,195 Q140,230 145,320 Q155,360 195,365 Q230,360 240,320 Q245,250 230,210 Q210,190 170,195 Z" fill="rgba(52,152,219,0.35)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('lungs')"/>
                        <path d="M165,270 Q200,290 235,275" fill="none" stroke="#2980b9" stroke-width="2"/>
                        <text x="195" y="250" text-anchor="middle" fill="#2980b9" font-size="9">Upper</text>
                        <text x="195" y="320" text-anchor="middle" fill="#2980b9" font-size="9">Lower</text>
                        <text x="135" y="280" fill="#2980b9" font-size="10">Left Lung</text>
                        
                        <!-- Right Lung (three lobes) -->
                        <path d="M330,195 Q360,230 355,320 Q345,360 305,365 Q270,360 260,320 Q255,250 270,210 Q290,190 330,195 Z" fill="rgba(52,152,219,0.35)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('lungs')"/>
                        <path d="M335,250 Q300,265 265,255" fill="none" stroke="#2980b9" stroke-width="2"/>
                        <path d="M340,310 Q305,325 265,315" fill="none" stroke="#2980b9" stroke-width="2"/>
                        <text x="305" y="230" text-anchor="middle" fill="#2980b9" font-size="8">Upper</text>
                        <text x="305" y="280" text-anchor="middle" fill="#2980b9" font-size="8">Middle</text>
                        <text x="305" y="340" text-anchor="middle" fill="#2980b9" font-size="8">Lower</text>
                        <text x="365" y="280" fill="#2980b9" font-size="10">Right Lung</text>
                        
                        <!-- Alveoli representation -->
                        <circle cx="175" cy="340" r="6" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="190" cy="345" r="5" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="183" cy="350" r="4" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="325" cy="340" r="6" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="310" cy="345" r="5" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="317" cy="350" r="4" fill="rgba(52,152,219,0.5)" stroke="${color}" stroke-width="1"/>
                        <text x="155" y="365" fill="#888" font-size="7">Alveoli</text>
                        
                        <!-- Diaphragm -->
                        <path d="M130,380 Q200,420 250,410 Q300,420 370,380" fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('diaphragm')"/>
                        <path d="M135,385 Q200,425 250,415 Q300,425 365,385" fill="rgba(52,152,219,0.2)" stroke="none"/>
                        <text x="250" y="440" text-anchor="middle" fill="#2980b9" font-size="10">Diaphragm</text>
                        
                        <!-- Airflow arrows -->
                        <path d="M250,25 L250,35 M245,30 L250,38 L255,30" fill="none" stroke="#2ecc71" stroke-width="2"/>
                        <text x="265" y="32" fill="#27ae60" font-size="7">Air In</text>
                    </g>`;
            } else if (system === 'digestive') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Mouth -->
                        <ellipse cx="250" cy="55" rx="25" ry="15" fill="rgba(39,174,96,0.3)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('mouth')"/>
                        <line x1="235" y1="55" x2="265" y2="55" stroke="${color}" stroke-width="1"/>
                        <text x="280" y="60" fill="#888" font-size="9">Mouth</text>
                        
                        <!-- Esophagus -->
                        <rect x="247" y="75" width="6" height="100" rx="2" fill="rgba(39,174,96,0.4)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('esophagus')"/>
                        <text x="265" y="125" fill="#888" font-size="9">Esophagus</text>
                        
                        <!-- Stomach (J-shaped) -->
                        <path d="M200,180 Q165,210 175,270 Q200,310 250,300 Q280,285 280,250 Q275,210 260,185 Q240,175 200,180 Z" fill="rgba(39,174,96,0.4)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('stomach')"/>
                        <path d="M210,200 Q185,220 190,250" fill="none" stroke="#1e8449" stroke-width="1.5"/>
                        <path d="M220,195 Q195,215 200,245" fill="none" stroke="#1e8449" stroke-width="1"/>
                        <text x="210" y="250" text-anchor="middle" fill="#fff" font-size="10">Stomach</text>
                        
                        <!-- Liver -->
                        <path d="M275,180 Q340,175 360,220 Q355,280 300,295 Q275,290 270,250 Z" fill="rgba(139,69,19,0.5)" stroke="#8B4513" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('liver')"/>
                        <text x="315" y="240" text-anchor="middle" fill="#fff" font-size="10">Liver</text>
                        
                        <!-- Gallbladder -->
                        <ellipse cx="305" cy="280" rx="12" ry="18" fill="rgba(46,204,113,0.5)" stroke="#27ae60" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('gallbladder')"/>
                        <text x="340" y="285" fill="#888" font-size="8">Gallbladder</text>
                        
                        <!-- Pancreas -->
                        <path d="M200,305 Q260,295 290,315 L285,330 Q255,315 195,325 Z" fill="rgba(230,126,34,0.5)" stroke="#e67e22" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pancreas')"/>
                        <text x="245" y="340" text-anchor="middle" fill="#bf5c0c" font-size="9">Pancreas</text>
                        
                        <!-- Small Intestine (coiled) -->
                        <path d="M255,305 Q280,320 270,340 Q260,360 285,370 Q310,380 295,400 Q280,420 305,430 Q330,440 310,460 Q290,480 315,490 Q340,500 315,520 Q290,540 270,520 Q250,500 230,520 Q210,540 195,520 Q180,500 205,480 Q230,460 210,440 Q190,420 215,400 Q240,380 220,360 Q200,340 225,320" fill="none" stroke="${color}" stroke-width="4" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('smallintestine')"/>
                        <text x="255" y="430" text-anchor="middle" fill="#27ae60" font-size="9">Small Intestine</text>
                        
                        <!-- Large Intestine (colon frame) -->
                        <path d="M155,350 L155,520 Q155,550 185,550 L315,550 Q345,550 345,520 L345,350 Q345,320 315,320" fill="none" stroke="#1e8449" stroke-width="8" stroke-linecap="round" class="anatomy-part" onclick="explainAnatomyPart('largeintestine')"/>
                        <text x="130" y="440" fill="#1e8449" font-size="8">Ascending</text>
                        <text x="250" y="570" text-anchor="middle" fill="#1e8449" font-size="8">Transverse Colon</text>
                        <text x="360" y="440" fill="#1e8449" font-size="8">Descending</text>
                        
                        <!-- Appendix -->
                        <path d="M155,350 Q140,365 145,385" fill="none" stroke="#1e8449" stroke-width="4" stroke-linecap="round"/>
                        <text x="115" y="380" fill="#888" font-size="7">Appendix</text>
                        
                        <!-- Rectum -->
                        <rect x="175" y="560" width="20" height="40" rx="5" fill="rgba(39,174,96,0.4)" stroke="${color}" stroke-width="2"/>
                        <text x="200" y="585" fill="#888" font-size="8">Rectum</text>
                    </g>`;
            } else if (system === 'endocrine') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Body outline (faded) -->
                        <ellipse cx="250" cy="55" rx="40" ry="48" fill="rgba(230,126,34,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        <ellipse cx="250" cy="300" rx="70" ry="180" fill="rgba(230,126,34,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        
                        <!-- Hypothalamus -->
                        <ellipse cx="250" cy="40" rx="15" ry="10" fill="rgba(230,126,34,0.6)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pituitary')"/>
                        <text x="280" y="45" fill="${color}" font-size="8">Hypothalamus</text>
                        
                        <!-- Pituitary Gland -->
                        <ellipse cx="250" cy="60" rx="12" ry="8" fill="rgba(230,126,34,0.7)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pituitary')"/>
                        <line x1="250" y1="50" x2="250" y2="52" stroke="${color}" stroke-width="2"/>
                        <text x="280" y="65" fill="${color}" font-size="9">Pituitary (Master)</text>
                        
                        <!-- Pineal Gland -->
                        <ellipse cx="250" cy="30" rx="6" ry="5" fill="rgba(155,89,182,0.6)" stroke="#9b59b6" stroke-width="1.5"/>
                        <text x="265" y="32" fill="#9b59b6" font-size="7">Pineal</text>
                        
                        <!-- Thyroid Gland -->
                        <path d="M220,115 Q250,105 280,115 L275,140 Q250,150 225,140 Z" fill="rgba(230,126,34,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('thyroid')"/>
                        <path d="M240,115 L245,135 M255,115 L260,135" fill="none" stroke="#bf5c0c" stroke-width="1.5"/>
                        <text x="300" y="130" fill="${color}" font-size="9">Thyroid</text>
                        
                        <!-- Parathyroid Glands -->
                        <circle cx="228" cy="130" r="5" fill="rgba(231,76,60,0.5)" stroke="#e74c3c" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('parathyroid')"/>
                        <circle cx="272" cy="130" r="5" fill="rgba(231,76,60,0.5)" stroke="#e74c3c" stroke-width="1.5"/>
                        <circle cx="228" cy="140" r="4" fill="rgba(231,76,60,0.5)" stroke="#e74c3c" stroke-width="1"/>
                        <circle cx="272" cy="140" r="4" fill="rgba(231,76,60,0.5)" stroke="#e74c3c" stroke-width="1"/>
                        <text x="180" y="135" fill="#e74c3c" font-size="7">Parathyroids</text>
                        
                        <!-- Thymus -->
                        <ellipse cx="250" cy="175" rx="20" ry="25" fill="rgba(26,188,156,0.4)" stroke="#1abc9c" stroke-width="2"/>
                        <text x="280" y="180" fill="#1abc9c" font-size="8">Thymus</text>
                        
                        <!-- Adrenal Glands -->
                        <path d="M200,285 Q195,270 210,270 Q225,270 220,285 Z" fill="rgba(241,196,15,0.6)" stroke="#f1c40f" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('adrenal')"/>
                        <path d="M280,285 Q275,270 290,270 Q305,270 300,285 Z" fill="rgba(241,196,15,0.6)" stroke="#f1c40f" stroke-width="2"/>
                        <text x="155" y="280" fill="#d4a10a" font-size="8">Adrenal</text>
                        <text x="315" y="280" fill="#d4a10a" font-size="8">Adrenal</text>
                        
                        <!-- Kidneys (context) -->
                        <ellipse cx="210" cy="310" rx="18" ry="30" fill="rgba(192,57,43,0.2)" stroke="#c0392b" stroke-width="1" stroke-dasharray="3,2"/>
                        <ellipse cx="290" cy="310" rx="18" ry="30" fill="rgba(192,57,43,0.2)" stroke="#c0392b" stroke-width="1" stroke-dasharray="3,2"/>
                        
                        <!-- Pancreas (endocrine portion) -->
                        <path d="M210,360 Q255,350 285,365 L280,380 Q250,370 205,380 Z" fill="rgba(230,126,34,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('pancreas')"/>
                        <circle cx="245" cy="370" r="5" fill="rgba(52,152,219,0.6)" stroke="#3498db" stroke-width="1"/>
                        <circle cx="260" cy="368" r="4" fill="rgba(52,152,219,0.6)" stroke="#3498db" stroke-width="1"/>
                        <circle cx="232" cy="372" r="4" fill="rgba(52,152,219,0.6)" stroke="#3498db" stroke-width="1"/>
                        <text x="300" y="375" fill="${color}" font-size="8">Pancreas</text>
                        <text x="300" y="385" fill="#3498db" font-size="7">(Islets)</text>
                        
                        <!-- Gonads (ovaries/testes represented abstractly) -->
                        <ellipse cx="220" cy="450" rx="15" ry="20" fill="rgba(155,89,182,0.5)" stroke="#9b59b6" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('gonads')"/>
                        <ellipse cx="280" cy="450" rx="15" ry="20" fill="rgba(155,89,182,0.5)" stroke="#9b59b6" stroke-width="2"/>
                        <text x="250" y="485" text-anchor="middle" fill="#9b59b6" font-size="9">Gonads</text>
                        
                        <!-- Hormone pathways (dotted lines) -->
                        <line x1="250" y1="68" x2="250" y2="105" stroke="${color}" stroke-width="1" stroke-dasharray="3,2"/>
                        <line x1="250" y1="150" x2="210" y2="270" stroke="${color}" stroke-width="1" stroke-dasharray="3,2"/>
                        <line x1="250" y1="150" x2="290" y2="270" stroke="${color}" stroke-width="1" stroke-dasharray="3,2"/>
                        <line x1="250" y1="68" x2="245" y2="350" stroke="${color}" stroke-width="1" stroke-dasharray="3,2"/>
                    </g>`;
            } else if (system === 'lymphatic') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Body outline -->
                        <ellipse cx="250" cy="55" rx="40" ry="48" fill="rgba(26,188,156,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        <ellipse cx="250" cy="300" rx="70" ry="180" fill="rgba(26,188,156,0.1)" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        
                        <!-- Tonsils -->
                        <ellipse cx="235" cy="75" rx="8" ry="10" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('tonsils')"/>
                        <ellipse cx="265" cy="75" rx="8" ry="10" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="2"/>
                        <text x="280" y="80" fill="${color}" font-size="8">Tonsils</text>
                        
                        <!-- Cervical lymph nodes -->
                        <circle cx="225" cy="100" r="6" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="1.5" class="anatomy-part" onclick="explainAnatomyPart('lymphnodes')"/>
                        <circle cx="275" cy="100" r="6" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="1.5"/>
                        <circle cx="220" cy="115" r="5" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="280" cy="115" r="5" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <text x="165" y="108" fill="${color}" font-size="7">Cervical Nodes</text>
                        
                        <!-- Thymus -->
                        <ellipse cx="250" cy="165" rx="25" ry="30" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('thymus')"/>
                        <text x="250" y="170" text-anchor="middle" fill="#fff" font-size="9">Thymus</text>
                        
                        <!-- Axillary lymph nodes -->
                        <circle cx="175" cy="155" r="8" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('lymphnodes')"/>
                        <circle cx="325" cy="155" r="8" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="2"/>
                        <circle cx="168" cy="168" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="332" cy="168" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <text x="130" y="160" fill="${color}" font-size="7">Axillary</text>
                        
                        <!-- Spleen -->
                        <ellipse cx="315" cy="260" rx="25" ry="35" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="2.5" class="anatomy-part" onclick="explainAnatomyPart('spleen')"/>
                        <text x="315" y="265" text-anchor="middle" fill="#fff" font-size="10">Spleen</text>
                        
                        <!-- Abdominal lymph nodes -->
                        <circle cx="230" cy="300" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1.5"/>
                        <circle cx="270" cy="300" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1.5"/>
                        <circle cx="250" cy="320" r="5" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        
                        <!-- Inguinal lymph nodes -->
                        <circle cx="210" cy="420" r="8" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('lymphnodes')"/>
                        <circle cx="290" cy="420" r="8" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="2"/>
                        <circle cx="200" cy="435" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <circle cx="300" cy="435" r="6" fill="rgba(26,188,156,0.5)" stroke="${color}" stroke-width="1"/>
                        <text x="155" y="425" fill="${color}" font-size="7">Inguinal</text>
                        
                        <!-- Lymph vessels -->
                        <line x1="225" y1="108" x2="180" y2="150" stroke="${color}" stroke-width="2" stroke-dasharray="4,2" class="anatomy-part" onclick="explainAnatomyPart('lymphvessels')"/>
                        <line x1="275" y1="108" x2="320" y2="150" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        
                        <line x1="175" y1="163" x2="160" y2="280" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        <line x1="325" y1="163" x2="340" y2="280" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        
                        <line x1="250" y1="195" x2="230" y2="295" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        <line x1="250" y1="195" x2="270" y2="295" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        
                        <line x1="230" y1="308" x2="210" y2="412" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        <line x1="270" y1="308" x2="290" y2="412" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        
                        <line x1="210" y1="428" x2="200" y2="550" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        <line x1="290" y1="428" x2="300" y2="550" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        
                        <!-- Thoracic duct -->
                        <path d="M250,325 Q245,280 250,195" fill="none" stroke="#16a085" stroke-width="3"/>
                        <text x="265" y="260" fill="#16a085" font-size="8">Thoracic Duct</text>
                        
                        <!-- Legend -->
                        <rect x="375" y="50" width="95" height="60" fill="rgba(20,20,35,0.8)" rx="5"/>
                        <circle cx="385" cy="65" r="5" fill="rgba(26,188,156,0.6)" stroke="${color}" stroke-width="1"/>
                        <text x="395" y="68" fill="${color}" font-size="7">Lymph Nodes</text>
                        <line x1="380" y1="85" x2="400" y2="85" stroke="${color}" stroke-width="2" stroke-dasharray="4,2"/>
                        <text x="405" y="88" fill="${color}" font-size="7">Lymph Vessels</text>
                    </g>`;
            } else if (system === 'integumentary') {
                svgContent = `
                    <g class="anatomy-layer">
                        <!-- Skin cross-section (large detailed view) -->
                        <rect x="50" y="80" width="400" height="500" rx="10" fill="rgba(212,165,116,0.15)" stroke="#888" stroke-width="1"/>
                        <text x="250" y="60" text-anchor="middle" fill="${color}" font-size="14">Skin Cross-Section</text>
                        
                        <!-- Epidermis -->
                        <rect x="60" y="100" width="380" height="80" rx="5" fill="rgba(212,165,116,0.6)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('epidermis')"/>
                        <text x="250" y="145" text-anchor="middle" fill="#8b5a2b" font-size="12">Epidermis</text>
                        
                        <!-- Epidermis layers -->
                        <line x1="60" y1="115" x2="440" y2="115" stroke="#a0764d" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="450" y="112" fill="#888" font-size="8">Stratum Corneum</text>
                        <line x1="60" y1="135" x2="440" y2="135" stroke="#a0764d" stroke-width="1" stroke-dasharray="5,3"/>
                        <line x1="60" y1="155" x2="440" y2="155" stroke="#a0764d" stroke-width="1" stroke-dasharray="5,3"/>
                        <line x1="60" y1="170" x2="440" y2="170" stroke="#a0764d" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="450" y="175" fill="#888" font-size="8">Basal Layer</text>
                        
                        <!-- Dermis -->
                        <rect x="60" y="180" width="380" height="200" rx="5" fill="rgba(245,176,144,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('dermis')"/>
                        <text x="250" y="280" text-anchor="middle" fill="#a0522d" font-size="14">Dermis</text>
                        
                        <!-- Blood vessels in dermis -->
                        <path d="M100,220 Q130,200 160,220 Q190,240 220,220 Q250,200 280,220 Q310,240 340,220 Q370,200 400,220" fill="none" stroke="#e74c3c" stroke-width="2"/>
                        <path d="M100,260 Q130,280 160,260 Q190,240 220,260 Q250,280 280,260 Q310,240 340,260 Q370,280 400,260" fill="none" stroke="#3498db" stroke-width="2"/>
                        <text x="420" y="245" fill="#c0392b" font-size="8">Blood Vessels</text>
                        
                        <!-- Nerve endings -->
                        <circle cx="120" cy="320" r="8" fill="rgba(241,196,15,0.5)" stroke="#f1c40f" stroke-width="1.5"/>
                        <circle cx="200" cy="340" r="6" fill="rgba(241,196,15,0.5)" stroke="#f1c40f" stroke-width="1.5"/>
                        <circle cx="280" cy="315" r="7" fill="rgba(241,196,15,0.5)" stroke="#f1c40f" stroke-width="1.5"/>
                        <circle cx="360" cy="335" r="8" fill="rgba(241,196,15,0.5)" stroke="#f1c40f" stroke-width="1.5"/>
                        <text x="420" y="330" fill="#d4a10a" font-size="8">Nerve Endings</text>
                        
                        <!-- Hair follicles -->
                        <path d="M140,100 L140,300 Q140,330 160,330 Q180,330 180,300 L180,100" fill="rgba(139,69,19,0.3)" stroke="#8B4513" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('hair')"/>
                        <line x1="160" y1="50" x2="160" y2="100" stroke="#5d3a1a" stroke-width="3"/>
                        <text x="185" y="320" fill="#8B4513" font-size="8">Hair Follicle</text>
                        
                        <path d="M300,100 L300,280 Q300,310 320,310 Q340,310 340,280 L340,100" fill="rgba(139,69,19,0.3)" stroke="#8B4513" stroke-width="2"/>
                        <line x1="320" y1="40" x2="320" y2="100" stroke="#5d3a1a" stroke-width="3"/>
                        
                        <!-- Sebaceous glands -->
                        <ellipse cx="175" cy="200" rx="15" ry="20" fill="rgba(241,196,15,0.4)" stroke="#f1c40f" stroke-width="1.5"/>
                        <ellipse cx="335" cy="190" rx="15" ry="20" fill="rgba(241,196,15,0.4)" stroke="#f1c40f" stroke-width="1.5"/>
                        <text x="420" y="200" fill="#d4a10a" font-size="8">Sebaceous Gland</text>
                        
                        <!-- Hypodermis -->
                        <rect x="60" y="380" width="380" height="180" rx="5" fill="rgba(255,223,186,0.5)" stroke="${color}" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('hypodermis')"/>
                        <text x="250" y="470" text-anchor="middle" fill="#cd853f" font-size="14">Hypodermis</text>
                        
                        <!-- Fat cells -->
                        <circle cx="100" cy="430" r="20" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="150" cy="450" r="25" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="200" cy="420" r="22" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="250" cy="455" r="20" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="300" cy="425" r="24" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="350" cy="450" r="21" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <circle cx="400" cy="430" r="23" fill="rgba(255,239,213,0.7)" stroke="#deb887" stroke-width="1.5"/>
                        <text x="420" y="470" fill="#deb887" font-size="8">Fat Cells</text>
                        
                        <!-- Sweat glands -->
                        <path d="M230,300 Q215,380 230,400 Q245,380 230,300" fill="none" stroke="#3498db" stroke-width="2" class="anatomy-part" onclick="explainAnatomyPart('sweatglands')"/>
                        <path d="M230,100 L230,300" fill="none" stroke="#3498db" stroke-width="1.5" stroke-dasharray="3,2"/>
                        <text x="240" y="405" fill="#2980b9" font-size="8">Sweat Gland</text>
                    </g>`;
            }
            
            svg.innerHTML = svgContent;
        }

        function renderAnimalAnatomy(animal, view = 'external') {
            const svg = document.getElementById('anatomySvg');
            const data = ANATOMY_DATA.animal[animal];
            
            const animalColors = {
                mammal: { main: '#8B5A2B', fill: 'rgba(139,90,43,0.5)', bone: '#e8d4b8', organ: '#9b59b6', muscle: '#dc3545' },
                bird: { main: '#4682B4', fill: 'rgba(70,130,180,0.5)', bone: '#e8d4b8', organ: '#9b59b6', muscle: '#dc3545' },
                fish: { main: '#00BFFF', fill: 'rgba(0,191,255,0.4)', bone: '#e8d4b8', organ: '#9b59b6', muscle: '#dc3545' },
                reptile: { main: '#228B22', fill: 'rgba(34,139,34,0.5)', bone: '#e8d4b8', organ: '#9b59b6', muscle: '#dc3545' },
                insect: { main: '#8B4513', fill: 'rgba(139,69,19,0.5)', bone: '#d4a574', organ: '#e67e22', muscle: '#cd853f' },
                amphibian: { main: '#32CD32', fill: 'rgba(50,205,50,0.5)', bone: '#e8d4b8', organ: '#9b59b6', muscle: '#dc3545' }
            };
            const colors = animalColors[animal];
            
            let svgContent = '';
            
            if (animal === 'mammal') {
                if (view === 'external') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Mammal (Dog) - External</text>
                        <!-- Head -->
                        <ellipse cx="120" cy="220" rx="55" ry="45" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('mammal', 'head')"/>
                        <circle cx="95" cy="200" r="10" fill="#333"/>
                        <circle cx="93" cy="198" r="3" fill="#fff"/>
                        <ellipse cx="125" cy="235" rx="20" ry="12" fill="rgba(0,0,0,0.2)" stroke="${colors.main}" stroke-width="1"/>
                        <circle cx="120" cy="232" r="4" fill="#333"/>
                        <circle cx="130" cy="232" r="4" fill="#333"/>
                        <!-- Ears -->
                        <ellipse cx="90" cy="175" rx="15" ry="25" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <ellipse cx="140" cy="175" rx="15" ry="25" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <!-- Body -->
                        <ellipse cx="280" cy="230" rx="130" ry="75" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('mammal', 'body')"/>
                        <text x="280" y="235" text-anchor="middle" fill="#fff" font-size="11">Body</text>
                        <!-- Legs -->
                        <rect x="170" y="290" width="25" height="100" rx="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'limbs')"/>
                        <rect x="210" y="295" width="22" height="95" rx="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <rect x="330" y="290" width="25" height="100" rx="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <rect x="370" y="295" width="22" height="95" rx="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <!-- Paws -->
                        <ellipse cx="182" cy="395" rx="18" ry="10" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <ellipse cx="221" cy="395" rx="15" ry="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <ellipse cx="342" cy="395" rx="18" ry="10" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <ellipse cx="381" cy="395" rx="15" ry="8" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <!-- Tail -->
                        <path d="M410,230 Q450,200 470,250 Q455,280 430,260" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'tail')"/>
                        <text x="460" y="240" fill="${colors.main}" font-size="9">Tail</text>
                    </g>`;
                } else if (view === 'skeletal') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.bone}" font-size="14">Mammal (Dog) - Skeletal System</text>
                        <!-- Skull -->
                        <ellipse cx="120" cy="220" rx="50" ry="40" fill="none" stroke="${colors.bone}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'skull')"/>
                        <ellipse cx="100" cy="210" rx="8" ry="6" fill="none" stroke="${colors.bone}" stroke-width="1"/>
                        <path d="M115,240 L135,250 L115,250 Z" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <text x="120" y="180" text-anchor="middle" fill="#888" font-size="9">Skull</text>
                        <!-- Spine -->
                        <path d="M170,220 Q280,190 400,220" fill="none" stroke="${colors.bone}" stroke-width="6" stroke-linecap="round" class="anatomy-part" onclick="explainAnimalPart('mammal', 'spine')"/>
                        <text x="280" y="180" text-anchor="middle" fill="#888" font-size="9">Vertebral Column</text>
                        <!-- Ribcage -->
                        <ellipse cx="250" cy="240" rx="70" ry="50" fill="none" stroke="${colors.bone}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'ribs')"/>
                        <path d="M200,210 Q250,230 300,210" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <path d="M195,230 Q250,255 305,230" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <path d="M200,250 Q250,280 300,250" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <text x="250" y="245" text-anchor="middle" fill="#888" font-size="9">Ribs</text>
                        <!-- Pelvis -->
                        <ellipse cx="370" cy="240" rx="40" ry="30" fill="none" stroke="${colors.bone}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'pelvis')"/>
                        <text x="370" y="275" fill="#888" font-size="8">Pelvis</text>
                        <!-- Front legs (scapula, humerus, radius/ulna) -->
                        <path d="M190,200 L175,220 L195,235 L210,210 Z" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <line x1="185" y1="235" x2="180" y2="310" stroke="${colors.bone}" stroke-width="5" stroke-linecap="round"/>
                        <line x1="180" y1="310" x2="178" y2="380" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="222" y1="235" x2="218" y2="310" stroke="${colors.bone}" stroke-width="5" stroke-linecap="round"/>
                        <line x1="218" y1="310" x2="216" y2="380" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <text x="155" y="330" fill="#888" font-size="8">Humerus</text>
                        <!-- Hind legs (femur, tibia/fibula) -->
                        <line x1="355" y1="265" x2="345" y2="340" stroke="${colors.bone}" stroke-width="6" stroke-linecap="round" class="anatomy-part" onclick="explainAnimalPart('mammal', 'femur')"/>
                        <line x1="345" y1="340" x2="342" y2="385" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="385" y1="265" x2="390" y2="340" stroke="${colors.bone}" stroke-width="6" stroke-linecap="round"/>
                        <line x1="390" y1="340" x2="392" y2="385" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <text x="400" y="330" fill="#888" font-size="8">Femur</text>
                        <!-- Tail vertebrae -->
                        <path d="M410,235 Q440,220 460,240" fill="none" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                    </g>`;
                } else if (view === 'organs') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.organ}" font-size="14">Mammal (Dog) - Internal Organs</text>
                        <!-- Body outline (faded) -->
                        <ellipse cx="280" cy="230" rx="130" ry="75" fill="none" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        <!-- Brain -->
                        <ellipse cx="120" cy="210" rx="25" ry="20" fill="rgba(233,196,196,0.5)" stroke="#e8a8a8" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'brain')"/>
                        <text x="120" y="215" text-anchor="middle" fill="#8b4a4a" font-size="8">Brain</text>
                        <!-- Trachea/Esophagus -->
                        <rect x="165" y="205" width="8" height="40" rx="3" fill="rgba(52,152,219,0.4)" stroke="#3498db" stroke-width="1"/>
                        <!-- Lungs -->
                        <ellipse cx="220" cy="220" rx="35" ry="45" fill="rgba(52,152,219,0.35)" stroke="#3498db" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'lungs')"/>
                        <text x="220" y="225" text-anchor="middle" fill="#2980b9" font-size="8">Lung</text>
                        <!-- Heart -->
                        <path d="M250,210 Q240,195 255,185 Q270,195 270,210 Q280,200 290,210 Q285,235 270,250 Q255,240 250,235 Q245,225 250,210 Z" fill="rgba(231,76,60,0.6)" stroke="#c0392b" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'heart')"/>
                        <text x="268" y="225" text-anchor="middle" fill="#fff" font-size="7">Heart</text>
                        <!-- Liver -->
                        <ellipse cx="310" cy="250" rx="35" ry="25" fill="rgba(139,69,19,0.5)" stroke="#8B4513" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'liver')"/>
                        <text x="310" y="255" text-anchor="middle" fill="#fff" font-size="8">Liver</text>
                        <!-- Stomach -->
                        <ellipse cx="280" cy="290" rx="30" ry="25" fill="rgba(241,196,15,0.4)" stroke="#f1c40f" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'stomach')"/>
                        <text x="280" y="295" text-anchor="middle" fill="#8a6d0b" font-size="8">Stomach</text>
                        <!-- Kidneys -->
                        <ellipse cx="340" cy="285" rx="15" ry="20" fill="rgba(192,57,43,0.4)" stroke="#c0392b" stroke-width="1.5" class="anatomy-part" onclick="explainAnimalPart('mammal', 'kidneys')"/>
                        <ellipse cx="375" cy="280" rx="15" ry="20" fill="rgba(192,57,43,0.4)" stroke="#c0392b" stroke-width="1.5"/>
                        <text x="400" y="285" fill="#c0392b" font-size="7">Kidneys</text>
                        <!-- Intestines -->
                        <path d="M300,315 Q280,330 300,345 Q320,360 300,375 Q280,390 300,400" fill="none" stroke="#e67e22" stroke-width="4" stroke-linecap="round"/>
                        <text x="330" y="360" fill="#e67e22" font-size="7">Intestines</text>
                        <!-- Bladder -->
                        <ellipse cx="370" cy="320" rx="18" ry="15" fill="rgba(241,196,15,0.3)" stroke="#d4a10a" stroke-width="1.5"/>
                        <text x="395" y="325" fill="#888" font-size="7">Bladder</text>
                    </g>`;
                } else if (view === 'muscular') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.muscle}" font-size="14">Mammal (Dog) - Muscular System</text>
                        <!-- Head muscles -->
                        <ellipse cx="120" cy="220" rx="50" ry="40" fill="rgba(220,53,69,0.35)" stroke="${colors.muscle}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'jaw_muscles')"/>
                        <path d="M100,230 Q120,245 140,230" fill="rgba(220,53,69,0.4)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="120" y="235" text-anchor="middle" fill="#fff" font-size="7">Masseter</text>
                        <!-- Neck muscles -->
                        <path d="M160,200 Q170,220 160,240 L195,260 Q210,240 195,215 Z" fill="rgba(220,53,69,0.4)" stroke="${colors.muscle}" stroke-width="1.5" class="anatomy-part" onclick="explainAnimalPart('mammal', 'neck_muscles')"/>
                        <text x="175" y="235" fill="#fff" font-size="7">Neck</text>
                        <!-- Chest/shoulder muscles -->
                        <ellipse cx="220" cy="250" rx="40" ry="35" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'chest')"/>
                        <text x="220" y="255" text-anchor="middle" fill="#fff" font-size="8">Pectorals</text>
                        <!-- Back muscles -->
                        <path d="M200,190 Q290,160 380,190 L370,220 Q290,200 210,220 Z" fill="rgba(220,53,69,0.4)" stroke="${colors.muscle}" stroke-width="1.5" class="anatomy-part" onclick="explainAnimalPart('mammal', 'back_muscles')"/>
                        <text x="290" y="200" text-anchor="middle" fill="#fff" font-size="8">Longissimus</text>
                        <!-- Hindquarter muscles -->
                        <ellipse cx="370" cy="250" rx="50" ry="40" fill="rgba(220,53,69,0.5)" stroke="${colors.muscle}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'hindquarters')"/>
                        <text x="370" y="255" text-anchor="middle" fill="#fff" font-size="8">Gluteals</text>
                        <!-- Front leg muscles -->
                        <ellipse cx="185" cy="330" rx="18" ry="45" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <ellipse cx="220" cy="335" rx="15" ry="40" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <!-- Hind leg muscles -->
                        <ellipse cx="350" cy="330" rx="22" ry="50" fill="rgba(220,53,69,0.5)" stroke="${colors.muscle}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('mammal', 'thigh_muscles')"/>
                        <ellipse cx="385" cy="335" rx="18" ry="45" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="350" y="335" text-anchor="middle" fill="#fff" font-size="7">Quads</text>
                        <!-- Abdominal muscles -->
                        <path d="M240,275 Q290,285 340,275 L335,310 Q290,320 245,310 Z" fill="rgba(220,53,69,0.35)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="290" y="295" text-anchor="middle" fill="#fff" font-size="7">Abdominals</text>
                    </g>`;
                }
            } else if (animal === 'bird') {
                if (view === 'external') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Bird (Eagle) - External</text>
                        <!-- Head -->
                        <circle cx="140" cy="160" r="40" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('bird', 'head')"/>
                        <circle cx="125" cy="150" r="10" fill="#333"/>
                        <circle cx="123" cy="148" r="3" fill="#fff"/>
                        <!-- Beak -->
                        <polygon points="100,165 50,160 55,175 100,175" fill="#FFA500" stroke="#FF8C00" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'beak')"/>
                        <text x="65" y="190" fill="#FF8C00" font-size="8">Beak</text>
                        <!-- Body -->
                        <ellipse cx="270" cy="220" rx="100" ry="65" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('bird', 'body')"/>
                        <text x="270" y="225" text-anchor="middle" fill="#fff" font-size="11">Body</text>
                        <!-- Wings -->
                        <path d="M200,180 Q120,100 50,130 Q80,150 100,140 Q130,155 150,145 Q170,165 180,160" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'wings')"/>
                        <path d="M340,180 Q420,100 490,130 Q460,150 440,140 Q410,155 390,145 Q370,165 360,160" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <text x="80" y="105" fill="${colors.main}" font-size="9">Wing</text>
                        <!-- Tail feathers -->
                        <polygon points="370,220 450,180 460,220 450,260" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'tail')"/>
                        <text x="455" y="225" fill="${colors.main}" font-size="8">Tail</text>
                        <!-- Legs -->
                        <line x1="240" y1="285" x2="230" y2="360" stroke="#FFA500" stroke-width="5"/>
                        <line x1="300" y1="285" x2="310" y2="360" stroke="#FFA500" stroke-width="5"/>
                        <!-- Talons -->
                        <path d="M210,360 L230,360 L235,380 M230,360 L230,385 M230,360 L250,365" fill="none" stroke="#FFA500" stroke-width="3" class="anatomy-part" onclick="explainAnimalPart('bird', 'talons')"/>
                        <path d="M290,360 L310,360 L305,380 M310,360 L310,385 M310,360 L330,365" fill="none" stroke="#FFA500" stroke-width="3"/>
                        <text x="250" y="400" fill="#FF8C00" font-size="8">Talons</text>
                    </g>`;
                } else if (view === 'skeletal') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.bone}" font-size="14">Bird - Skeletal System (Hollow Bones)</text>
                        <!-- Skull -->
                        <ellipse cx="140" cy="160" rx="35" ry="30" fill="none" stroke="${colors.bone}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'skull')"/>
                        <ellipse cx="120" cy="150" rx="8" ry="6" fill="none" stroke="${colors.bone}" stroke-width="1"/>
                        <text x="140" y="125" text-anchor="middle" fill="#888" font-size="8">Skull</text>
                        <!-- Beak bone -->
                        <polygon points="105,165 60,160 65,175 105,170" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <!-- Vertebrae -->
                        <path d="M175,165 Q240,140 330,180" fill="none" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <text x="250" y="135" text-anchor="middle" fill="#888" font-size="8">Vertebrae</text>
                        <!-- Wishbone (furcula) -->
                        <path d="M200,175 Q220,200 200,220 M240,175 Q220,200 240,220" fill="none" stroke="${colors.bone}" stroke-width="3" class="anatomy-part" onclick="explainAnimalPart('bird', 'wishbone')"/>
                        <text x="220" y="245" text-anchor="middle" fill="#888" font-size="7">Wishbone</text>
                        <!-- Keel (sternum) -->
                        <path d="M210,220 L220,280 L270,280 L280,220" fill="none" stroke="${colors.bone}" stroke-width="3" class="anatomy-part" onclick="explainAnimalPart('bird', 'keel')"/>
                        <text x="245" y="260" text-anchor="middle" fill="#888" font-size="8">Keel</text>
                        <!-- Ribs -->
                        <path d="M200,200 Q245,215 290,200" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <path d="M195,220 Q245,240 295,220" fill="none" stroke="${colors.bone}" stroke-width="1.5"/>
                        <!-- Wing bones (hollow) -->
                        <line x1="195" y1="180" x2="140" y2="130" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="140" y1="130" x2="80" y2="110" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                        <line x1="295" y1="180" x2="350" y2="130" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="350" y1="130" x2="410" y2="110" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                        <text x="110" y="100" fill="#888" font-size="7">Wing (Hollow)</text>
                        <!-- Pelvis -->
                        <ellipse cx="320" cy="200" rx="25" ry="15" fill="none" stroke="${colors.bone}" stroke-width="2"/>
                        <!-- Leg bones -->
                        <line x1="240" y1="280" x2="235" y2="340" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="235" y1="340" x2="230" y2="380" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                        <line x1="270" y1="280" x2="275" y2="340" stroke="${colors.bone}" stroke-width="4" stroke-linecap="round"/>
                        <line x1="275" y1="340" x2="280" y2="380" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                        <!-- Tail vertebrae -->
                        <path d="M340,190 L380,200 L400,195" fill="none" stroke="${colors.bone}" stroke-width="3" stroke-linecap="round"/>
                    </g>`;
                } else if (view === 'organs') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.organ}" font-size="14">Bird - Internal Organs</text>
                        <!-- Body outline -->
                        <ellipse cx="270" cy="220" rx="100" ry="65" fill="none" stroke="#888" stroke-width="1" stroke-dasharray="5,3"/>
                        <!-- Brain -->
                        <ellipse cx="140" cy="155" rx="20" ry="15" fill="rgba(233,196,196,0.5)" stroke="#e8a8a8" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'brain')"/>
                        <text x="140" y="158" text-anchor="middle" fill="#8b4a4a" font-size="7">Brain</text>
                        <!-- Heart (large, efficient) -->
                        <path d="M230,195 Q220,180 235,170 Q250,180 250,195 Q260,185 270,195 Q265,215 250,230 Q235,220 230,215 Q225,205 230,195 Z" fill="rgba(231,76,60,0.6)" stroke="#c0392b" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'heart')"/>
                        <text x="248" y="205" text-anchor="middle" fill="#fff" font-size="7">Heart</text>
                        <!-- Lungs + Air Sacs -->
                        <ellipse cx="280" cy="190" rx="25" ry="30" fill="rgba(52,152,219,0.35)" stroke="#3498db" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'lungs')"/>
                        <text x="280" y="195" text-anchor="middle" fill="#2980b9" font-size="7">Lung</text>
                        <!-- Air sacs -->
                        <ellipse cx="200" cy="200" rx="15" ry="20" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="1" stroke-dasharray="3,2" class="anatomy-part" onclick="explainAnimalPart('bird', 'air_sacs')"/>
                        <ellipse cx="320" cy="200" rx="15" ry="20" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="1" stroke-dasharray="3,2"/>
                        <text x="185" y="230" fill="#3498db" font-size="6">Air Sacs</text>
                        <!-- Gizzard -->
                        <ellipse cx="260" cy="250" rx="20" ry="25" fill="rgba(241,196,15,0.5)" stroke="#f1c40f" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('bird', 'gizzard')"/>
                        <text x="260" y="255" text-anchor="middle" fill="#8a6d0b" font-size="7">Gizzard</text>
                        <!-- Liver -->
                        <ellipse cx="300" cy="235" rx="25" ry="18" fill="rgba(139,69,19,0.5)" stroke="#8B4513" stroke-width="1.5" class="anatomy-part" onclick="explainAnimalPart('bird', 'liver')"/>
                        <text x="300" y="240" text-anchor="middle" fill="#fff" font-size="7">Liver</text>
                        <!-- Intestines -->
                        <path d="M280,280 Q260,295 280,310 Q300,325 280,340" fill="none" stroke="#e67e22" stroke-width="3" stroke-linecap="round"/>
                        <text x="310" y="315" fill="#e67e22" font-size="6">Intestine</text>
                        <!-- Kidneys -->
                        <ellipse cx="330" cy="250" rx="12" ry="15" fill="rgba(192,57,43,0.4)" stroke="#c0392b" stroke-width="1.5"/>
                        <text x="350" y="255" fill="#c0392b" font-size="6">Kidney</text>
                    </g>`;
                } else if (view === 'muscular') {
                    svgContent = `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.muscle}" font-size="14">Bird - Muscular System (Flight Muscles)</text>
                        <!-- Body outline -->
                        <ellipse cx="270" cy="220" rx="100" ry="65" fill="rgba(220,53,69,0.15)" stroke="#888" stroke-width="1"/>
                        <!-- Pectoralis major (main flight muscle) -->
                        <path d="M200,180 Q250,170 300,180 L295,260 Q250,280 205,260 Z" fill="rgba(220,53,69,0.6)" stroke="${colors.muscle}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('bird', 'flight_muscles')"/>
                        <text x="250" y="225" text-anchor="middle" fill="#fff" font-size="10">Pectoralis Major</text>
                        <text x="250" y="240" text-anchor="middle" fill="#fff" font-size="7">(Main Flight Muscle)</text>
                        <!-- Supracoracoideus -->
                        <path d="M210,175 Q250,165 290,175 L285,195 Q250,205 215,195 Z" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="250" y="190" text-anchor="middle" fill="#fff" font-size="7">Supracoracoideus</text>
                        <!-- Wing muscles -->
                        <path d="M195,175 L140,130 L80,115 L85,125 L145,145 L200,185" fill="rgba(220,53,69,0.4)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <path d="M305,175 L360,130 L420,115 L415,125 L355,145 L300,185" fill="rgba(220,53,69,0.4)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="110" y="105" fill="#888" font-size="7">Wing Extensors</text>
                        <!-- Leg muscles -->
                        <ellipse cx="240" cy="310" rx="18" ry="35" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5" class="anatomy-part" onclick="explainAnimalPart('bird', 'leg_muscles')"/>
                        <ellipse cx="280" cy="310" rx="18" ry="35" fill="rgba(220,53,69,0.45)" stroke="${colors.muscle}" stroke-width="1.5"/>
                        <text x="260" y="360" text-anchor="middle" fill="#888" font-size="7">Leg Muscles</text>
                        <!-- Neck muscles -->
                        <path d="M175,170 Q155,180 160,200 L180,195 Q175,180 185,175" fill="rgba(220,53,69,0.35)" stroke="${colors.muscle}" stroke-width="1"/>
                        <text x="145" y="195" fill="#888" font-size="6">Neck</text>
                    </g>`;
                }
            } else {
                // Simplified versions for other animals - external only for now
                const simpleAnimalSvgs = {
                    fish: `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Fish - ${view === 'external' ? 'External' : view.charAt(0).toUpperCase() + view.slice(1)}</text>
                        <ellipse cx="250" cy="220" rx="150" ry="60" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('fish', 'body')"/>
                        <polygon points="400,220 470,170 470,270" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('fish', 'tail')"/>
                        <circle cx="130" cy="205" r="12" fill="#333"/>
                        <circle cx="127" cy="202" r="4" fill="#fff"/>
                        <path d="M250,160 L250,100 L270,120 L250,115 L230,120 Z" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('fish', 'dorsal_fin')"/>
                        <path d="M180,260 L160,320 L200,320 Z" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <path d="M320,260 L300,320 L340,320 Z" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <path d="M150,200 Q175,220 150,240" fill="none" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('fish', 'gills')"/>
                        <path d="M160,200 Q185,220 160,240" fill="none" stroke="${colors.main}" stroke-width="1.5"/>
                        <path d="M170,200 Q195,220 170,240" fill="none" stroke="${colors.main}" stroke-width="1"/>
                        <text x="145" y="265" fill="${colors.main}" font-size="9">Gills</text>
                        <path d="M200,220 Q250,200 300,220 Q250,240 200,220" fill="none" stroke="${colors.main}" stroke-width="1" stroke-dasharray="5,3"/>
                        <text x="250" y="250" text-anchor="middle" fill="${colors.main}" font-size="8">Lateral Line</text>
                    </g>`,
                    reptile: `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Reptile (Lizard) - ${view === 'external' ? 'External' : view.charAt(0).toUpperCase() + view.slice(1)}</text>
                        <ellipse cx="130" cy="220" rx="50" ry="35" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('reptile', 'head')"/>
                        <circle cx="105" cy="205" r="10" fill="#333"/>
                        <circle cx="103" cy="203" r="3" fill="#fff"/>
                        <path d="M85,230 L60,225 L60,235 Z" fill="#cc0000" stroke="#990000"/>
                        <ellipse cx="280" cy="230" rx="120" ry="55" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('reptile', 'body')"/>
                        <text x="280" y="235" text-anchor="middle" fill="#fff" font-size="11">Body</text>
                        <rect x="180" y="275" width="20" height="80" rx="5" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <rect x="220" y="280" width="18" height="75" rx="5" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <rect x="320" y="275" width="20" height="80" rx="5" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <rect x="360" y="280" width="18" height="75" rx="5" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <path d="M400,230 Q450,210 480,240 Q470,260 450,250 Q430,270 400,250" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('reptile', 'tail')"/>
                        <text x="460" y="245" fill="${colors.main}" font-size="8">Tail</text>
                    </g>`,
                    insect: `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Insect (Beetle) - ${view === 'external' ? 'External' : view.charAt(0).toUpperCase() + view.slice(1)}</text>
                        <circle cx="130" cy="220" r="40" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('insect', 'head')"/>
                        <text x="130" y="225" text-anchor="middle" fill="#fff" font-size="10">Head</text>
                        <ellipse cx="115" cy="205" rx="10" ry="8" fill="#800000" stroke="#600000" stroke-width="1"/>
                        <ellipse cx="145" cy="205" rx="10" ry="8" fill="#800000" stroke="#600000" stroke-width="1"/>
                        <path d="M110,180 L80,140 M100,178 L65,155" fill="none" stroke="${colors.main}" stroke-width="3" class="anatomy-part" onclick="explainAnimalPart('insect', 'antennae')"/>
                        <text x="55" y="135" fill="${colors.main}" font-size="7">Antennae</text>
                        <ellipse cx="220" cy="220" rx="45" ry="35" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('insect', 'thorax')"/>
                        <text x="220" y="225" text-anchor="middle" fill="#fff" font-size="10">Thorax</text>
                        <ellipse cx="330" cy="220" rx="70" ry="45" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('insect', 'abdomen')"/>
                        <text x="330" y="225" text-anchor="middle" fill="#fff" font-size="10">Abdomen</text>
                        <line x1="200" y1="255" x2="170" y2="340" stroke="${colors.main}" stroke-width="4"/>
                        <line x1="220" y1="255" x2="210" y2="340" stroke="${colors.main}" stroke-width="4"/>
                        <line x1="240" y1="255" x2="260" y2="340" stroke="${colors.main}" stroke-width="4"/>
                        <text x="210" y="360" text-anchor="middle" fill="${colors.main}" font-size="8">6 Legs</text>
                    </g>`,
                    amphibian: `<g class="anatomy-layer">
                        <text x="250" y="50" text-anchor="middle" fill="${colors.main}" font-size="14">Amphibian (Frog) - ${view === 'external' ? 'External' : view.charAt(0).toUpperCase() + view.slice(1)}</text>
                        <ellipse cx="160" cy="210" rx="65" ry="50" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('amphibian', 'head')"/>
                        <circle cx="125" cy="175" r="18" fill="#333"/>
                        <circle cx="122" cy="172" r="6" fill="#90EE90"/>
                        <circle cx="195" cy="175" r="18" fill="#333"/>
                        <circle cx="192" cy="172" r="6" fill="#90EE90"/>
                        <ellipse cx="160" cy="225" rx="25" ry="10" fill="rgba(0,100,0,0.3)"/>
                        <circle cx="150" cy="232" r="3" fill="#333"/>
                        <circle cx="170" cy="232" r="3" fill="#333"/>
                        <ellipse cx="300" cy="220" rx="100" ry="60" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2.5" class="anatomy-part" onclick="explainAnimalPart('amphibian', 'body')"/>
                        <text x="300" y="225" text-anchor="middle" fill="#fff" font-size="11">Body</text>
                        <path d="M230,280 L190,360 L170,350 L180,330 L165,340 L185,310 L160,320 L200,290" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2" class="anatomy-part" onclick="explainAnimalPart('amphibian', 'limbs')"/>
                        <path d="M350,280 L400,360 L420,350 L410,330 L425,340 L405,310 L430,320 L390,290" fill="${colors.fill}" stroke="${colors.main}" stroke-width="2"/>
                        <text x="140" y="380" fill="${colors.main}" font-size="8">Webbed Feet</text>
                    </g>`
                };
                
                svgContent = simpleAnimalSvgs[animal] || `<g class="anatomy-layer"><text x="250" y="200" text-anchor="middle" fill="#888">Select an animal and view</text></g>`;
            }
            
            svg.innerHTML = svgContent;
            
            const infoPanel = document.getElementById('anatomyInfoPanel');
            const viewLabel = view === 'external' ? 'External Anatomy' : view.charAt(0).toUpperCase() + view.slice(1) + ' System';
            infoPanel.innerHTML = `
                <h4>${data.name}</h4>
                <p class="anatomy-info-desc"><strong>${viewLabel}</strong> - Example: ${data.example}</p>
                <div class="anatomy-quick-facts">
                    ${data.facts.map(f => `<div class="anatomy-fact"><div class="anatomy-fact-value">${f}</div></div>`).join('')}
                </div>
            `;
        }

        async function explainAnatomyPart(partId) {
            const system = ANATOMY_DATA.human[currentBodySystem];
            const partData = system[partId];
            
            if (!partData) return;
            
            const infoPanel = document.getElementById('anatomyInfoPanel');
            infoPanel.innerHTML = `
                <h4>${partData.name}</h4>
                <p class="anatomy-info-desc">${partData.function}</p>
                <div class="anatomy-quick-facts">
                    ${partData.facts.map(f => `<div class="anatomy-fact"><div class="anatomy-fact-value">${f}</div></div>`).join('')}
                </div>
                <p style="color:var(--text-muted);font-size:0.8rem;margin-top:1rem;">Getting AI explanation...</p>
            `;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: 'minerva',
                        message: `Explain the ${partData.name} in human anatomy. What is its structure, function, and why is it important? Keep it educational and concise (3-4 sentences).`,
                        mode: 'explain_short'
                    })
                });
                const data = await response.json();
                
                if (data.response) {
                    infoPanel.innerHTML += `<div class="anatomy-fact" style="margin-top:0.5rem;border-left-color:#9b59b6;"><div class="anatomy-fact-title">Minerva's Insight</div><div class="anatomy-fact-value">${data.response}</div></div>`;
                }
            } catch (err) {
                console.log('Could not get AI explanation');
            }
        }

        async function explainAnimalPart(animal, part) {
            const data = ANATOMY_DATA.animal[animal];
            const infoPanel = document.getElementById('anatomyInfoPanel');
            
            infoPanel.innerHTML = `
                <h4>${data.name} - ${part.charAt(0).toUpperCase() + part.slice(1)}</h4>
                <p class="anatomy-info-desc">Example: ${data.example}</p>
                <div class="anatomy-quick-facts">
                    ${data.facts.map(f => `<div class="anatomy-fact"><div class="anatomy-fact-value">${f}</div></div>`).join('')}
                </div>
                <p style="color:var(--text-muted);font-size:0.8rem;margin-top:1rem;">Getting AI explanation...</p>
            `;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: 'minerva',
                        message: `Explain the ${part} anatomy of a ${animal}. What makes it unique compared to other animals? Keep it educational (3-4 sentences).`,
                        mode: 'explain_short'
                    })
                });
                const resData = await response.json();
                
                if (resData.response) {
                    infoPanel.innerHTML += `<div class="anatomy-fact" style="margin-top:0.5rem;border-left-color:#9b59b6;"><div class="anatomy-fact-title">Minerva's Insight</div><div class="anatomy-fact-value">${resData.response}</div></div>`;
                }
            } catch (err) {
                console.log('Could not get AI explanation');
            }
        }

        // Drag & Drop handlers
        function handleDesignDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('designDropzone').classList.add('dragover');
        }

        function handleDesignDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('designDropzone').classList.remove('dragover');
        }

        function handleDesignDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('designDropzone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                processDesignImage(files[0]);
            }
        }

        function handleDesignFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processDesignImage(file);
            }
        }

        function processDesignImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                designReferenceImage = e.target.result;
                document.getElementById('dropzoneContent').style.display = 'none';
                document.getElementById('dropzonePreview').style.display = 'block';
                document.getElementById('dropzoneImage').src = designReferenceImage;
            };
            reader.readAsDataURL(file);
        }

        function removeDesignReference() {
            designReferenceImage = null;
            document.getElementById('dropzoneContent').style.display = 'block';
            document.getElementById('dropzonePreview').style.display = 'none';
            document.getElementById('dropzoneImage').src = '';
            document.getElementById('designFileInput').value = '';
        }

        // Texture & Color Scheme selection
        function selectTexture(texture) {
            selectedTexture = texture;
            document.querySelectorAll('.texture-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-texture="${texture}"]`).classList.add('active');
        }

        function selectColorScheme(scheme) {
            selectedColorScheme = scheme;
            document.querySelectorAll('.colorscheme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-scheme="${scheme}"]`).classList.add('active');
        }

        const COLOR_SCHEMES = {
            // Solid
            dark: { bg: '#0a0a0f', primary: '#50ff88', secondary: '#1a1a2e' },
            crimson: { bg: '#1a0a0a', primary: '#dc143c', secondary: '#8b0000' },
            teal: { bg: '#0a1a1a', primary: '#00d4aa', secondary: '#008080' },
            purple: { bg: '#0f0a1a', primary: '#6040ff', secondary: '#4b0082' },
            gold: { bg: '#1a1a0a', primary: '#ffd700', secondary: '#b8860b' },
            cyber: { bg: '#001a00', primary: '#00ff00', secondary: '#003300' },
            sunset: { bg: '#1a0f0a', primary: '#ff6b35', secondary: '#f7931e' },
            ice: { bg: '#0a1a1f', primary: '#a5f3fc', secondary: '#0ea5e9' },
            // Transparent / Glass
            'glass-dark': { bg: 'rgba(10,10,20,0.6)', primary: 'rgba(255,255,255,0.9)', secondary: 'rgba(30,30,50,0.4)', transparent: true },
            'glass-frost': { bg: 'rgba(255,255,255,0.15)', primary: 'rgba(0,0,0,0.8)', secondary: 'rgba(200,200,220,0.2)', transparent: true },
            'glass-crimson': { bg: 'rgba(220,20,60,0.4)', primary: '#ffffff', secondary: 'rgba(139,0,0,0.3)', transparent: true },
            'glass-teal': { bg: 'rgba(0,212,170,0.4)', primary: '#ffffff', secondary: 'rgba(0,128,128,0.3)', transparent: true },
            'glass-purple': { bg: 'rgba(96,64,255,0.4)', primary: '#ffffff', secondary: 'rgba(75,0,130,0.3)', transparent: true },
            'glass-gold': { bg: 'rgba(255,215,0,0.4)', primary: '#1a1a0a', secondary: 'rgba(184,134,11,0.3)', transparent: true },
            'smoke': { bg: 'rgba(50,50,60,0.5)', primary: 'rgba(255,255,255,0.9)', secondary: 'rgba(20,20,30,0.3)', transparent: true },
            'void': { bg: 'rgba(0,0,0,0.8)', primary: 'rgba(128,0,255,0.9)', secondary: 'rgba(20,0,40,0.6)', transparent: true }
        };

        const TEXTURE_DESCRIPTIONS = {
            none: '',
            metal: 'Add metallic sheen with subtle reflections and brushed metal texture.',
            glass: 'Add glass/frosted effect with transparency and blur.',
            wood: 'Add wood grain texture with warm brown tones.',
            fabric: 'Add soft fabric/cloth texture with subtle weave pattern.',
            neon: 'Add neon glow effects with bright edge lighting.',
            hologram: 'Add holographic rainbow shimmer effect.',
            carbon: 'Add carbon fiber texture with dark woven pattern.'
        };

        // 3D Rotation
        function toggle3DRotation() {
            is3DEnabled = !is3DEnabled;
            const btn = document.getElementById('rotate3DBtn');
            const controls = document.getElementById('rotationControls');
            const wrapper = document.getElementById('previewWrapper');
            
            if (is3DEnabled) {
                btn.classList.add('active');
                controls.style.display = 'flex';
                wrapper.classList.add('rotate-enabled');
            } else {
                btn.classList.remove('active');
                controls.style.display = 'none';
                wrapper.classList.remove('rotate-enabled');
                document.getElementById('designPreview').style.transform = 'none';
            }
        }

        function updateRotation() {
            const x = document.getElementById('rotateX').value;
            const y = document.getElementById('rotateY').value;
            document.getElementById('rotationLabel').textContent = `X: ${x}Â° Y: ${y}Â°`;
            
            const preview = document.getElementById('designPreview');
            preview.style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;
        }

        // Layer Panel
        function toggleLayerPanel() {
            const panel = document.getElementById('layerPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateLayerPanel(html) {
            const layerList = document.getElementById('layerList');
            const layers = [];
            
            const layerIcons = {
                'layer-background': 'ğŸ¨',
                'layer-container': 'ğŸ“¦',
                'layer-header': 'ğŸ”',
                'layer-content': 'ğŸ“„',
                'layer-buttons': 'ğŸ”˜',
                'layer-decorations': 'âœ¨',
                'layer-overlay': 'ğŸŒŸ',
                'layer-nav': 'ğŸ§­',
                'layer-footer': 'ğŸ”½',
                'layer-form': 'ğŸ“‹',
                'layer-image': 'ğŸ–¼ï¸'
            };
            
            const layerClassMatches = html.match(/class="[^"]*layer-[^"]+"/gi) || [];
            const seen = new Set();
            
            layerClassMatches.forEach(match => {
                const classes = match.match(/layer-\w+/g) || [];
                classes.forEach(layerClass => {
                    if (!seen.has(layerClass)) {
                        seen.add(layerClass);
                        layers.push({
                            name: layerClass.replace('layer-', '').replace(/-/g, ' '),
                            className: layerClass,
                            icon: layerIcons[layerClass] || 'ğŸ“¦'
                        });
                    }
                });
            });
            
            if (layers.length === 0) {
                const tagMatches = html.match(/<(div|section|header|footer|nav|button)[^>]*class="([^"]+)"/gi) || [];
                tagMatches.forEach(tag => {
                    const classMatch = tag.match(/class="([^"]+)"/);
                    if (classMatch) {
                        const firstClass = classMatch[1].split(' ')[0];
                        if (!seen.has(firstClass) && firstClass) {
                            seen.add(firstClass);
                            const tagType = tag.match(/<(\w+)/)[1].toUpperCase();
                            layers.push({ name: firstClass, className: firstClass, icon: getLayerIcon(tagType) });
                        }
                    }
                });
            }

            if (layers.length === 0) {
                layers.push({ name: 'Container', className: 'container', icon: 'ğŸ“¦' });
            }

            layerList.innerHTML = layers.map((layer, i) => `
                <div class="layer-item" data-layer-index="${i}" data-layer-class="${layer.className || layer.name}">
                    <span class="layer-icon">${layer.icon}</span>
                    <span class="layer-name">${layer.name}</span>
                    <input type="checkbox" checked onchange="toggleLayer(this)">
                </div>
            `).join('');
            
            document.getElementById('layerCount').textContent = `${layers.length} layer${layers.length !== 1 ? 's' : ''}`;
            document.getElementById('layerPanel').style.display = 'block';
            currentLayers = layers;
        }

        function getLayerIcon(tag) {
            const icons = {
                'DIV': 'ğŸ“¦', 'SECTION': 'ğŸ“„', 'HEADER': 'ğŸ”', 'FOOTER': 'ğŸ”½',
                'NAV': 'ğŸ§­', 'BUTTON': 'ğŸ”˜', 'INPUT': 'ğŸ“', 'FORM': 'ğŸ“‹',
                'H1': 'ğŸ“°', 'H2': 'ğŸ“°', 'H3': 'ğŸ“°', 'P': 'ğŸ“', 'SPAN': 'ğŸ’¬',
                'IMG': 'ğŸ–¼ï¸', 'UL': 'ğŸ“‹', 'LI': 'â€¢'
            };
            return icons[tag] || 'ğŸ“¦';
        }

        let currentLayers = [];
        let buildupActive = false;

        function toggleLayer(checkbox) {
            const layerItem = checkbox.closest('.layer-item');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            if (checkbox.checked) {
                layerItem.classList.remove('hidden-layer');
            } else {
                layerItem.classList.add('hidden-layer');
            }
            
            updateIframeLayerVisibility();
        }

        function updateIframeLayerVisibility() {
            const iframe = document.getElementById('designIframe');
            if (!iframe || !iframe.contentDocument) return;
            
            const layerItems = document.querySelectorAll('.layer-item');
            layerItems.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const layerClass = item.dataset.layerClass;
                const isVisible = checkbox.checked;
                
                try {
                    const iframeDoc = iframe.contentDocument;
                    const elements = iframeDoc.querySelectorAll(`.${layerClass}`);
                    elements.forEach(el => {
                        el.style.opacity = isVisible ? '1' : '0';
                        el.style.transition = 'opacity 0.3s ease';
                        el.style.pointerEvents = isVisible ? 'auto' : 'none';
                    });
                } catch (e) {}
            });
        }

        function showAllLayers() {
            document.querySelectorAll('.layer-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = true;
                item.classList.remove('hidden-layer');
            });
            updateIframeLayerVisibility();
            
            const buildupControls = document.getElementById('buildupControls');
            if (buildupControls) buildupControls.remove();
            buildupActive = false;
        }

        function buildupMode() {
            if (buildupActive) {
                showAllLayers();
                return;
            }
            
            buildupActive = true;
            const layerPanel = document.getElementById('layerPanel');
            const layerList = document.getElementById('layerList');
            const layerItems = layerList.querySelectorAll('.layer-item');
            const layerCount = layerItems.length;
            
            let existingControls = document.getElementById('buildupControls');
            if (!existingControls) {
                const controlsDiv = document.createElement('div');
                controlsDiv.id = 'buildupControls';
                controlsDiv.className = 'buildup-controls';
                controlsDiv.innerHTML = `
                    <span id="buildupLabel">Layer 1/${layerCount}</span>
                    <input type="range" min="1" max="${layerCount}" value="1" oninput="updateBuildup(this.value)">
                    <button onclick="animateBuildup()" style="background:none;border:none;cursor:pointer;font-size:1rem;">â–¶ï¸</button>
                `;
                layerPanel.appendChild(controlsDiv);
            }
            
            updateBuildup(1);
        }

        function updateBuildup(value) {
            const layerItems = document.querySelectorAll('.layer-item');
            const total = layerItems.length;
            
            document.getElementById('buildupLabel').textContent = `Layer ${value}/${total}`;
            
            layerItems.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (index < value) {
                    checkbox.checked = true;
                    item.classList.remove('hidden-layer');
                } else {
                    checkbox.checked = false;
                    item.classList.add('hidden-layer');
                }
            });
            
            updateIframeLayerVisibility();
        }

        async function animateBuildup() {
            const layerItems = document.querySelectorAll('.layer-item');
            const total = layerItems.length;
            const slider = document.querySelector('#buildupControls input[type="range"]');
            
            for (let i = 1; i <= total; i++) {
                slider.value = i;
                updateBuildup(i);
                await new Promise(r => setTimeout(r, 500));
            }
        }

        // ===== MAGICIAN TOOLS =====
        function toggleMagician() {
            const tools = document.getElementById('magicianTools');
            const toggle = document.getElementById('magicianToggle');
            if (tools.style.display === 'none') {
                tools.style.display = 'block';
                toggle.textContent = 'â–²';
            } else {
                tools.style.display = 'none';
                toggle.textContent = 'â–¼';
            }
        }

        async function generateIcon() {
            const prompt = document.getElementById('iconPrompt').value.trim();
            const style = document.getElementById('iconStyle').value;
            const result = document.getElementById('iconResult');
            
            if (!prompt) {
                alert('Enter an icon description');
                return;
            }
            
            result.innerHTML = '<span style="color:var(--text-muted)">Creating icon...</span>';
            result.classList.add('active');
            
            try {
                const response = await fetch('/magician/icon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: prompt, style: style })
                });
                const data = await response.json();
                
                if (data.svg) {
                    result.innerHTML = `
                        <div class="magic-icon-preview">
                            <div>${data.svg}</div>
                            <div class="magic-icon-actions">
                                <button onclick="copyIconSVG()">Copy SVG</button>
                                <button onclick="downloadIcon()">Download</button>
                                <button onclick="insertIconToDesign()">Insert</button>
                            </div>
                        </div>
                    `;
                    result.dataset.svg = data.svg;
                } else {
                    result.innerHTML = `<span style="color:var(--accent-ajani)">Error: ${data.error}</span>`;
                }
            } catch (err) {
                result.innerHTML = '<span style="color:var(--accent-ajani)">Connection error</span>';
            }
        }

        function copyIconSVG() {
            const svg = document.getElementById('iconResult').dataset.svg;
            navigator.clipboard.writeText(svg);
            alert('SVG copied to clipboard!');
        }

        function downloadIcon() {
            const svg = document.getElementById('iconResult').dataset.svg;
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'icon.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        function insertIconToDesign() {
            const svg = document.getElementById('iconResult').dataset.svg;
            if (currentDesignCode && svg) {
                const newCode = currentDesignCode.replace('</div>', svg + '</div>');
                displayDesign(newCode);
            }
        }

        async function generateCopy() {
            const context = document.getElementById('copyContext').value.trim();
            const type = document.getElementById('copyType').value;
            const result = document.getElementById('copyResult');
            
            if (!context) {
                alert('Enter a context for the copy');
                return;
            }
            
            result.innerHTML = '<span style="color:var(--text-muted)">Generating...</span>';
            result.classList.add('active');
            
            try {
                const response = await fetch('/magician/copy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context: context, type: type })
                });
                const data = await response.json();
                
                if (data.copy) {
                    result.innerHTML = `
                        <div class="magic-copy-result">
                            ${data.copy}
                            <div style="margin-top:0.5rem">
                                <button onclick="navigator.clipboard.writeText('${data.copy.replace(/'/g, "\\'")}');alert('Copied!')" style="font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:4px;border:1px solid var(--border-glass);background:rgba(40,40,50,0.8);color:var(--text-secondary);cursor:pointer;">Copy</button>
                            </div>
                        </div>
                    `;
                } else {
                    result.innerHTML = `<span style="color:var(--accent-ajani)">Error: ${data.error}</span>`;
                }
            } catch (err) {
                result.innerHTML = '<span style="color:var(--accent-ajani)">Connection error</span>';
            }
        }

        async function exportToReact() {
            if (!currentDesignCode) {
                alert('Generate a design first');
                return;
            }
            
            const componentName = document.getElementById('componentName').value.trim() || 'GeneratedComponent';
            const result = document.getElementById('reactResult');
            
            result.innerHTML = 'Converting to React...';
            result.classList.add('active');
            
            try {
                const response = await fetch('/magician/react', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html: currentDesignCode, component_name: componentName })
                });
                const data = await response.json();
                
                if (data.react) {
                    result.innerHTML = `<pre style="margin:0;white-space:pre-wrap;word-break:break-all;">${escapeHtml(data.react)}</pre>
                        <button onclick="navigator.clipboard.writeText(document.getElementById('reactResult').querySelector('pre').textContent);alert('Copied!')" style="margin-top:0.5rem;font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:4px;border:1px solid var(--border-glass);background:var(--accent-primary);color:#1a1a1f;cursor:pointer;">Copy Code</button>`;
                } else {
                    result.innerHTML = `Error: ${data.error}`;
                }
            } catch (err) {
                result.innerHTML = 'Connection error';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function suggestLayouts() {
            const purpose = document.getElementById('layoutPurpose').value.trim();
            const results = document.getElementById('layoutResults');
            
            if (!purpose) {
                alert('Enter a layout purpose');
                return;
            }
            
            results.innerHTML = '<span style="color:var(--text-muted)">Generating layouts...</span>';
            
            try {
                const response = await fetch('/magician/suggest-layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ purpose: purpose })
                });
                const data = await response.json();
                
                if (data.layouts && data.layouts.length > 0) {
                    results.innerHTML = data.layouts.map((layout, i) => `
                        <div class="layout-suggestion" onclick="applyLayout(${i})">
                            <h5>${layout.name}</h5>
                            <p>${layout.description}</p>
                        </div>
                    `).join('');
                    results.dataset.layouts = JSON.stringify(data.layouts);
                } else {
                    results.innerHTML = '<span style="color:var(--accent-ajani)">No layouts generated</span>';
                }
            } catch (err) {
                results.innerHTML = '<span style="color:var(--accent-ajani)">Connection error</span>';
            }
        }

        function applyLayout(index) {
            const layouts = JSON.parse(document.getElementById('layoutResults').dataset.layouts || '[]');
            if (layouts[index] && layouts[index].html) {
                displayDesign(layouts[index].html);
                updateLayerPanel(layouts[index].html);
                document.getElementById('refinementTools').style.display = 'block';
            }
        }

        async function createPrototype() {
            const screensInput = document.getElementById('prototypeScreens').value.trim();
            
            if (!screensInput) {
                alert('Enter screen names separated by commas');
                return;
            }
            
            const screens = screensInput.split(',').map(s => s.trim()).filter(s => s);
            const preview = document.getElementById('designPreview');
            const placeholder = document.getElementById('previewPlaceholder');
            const iframe = document.getElementById('designIframe');
            
            placeholder.style.display = 'none';
            iframe.style.display = 'none';
            preview.innerHTML = `
                <div class="design-loading">
                    <div class="design-loading-spinner"></div>
                    <span>Building prototype...</span>
                </div>
            `;
            
            try {
                const response = await fetch('/magician/prototype', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ screens: screens })
                });
                const data = await response.json();
                
                if (data.prototype) {
                    displayDesign(data.prototype);
                    document.getElementById('refinementTools').style.display = 'block';
                } else {
                    placeholder.style.display = 'block';
                    preview.querySelector('.design-loading')?.remove();
                    alert('Error: ' + (data.error || 'Failed to create prototype'));
                }
            } catch (err) {
                placeholder.style.display = 'block';
                preview.querySelector('.design-loading')?.remove();
                alert('Connection error');
            }
        }

        // Refinement Tools
        async function refineDesign(action) {
            if (!currentDesignCode) {
                alert('Generate a design first');
                return;
            }

            const refinements = {
                darker: 'Make the design darker with more contrast',
                lighter: 'Make the design lighter and brighter',
                glow: 'Add glowing effects to borders and important elements',
                sharper: 'Make edges sharper with more defined borders',
                rounder: 'Make corners more rounded and softer',
                bigger: 'Increase the size and padding of elements'
            };

            const preview = document.getElementById('designPreview');
            const placeholder = document.getElementById('previewPlaceholder');
            const iframe = document.getElementById('designIframe');
            
            placeholder.style.display = 'none';
            iframe.style.display = 'none';
            preview.innerHTML = `
                <div class="design-loading">
                    <div class="design-loading-spinner"></div>
                    <span>Refining...</span>
                </div>
            `;

            try {
                const response = await fetch('/design/refine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        html: currentDesignCode,
                        refinement: refinements[action]
                    })
                });
                const data = await response.json();
                if (data.html) {
                    displayDesign(data.html);
                }
            } catch (err) {
                displayDesign(currentDesignCode);
            }
        }

        const DESIGN_TEMPLATES = {
            card: 'Create a card component with a header, body, and footer. Dark background with subtle border.',
            button: 'Create a set of 3 buttons: primary, secondary, and danger. Rounded corners, hover effects.',
            layout: 'Create a page layout with a sidebar and main content area. Dark theme.',
            nav: 'Create a horizontal navigation bar with logo area, menu links, and action buttons.',
            form: 'Create a form with text input, email input, password input, and submit button. Styled labels.',
            dashboard: 'Create a dashboard panel with 4 stat cards showing numbers and icons.',
            hero: 'Create a hero section with large heading, subtext, and call-to-action button.'
        };

        const PERSONA_DESIGN_STYLES = {
            ajani: {
                colors: ['#dc143c', '#ff4444', '#ff6b6b'],
                style: 'Bold, sharp edges, high contrast, tactical feel. Uses crimson and red accents.'
            },
            minerva: {
                colors: ['#00d4aa', '#50ffc8', '#88ffdd'],
                style: 'Elegant, flowing curves, sophisticated. Uses teal and gold accents.'
            },
            hermes: {
                colors: ['#6040ff', '#8070ff', '#00bfff'],
                style: 'Technical, clean lines, data-driven. Uses blue and purple accents.'
            }
        };

        async function generateDesign() {
            const template = document.getElementById('designTemplate').value;
            const persona = document.getElementById('designPersona').value;
            const userPrompt = document.getElementById('designPrompt').value.trim();
            const preview = document.getElementById('designPreview');
            const placeholder = document.getElementById('previewPlaceholder');
            const iframe = document.getElementById('designIframe');
            
            if (!userPrompt && template === 'custom') {
                alert('Please describe what you want to design');
                return;
            }

            const cacheKey = `${template}-${persona}-${userPrompt}-${selectedTexture}-${selectedColorScheme}-${selectedSkin}-${selectedShape}-${hdQuality}`;
            if (designCache.has(cacheKey)) {
                displayDesign(designCache.get(cacheKey));
                return;
            }

            placeholder.style.display = 'none';
            iframe.style.display = 'none';
            preview.innerHTML = `
                <div class="design-loading">
                    <div class="design-loading-spinner"></div>
                    <span>Forging ${hdQuality ? 'HD ' : ''}design...</span>
                </div>
            `;

            const basePrompt = template !== 'custom' ? DESIGN_TEMPLATES[template] : '';
            const styleGuide = PERSONA_DESIGN_STYLES[persona];
            const colorInfo = COLOR_SCHEMES[selectedColorScheme];
            const textureInfo = TEXTURE_DESCRIPTIONS[selectedTexture];

            // Skin descriptions
            const SKIN_DESCRIPTIONS = {
                minimal: 'Clean minimal design with lots of whitespace, simple lines, no shadows.',
                forge: 'Dark forge aesthetic with metallic accents, glowing edges, industrial feel.',
                retro: '80s retro style with neon colors, grid patterns, synthwave aesthetic.',
                brutalist: 'Brutalist design with raw shapes, bold typography, stark contrasts.',
                organic: 'Organic flowing shapes, natural curves, soft gradients.',
                scifi: 'Sci-fi futuristic with holographic elements, tech patterns, sleek lines.'
            };

            // Shape descriptions
            const SHAPE_DESCRIPTIONS = {
                rounded: 'Use rounded corners (border-radius: 12px) on all elements.',
                sharp: 'Use sharp 90-degree corners on all elements.',
                pill: 'Use pill-shaped elements (border-radius: 999px).',
                hexagon: 'Use hexagonal shapes via clip-path.',
                diamond: 'Use diamond/rhombus shapes via transform: rotate(45deg).',
                organic: 'Use organic blob shapes with border-radius variations.'
            };

            // Build enhanced prompt with texture, color, skin, shape
            let enhancedPrompt = userPrompt || basePrompt;
            if (selectedColorScheme !== 'dark') {
                if (colorInfo.transparent) {
                    enhancedPrompt += ` Use transparent/glass color scheme: background ${colorInfo.bg} with backdrop-filter: blur(10px), primary color ${colorInfo.primary}, secondary ${colorInfo.secondary}. Add subtle borders with rgba colors.`;
                } else {
                    enhancedPrompt += ` Use this color scheme: background ${colorInfo.bg}, primary color ${colorInfo.primary}, secondary ${colorInfo.secondary}.`;
                }
            }
            if (selectedTexture !== 'none') {
                enhancedPrompt += ` ${textureInfo}`;
            }
            if (selectedSkin !== 'forge') {
                enhancedPrompt += ` ${SKIN_DESCRIPTIONS[selectedSkin]}`;
            }
            if (selectedShape !== 'sharp') {
                enhancedPrompt += ` ${SHAPE_DESCRIPTIONS[selectedShape]}`;
            }
            if (hdQuality) {
                enhancedPrompt += ' High-definition quality with crisp edges, detailed shadows, refined gradients, and pixel-perfect rendering.';
            }
            if (designReferenceImage) {
                enhancedPrompt += ' Use the reference image as inspiration for the layout and style.';
            }

            try {
                const response = await fetch('/design/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: persona,
                        template: template,
                        prompt: enhancedPrompt,
                        style: styleGuide,
                        texture: selectedTexture,
                        colorScheme: selectedColorScheme,
                        referenceImage: designReferenceImage
                    })
                });

                const data = await response.json();
                if (data.html) {
                    designCache.set(cacheKey, data.html);
                    displayDesign(data.html);
                    updateLayerPanel(data.html);
                    document.getElementById('refinementTools').style.display = 'block';
                } else {
                    placeholder.style.display = 'block';
                    preview.querySelector('.design-loading')?.remove();
                    alert('Error: ' + (data.error || 'Failed to generate'));
                }
            } catch (err) {
                placeholder.style.display = 'block';
                preview.querySelector('.design-loading')?.remove();
                alert('Connection error');
            }
        }

        function displayDesign(html) {
            const placeholder = document.getElementById('previewPlaceholder');
            const iframe = document.getElementById('designIframe');
            const codeContent = document.getElementById('designCodeContent');
            
            currentDesignCode = html;
            codeContent.textContent = html;
            
            // Use sandboxed iframe for security - prevents script execution
            placeholder.style.display = 'none';
            iframe.style.display = 'block';
            
            // Create safe HTML document for iframe
            const safeDoc = `<!DOCTYPE html>
<html>
<head>
<style>
body { 
    margin: 0; 
    padding: 16px; 
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    min-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Inter', -apple-system, sans-serif;
    color: #e8e8e8;
}
* { box-sizing: border-box; }
</style>
</head>
<body>${html}</body>
</html>`;
            
            iframe.srcdoc = safeDoc;
            
            document.getElementById('designAdjustments').style.display = 'block';
        }

        function clearDesign() {
            const placeholder = document.getElementById('previewPlaceholder');
            const iframe = document.getElementById('designIframe');
            
            placeholder.style.display = 'block';
            iframe.style.display = 'none';
            iframe.srcdoc = '';
            
            document.getElementById('designPrompt').value = '';
            document.getElementById('designCode').style.display = 'none';
            document.getElementById('designAdjustments').style.display = 'none';
            currentDesignCode = '';
        }

        function toggleCode() {
            const codePanel = document.getElementById('designCode');
            const previewPanel = document.getElementById('designPreview');
            
            if (codePanel.style.display === 'none') {
                codePanel.style.display = 'block';
                previewPanel.style.display = 'none';
            } else {
                codePanel.style.display = 'none';
                previewPanel.style.display = 'flex';
            }
        }

        function copyDesignCode() {
            if (!currentDesignCode) {
                alert('No design to copy');
                return;
            }
            navigator.clipboard.writeText(currentDesignCode).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        function saveDesign() {
            if (!currentDesignCode) {
                alert('Generate a design first');
                return;
            }
            
            // Save to project pipeline if linked
            if (window.currentForgeProject) {
                saveBlueprintToProject(currentDesignCode);
            }
            
            const name = prompt('Name this design:', `Design ${savedDesigns.length + 1}`);
            if (!name) return;
            
            savedDesigns.push({
                name: name,
                html: currentDesignCode,
                timestamp: Date.now()
            });
            
            localStorage.setItem('atlasDesigns', JSON.stringify(savedDesigns));
            renderSavedDesigns();
        }

        function renderSavedDesigns() {
            const grid = document.getElementById('savedDesignsGrid');
            if (savedDesigns.length === 0) {
                grid.innerHTML = '<div class="saved-design-placeholder">No saved designs yet</div>';
                return;
            }
            
            grid.innerHTML = savedDesigns.map((design, index) => `
                <div class="saved-design-item" onclick="loadSavedDesign(${index})">
                    <div class="saved-design-preview">${design.html}</div>
                    <div class="saved-design-name">${design.name}</div>
                </div>
            `).join('');
        }

        function loadSavedDesign(index) {
            const design = savedDesigns[index];
            if (design) {
                displayDesign(design.html);
            }
        }

        function applyAdjustments() {
            const preview = document.getElementById('designPreview');
            const primaryColor = document.getElementById('adjPrimaryColor').value;
            const bgColor = document.getElementById('adjBgColor').value;
            const borderRadius = document.getElementById('adjBorderRadius').value;
            const padding = document.getElementById('adjPadding').value;
            const shadow = document.getElementById('adjShadow').value;
            
            document.getElementById('adjBorderRadiusVal').textContent = borderRadius + 'px';
            document.getElementById('adjPaddingVal').textContent = padding + 'px';
            document.getElementById('adjShadowVal').textContent = shadow;
            
            const firstChild = preview.firstElementChild;
            if (firstChild && !firstChild.classList.contains('preview-placeholder')) {
                firstChild.style.setProperty('--adj-primary', primaryColor);
                firstChild.style.setProperty('--adj-bg', bgColor);
                firstChild.style.borderRadius = borderRadius + 'px';
                firstChild.style.padding = padding + 'px';
                firstChild.style.boxShadow = `0 ${shadow/2}px ${shadow}px rgba(0,0,0,0.5)`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderSavedDesigns();
        });

        // ===== INCOGNITO MODE =====
        let incognitoMode = false;

        function initIncognitoMode() {
            const saved = sessionStorage.getItem('atlasIncognito');
            if (saved === 'true') {
                incognitoMode = true;
                updateIncognitoUI();
            }
        }

        function toggleIncognitoMode() {
            incognitoMode = !incognitoMode;
            sessionStorage.setItem('atlasIncognito', incognitoMode);
            updateIncognitoUI();
            showNotification(incognitoMode ? 'Incognito Mode: ON - Nothing will be saved' : 'Incognito Mode: OFF', incognitoMode ? 'info' : 'success');
        }

        function updateIncognitoUI() {
            const toggle = document.getElementById('incognitoToggle');
            const banner = document.getElementById('incognitoBanner');
            if (incognitoMode) {
                toggle.classList.add('incognito-active');
                banner.classList.add('active');
            } else {
                toggle.classList.remove('incognito-active');
                banner.classList.remove('active');
            }
        }

        function shouldSaveData() {
            return !incognitoMode;
        }

        // ===== VOICE COMMAND SYSTEM =====
        let voiceCommandsActive = false;
        let voiceCommandRecognition = null;

        const voiceCommands = {
            // Navigation commands
            'go to lessons': () => scrollToSection('fields-section'),
            'open lessons': () => scrollToSection('fields-section'),
            'show lessons': () => scrollToSection('fields-section'),
            'go to chat': () => scrollToSection('chat-section'),
            'open chat': () => scrollToSection('chat-section'),
            'go to projects': () => scrollToSection('projects-section'),
            'open projects': () => scrollToSection('projects-section'),
            'go to ideas': () => scrollToSection('ideas-section'),
            'go home': () => window.scrollTo({ top: 0, behavior: 'smooth' }),
            'scroll up': () => window.scrollBy({ top: -400, behavior: 'smooth' }),
            'scroll down': () => window.scrollBy({ top: 400, behavior: 'smooth' }),
            'go up': () => window.scrollBy({ top: -400, behavior: 'smooth' }),
            'go down': () => window.scrollBy({ top: 400, behavior: 'smooth' }),
            
            // Persona commands
            'talk to ajani': () => selectPersona('ajani'),
            'open ajani': () => selectPersona('ajani'),
            'switch to ajani': () => selectPersona('ajani'),
            'talk to minerva': () => selectPersona('minerva'),
            'open minerva': () => selectPersona('minerva'),
            'switch to minerva': () => selectPersona('minerva'),
            'talk to hermes': () => selectPersona('hermes'),
            'open hermes': () => selectPersona('hermes'),
            'switch to hermes': () => selectPersona('hermes'),
            'trinity counsel': () => selectPersona('counsel'),
            'open counsel': () => selectPersona('counsel'),
            'open trinity': () => selectPersona('counsel'),
            
            // Field study commands
            'study biology': () => startFieldStudy('biology'),
            'open biology': () => startFieldStudy('biology'),
            'study physics': () => startFieldStudy('physics'),
            'open physics': () => startFieldStudy('physics'),
            'study robotics': () => startFieldStudy('robotics'),
            'open robotics': () => startFieldStudy('robotics'),
            'study computer science': () => startFieldStudy('computer_science'),
            'open computer science': () => startFieldStudy('computer_science'),
            'study electronics': () => startFieldStudy('electrical'),
            'open electronics': () => startFieldStudy('electrical'),
            'study chemistry': () => startFieldStudy('chemistry'),
            'study psychology': () => startFieldStudy('medicine'),
            'study history': () => startFieldStudy('linguistics'),
            'study music': () => startFieldStudy('acoustics'),
            'study art': () => startFieldStudy('creative_arts'),
            
            // Mode commands
            'incognito on': () => { if (!incognitoMode) toggleIncognitoMode(); },
            'incognito off': () => { if (incognitoMode) toggleIncognitoMode(); },
            'private mode': () => { if (!incognitoMode) toggleIncognitoMode(); },
            'text mode': () => setLearningMode('text'),
            'audio mode': () => setLearningMode('audio'),
            'read mode': () => setLearningMode('text'),
            'listen mode': () => setLearningMode('audio'),
            
            // Build commands
            'show builds': () => openEdgePanelAndShowBuilds(),
            'check builds': () => openEdgePanelAndShowBuilds(),
            'open builds': () => openEdgePanelAndShowBuilds(),
            'build status': () => voiceBuildStatus(),
            'check build status': () => voiceBuildStatus(),
            'how are builds': () => voiceBuildStatus(),
            'show ajani builds': () => voiceBuildStatus('ajani'),
            'ajani builds': () => voiceBuildStatus('ajani'),
            'show minerva builds': () => voiceBuildStatus('minerva'),
            'minerva builds': () => voiceBuildStatus('minerva'),
            'show hermes builds': () => voiceBuildStatus('hermes'),
            'hermes builds': () => voiceBuildStatus('hermes'),

            // Action commands
            'stop listening': () => stopVoiceCommands(),
            'stop voice': () => stopVoiceCommands(),
            'new project': () => showNewProjectForm(),
            'close modal': () => { document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active')); }
        };

        function initVoiceCommands() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('Voice commands not supported in this browser');
                document.getElementById('voiceCommandToggle').style.display = 'none';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = true;
            voiceCommandRecognition.lang = 'en-US';

            voiceCommandRecognition.onresult = (event) => {
                const last = event.results.length - 1;
                const transcript = event.results[last][0].transcript.toLowerCase().trim();
                
                showVoiceFeedback(transcript, event.results[last].isFinal ? 'Processing...' : 'Listening...');
                
                if (event.results[last].isFinal) {
                    processVoiceCommand(transcript);
                }
            };

            voiceCommandRecognition.onerror = (event) => {
                console.log('Voice recognition error:', event.error);
                if (event.error === 'no-speech') {
                    showVoiceFeedback('No speech detected', 'Try speaking again');
                } else if (event.error !== 'aborted') {
                    showVoiceFeedback('Error', event.error);
                }
            };

            voiceCommandRecognition.onend = () => {
                if (voiceCommandsActive) {
                    try {
                        voiceCommandRecognition.start();
                    } catch (e) {
                        console.log('Could not restart recognition');
                    }
                }
            };
        }

        function toggleVoiceCommands() {
            if (voiceCommandsActive) {
                stopVoiceCommands();
            } else {
                startVoiceCommands();
            }
        }

        function startVoiceCommands() {
            if (!voiceCommandRecognition) {
                showNotification('Voice commands not supported in this browser', 'error');
                return;
            }

            voiceCommandsActive = true;
            document.getElementById('voiceCommandToggle').classList.add('listening');
            document.getElementById('voiceCommandLabel').textContent = 'Listening';
            showVoiceFeedback('Voice Commands Active', 'Say a command like "go to lessons"');
            
            try {
                voiceCommandRecognition.start();
            } catch (e) {
                console.log('Recognition already started');
            }
            
            showNotification('Voice Commands: ON', 'success');
        }

        function stopVoiceCommands() {
            voiceCommandsActive = false;
            document.getElementById('voiceCommandToggle').classList.remove('listening');
            document.getElementById('voiceCommandLabel').textContent = 'Voice';
            hideVoiceFeedback();
            
            if (voiceCommandRecognition) {
                try {
                    voiceCommandRecognition.stop();
                } catch (e) {}
            }
            
            showNotification('Voice Commands: OFF', 'info');
        }

        function processVoiceCommand(transcript) {
            let commandFound = false;
            
            for (const [phrase, action] of Object.entries(voiceCommands)) {
                if (transcript.includes(phrase)) {
                    showVoiceFeedback(`"${phrase}"`, 'Command recognized!');
                    action();
                    commandFound = true;
                    setTimeout(hideVoiceFeedback, 1500);
                    break;
                }
            }
            
            if (!commandFound) {
                showVoiceFeedback(`"${transcript}"`, 'Command not recognized');
                setTimeout(hideVoiceFeedback, 2000);
            }
        }

        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showVoiceFeedback(text, status) {
            const feedback = document.getElementById('voiceCommandFeedback');
            const feedbackText = document.getElementById('voiceFeedbackText');
            const feedbackStatus = document.getElementById('voiceFeedbackStatus');
            
            feedbackText.textContent = text;
            feedbackStatus.textContent = status;
            feedback.classList.add('active');
        }

        function hideVoiceFeedback() {
            document.getElementById('voiceCommandFeedback').classList.remove('active');
        }

        function openEdgePanelAndShowBuilds() {
            var panel = document.getElementById('edgePanel');
            var overlay = document.getElementById('edgePanelOverlay');
            if (panel && overlay) {
                panel.classList.add('open');
                overlay.classList.add('open');
            }
            showVoiceFeedback('Opening Build Plans', 'Showing your builds...');
            setTimeout(function() {
                var buildToggles = document.querySelectorAll('[id^="epBuildTog-"]');
                buildToggles.forEach(function(btn) {
                    if (!btn.classList.contains('open')) {
                        btn.click();
                    }
                });
                hideVoiceFeedback();
            }, 800);
        }

        function voiceBuildStatus(persona) {
            var url = '/build/status-summary';
            if (persona) url += '?persona=' + persona;
            showVoiceFeedback('Checking Build Status...', persona ? persona + ' builds' : 'All builds');
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status !== 'ok') {
                        showVoiceFeedback('Could not load build status', 'Try again');
                        setTimeout(hideVoiceFeedback, 2000);
                        return;
                    }
                    var summary = data.voice_summary;
                    showVoiceFeedback(summary, 'Build Status Report');
                    setTimeout(hideVoiceFeedback, 5000);

                    openEdgePanelAndShowBuilds();

                    var currentMode = document.querySelector('.mode-btn.active');
                    var isAudioMode = currentMode && currentMode.dataset.mode === 'audio';
                    if (isAudioMode && summary) {
                        var activePersona = persona || epCurrentPersona || 'ajani';
                        fetch('/tts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: summary, persona: activePersona })
                        })
                        .then(function(r) {
                            if (r.ok) return r.blob();
                            return null;
                        })
                        .then(function(blob) {
                            if (blob) {
                                var audio = new Audio(URL.createObjectURL(blob));
                                audio.play();
                            }
                        })
                        .catch(function() {});
                    }
                })
                .catch(function() {
                    showVoiceFeedback('Build status unavailable', 'Error');
                    setTimeout(hideVoiceFeedback, 2000);
                });
        }

        // ===== INTERACTIVE DIAGRAMS FOR SCIENCE SUBJECTS =====
        const scienceDiagrams = {
            biology: {
                cell: {
                    title: 'Animal Cell Diagram',
                    svg: `<svg viewBox="0 0 400 300" class="diagram-svg">
                        <ellipse cx="200" cy="150" rx="180" ry="120" fill="#2a3a2a" stroke="#50d890" stroke-width="3" class="diagram-hotspot" data-part="membrane"/>
                        <ellipse cx="200" cy="150" rx="50" ry="40" fill="#3a2a3a" stroke="#8b5cf6" stroke-width="2" class="diagram-hotspot" data-part="nucleus"/>
                        <circle cx="200" cy="150" r="15" fill="#5c3d7a" class="diagram-hotspot" data-part="nucleolus"/>
                        <ellipse cx="120" cy="100" rx="25" ry="12" fill="#2a4a4a" stroke="#00d4aa" stroke-width="1.5" class="diagram-hotspot" data-part="mitochondria"/>
                        <ellipse cx="280" cy="180" rx="25" ry="12" fill="#2a4a4a" stroke="#00d4aa" stroke-width="1.5" class="diagram-hotspot" data-part="mitochondria"/>
                        <path d="M 80 130 Q 100 150 80 170 Q 100 160 120 170 Q 100 150 120 130 Q 100 140 80 130" fill="#3a3a4a" stroke="#60a5fa" stroke-width="1" class="diagram-hotspot" data-part="er"/>
                        <circle cx="300" cy="100" r="12" fill="#4a3a2a" stroke="#fbbf24" stroke-width="1.5" class="diagram-hotspot" data-part="golgi"/>
                        <circle cx="150" cy="200" r="8" fill="#3a4a3a" class="diagram-hotspot" data-part="ribosome"/>
                        <circle cx="170" cy="190" r="8" fill="#3a4a3a" class="diagram-hotspot" data-part="ribosome"/>
                        <circle cx="250" cy="120" r="10" fill="#4a4a3a" stroke="#94a3b8" stroke-width="1" class="diagram-hotspot" data-part="lysosome"/>
                    </svg>`,
                    parts: {
                        membrane: { name: 'Cell Membrane', desc: 'Outer boundary that controls what enters and exits the cell. Made of phospholipid bilayer.' },
                        nucleus: { name: 'Nucleus', desc: 'Control center containing DNA. Directs all cell activities and holds genetic information.' },
                        nucleolus: { name: 'Nucleolus', desc: 'Dense region inside nucleus. Produces ribosomal RNA and assembles ribosomes.' },
                        mitochondria: { name: 'Mitochondria', desc: 'Powerhouse of the cell. Produces ATP through cellular respiration.' },
                        er: { name: 'Endoplasmic Reticulum', desc: 'Network of membranes for protein synthesis (rough ER) and lipid synthesis (smooth ER).' },
                        golgi: { name: 'Golgi Apparatus', desc: 'Packages and ships proteins. Modifies and sorts molecules for transport.' },
                        ribosome: { name: 'Ribosome', desc: 'Protein factories. Translates mRNA into proteins.' },
                        lysosome: { name: 'Lysosome', desc: 'Digestive system of the cell. Contains enzymes to break down waste.' }
                    }
                },
                dna: {
                    title: 'DNA Double Helix',
                    svg: `<svg viewBox="0 0 400 300" class="diagram-svg">
                        <path d="M 100 20 Q 200 80 100 140 Q 200 200 100 260" fill="none" stroke="#dc143c" stroke-width="8" class="diagram-hotspot" data-part="backbone1"/>
                        <path d="M 300 20 Q 200 80 300 140 Q 200 200 300 260" fill="none" stroke="#2563eb" stroke-width="8" class="diagram-hotspot" data-part="backbone2"/>
                        <line x1="130" y1="50" x2="270" y2="50" stroke="#00d4aa" stroke-width="4" class="diagram-hotspot" data-part="basepair"/>
                        <line x1="115" y1="100" x2="285" y2="100" stroke="#fbbf24" stroke-width="4" class="diagram-hotspot" data-part="basepair"/>
                        <line x1="130" y1="150" x2="270" y2="150" stroke="#00d4aa" stroke-width="4" class="diagram-hotspot" data-part="basepair"/>
                        <line x1="115" y1="200" x2="285" y2="200" stroke="#fbbf24" stroke-width="4" class="diagram-hotspot" data-part="basepair"/>
                        <line x1="130" y1="250" x2="270" y2="250" stroke="#00d4aa" stroke-width="4" class="diagram-hotspot" data-part="basepair"/>
                        <text x="90" y="280" fill="#dc143c" font-size="12">5'</text>
                        <text x="300" y="280" fill="#2563eb" font-size="12">3'</text>
                    </svg>`,
                    parts: {
                        backbone1: { name: 'Sugar-Phosphate Backbone', desc: 'Alternating sugar (deoxyribose) and phosphate groups forming the structural support.' },
                        backbone2: { name: 'Antiparallel Strand', desc: 'The two strands run in opposite directions (5\' to 3\' and 3\' to 5\').' },
                        basepair: { name: 'Base Pairs', desc: 'Adenine pairs with Thymine (A-T), Guanine pairs with Cytosine (G-C). Connected by hydrogen bonds.' }
                    }
                }
            },
            physics: {
                atom: {
                    title: 'Atomic Structure',
                    svg: `<svg viewBox="0 0 400 300" class="diagram-svg">
                        <circle cx="200" cy="150" r="30" fill="#dc143c" class="diagram-hotspot" data-part="nucleus"/>
                        <ellipse cx="200" cy="150" rx="100" ry="40" fill="none" stroke="#60a5fa" stroke-width="2" stroke-dasharray="5,5" class="diagram-hotspot" data-part="orbit1"/>
                        <ellipse cx="200" cy="150" rx="40" ry="100" fill="none" stroke="#00d4aa" stroke-width="2" stroke-dasharray="5,5" class="diagram-hotspot" data-part="orbit2"/>
                        <ellipse cx="200" cy="150" rx="140" ry="60" fill="none" stroke="#fbbf24" stroke-width="2" stroke-dasharray="5,5" transform="rotate(45 200 150)" class="diagram-hotspot" data-part="orbit3"/>
                        <circle cx="300" cy="150" r="10" fill="#60a5fa" class="diagram-hotspot" data-part="electron"/>
                        <circle cx="200" cy="50" r="10" fill="#00d4aa" class="diagram-hotspot" data-part="electron"/>
                        <circle cx="280" cy="220" r="10" fill="#fbbf24" class="diagram-hotspot" data-part="electron"/>
                        <text x="190" y="155" fill="white" font-size="14" font-weight="bold">+</text>
                    </svg>`,
                    parts: {
                        nucleus: { name: 'Nucleus', desc: 'Dense center containing protons (positive) and neutrons (neutral). Contains most of the atom\'s mass.' },
                        orbit1: { name: 'Electron Shell (1s)', desc: 'First energy level. Can hold up to 2 electrons.' },
                        orbit2: { name: 'Electron Shell (2s/2p)', desc: 'Second energy level. Can hold up to 8 electrons.' },
                        orbit3: { name: 'Electron Shell (3s/3p)', desc: 'Third energy level. Can hold up to 18 electrons.' },
                        electron: { name: 'Electron', desc: 'Negatively charged particle. Orbits the nucleus in defined energy levels.' }
                    }
                }
            },
            chemistry: {
                periodic: {
                    title: 'Periodic Table Element',
                    svg: `<svg viewBox="0 0 400 300" class="diagram-svg">
                        <rect x="100" y="50" width="200" height="200" fill="#1a3a4a" stroke="#00d4aa" stroke-width="3" rx="10" class="diagram-hotspot" data-part="element"/>
                        <text x="200" y="100" fill="#fbbf24" font-size="24" text-anchor="middle" class="diagram-hotspot" data-part="atomicnum">6</text>
                        <text x="200" y="170" fill="white" font-size="48" text-anchor="middle" font-weight="bold" class="diagram-hotspot" data-part="symbol">C</text>
                        <text x="200" y="210" fill="#60a5fa" font-size="16" text-anchor="middle" class="diagram-hotspot" data-part="name">Carbon</text>
                        <text x="200" y="235" fill="#94a3b8" font-size="14" text-anchor="middle" class="diagram-hotspot" data-part="mass">12.011</text>
                    </svg>`,
                    parts: {
                        element: { name: 'Element Block', desc: 'Each block represents one element. Position indicates properties and electron configuration.' },
                        atomicnum: { name: 'Atomic Number', desc: 'Number of protons in the nucleus. Defines the element. Carbon has 6 protons.' },
                        symbol: { name: 'Chemical Symbol', desc: 'One or two letter abbreviation. C = Carbon, O = Oxygen, Fe = Iron.' },
                        name: { name: 'Element Name', desc: 'Full name of the element. Often derived from Latin or discoverer\'s name.' },
                        mass: { name: 'Atomic Mass', desc: 'Average mass in atomic mass units (amu). Includes all isotopes weighted by abundance.' }
                    }
                }
            }
        };

        function renderInteractiveDiagram(subject, diagramType) {
            const subjectDiagrams = scienceDiagrams[subject];
            if (!subjectDiagrams) return null;
            
            const diagram = subjectDiagrams[diagramType];
            if (!diagram) return null;

            const container = document.createElement('div');
            container.className = 'interactive-diagram';
            container.innerHTML = `
                <div class="diagram-container" id="diagram-${diagramType}">
                    ${diagram.svg}
                    <div class="diagram-tooltip" id="tooltip-${diagramType}">
                        <div class="diagram-tooltip-title"></div>
                        <div class="diagram-tooltip-text"></div>
                    </div>
                </div>
                <div class="diagram-legend">
                    ${Object.entries(diagram.parts).map(([key, part]) => `
                        <div class="legend-item" data-part="${key}">
                            <div class="legend-color" style="background: var(--accent-primary);"></div>
                            <span>${part.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Add event listeners
            setTimeout(() => {
                const diagramEl = document.getElementById(`diagram-${diagramType}`);
                if (!diagramEl) return;

                const tooltip = document.getElementById(`tooltip-${diagramType}`);
                const hotspots = diagramEl.querySelectorAll('.diagram-hotspot');
                
                hotspots.forEach(hotspot => {
                    hotspot.addEventListener('click', (e) => {
                        const partName = hotspot.dataset.part;
                        const partInfo = diagram.parts[partName];
                        if (!partInfo) return;

                        tooltip.querySelector('.diagram-tooltip-title').textContent = partInfo.name;
                        tooltip.querySelector('.diagram-tooltip-text').textContent = partInfo.desc;
                        tooltip.style.left = `${e.offsetX + 10}px`;
                        tooltip.style.top = `${e.offsetY - 50}px`;
                        tooltip.classList.add('active');

                        setTimeout(() => tooltip.classList.remove('active'), 4000);
                    });
                });

                const legendItems = container.querySelectorAll('.legend-item');
                legendItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const partName = item.dataset.part;
                        const partInfo = diagram.parts[partName];
                        if (!partInfo) return;

                        tooltip.querySelector('.diagram-tooltip-title').textContent = partInfo.name;
                        tooltip.querySelector('.diagram-tooltip-text').textContent = partInfo.desc;
                        tooltip.style.left = '50%';
                        tooltip.style.top = '50%';
                        tooltip.style.transform = 'translate(-50%, -50%)';
                        tooltip.classList.add('active');

                        setTimeout(() => {
                            tooltip.classList.remove('active');
                            tooltip.style.transform = '';
                        }, 4000);
                    });
                });
            }, 100);

            return container;
        }

        // ===== GPS INTEGRATION =====
        let userLocation = null;

        async function initGPS() {
            if (!navigator.geolocation) {
                console.log('Geolocation not supported');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    updateGPSUI();
                },
                (error) => {
                    console.log('GPS error:', error.message);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function updateGPSUI() {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsCoords = document.getElementById('gpsCoords');
            
            if (gpsStatus) {
                gpsStatus.classList.add('active');
                gpsStatus.querySelector('span').textContent = 'Location Active';
            }
            
            if (gpsCoords && userLocation) {
                gpsCoords.textContent = `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)} (Â±${Math.round(userLocation.accuracy)}m)`;
            }
        }

        async function findNearbyMakerspaces() {
            if (!userLocation) {
                showNotification('Enable GPS to find nearby makerspaces', 'info');
                initGPS();
                return;
            }

            const nearbyPlaces = document.getElementById('nearbyPlaces');
            if (!nearbyPlaces) return;

            nearbyPlaces.innerHTML = '<p style="color: var(--text-secondary);">Searching nearby makerspaces...</p>';

            // Simulated makerspace data (in production, use Google Places API or similar)
            const mockPlaces = [
                { name: 'Community Makerspace', type: 'makerspace', icon: 'ğŸ”§', distance: '1.2 mi' },
                { name: 'Hardware Store', type: 'store', icon: 'ğŸª', distance: '0.8 mi' },
                { name: 'Electronics Supply', type: 'electronics', icon: 'âš¡', distance: '2.1 mi' },
                { name: 'University Fab Lab', type: 'fablab', icon: 'ğŸ”¬', distance: '3.5 mi' }
            ];

            nearbyPlaces.innerHTML = mockPlaces.map(place => `
                <div class="place-item" onclick="openPlaceDetails('${place.name}')">
                    <div class="place-icon">${place.icon}</div>
                    <div class="place-info">
                        <div class="place-name">${place.name}</div>
                        <div class="place-distance">${place.distance} away</div>
                    </div>
                </div>
            `).join('');
        }

        function openPlaceDetails(placeName) {
            showNotification(`Opening ${placeName} details...`, 'info');
            // In production, this would open a map or detailed view
        }

        function tagProjectWithLocation() {
            if (!userLocation) {
                showNotification('Enable GPS to tag location', 'info');
                initGPS();
                return;
            }

            showNotification(`Project tagged at: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`, 'success');
            return userLocation;
        }

        // ===== INTERACTIVE EXERCISES SYSTEM (60% Hands-On) =====
        const interactiveExercises = {
            // ========== BIOLOGY ==========
            biology: {
                cell_biology: [
                    { type: 'build', title: 'Build a Cell', description: 'Drag organelles to their correct positions inside the cell', parts: ['nucleus', 'mitochondria', 'ribosome', 'endoplasmic_reticulum', 'golgi', 'cell_membrane'] },
                    { type: 'puzzle', title: 'Organelle Match', description: 'Match each organelle to its function', pairs: [{ item: 'Nucleus', match: 'Contains DNA' }, { item: 'Mitochondria', match: 'Produces ATP' }, { item: 'Ribosome', match: 'Makes proteins' }, { item: 'Golgi', match: 'Packages proteins' }] },
                    { type: 'simulation', title: 'Cell Division Simulator', description: 'Watch and control the stages of mitosis', stages: ['interphase', 'prophase', 'metaphase', 'anaphase', 'telophase'] },
                    { type: 'quiz', title: 'Cell Structures', questions: [{ q: 'Powerhouse of the cell?', options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Golgi'], answer: 1 }] }
                ],
                genetics: [
                    { type: 'build', title: 'DNA Double Helix', description: 'Construct a DNA strand with matching base pairs', basePairs: ['A-T', 'T-A', 'G-C', 'C-G'] },
                    { type: 'puzzle', title: 'Punnett Square', description: 'Predict offspring traits using genetic crosses', traits: ['dominant', 'recessive'] },
                    { type: 'simulation', title: 'Protein Synthesis', description: 'Transcribe DNA to mRNA and translate to amino acids' },
                    { type: 'quiz', title: 'Genetics Basics', questions: [{ q: 'DNA base pairs with?', options: ['Thymine', 'Guanine', 'Cytosine', 'Uracil'], answer: 0 }] }
                ],
                ecology: [
                    { type: 'build', title: 'Food Web Constructor', description: 'Connect producers, consumers, and decomposers', organisms: ['plant', 'herbivore', 'carnivore', 'decomposer'] },
                    { type: 'simulation', title: 'Population Dynamics', description: 'Adjust birth rate, death rate, and resources to see population changes' },
                    { type: 'puzzle', title: 'Ecosystem Roles', description: 'Match organisms to their ecological roles', pairs: [{ item: 'Hawk', match: 'Tertiary consumer' }, { item: 'Grass', match: 'Producer' }] }
                ],
                marine_biology: [
                    { type: 'build', title: 'Ocean Zones', description: 'Place creatures in correct ocean depth zones', zones: ['sunlight', 'twilight', 'midnight', 'abyssal'] },
                    { type: 'simulation', title: 'Coral Reef Ecosystem', description: 'Balance reef health with temperature, pH, and biodiversity' },
                    { type: 'puzzle', title: 'Marine Adaptations', description: 'Match deep-sea creatures to their adaptations' }
                ],
                microbiology: [
                    { type: 'build', title: 'Bacteria Structure', description: 'Assemble a bacterial cell with flagella, pili, and plasmids' },
                    { type: 'simulation', title: 'Petri Dish Lab', description: 'Grow bacterial colonies and observe antibiotic effects' },
                    { type: 'quiz', title: 'Microbe Types', questions: [{ q: 'Which is NOT a microorganism?', options: ['Bacteria', 'Virus', 'Fungus', 'Plant'], answer: 3 }] }
                ]
            },
            // ========== PHYSICS ==========
            physics: {
                classical_mechanics: [
                    { type: 'simulation', title: 'Projectile Motion', description: 'Adjust angle and velocity to hit targets', variables: ['angle', 'velocity', 'gravity'] },
                    { type: 'build', title: 'Simple Machines', description: 'Build lever, pulley, or inclined plane systems', machines: ['lever', 'pulley', 'inclined_plane'] },
                    { type: 'puzzle', title: "Newton's Laws", description: 'Match scenarios to the correct law of motion' },
                    { type: 'simulation', title: 'Collision Lab', description: 'Test elastic and inelastic collisions' }
                ],
                electromagnetism: [
                    { type: 'build', title: 'Circuit Builder', description: 'Wire series and parallel circuits', components: ['battery', 'resistor', 'LED', 'switch'] },
                    { type: 'simulation', title: 'Ohms Law Calculator', description: 'Adjust voltage and resistance to see current changes' },
                    { type: 'puzzle', title: 'Circuit Symbols', description: 'Match symbols to components' },
                    { type: 'simulation', title: 'Magnetic Fields', description: 'Visualize field lines around magnets and currents' }
                ],
                modern_physics: [
                    { type: 'simulation', title: 'Double Slit Experiment', description: 'Observe wave-particle duality with photons' },
                    { type: 'puzzle', title: 'Quantum States', description: 'Explore superposition and measurement' },
                    { type: 'simulation', title: 'Wave Interference', description: 'Create constructive and destructive interference patterns' },
                    { type: 'build', title: 'Photoelectric Effect', description: 'Adjust light frequency to eject electrons' }
                ]
            },
            // ========== CHEMISTRY ==========
            chemistry: {
                general_chemistry: [
                    { type: 'build', title: 'Atom Builder', description: 'Add protons, neutrons, and electrons to build atoms', particles: ['proton', 'neutron', 'electron'] },
                    { type: 'puzzle', title: 'Periodic Table', description: 'Arrange elements by atomic number', elements: ['H', 'He', 'Li', 'Be', 'B', 'C', 'N', 'O'] },
                    { type: 'quiz', title: 'Element Properties', questions: [{ q: 'Noble gases are...', options: ['Reactive', 'Inert', 'Metals', 'Radioactive'], answer: 1 }] }
                ],
                organic_chemistry: [
                    { type: 'build', title: 'Molecule Constructor', description: 'Build organic molecules with carbon chains', molecules: ['methane', 'ethanol', 'benzene'] },
                    { type: 'puzzle', title: 'Functional Groups', description: 'Match functional groups to their properties' },
                    { type: 'simulation', title: 'Chemical Reactions', description: 'Balance equations and observe reactions' }
                ],
                reactions: [
                    { type: 'build', title: 'Protein Folding', description: 'Fold amino acid chains into correct 3D structures' },
                    { type: 'simulation', title: 'Enzyme Kinetics', description: 'Adjust substrate concentration and temperature' },
                    { type: 'simulation', title: 'Reaction Rates', description: 'Adjust temperature and concentration to see rate changes' },
                    { type: 'puzzle', title: 'Balance Equations', description: 'Add coefficients to balance chemical equations' }
                ]
            },
            // ========== ROBOTICS ==========
            robotics: {
                mechanical_design: [
                    { type: 'build', title: 'Robot Arm Assembly', description: 'Connect joints, servos, and grippers', parts: ['base', 'shoulder', 'elbow', 'wrist', 'gripper'] },
                    { type: 'simulation', title: 'Gear Ratio Calculator', description: 'Design gear trains for speed vs torque' },
                    { type: 'puzzle', title: 'Mechanism Types', description: 'Match mechanisms to their functions' }
                ],
                electronics: [
                    { type: 'build', title: 'Sensor Circuit', description: 'Wire up sensors to a microcontroller', components: ['Arduino', 'ultrasonic', 'IR', 'motor_driver'] },
                    { type: 'simulation', title: 'PWM Motor Control', description: 'Adjust duty cycle to control motor speed' },
                    { type: 'puzzle', title: 'Pin Diagrams', description: 'Identify microcontroller pins and functions' }
                ],
                robot_programming: [
                    { type: 'puzzle', title: 'Motion Commands', description: 'Sequence commands to navigate a maze', commands: ['forward', 'turn_left', 'turn_right', 'stop'] },
                    { type: 'simulation', title: 'PID Controller', description: 'Tune PID values for smooth line following' },
                    { type: 'build', title: 'State Machine', description: 'Design robot behavior states' }
                ],
                swarm_robotics: [
                    { type: 'simulation', title: 'Swarm Behavior', description: 'Program simple rules that create emergent swarm patterns' },
                    { type: 'puzzle', title: 'Communication Protocols', description: 'Match swarm signals to behaviors' }
                ],
                soft_robotics: [
                    { type: 'build', title: 'Pneumatic Actuator', description: 'Design a soft gripper using air chambers' },
                    { type: 'simulation', title: 'Material Flexibility', description: 'Test different materials for soft robot performance' }
                ]
            },
            // ========== SOFTWARE ENGINEERING ==========
            software_engineering: {
                programming_fundamentals: [
                    { type: 'puzzle', title: 'Code Blocks', description: 'Arrange code blocks to create a working program', blocks: ['function', 'variable', 'if', 'loop', 'return'] },
                    { type: 'simulation', title: 'Variable Tracker', description: 'Step through code and track variable values' },
                    { type: 'build', title: 'Function Builder', description: 'Define inputs, logic, and outputs for a function' },
                    { type: 'quiz', title: 'Syntax Check', questions: [{ q: 'Loop that runs while true?', options: ['for', 'while', 'if', 'switch'], answer: 1 }] }
                ],
                web_development: [
                    { type: 'build', title: 'HTML Page Builder', description: 'Arrange HTML elements to create a webpage', elements: ['header', 'nav', 'main', 'footer'] },
                    { type: 'puzzle', title: 'CSS Selectors', description: 'Match selectors to the elements they target' },
                    { type: 'simulation', title: 'Responsive Design', description: 'Adjust viewport and see layout changes' }
                ],
                backend_systems: [
                    { type: 'build', title: 'API Endpoint', description: 'Design REST endpoints with routes and methods' },
                    { type: 'puzzle', title: 'SQL Queries', description: 'Match queries to their results' },
                    { type: 'simulation', title: 'Database Schema', description: 'Design tables and relationships' }
                ]
            },
            // ========== 3D PRINTING ==========
            '3d_printing': {
                printer_technology: [
                    { type: 'build', title: 'Printer Assembly', description: 'Identify key components: extruder, bed, frame' },
                    { type: 'simulation', title: 'Print Process', description: 'Watch layer-by-layer build simulation' },
                    { type: 'puzzle', title: 'Technology Types', description: 'Match FDM, SLA, SLS to their characteristics' }
                ],
                '3d_modeling': [
                    { type: 'build', title: 'Shape Constructor', description: 'Combine primitives to design objects', shapes: ['cube', 'sphere', 'cylinder', 'cone'] },
                    { type: 'simulation', title: 'Boolean Operations', description: 'Union, subtract, and intersect shapes' },
                    { type: 'puzzle', title: 'CAD Tools', description: 'Match tools to their functions' }
                ],
                print_optimization: [
                    { type: 'simulation', title: 'Slicer Settings', description: 'Adjust layer height, infill, and speed' },
                    { type: 'puzzle', title: 'Problem Diagnosis', description: 'Match print issues to causes and fixes' },
                    { type: 'build', title: 'Support Structures', description: 'Place supports for overhanging parts' }
                ]
            },
            // ========== CREATIVE WRITING ==========
            creative_writing: {
                fiction_fundamentals: [
                    { type: 'build', title: 'Story Structure', description: 'Arrange plot points: setup, conflict, climax, resolution' },
                    { type: 'puzzle', title: 'Point of View', description: 'Match excerpts to their narrative perspective' },
                    { type: 'simulation', title: 'Character Builder', description: 'Create a character with traits, goals, and flaws' }
                ],
                genre_writing: [
                    { type: 'puzzle', title: 'Genre Conventions', description: 'Match story elements to their genres' },
                    { type: 'build', title: 'World Building', description: 'Design a setting with rules, history, and culture' }
                ],
                craft: [
                    { type: 'puzzle', title: 'Show vs Tell', description: 'Identify which passages show vs tell' },
                    { type: 'build', title: 'Dialogue Workshop', description: 'Write realistic character conversations' }
                ]
            },
            // ========== VISUAL ARTS ==========
            visual_arts: {
                drawing_fundamentals: [
                    { type: 'build', title: 'Shape Construction', description: 'Build complex forms from basic shapes' },
                    { type: 'simulation', title: 'Perspective Grid', description: 'Draw in 1-point, 2-point, 3-point perspective' },
                    { type: 'puzzle', title: 'Proportions', description: 'Identify correct human body proportions' }
                ],
                color_theory: [
                    { type: 'build', title: 'Color Wheel', description: 'Arrange primary, secondary, tertiary colors' },
                    { type: 'puzzle', title: 'Color Harmony', description: 'Match color schemes: complementary, triadic' },
                    { type: 'simulation', title: 'Mood Palette', description: 'Create palettes for different emotions' }
                ],
                digital_art: [
                    { type: 'build', title: 'Layer Composition', description: 'Stack layers for a complete illustration' },
                    { type: 'simulation', title: 'Brush Toolkit', description: 'Test different brush settings and effects' }
                ]
            },
            // ========== PHILOSOPHY ==========
            philosophy: {
                history_of_philosophy: [
                    { type: 'puzzle', title: 'Philosopher Match', description: 'Match philosophers to their key ideas' },
                    { type: 'simulation', title: 'Timeline', description: 'Place philosophical movements in order' }
                ],
                ethics: [
                    { type: 'simulation', title: 'Trolley Problem', description: 'Explore ethical dilemmas and frameworks' },
                    { type: 'puzzle', title: 'Ethical Frameworks', description: 'Match scenarios to utilitarian, deontological approaches' }
                ],
                epistemology: [
                    { type: 'puzzle', title: 'Knowledge Types', description: 'Classify claims as a priori or a posteriori' },
                    { type: 'simulation', title: 'Skepticism Challenge', description: 'Evaluate arguments against certainty' }
                ]
            },
            // ========== HISTORY ==========
            history: {
                world_history: [
                    { type: 'simulation', title: 'Timeline Builder', description: 'Arrange major events in chronological order' },
                    { type: 'puzzle', title: 'Cause and Effect', description: 'Match historical causes to their effects' }
                ],
                african_diaspora: [
                    { type: 'build', title: 'Migration Map', description: 'Trace African diaspora routes and settlements' },
                    { type: 'puzzle', title: 'Cultural Connections', description: 'Match diaspora influences across continents' }
                ],
                historiography: [
                    { type: 'puzzle', title: 'Source Analysis', description: 'Identify primary vs secondary sources' },
                    { type: 'simulation', title: 'Bias Detection', description: 'Analyze documents for historical bias' }
                ]
            },
            // ========== PSYCHOLOGY ==========
            psychology: {
                general_psychology: [
                    { type: 'puzzle', title: 'Psychology Schools', description: 'Match approaches: behaviorist, cognitive, humanistic' },
                    { type: 'simulation', title: 'Experiment Design', description: 'Create a controlled psychology experiment' }
                ],
                cognitive: [
                    { type: 'simulation', title: 'Memory Test', description: 'Test short-term vs long-term memory' },
                    { type: 'puzzle', title: 'Cognitive Biases', description: 'Identify biases in decision-making scenarios' }
                ],
                social: [
                    { type: 'simulation', title: 'Conformity Lab', description: 'Explore social influence and group dynamics' },
                    { type: 'puzzle', title: 'Attribution Theory', description: 'Identify internal vs external attributions' }
                ]
            },
            // ========== ECONOMICS ==========
            economics: {
                microeconomics: [
                    { type: 'simulation', title: 'Supply & Demand', description: 'Adjust curves and find equilibrium price' },
                    { type: 'puzzle', title: 'Market Structures', description: 'Match businesses to perfect competition, monopoly, etc' }
                ],
                macroeconomics: [
                    { type: 'simulation', title: 'GDP Calculator', description: 'Calculate GDP using different methods' },
                    { type: 'puzzle', title: 'Monetary Policy', description: 'Match Fed actions to economic effects' }
                ],
                personal_finance: [
                    { type: 'build', title: 'Budget Planner', description: 'Allocate income across expenses and savings' },
                    { type: 'simulation', title: 'Investment Growth', description: 'See compound interest over time' }
                ]
            },
            // ========== BUSINESS ==========
            business: {
                entrepreneurship: [
                    { type: 'build', title: 'Business Model Canvas', description: 'Design value proposition, customers, revenue' },
                    { type: 'simulation', title: 'Startup Simulator', description: 'Make decisions and see business outcomes' }
                ],
                management: [
                    { type: 'puzzle', title: 'Leadership Styles', description: 'Match situations to appropriate leadership approaches' },
                    { type: 'simulation', title: 'Project Timeline', description: 'Allocate resources and manage deadlines' }
                ],
                marketing: [
                    { type: 'build', title: 'Marketing Mix', description: 'Design the 4 Ps: product, price, place, promotion' },
                    { type: 'puzzle', title: 'Target Audience', description: 'Match products to customer segments' }
                ]
            },
            // ========== FILM STUDIES ==========
            film_studies: {
                film_analysis: [
                    { type: 'puzzle', title: 'Shot Types', description: 'Identify wide shot, close-up, medium shot' },
                    { type: 'simulation', title: 'Scene Breakdown', description: 'Analyze cinematography, sound, and editing' }
                ],
                screenwriting: [
                    { type: 'build', title: 'Three-Act Structure', description: 'Outline setup, confrontation, resolution' },
                    { type: 'puzzle', title: 'Script Format', description: 'Arrange script elements correctly' }
                ],
                production: [
                    { type: 'simulation', title: 'Shot List', description: 'Plan camera setups for a scene' },
                    { type: 'build', title: 'Storyboard', description: 'Sketch key frames for visual storytelling' }
                ]
            },
            // ========== ARCHITECTURE ==========
            architecture: {
                design_principles: [
                    { type: 'puzzle', title: 'Architectural Styles', description: 'Match buildings to Gothic, Modern, Brutalist, etc' },
                    { type: 'build', title: 'Form & Function', description: 'Design a space that meets user needs' }
                ],
                technical: [
                    { type: 'simulation', title: 'Structural Load', description: 'Calculate loads and choose support systems' },
                    { type: 'puzzle', title: 'Building Materials', description: 'Match materials to their properties' }
                ],
                representation: [
                    { type: 'build', title: 'Floor Plan', description: 'Design room layouts with scale and circulation' },
                    { type: 'simulation', title: '3D Walkthrough', description: 'Explore a space in virtual reality' }
                ]
            },
            // ========== ARTIFICIAL INTELLIGENCE ==========
            artificial_intelligence: {
                ml_fundamentals: [
                    { type: 'simulation', title: 'Training Visualizer', description: 'Watch a model learn from data over epochs' },
                    { type: 'build', title: 'Feature Selector', description: 'Choose which features to train on' },
                    { type: 'puzzle', title: 'ML Types', description: 'Classify problems as supervised, unsupervised, or reinforcement' }
                ],
                deep_learning: [
                    { type: 'build', title: 'Neural Network Builder', description: 'Stack layers to create a neural network', layers: ['input', 'hidden', 'activation', 'output'] },
                    { type: 'simulation', title: 'Backpropagation', description: 'See how gradients flow backward to update weights' }
                ],
                applied_ai: [
                    { type: 'simulation', title: 'Image Classifier', description: 'Train a model to recognize images' },
                    { type: 'puzzle', title: 'AI Ethics', description: 'Match scenarios to ethical considerations' }
                ]
            },
            // ========== MATHEMATICS ==========
            mathematics: {
                algebra_foundations: [
                    { type: 'simulation', title: 'Equation Solver', description: 'Step through solving equations visually' },
                    { type: 'puzzle', title: 'Expression Match', description: 'Match equivalent expressions' },
                    { type: 'build', title: 'Function Grapher', description: 'Build functions and see their graphs' }
                ],
                calculus: [
                    { type: 'simulation', title: 'Derivative Visualizer', description: 'See slopes change along a curve' },
                    { type: 'build', title: 'Area Under Curve', description: 'Approximate integrals with rectangles' },
                    { type: 'puzzle', title: 'Limit Problems', description: 'Evaluate limits as x approaches values' }
                ],
                statistics: [
                    { type: 'simulation', title: 'Data Distribution', description: 'Adjust sample size and see normal curves form' },
                    { type: 'build', title: 'Probability Calculator', description: 'Combine events and calculate probabilities' },
                    { type: 'puzzle', title: 'Mean, Median, Mode', description: 'Identify the correct statistical measures' }
                ]
            },
            // ========== ELECTRONICS ==========
            electronics: {
                circuit_fundamentals: [
                    { type: 'build', title: 'Breadboard Circuit', description: 'Wire components on a virtual breadboard', components: ['resistor', 'LED', 'capacitor', 'transistor'] },
                    { type: 'simulation', title: 'Multimeter', description: 'Measure voltage, current, and resistance' },
                    { type: 'puzzle', title: 'Component Symbols', description: 'Match schematic symbols to components' }
                ],
                digital_electronics: [
                    { type: 'build', title: 'Logic Gate Circuit', description: 'Connect AND, OR, NOT gates', gates: ['AND', 'OR', 'NOT', 'XOR'] },
                    { type: 'simulation', title: 'Truth Table Generator', description: 'See outputs for all input combinations' }
                ],
                pcb_design: [
                    { type: 'build', title: 'PCB Layout', description: 'Route traces between components on a board' },
                    { type: 'simulation', title: 'Signal Integrity', description: 'Check for crosstalk and noise issues' },
                    { type: 'puzzle', title: 'Component Placement', description: 'Optimize component positions for routing' }
                ]
            },
            // ========== AEROSPACE ENGINEERING ==========
            aerospace_engineering: {
                aerodynamics: [
                    { type: 'simulation', title: 'Wind Tunnel', description: 'Test airfoil shapes and see lift/drag' },
                    { type: 'build', title: 'Wing Designer', description: 'Adjust camber, span, and aspect ratio' },
                    { type: 'puzzle', title: 'Forces of Flight', description: 'Match forces to their effects' }
                ],
                propulsion: [
                    { type: 'build', title: 'Rocket Engine', description: 'Assemble rocket engine components' },
                    { type: 'simulation', title: 'Thrust Calculator', description: 'Balance fuel, oxidizer, and nozzle design' }
                ],
                orbital_mechanics: [
                    { type: 'simulation', title: 'Orbit Simulator', description: 'Adjust velocity and altitude to achieve orbit' },
                    { type: 'puzzle', title: 'Orbital Maneuvers', description: 'Match burns to orbit changes' }
                ],
                spacecraft_design: [
                    { type: 'build', title: 'Spacecraft Assembly', description: 'Add subsystems: power, thermal, comms' },
                    { type: 'simulation', title: 'Mission Planner', description: 'Plan a mission trajectory' }
                ]
            },
            // ========== ENVIRONMENTAL SCIENCE ==========
            environmental_science: {
                earth_systems: [
                    { type: 'build', title: 'Water Cycle', description: 'Connect evaporation, condensation, precipitation' },
                    { type: 'simulation', title: 'Climate Model', description: 'Adjust CO2 levels and see temperature effects' }
                ],
                climate: [
                    { type: 'simulation', title: 'Greenhouse Effect', description: 'See how gases trap heat' },
                    { type: 'puzzle', title: 'Climate Factors', description: 'Match causes to climate effects' }
                ],
                sustainability: [
                    { type: 'build', title: 'Renewable Grid', description: 'Design a power grid with solar, wind, hydro' },
                    { type: 'simulation', title: 'Carbon Footprint', description: 'Calculate and reduce emissions' }
                ],
                terraforming: [
                    { type: 'simulation', title: 'Mars Atmosphere', description: 'Add gases to warm Mars over centuries' },
                    { type: 'build', title: 'Closed Ecosystem', description: 'Balance plants, animals, and resources' }
                ]
            },
            // ========== NANOTECHNOLOGY ==========
            nanotechnology: {
                nanomaterials: [
                    { type: 'build', title: 'Carbon Nanotube', description: 'Roll graphene into nanotubes' },
                    { type: 'simulation', title: 'Quantum Dot', description: 'Adjust size to change emission color' }
                ],
                nanofabrication: [
                    { type: 'simulation', title: 'Lithography', description: 'Pattern nanoscale features with light' },
                    { type: 'build', title: 'Self-Assembly', description: 'Watch molecules arrange themselves' }
                ],
                nanomedicine: [
                    { type: 'simulation', title: 'Drug Delivery', description: 'Target nanoparticles to cancer cells' },
                    { type: 'puzzle', title: 'Nano Sensors', description: 'Match sensors to their applications' }
                ]
            },
            // ========== MUSIC THEORY ==========
            music_theory: {
                fundamentals: [
                    { type: 'build', title: 'Scale Builder', description: 'Construct major and minor scales', notes: ['C', 'D', 'E', 'F', 'G', 'A', 'B'] },
                    { type: 'simulation', title: 'Chord Player', description: 'Hear how different chords sound' },
                    { type: 'puzzle', title: 'Note Values', description: 'Match notes to their durations' }
                ],
                harmony: [
                    { type: 'build', title: 'Chord Progressions', description: 'Create common progressions like I-IV-V-I' },
                    { type: 'simulation', title: 'Voice Leading', description: 'See smooth note transitions between chords' }
                ],
                composition: [
                    { type: 'build', title: 'Melody Maker', description: 'Compose a melody with rhythm and pitch' },
                    { type: 'simulation', title: 'Arrangement Lab', description: 'Layer instruments in a track' }
                ]
            },
            // ========== GAME DESIGN ==========
            game_design: {
                game_theory: [
                    { type: 'simulation', title: 'Game Loop', description: 'Create the core update-render cycle' },
                    { type: 'puzzle', title: 'Design Patterns', description: 'Match patterns to their uses' },
                    { type: 'build', title: 'Rules System', description: 'Define win conditions and scoring mechanics' }
                ],
                game_development: [
                    { type: 'build', title: 'Level Layout', description: 'Place platforms, obstacles, and collectibles' },
                    { type: 'simulation', title: 'Physics Engine', description: 'Test collision detection and response' },
                    { type: 'simulation', title: 'Pathfinding', description: 'Watch A* navigate through a maze' }
                ],
                game_art: [
                    { type: 'build', title: 'Sprite Sheet', description: 'Create animation frames for characters' },
                    { type: 'puzzle', title: 'Color Palette', description: 'Match palettes to game moods' },
                    { type: 'simulation', title: 'Particle Effects', description: 'Design visual effects for gameplay' }
                ]
            }
        };

        function getExercisesForChapter(fieldId, subfieldId, chapterId) {
            const fieldExercises = interactiveExercises[fieldId];
            if (!fieldExercises) return generateGenericExercise(fieldId, subfieldId, chapterId);
            
            const subfieldExercises = fieldExercises[subfieldId];
            if (!subfieldExercises) return generateGenericExercise(fieldId, subfieldId, chapterId);
            
            return subfieldExercises;
        }

        function generateGenericExercise(fieldId, subfieldId, chapterId) {
            return [{
                type: 'quiz',
                title: 'Knowledge Check',
                description: 'Test your understanding of this chapter',
                questions: [
                    { q: 'What is the main concept of this chapter?', options: ['Answer A', 'Answer B', 'Answer C', 'Answer D'], answer: 0, dynamic: true }
                ]
            }, {
                type: 'reflection',
                title: 'Apply What You Learned',
                description: 'Think about how you would use this concept in a real project',
                prompts: [
                    'Describe one way you could apply this knowledge',
                    'What questions do you still have?',
                    'How does this connect to something you already know?'
                ]
            }];
        }

        function renderInteractiveExercise(exercise, container) {
            const exerciseEl = document.createElement('div');
            exerciseEl.className = 'interactive-exercise';
            
            let content = '';
            
            switch(exercise.type) {
                case 'quiz':
                    content = renderQuizExercise(exercise);
                    break;
                case 'puzzle':
                    content = renderPuzzleExercise(exercise);
                    break;
                case 'build':
                    content = renderBuildExercise(exercise);
                    break;
                case 'simulation':
                    content = renderSimulationExercise(exercise);
                    break;
                case 'reflection':
                    content = renderReflectionExercise(exercise);
                    break;
                default:
                    content = `<p>Exercise: ${exercise.title}</p>`;
            }
            
            exerciseEl.innerHTML = `
                <div class="exercise-header">
                    <span class="exercise-type-badge ${exercise.type}">${exercise.type.toUpperCase()}</span>
                    <h4>${exercise.title}</h4>
                </div>
                <p class="exercise-description">${exercise.description || ''}</p>
                <div class="exercise-content">${content}</div>
            `;
            
            container.appendChild(exerciseEl);
            
            // Add event listeners after appending
            setTimeout(() => addExerciseEventListeners(exerciseEl, exercise), 100);
        }

        function renderQuizExercise(exercise) {
            return exercise.questions.map((q, i) => `
                <div class="quiz-question" data-index="${i}">
                    <p class="question-text">${q.q}</p>
                    <div class="quiz-options">
                        ${q.options.map((opt, j) => `
                            <button class="quiz-option" data-answer="${j}">${opt}</button>
                        `).join('')}
                    </div>
                    <div class="quiz-feedback" style="display: none;"></div>
                </div>
            `).join('');
        }

        function renderPuzzleExercise(exercise) {
            if (exercise.pairs) {
                return `
                    <div class="match-puzzle">
                        <div class="puzzle-items">
                            ${exercise.pairs.map((p, i) => `
                                <div class="puzzle-item" draggable="true" data-index="${i}">${p.item}</div>
                            `).join('')}
                        </div>
                        <div class="puzzle-targets">
                            ${exercise.pairs.sort(() => Math.random() - 0.5).map((p, i) => `
                                <div class="puzzle-target" data-match="${p.item}">${p.match}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            return `<p>Puzzle exercise coming soon...</p>`;
        }

        function renderBuildExercise(exercise) {
            const parts = exercise.parts || exercise.components || exercise.shapes || [];
            return `
                <div class="build-exercise">
                    <div class="build-workspace">
                        <div class="build-canvas" id="buildCanvas">
                            <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                                Drag parts from the toolbox to build your ${exercise.title.toLowerCase()}
                            </p>
                        </div>
                    </div>
                    <div class="build-toolbox">
                        <h5>Parts</h5>
                        ${parts.map(part => `
                            <div class="build-part" draggable="true" data-part="${part}">
                                ${part.replace(/_/g, ' ')}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button class="action-btn" onclick="checkBuild(this)" style="margin-top: 1rem;">Check Build</button>
            `;
        }

        function renderSimulationExercise(exercise) {
            const vars = exercise.variables || [];
            return `
                <div class="simulation-exercise">
                    <div class="sim-controls">
                        ${vars.map(v => `
                            <div class="sim-control">
                                <label>${v.replace(/_/g, ' ')}</label>
                                <input type="range" min="0" max="100" value="50" class="sim-slider" data-var="${v}">
                                <span class="sim-value">50</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="sim-canvas">
                        <p style="color: var(--text-secondary);">Simulation visualization</p>
                    </div>
                    <button class="action-btn" onclick="runSimulation(this)">Run Simulation</button>
                </div>
            `;
        }

        function renderReflectionExercise(exercise) {
            return `
                <div class="reflection-exercise">
                    ${exercise.prompts.map((prompt, i) => `
                        <div class="reflection-prompt">
                            <p>${prompt}</p>
                            <textarea class="reflection-input" placeholder="Your thoughts..." rows="3"></textarea>
                        </div>
                    `).join('')}
                    <button class="action-btn" onclick="saveReflection(this)">Save Reflection</button>
                </div>
            `;
        }

        function addExerciseEventListeners(container, exercise) {
            // Quiz answer handling
            container.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionEl = this.closest('.quiz-question');
                    const index = parseInt(questionEl.dataset.index);
                    const selectedAnswer = parseInt(this.dataset.answer);
                    const correctAnswer = exercise.questions[index].answer;
                    
                    questionEl.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected', 'correct', 'incorrect'));
                    this.classList.add('selected');
                    
                    if (selectedAnswer === correctAnswer) {
                        this.classList.add('correct');
                        questionEl.querySelector('.quiz-feedback').textContent = 'âœ“ Correct!';
                        questionEl.querySelector('.quiz-feedback').style.display = 'block';
                        questionEl.querySelector('.quiz-feedback').style.color = 'var(--accent-primary)';
                    } else {
                        this.classList.add('incorrect');
                        questionEl.querySelector('.quiz-feedback').textContent = 'âœ— Try again';
                        questionEl.querySelector('.quiz-feedback').style.display = 'block';
                        questionEl.querySelector('.quiz-feedback').style.color = 'var(--accent-ajani)';
                    }
                });
            });

            // Simulation slider handling
            container.querySelectorAll('.sim-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    this.nextElementSibling.textContent = this.value;
                });
            });

            // Drag and drop for build exercises
            container.querySelectorAll('.build-part').forEach(part => {
                part.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.part);
                });
            });

            const canvas = container.querySelector('.build-canvas');
            if (canvas) {
                canvas.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                canvas.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                canvas.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const partName = e.dataTransfer.getData('text/plain');
                    const partEl = document.createElement('div');
                    partEl.className = 'placed-part';
                    partEl.textContent = partName.replace(/_/g, ' ');
                    partEl.style.left = (e.offsetX - 40) + 'px';
                    partEl.style.top = (e.offsetY - 15) + 'px';
                    this.appendChild(partEl);
                });
            }
        }

        function checkBuild(btn) {
            showNotification('Build checked! Great work on your assembly.', 'success');
        }

        function runSimulation(btn) {
            const simEl = btn.closest('.simulation-exercise');
            const canvas = simEl.querySelector('.sim-canvas');
            canvas.innerHTML = '<p style="color: var(--accent-primary);">Running simulation...</p>';
            setTimeout(() => {
                canvas.innerHTML = '<p style="color: var(--accent-primary);">âœ“ Simulation complete! Target hit!</p>';
            }, 1500);
        }

        function saveReflection(btn) {
            const inputs = btn.closest('.reflection-exercise').querySelectorAll('.reflection-input');
            const reflections = Array.from(inputs).map(i => i.value).filter(v => v.trim());
            if (reflections.length > 0) {
                showNotification('Reflection saved!', 'success');
            } else {
                showNotification('Please write your thoughts first', 'info');
            }
        }

        // ===== PROJECT STORAGE SYSTEM =====
        let savedProjects = [];

        async function saveProjectToStorage(projectData) {
            try {
                const response = await fetch('/saved-projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
                const data = await response.json();
                if (data.id) {
                    showNotification('Project saved!', 'success');
                    loadSavedProjects();
                }
                return data;
            } catch (err) {
                console.log('Could not save project:', err);
                showNotification('Could not save project', 'error');
            }
        }

        async function loadSavedProjects() {
            try {
                const response = await fetch('/saved-projects');
                savedProjects = await response.json();
                renderSavedProjects();
            } catch (err) {
                console.log('Could not load saved projects:', err);
            }
        }

        function renderSavedProjects() {
            const container = document.getElementById('savedProjectsGallery');
            if (!container) return;
            
            if (savedProjects.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No saved projects yet</p>';
                return;
            }
            
            container.innerHTML = savedProjects.map(project => `
                <div class="saved-project-card" onclick="openSavedProject('${project.id}')">
                    ${project.image_data ? `<img src="${project.image_data}" alt="${project.title}">` : '<div class="project-placeholder">ğŸ“</div>'}
                    <h5>${project.title}</h5>
                    <p>${project.description || 'No description'}</p>
                    <span class="project-date">${new Date(project.created_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        function openSavedProject(projectId) {
            const project = savedProjects.find(p => p.id === projectId);
            if (project) {
                showNotification(`Opening: ${project.title}`, 'info');
            }
        }

        // ===== FULLSCREEN EXERCISE SYSTEM =====
        let currentExerciseState = {
            exercise: null,
            fieldId: null,
            subfieldId: null,
            chapterId: null,
            completed: false,
            progress: 0,
            requiredActions: 0,
            completedActions: 0
        };

        function openFullscreenExercise(exercise, fieldId, subfieldId, chapterId) {
            currentExerciseState = {
                exercise,
                fieldId,
                subfieldId,
                chapterId,
                completed: false,
                progress: 0,
                requiredActions: getRequiredActions(exercise),
                completedActions: 0
            };

            const modal = document.getElementById('exerciseModal');
            const titleEl = document.getElementById('exerciseModalTitle');
            const badgeEl = document.getElementById('exerciseModalBadge');
            const workspaceEl = document.getElementById('exerciseWorkspace');
            const progressFill = document.getElementById('exerciseProgressFill');
            const progressText = document.getElementById('exerciseProgressText');

            titleEl.textContent = exercise.title;
            badgeEl.textContent = exercise.type.toUpperCase();
            badgeEl.className = 'exercise-type-badge ' + exercise.type;
            progressFill.style.width = '0%';
            progressText.textContent = '0% Complete';

            workspaceEl.innerHTML = renderFullscreenExercise(exercise);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            setTimeout(() => setupFullscreenExerciseListeners(exercise), 100);
        }

        function closeExerciseModal() {
            const modal = document.getElementById('exerciseModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            if (!currentExerciseState.completed) {
                showNotification('Exercise not completed. Progress not saved.', 'info');
            }
        }

        function getRequiredActions(exercise) {
            switch(exercise.type) {
                case 'quiz':
                    return exercise.questions ? exercise.questions.length : 1;
                case 'build':
                    const parts = exercise.parts || exercise.components || exercise.shapes || ['part1', 'part2', 'part3'];
                    return Math.max(parts.length, 1);
                case 'puzzle':
                    return exercise.pairs ? Math.max(exercise.pairs.length, 1) : 3;
                case 'simulation':
                    return 1;
                case 'reflection':
                    return exercise.prompts ? Math.max(exercise.prompts.length, 1) : 1;
                default:
                    return 1;
            }
        }

        function updateExerciseProgress() {
            const progress = Math.round((currentExerciseState.completedActions / currentExerciseState.requiredActions) * 100);
            currentExerciseState.progress = Math.min(progress, 100);
            
            const progressFill = document.getElementById('exerciseProgressFill');
            const progressText = document.getElementById('exerciseProgressText');
            
            if (progressFill) progressFill.style.width = currentExerciseState.progress + '%';
            if (progressText) progressText.textContent = currentExerciseState.progress + '% Complete';

            if (currentExerciseState.progress >= 100 && !currentExerciseState.completed) {
                currentExerciseState.completed = true;
                showExerciseComplete();
            }
        }

        function showExerciseComplete() {
            if (typeof forgeLearnEvent === 'function') forgeLearnEvent('exercise_complete');
            const workspaceEl = document.getElementById('exerciseWorkspace');
            workspaceEl.innerHTML = `
                <div class="exercise-complete-screen show">
                    <div class="complete-icon">ğŸ‰</div>
                    <h2 class="complete-title">Exercise Complete!</h2>
                    <p class="complete-subtitle">Great work! You've finished "${currentExerciseState.exercise.title}"</p>
                    <div class="complete-actions">
                        <button class="action-btn primary" onclick="closeExerciseModal()">Continue Learning</button>
                    </div>
                </div>
            `;
            showNotification('Exercise completed!', 'success');
        }

        function renderFullscreenExercise(exercise) {
            let content = `
                <div class="exercise-description" style="font-size: 1.1rem; margin-bottom: 2rem;">
                    ${exercise.description || ''}
                </div>
            `;

            switch(exercise.type) {
                case 'quiz':
                    content += renderFullscreenQuiz(exercise);
                    break;
                case 'build':
                    content += renderFullscreenBuild(exercise);
                    break;
                case 'puzzle':
                    content += renderFullscreenPuzzle(exercise);
                    break;
                case 'simulation':
                    content += renderFullscreenSimulation(exercise);
                    break;
                case 'reflection':
                    content += renderFullscreenReflection(exercise);
                    break;
                default:
                    content += '<p>Exercise type not yet implemented</p>';
            }

            return content;
        }

        function renderFullscreenQuiz(exercise) {
            const questions = exercise.questions || [{ q: 'Sample question?', options: ['A', 'B', 'C', 'D'], answer: 0 }];
            return `
                <div class="fs-quiz-area">
                    ${questions.map((q, i) => `
                        <div class="fs-quiz-question" data-index="${i}" data-answered="false">
                            <div class="fs-question-number">Question ${i + 1} of ${questions.length}</div>
                            <div class="fs-question-text">${q.q}</div>
                            <div class="fs-quiz-options">
                                ${q.options.map((opt, j) => `
                                    <button class="fs-quiz-option" data-answer="${j}" data-correct="${j === q.answer}">${opt}</button>
                                `).join('')}
                            </div>
                            <div class="fs-quiz-feedback"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFullscreenBuild(exercise) {
            const parts = exercise.parts || exercise.components || exercise.shapes || ['part1', 'part2', 'part3'];
            return `
                <div class="fs-build-area">
                    <div class="fs-build-canvas" id="fsBuildCanvas">
                        <p style="color: var(--text-secondary); text-align: center; padding: 3rem; width: 100%;">
                            Drag all parts from the toolbox into this workspace to build your project.
                            <br><br>
                            <span style="font-size: 3rem;">ğŸ”§</span>
                        </p>
                    </div>
                    <div class="fs-toolbox">
                        <h4>Parts (${parts.length})</h4>
                        ${parts.map((part, i) => `
                            <div class="fs-tool-item" draggable="true" data-part="${part}" data-index="${i}">
                                ${part.replace(/_/g, ' ')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFullscreenPuzzle(exercise) {
            const pairs = exercise.pairs || [
                { item: 'Item 1', match: 'Match 1' },
                { item: 'Item 2', match: 'Match 2' },
                { item: 'Item 3', match: 'Match 3' }
            ];
            const shuffledMatches = [...pairs].sort(() => Math.random() - 0.5);
            
            return `
                <div class="fs-puzzle-area">
                    <div class="fs-puzzle-column">
                        <h4>Items to Match</h4>
                        ${pairs.map((p, i) => `
                            <div class="fs-puzzle-item" data-item="${p.item}" data-index="${i}">
                                ${p.item}
                            </div>
                        `).join('')}
                    </div>
                    <div class="fs-puzzle-column">
                        <h4>Click matching description</h4>
                        ${shuffledMatches.map((p, i) => `
                            <div class="fs-puzzle-target" data-match="${p.item}" data-index="${i}">
                                ${p.match}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
                    Click an item on the left, then click its matching description on the right.
                </p>
            `;
        }

        function renderFullscreenSimulation(exercise) {
            const vars = exercise.variables || ['value1', 'value2'];
            return `
                <div class="fs-simulation-area">
                    <div class="fs-sim-controls">
                        <h4 style="margin: 0 0 1.5rem 0; color: var(--text-primary);">Controls</h4>
                        ${vars.map(v => `
                            <div class="fs-sim-control">
                                <label>${v.replace(/_/g, ' ')}</label>
                                <input type="range" class="fs-sim-slider" min="0" max="100" value="50" data-var="${v}">
                                <span class="fs-sim-value">50</span>
                            </div>
                        `).join('')}
                        <button class="action-btn primary" onclick="runFullscreenSimulation()" style="width: 100%; margin-top: 1rem;">
                            â–¶ Run Simulation
                        </button>
                    </div>
                    <div class="fs-sim-canvas" id="fsSimCanvas">
                        <div style="text-align: center; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ”¬</div>
                            <p>Adjust the controls and run the simulation</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFullscreenReflection(exercise) {
            const prompts = exercise.prompts || ['Share your thoughts...'];
            return `
                <div class="fs-reflection-area" style="max-width: 800px; margin: 0 auto;">
                    ${prompts.map((prompt, i) => `
                        <div class="reflection-prompt" style="margin-bottom: 2rem;">
                            <p style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 0.75rem;">${prompt}</p>
                            <textarea class="reflection-input fs-reflection-input" placeholder="Type your response here..." rows="4" data-index="${i}"></textarea>
                        </div>
                    `).join('')}
                    <button class="action-btn primary" onclick="submitReflection()" style="width: 100%;">
                        Submit Reflection
                    </button>
                </div>
            `;
        }

        function setupFullscreenExerciseListeners(exercise) {
            // Quiz listeners
            document.querySelectorAll('.fs-quiz-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionEl = this.closest('.fs-quiz-question');
                    if (questionEl.dataset.answered === 'true') return;
                    
                    const isCorrect = this.dataset.correct === 'true';
                    const feedbackEl = questionEl.querySelector('.fs-quiz-feedback');
                    
                    questionEl.querySelectorAll('.fs-quiz-option').forEach(b => b.classList.add('answered'));
                    
                    if (isCorrect) {
                        this.classList.add('correct');
                        feedbackEl.textContent = 'âœ“ Correct! Logic path validated.';
                        feedbackEl.className = 'fs-quiz-feedback show correct';
                        questionEl.dataset.answered = 'true';
                        currentExerciseState.completedActions++;
                        updateExerciseProgress();
                        if (typeof forgeLearnEvent === 'function') forgeLearnEvent('correct_answer');
                    } else {
                        this.classList.add('incorrect');
                        feedbackEl.textContent = 'âœ— Logic inconsistency. Recalibrating...';
                        feedbackEl.className = 'fs-quiz-feedback show incorrect';
                        if (typeof forgeLearnEvent === 'function') forgeLearnEvent('wrong_answer');
                        setTimeout(() => {
                            this.classList.remove('incorrect');
                            questionEl.querySelectorAll('.fs-quiz-option').forEach(b => b.classList.remove('answered'));
                            feedbackEl.className = 'fs-quiz-feedback';
                        }, 1500);
                    }
                });
            });

            // Build drag-drop listeners
            const canvas = document.getElementById('fsBuildCanvas');
            if (canvas) {
                document.querySelectorAll('.fs-tool-item').forEach(item => {
                    item.addEventListener('dragstart', function(e) {
                        if (this.classList.contains('used')) {
                            e.preventDefault();
                            return;
                        }
                        e.dataTransfer.setData('text/plain', this.dataset.part);
                        e.dataTransfer.setData('index', this.dataset.index);
                    });
                });

                canvas.addEventListener('dragover', e => {
                    e.preventDefault();
                    canvas.classList.add('drag-over');
                });
                
                canvas.addEventListener('dragleave', () => {
                    canvas.classList.remove('drag-over');
                });
                
                canvas.addEventListener('drop', function(e) {
                    e.preventDefault();
                    canvas.classList.remove('drag-over');
                    
                    const partName = e.dataTransfer.getData('text/plain');
                    const index = e.dataTransfer.getData('index');
                    
                    // Mark tool as used
                    const tool = document.querySelector(`.fs-tool-item[data-index="${index}"]`);
                    if (tool && !tool.classList.contains('used')) {
                        tool.classList.add('used');
                        
                        // Clear placeholder text
                        if (canvas.querySelector('p')) {
                            canvas.innerHTML = '';
                        }
                        
                        // Create placed part
                        const partEl = document.createElement('div');
                        partEl.className = 'fs-placed-part';
                        partEl.innerHTML = `
                            ${partName.replace(/_/g, ' ')}
                            <button class="remove-btn" onclick="removePlacedPart(this, '${index}')">&times;</button>
                        `;
                        canvas.appendChild(partEl);
                        
                        // LOCAL LOGIC - Track part in ForgeEngine
                        ForgeEngine.setVariable(`part_${index}`, partName);
                        ForgeEngine.incrementLogicFlow(3);
                        ForgeEngine.syncToUI();
                        
                        currentExerciseState.completedActions++;
                        updateExerciseProgress();
                        if (typeof forgeLearnEvent === 'function') forgeLearnEvent('part_placed', { part: partName });
                    }
                });
            }

            // Puzzle listeners
            let selectedPuzzleItem = null;
            document.querySelectorAll('.fs-puzzle-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('matched')) return;
                    
                    document.querySelectorAll('.fs-puzzle-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPuzzleItem = this.dataset.item;
                    
                    document.querySelectorAll('.fs-puzzle-target:not(.matched)').forEach(t => t.classList.add('highlight'));
                });
            });

            document.querySelectorAll('.fs-puzzle-target').forEach(target => {
                target.addEventListener('click', function() {
                    if (!selectedPuzzleItem || this.classList.contains('matched')) return;
                    
                    const isMatch = this.dataset.match === selectedPuzzleItem;
                    
                    // LOCAL SCORING - No AI call
                    const result = ForgeEngine.scoreAnswer(isMatch);
                    ForgeEngine.syncToUI();
                    
                    if (isMatch) {
                        this.classList.add('matched');
                        this.classList.remove('highlight');
                        this.innerHTML = `<span class="matched-label">${selectedPuzzleItem}</span>${this.textContent}`;
                        
                        const itemEl = document.querySelector(`.fs-puzzle-item[data-item="${selectedPuzzleItem}"]`);
                        if (itemEl) itemEl.classList.add('matched');
                        
                        selectedPuzzleItem = null;
                        document.querySelectorAll('.fs-puzzle-target:not(.matched)').forEach(t => t.classList.remove('highlight'));
                        
                        currentExerciseState.completedActions++;
                        updateExerciseProgress();
                        if (typeof forgeLearnEvent === 'function') forgeLearnEvent('correct_answer');
                    } else {
                        this.style.borderColor = '#ff6464';
                        this.style.background = 'rgba(255, 100, 100, 0.1)';
                        if (typeof forgeLearnEvent === 'function') forgeLearnEvent('wrong_answer');
                        setTimeout(() => {
                            this.style.borderColor = '';
                            this.style.background = '';
                        }, 500);
                    }
                });
            });

            // Simulation slider listeners
            document.querySelectorAll('.fs-sim-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    this.nextElementSibling.textContent = this.value;
                });
            });
        }

        function removePlacedPart(btn, index) {
            const tool = document.querySelector(`.fs-tool-item[data-index="${index}"]`);
            if (tool) tool.classList.remove('used');
            
            btn.closest('.fs-placed-part').remove();
            currentExerciseState.completedActions--;
            updateExerciseProgress();
            
            const canvas = document.getElementById('fsBuildCanvas');
            if (canvas && canvas.children.length === 0) {
                canvas.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 3rem; width: 100%;">
                        Drag all parts from the toolbox into this workspace to build your project.
                        <br><br>
                        <span style="font-size: 3rem;">ğŸ”§</span>
                    </p>
                `;
            }
        }

        function runFullscreenSimulation() {
            const canvas = document.getElementById('fsSimCanvas');
            if (!canvas) return;
            
            canvas.innerHTML = `
                <div style="text-align: center;">
                    <div class="fs-sim-visualization">âš¡</div>
                    <p style="color: var(--accent-primary); font-size: 1.2rem;">Running simulation...</p>
                </div>
            `;
            
            if (typeof forgeLearnEvent === 'function') forgeLearnEvent('simulation_run');
            setTimeout(() => {
                canvas.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">âœ“</div>
                        <p style="color: var(--accent-primary); font-size: 1.3rem; font-weight: 600;">Simulation Complete!</p>
                        <p style="color: var(--text-secondary);">Results calculated based on your input values.</p>
                    </div>
                `;
                currentExerciseState.completedActions = currentExerciseState.requiredActions;
                updateExerciseProgress();
            }, 2000);
        }

        function submitReflection() {
            const inputs = document.querySelectorAll('.fs-reflection-input');
            let filledCount = 0;
            
            inputs.forEach(input => {
                if (input.value.trim().length > 10) {
                    filledCount++;
                }
            });
            
            if (filledCount < inputs.length) {
                showNotification('Please write thoughtful responses (at least 10 characters each)', 'info');
                return;
            }
            
            currentExerciseState.completedActions = currentExerciseState.requiredActions;
            updateExerciseProgress();
        }

        // Override the study chapter for interactive mode to use fullscreen
        const originalStudyChapter = window.studyChapter;
        window.studyChapter = function(fieldId, subfieldId, chapterId) {
            const mode = localStorage.getItem('atlas_learning_mode') || 'text';
            
            if (mode === 'interactive') {
                const exercises = getExercisesForChapter(fieldId, subfieldId, chapterId);
                if (exercises && exercises.length > 0) {
                    openFullscreenExercise(exercises[0], fieldId, subfieldId, chapterId);
                    return;
                }
            }
            
            if (typeof originalStudyChapter === 'function') {
                originalStudyChapter(fieldId, subfieldId, chapterId);
            }
        };
    </script>

    <!-- Fullscreen Exercise Modal -->
    <div id="exerciseModal" class="exercise-modal">
        <div class="exercise-modal-header">
            <div class="exercise-modal-title">
                <span id="exerciseModalBadge" class="exercise-type-badge build">BUILD</span>
                <h2 id="exerciseModalTitle">Exercise Title</h2>
            </div>
            <button class="exercise-close-btn" onclick="closeExerciseModal()">âœ• Close</button>
        </div>
        <div class="exercise-modal-body">
            <div class="exercise-progress-bar">
                <span>Progress:</span>
                <div class="progress-track">
                    <div class="progress-fill" id="exerciseProgressFill"></div>
                </div>
                <span class="progress-text" id="exerciseProgressText">0% Complete</span>
            </div>
            <div class="exercise-workspace" id="exerciseWorkspace"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         EDGE PANEL â€” Hypothesis Development Lab
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <style>
        .edge-panel-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 120px;
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-right: none;
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 901;
            transition: all var(--transition-base);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: var(--font-xs);
            font-weight: var(--weight-semibold);
            color: var(--text-secondary);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: -2px 0 12px rgba(90, 154, 138, 0.08);
        }
        .edge-panel-tab:hover {
            background: var(--surface-3);
            color: var(--text-primary);
            box-shadow: -2px 0 20px rgba(90, 154, 138, 0.18);
            width: 40px;
        }
        .edge-panel-tab.hidden { display: none; }
        .edge-panel-tab .tab-icon {
            font-size: 14px;
            margin-bottom: 6px;
        }

        .edge-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 899;
        }
        .edge-panel-overlay.open { display: block; }

        .edge-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 340px;
            max-width: 100vw;
            background: var(--surface-1);
            border-left: 1px solid var(--border-default);
            z-index: 900;
            transform: translateX(100%);
            transition: transform var(--transition-slow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .edge-panel.open { transform: translateX(0); }

        .edge-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border-default);
            background: var(--surface-2);
            flex-shrink: 0;
        }
        .edge-panel-header h3 {
            margin: 0;
            font-size: var(--font-lg);
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .edge-panel-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        .edge-panel-close:hover { color: var(--text-primary); background: var(--surface-3); }

        .edge-panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-default);
            background: var(--surface-2);
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .edge-panel-tabs::-webkit-scrollbar { display: none; }
        .edge-panel-tabs button {
            flex: 0 0 auto;
            padding: var(--space-3) var(--space-2);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: var(--font-xs);
            font-weight: var(--weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }
        .edge-panel-tabs button:hover { color: var(--text-secondary); background: var(--surface-3); }
        .edge-panel-tabs button.active-ajani { color: var(--ajani); border-bottom-color: var(--ajani); }
        .edge-panel-tabs button.active-minerva { color: var(--minerva); border-bottom-color: var(--minerva); }
        .edge-panel-tabs button.active-hermes { color: var(--hermes); border-bottom-color: var(--hermes); }
        .edge-panel-tabs button.active-doctrine { color: #ffc107; border-bottom-color: #ffc107; }
        .edge-panel-tabs button.active-figma { color: #a259ff; border-bottom-color: #a259ff; }
        .edge-panel-tabs button.active-reality { color: #f97316; border-bottom-color: #f97316; }
        .edge-panel-tabs button.active-validation { color: #22d3ee; border-bottom-color: #22d3ee; }
        .edge-panel-tabs button.active-blueprints { color: #ef4444; border-bottom-color: #ef4444; }

        .edge-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }
        .edge-panel-body::-webkit-scrollbar { width: 4px; }
        .edge-panel-body::-webkit-scrollbar-track { background: transparent; }
        .edge-panel-body::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }

        .ep-build-order-banner {
            background: linear-gradient(135deg, rgba(255,170,0,0.08), rgba(255,100,0,0.04));
            border: 1px solid rgba(255,170,0,0.25);
            border-radius: var(--radius-md);
            padding: 10px 12px;
            margin-bottom: var(--space-4);
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .ep-build-order-banner .ep-bo-title {
            font-weight: var(--weight-bold);
            color: #ffaa00;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .ep-build-order-banner .ep-bo-chain {
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: monospace;
            font-size: 10px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .ep-build-order-banner .ep-bo-step {
            background: var(--surface-4);
            padding: 2px 6px;
            border-radius: 3px;
            color: var(--text-primary);
            font-weight: var(--weight-semibold);
        }
        .ep-build-order-banner .ep-bo-step.foundation {
            background: rgba(255,170,0,0.2);
            color: #ffaa00;
            border: 1px solid rgba(255,170,0,0.3);
        }
        .ep-build-order-banner .ep-bo-arrow { color: var(--text-muted); }
        .ep-platform-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: var(--weight-bold);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 2px 8px;
            border-radius: 3px;
            margin-bottom: 6px;
        }
        .ep-platform-badge.foundation {
            background: rgba(255,170,0,0.15);
            color: #ffaa00;
            border: 1px solid rgba(255,170,0,0.3);
        }
        .ep-platform-badge.cell-type {
            background: rgba(100,200,255,0.1);
            color: #64c8ff;
            border: 1px solid rgba(100,200,255,0.2);
        }
        .ep-platform-badge.alternate {
            background: rgba(150,150,150,0.1);
            color: var(--text-muted);
            border: 1px solid var(--border-subtle);
        }
        .ep-project-card {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            transition: border-color var(--transition-fast);
            cursor: pointer;
        }
        .ep-card-collapse-arrow {
            float: right;
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .ep-project-card.ep-card-expanded .ep-card-collapse-arrow { transform: rotate(90deg); }
        .ep-card-detail { display: none; }
        .ep-project-card.ep-card-expanded .ep-card-detail { display: block; }
        .ep-project-card.ep-card-highlighted {
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 12px rgba(100,200,255, 0.2);
            animation: ep-highlight-pulse 1.5s ease-out;
        }
        @keyframes ep-highlight-pulse {
            0% { box-shadow: 0 0 20px rgba(100,200,255,0.4); }
            100% { box-shadow: 0 0 12px rgba(100,200,255,0.2); }
        }
        .ep-activity-clickable { cursor: pointer; transition: background 0.2s; }
        .ep-activity-clickable:hover { background: var(--surface-3); }
        .ep-phase-dot {
            position: relative;
            cursor: pointer;
        }
        .ep-phase-tooltip {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .ep-phase-dot:hover .ep-phase-tooltip { display: block; }
        .ep-phase-tooltip-name { font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
        .ep-phase-tooltip-desc { font-size: 9px; color: var(--text-muted); }
        .ep-search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: var(--space-4);
        }
        .ep-search-input {
            flex: 1;
            background: var(--surface-3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            font-size: var(--font-xs);
            color: var(--text-primary);
            outline: none;
        }
        .ep-search-input:focus { border-color: var(--border-strong); }
        .ep-search-input::placeholder { color: var(--text-muted); }
        .ep-search-count {
            font-size: 10px;
            color: var(--text-muted);
            padding: 6px 0;
        }
        .ep-doctrine-expandable { cursor: pointer; }
        .ep-doctrine-expandable:hover { background: var(--surface-3); }
        .ep-doctrine-detail { display: none; margin-top: 6px; }
        .ep-doctrine-detail.open { display: block; }
        .ep-expand-arrow {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
            display: inline-block;
        }
        .ep-doctrine-detail.open ~ .ep-expand-arrow,
        .ep-doctrine-expandable.open .ep-expand-arrow { transform: rotate(90deg); }
        .ep-project-card.ep-foundation-card {
            border-color: rgba(255,170,0,0.3);
            box-shadow: 0 0 12px rgba(255,170,0,0.06);
        }
        .ep-project-card.ep-cell-card {
            border-left: 2px solid rgba(100,200,255,0.3);
        }
        .ep-project-card:hover { border-color: var(--border-strong); }
        .ep-project-name {
            font-size: var(--font-sm);
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
            margin: 0 0 2px 0;
        }
        .ep-project-codename {
            font-size: var(--font-xs);
            color: var(--text-muted);
            font-family: monospace;
            margin-bottom: var(--space-3);
        }

        .ep-phase-dots {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        .ep-phase-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--surface-4);
            border: 1px solid var(--border-default);
            transition: all var(--transition-fast);
        }
        .ep-phase-dot.filled {
            border-color: transparent;
        }
        .ep-phase-dot.current {
            box-shadow: 0 0 6px currentColor;
            transform: scale(1.15);
        }
        .ep-phase-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-left: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ep-progress-bar {
            height: 4px;
            background: var(--surface-4);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 2px;
        }
        .ep-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width var(--transition-slow);
        }
        .ep-progress-text {
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            margin-bottom: var(--space-3);
        }

        .ep-focus {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            line-height: var(--leading-relaxed);
            margin-bottom: var(--space-2);
        }
        .ep-focus-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .ep-hypothesis {
            font-size: var(--font-xs);
            color: var(--success);
            background: rgba(74, 138, 90, 0.08);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--success);
            line-height: var(--leading-normal);
        }

        .ep-tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }
        .ep-tier-badge.conceptual_sandbox {
            background: rgba(90, 154, 138, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(90, 154, 138, 0.3);
        }
        .ep-tier-badge.validation_prep {
            background: rgba(255, 170, 0, 0.12);
            color: #ffaa00;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }
        .ep-tier-badge.empirical_bridge {
            background: rgba(76, 175, 80, 0.12);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .ep-tier-desc {
            font-size: 9px;
            color: var(--text-muted);
            padding: 4px 0 6px 0;
            line-height: 1.4;
            font-style: italic;
        }
        .ep-feasibility-badge {
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 8px;
            border-radius: 4px;
            margin: 4px 0;
            cursor: pointer;
            transition: opacity 0.2s;
            text-align: center;
        }
        .ep-feasibility-badge:hover { opacity: 0.8; }
        .ep-ft-unvalidated {
            background: rgba(100,100,100,0.1);
            color: var(--text-muted);
            border: 1px dashed rgba(100,100,100,0.3);
        }
        .ep-eng-validation-card {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            background: rgba(99,102,241,0.04);
            border: 1px solid rgba(99,102,241,0.12);
        }

        .ep-schedule-indicator {
            margin-bottom: 8px;
        }
        .ep-sched-bar {
            padding: 8px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .ep-sched-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ep-sched-icon {
            font-size: 16px;
        }
        .ep-sched-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ep-sched-next {
            font-size: 9px;
            color: var(--text-muted);
            margin-left: auto;
        }
        .ep-sched-desc {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }
        .ep-sched-timeline {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .ep-sched-block {
            flex: 1;
            padding: 4px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.02);
            transition: all 0.2s ease;
        }
        .ep-sched-block.active {
            border-width: 2px;
        }
        .ep-sched-block-icon {
            font-size: 12px;
            display: block;
        }
        .ep-sched-block-time {
            font-size: 8px;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        .bp-lab-card {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .bp-lab-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255,255,255,0.25);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .bp-lab-card-header {
            padding: 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .bp-lab-card-info {
            padding: 12px 14px;
        }
        .bp-lab-card-title {
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .bp-lab-card-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .bp-lab-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .bp-lab-tag {
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ep-handbook-viewer {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 6px;
        }
        .ep-hb-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .ep-hb-nav-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.15s ease;
        }
        .ep-hb-nav-btn:hover { background: rgba(255,255,255,0.15); }
        .ep-hb-nav-btn:disabled { opacity: 0.3; cursor: default; }
        .ep-hb-page-info {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
        }
        .ep-hb-page {
            padding: 12px;
            min-height: 320px;
        }
        .ep-hb-cover {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            text-align: center;
        }
        .ep-hb-cover-title {
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .ep-hb-cover-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .ep-hb-cover-badge {
            font-size: 9px;
            padding: 3px 10px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 6px;
        }
        .ep-hb-page-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .ep-hb-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .ep-hb-svg-container {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }
        .ep-hb-svg-container svg {
            width: 100%;
            height: auto;
            display: block;
        }
        .ep-hb-step-info {
            margin-top: 8px;
        }
        .ep-hb-step-instruction {
            font-size: 10px;
            color: var(--text-primary);
            line-height: 1.5;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            border-left: 3px solid rgba(255,255,255,0.15);
            margin-bottom: 8px;
        }
        .ep-hb-tools-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 6px 0;
        }
        .ep-hb-tool-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(100,170,255,0.12);
            color: #66aaff;
            border-radius: 3px;
            border: 1px solid rgba(100,170,255,0.2);
        }
        .ep-hb-safety {
            font-size: 9px;
            padding: 6px 8px;
            background: rgba(255,170,0,0.08);
            border-left: 3px solid #ffaa00;
            border-radius: 4px;
            color: #ffaa00;
            margin: 6px 0;
        }
        .ep-hb-checkpoint {
            font-size: 9px;
            padding: 6px 8px;
            background: rgba(0,204,102,0.08);
            border-left: 3px solid #00cc66;
            border-radius: 4px;
            color: #00cc66;
            margin: 6px 0;
        }
        .ep-hb-parts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin: 8px 0;
        }
        .ep-hb-part-tag {
            font-size: 9px;
            padding: 4px 6px;
            background: rgba(255,255,255,0.04);
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .ep-hb-part-tag-name { font-weight: 600; color: var(--text-primary); }
        .ep-hb-part-tag-spec { color: var(--text-muted); font-style: italic; }
        .ep-hb-wire-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin: 8px 0;
        }
        .ep-hb-wire-table th {
            text-align: left;
            padding: 4px 6px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .ep-hb-wire-table td {
            padding: 3px 6px;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .ep-hb-checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            padding: 4px 0;
            font-size: 10px;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .ep-hb-checklist-item:last-child { border-bottom: none; }
        .ep-hb-check-icon { font-size: 12px; flex-shrink: 0; }
        .ep-hb-critical { color: #ff4444; font-weight: 600; }
        .ep-hb-machine-specs {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2px 10px;
            font-size: 9px;
            margin: 8px 0;
            padding: 6px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
        }
        .ep-hb-spec-label {
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .ep-hb-spec-value { color: var(--text-primary); }
        .ep-hb-sensor-list, .ep-hb-tool-list-full {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 4px 0;
        }
        .ep-hb-sensor-tag {
            font-size: 8px;
            padding: 2px 5px;
            background: rgba(68,170,170,0.12);
            color: #44aaaa;
            border-radius: 3px;
        }
        .ep-hb-charter-rule {
            padding: 8px;
            margin: 4px 0;
            background: rgba(255,68,68,0.06);
            border: 1px solid rgba(255,68,68,0.15);
            border-radius: 4px;
        }
        .ep-hb-charter-number {
            font-size: 18px;
            font-weight: 900;
            color: #ff4444;
            float: left;
            margin-right: 8px;
            line-height: 1;
        }
        .ep-hb-charter-name {
            font-size: 10px;
            font-weight: 700;
            color: #ff6666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ep-hb-charter-desc {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 3px;
            line-height: 1.4;
        }

        .ep-build-plan-card {
            margin: 6px 0;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
        }
        .ep-build-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            padding: 4px 0;
        }
        .ep-build-plan-header:hover { opacity: 0.8; }
        .ep-build-plan-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }
        .ep-build-type-badge {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.08);
            color: var(--text-muted);
        }
        .ep-build-section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 6px 0 4px;
        }
        .ep-parts-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .ep-part-item {
            padding: 4px 6px;
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
            border-left: 2px solid rgba(255,255,255,0.1);
        }
        .ep-part-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .ep-part-spec {
            font-size: 9px;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 2px;
        }
        .ep-part-source {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 1px;
        }
        .ep-build-step {
            padding: 6px;
            margin: 3px 0;
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
            border-left: 2px solid rgba(255,255,255,0.08);
        }
        .ep-build-step.ep-step-done {
            border-left-color: #00cc66;
            opacity: 0.7;
        }
        .ep-step-header {
            font-size: 10px;
            color: var(--text-primary);
        }
        .ep-step-desc {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 3px;
            line-height: 1.4;
        }
        .ep-step-tools {
            font-size: 9px;
            color: #66aaff;
            margin-top: 2px;
        }
        .ep-step-safety {
            font-size: 9px;
            color: #ffaa00;
            margin-top: 2px;
        }
        .ep-step-outcome {
            font-size: 9px;
            color: #00cc66;
            margin-top: 2px;
            font-style: italic;
        }

        .ep-validation-section {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 170, 0, 0.05);
            border: 1px solid rgba(255, 170, 0, 0.15);
            border-radius: 6px;
        }
        .ep-validation-title {
            font-size: 10px;
            font-weight: 600;
            color: #ffaa00;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ep-validation-item {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .ep-validation-item:last-child { border-bottom: none; }
        .ep-validation-label { font-size: 9px; color: var(--text-muted); font-weight: 600; }

        .ep-empirical-section {
            margin-top: 8px;
            padding: 8px;
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.15);
            border-radius: 6px;
        }
        .ep-empirical-title {
            font-size: 10px;
            font-weight: 600;
            color: #4caf50;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ep-empirical-locked {
            font-size: 10px;
            color: var(--text-muted);
            padding: 8px;
            text-align: center;
            font-style: italic;
        }
        .ep-empirical-locked .lock-icon { font-size: 16px; display: block; margin-bottom: 4px; opacity: 0.5; }
        .ep-empirical-entry {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .ep-empirical-verified {
            font-size: 8px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 8px;
            background: rgba(76,175,80,0.2);
            color: #4caf50;
        }

        .ep-section-title {
            font-size: var(--font-xs);
            font-weight: var(--weight-semibold);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: var(--space-5) 0 var(--space-3) 0;
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border-subtle);
        }

        .ep-activity-item {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .ep-activity-item:last-child { border-bottom: none; }
        .ep-activity-badge {
            flex-shrink: 0;
            font-size: 9px;
            font-weight: var(--weight-semibold);
            padding: 2px 6px;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 2px;
        }
        .ep-badge-breakthrough, .ep-badge-hypothesis { background: rgba(74, 138, 90, 0.15); color: var(--success); }
        .ep-badge-phase_change { background: rgba(107, 90, 138, 0.15); color: var(--accent-secondary); }
        .ep-badge-focus_shift { background: rgba(74, 106, 138, 0.15); color: var(--info); }
        .ep-badge-daily_update { background: rgba(90, 90, 100, 0.15); color: var(--text-muted); }
        .ep-badge-note { background: rgba(154, 138, 74, 0.15); color: var(--warning); }
        .ep-activity-content { flex: 1; min-width: 0; }
        .ep-activity-title {
            font-size: var(--font-xs);
            font-weight: var(--weight-medium);
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .ep-activity-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: var(--leading-normal);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .ep-activity-time {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .ep-loading {
            text-align: center;
            padding: var(--space-8);
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        .ep-resources-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: var(--space-2) var(--space-3);
            margin-top: var(--space-3);
            background: var(--surface-3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: var(--font-xs);
            font-weight: var(--weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .ep-resources-toggle:hover {
            background: var(--surface-4);
            color: var(--text-primary);
            border-color: var(--border-default);
        }
        .ep-resources-toggle .ep-res-badge {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
            font-size: 10px;
            font-weight: var(--weight-semibold);
            padding: 1px 6px;
            border-radius: var(--radius-full);
        }
        .ep-resources-toggle .ep-res-arrow {
            font-size: 10px;
            transition: transform var(--transition-fast);
        }
        .ep-resources-toggle.open .ep-res-arrow {
            transform: rotate(180deg);
        }
        .ep-resources-content {
            display: none;
            margin-top: var(--space-2);
            padding: var(--space-3);
            background: var(--surface-0);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
        }
        .ep-resources-content.open {
            display: block;
        }
        .ep-res-group {
            margin-bottom: var(--space-3);
        }
        .ep-res-group:last-child {
            margin-bottom: 0;
        }
        .ep-res-group-title {
            font-size: 10px;
            font-weight: var(--weight-semibold);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        .ep-res-item {
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .ep-res-item:last-child {
            border-bottom: none;
        }
        .ep-res-link {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            line-height: var(--leading-normal);
            transition: color var(--transition-fast);
        }
        .ep-res-link:hover {
            color: var(--accent-primary);
        }
        .ep-res-title {
            font-weight: var(--weight-medium);
            color: var(--text-primary);
            font-size: 11px;
            margin-bottom: 1px;
        }
        .ep-res-meta {
            font-size: 9px;
            color: var(--text-muted);
        }
        .ep-res-expandable {
            cursor: pointer;
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .ep-res-expandable:last-child {
            border-bottom: none;
        }
        .ep-res-expand-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-2);
        }
        .ep-res-expand-header .ep-res-title {
            flex: 1;
        }
        .ep-res-expand-arrow {
            font-size: 9px;
            color: var(--text-muted);
            transition: transform var(--transition-fast);
            flex-shrink: 0;
        }
        .ep-res-expandable.open .ep-res-expand-arrow {
            transform: rotate(180deg);
        }
        .ep-res-expand-body {
            display: none;
            margin-top: var(--space-2);
            font-size: 11px;
            color: var(--text-secondary);
            line-height: var(--leading-relaxed);
            padding: var(--space-2) var(--space-3);
            background: var(--surface-1);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--border-default);
        }
        .ep-res-expandable.open .ep-res-expand-body {
            display: block;
        }
        .ep-res-loading {
            text-align: center;
            padding: var(--space-3);
            color: var(--text-muted);
            font-size: 11px;
        }

        .ep-blueprint-visual {
            margin: 8px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .ep-blueprint-img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px 8px 0 0;
            opacity: 0.92;
            transition: opacity 0.3s;
        }
        .ep-blueprint-img:hover {
            opacity: 1;
        }
        .ep-blueprint-steps {
            display: flex;
            gap: 2px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.5);
        }
        .ep-blueprint-step {
            flex: 1;
            text-align: center;
            padding: 4px 2px;
            font-size: 9px;
            color: var(--text-muted);
            border-radius: 4px;
            background: rgba(255,255,255,0.04);
            position: relative;
            overflow: hidden;
        }
        .ep-blueprint-step.completed {
            color: var(--text-primary);
        }
        .ep-blueprint-step .step-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: currentColor;
            opacity: 0.15;
            border-radius: 4px;
            transition: height 0.5s ease;
        }
        .ep-blueprint-step.completed .step-fill {
            height: 100%;
        }
        .ep-blueprint-step.active {
            border: 1px solid currentColor;
        }
        .ep-blueprint-step .step-num {
            font-weight: 700;
            font-size: 10px;
            display: block;
            margin-bottom: 1px;
        }
        .ep-blueprint-step .step-label {
            display: block;
            line-height: 1.1;
        }
        .ep-blueprint-caption {
            padding: 6px 8px;
            font-size: 10px;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .ep-prototype-section {
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.3);
        }
        .ep-prototype-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            user-select: none;
        }
        .ep-prototype-header:hover {
            background: rgba(255,255,255,0.03);
        }
        .ep-prototype-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .ep-prototype-arrow {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .ep-prototype-section.open .ep-prototype-arrow {
            transform: rotate(180deg);
        }
        .ep-prototype-body {
            display: none;
            padding: 0;
        }
        .ep-prototype-section.open .ep-prototype-body {
            display: block;
        }
        .ep-prototype-img-wrap {
            position: relative;
            overflow: hidden;
        }
        .ep-prototype-img {
            width: 100%;
            height: auto;
            display: block;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        .ep-prototype-img:hover {
            opacity: 1;
        }
        .ep-prototype-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            padding: 20px 10px 10px;
        }
        .ep-prototype-completion {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ep-prototype-bar-track {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            overflow: hidden;
        }
        .ep-prototype-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.6s ease;
        }
        .ep-prototype-pct {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            min-width: 35px;
            text-align: right;
        }
        .ep-prototype-phase {
            font-size: 9px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .ep-prototype-status-dots {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        .ep-proto-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
        }
        .ep-proto-dot.filled {
            opacity: 0.9;
        }
        .ep-proto-dot.current {
            box-shadow: 0 0 6px currentColor;
        }

        .ep-ref-label {
            background: rgba(180, 40, 40, 0.85);
            color: #fff;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            padding: 4px 8px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2;
        }
        .ep-eng-view {
            padding: 8px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .ep-eng-section {
            margin-bottom: 12px;
        }
        .ep-eng-section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .ep-block-diagram {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 8px;
            position: relative;
        }
        .ep-block-node {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 6px 4px;
            text-align: center;
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ep-block-node:hover:not(.ep-block-node-empty) {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255,255,255,0.15);
            z-index: 2;
        }
        .ep-block-node.ep-node-active {
            box-shadow: 0 0 16px rgba(255,255,255,0.25);
            transform: scale(1.08);
            z-index: 3;
        }
        .ep-node-detail-popup {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            background: rgba(15,15,20,0.97);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            pointer-events: auto;
        }
        .ep-node-detail-popup::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(255,255,255,0.2);
        }
        .ep-node-popup-title {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .ep-node-popup-id {
            font-size: 9px;
            font-family: 'Courier New', monospace;
            opacity: 0.6;
            margin-bottom: 6px;
        }
        .ep-node-popup-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .ep-node-popup-connections {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.08);
            font-size: 9px;
            color: var(--text-muted);
        }
        .ep-block-node-id {
            font-family: 'Courier New', monospace;
            font-size: 9px;
            font-weight: 700;
            opacity: 0.7;
            margin-bottom: 2px;
        }
        .ep-block-node-label {
            font-size: 9px;
            color: var(--text-primary);
            line-height: 1.2;
            white-space: pre-line;
        }
        .ep-block-node-empty {
            background: transparent;
            border: none;
        }
        .ep-block-arrows {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 6px 0 0;
        }
        .ep-block-arrow {
            font-size: 8px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.04);
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .ep-eng-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 4px;
        }
        .ep-eng-table th {
            background: rgba(255,255,255,0.06);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 5px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            font-size: 8px;
        }
        .ep-eng-table td {
            padding: 4px 5px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text-primary);
            vertical-align: top;
        }
        .ep-eng-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }
        .ep-eng-table .ep-mono {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        .ep-severity-critical {
            background: #ff4444;
            color: #fff;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .ep-severity-high {
            background: #ff8c00;
            color: #fff;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .ep-severity-medium {
            background: #ffd700;
            color: #000;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .ep-severity-low {
            background: #4caf50;
            color: #fff;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .ep-status-theoretical {
            background: rgba(156,39,176,0.25);
            color: #ce93d8;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(156,39,176,0.3);
        }
        .ep-status-designed {
            background: rgba(33,150,243,0.25);
            color: #90caf9;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(33,150,243,0.3);
        }
        .ep-status-simulated {
            background: rgba(255,152,0,0.25);
            color: #ffcc80;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(255,152,0,0.3);
        }
        .ep-status-validated {
            background: rgba(76,175,80,0.25);
            color: #a5d6a7;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid rgba(76,175,80,0.3);
        }
        .ep-lifecycle-grid {
            display: grid;
            gap: 6px;
        }
        .ep-lifecycle-item {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 5px 7px;
            border-left: 2px solid rgba(255,255,255,0.15);
        }
        .ep-lifecycle-key {
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .ep-lifecycle-val {
            font-size: 9px;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .ep-eng-loading {
            text-align: center;
            padding: 12px;
            color: var(--text-muted);
            font-size: 10px;
        }

        @media (max-width: 480px) {
            .edge-panel { width: 100vw; }
        }

        .ep-doctrine-header { padding: 12px; background: rgba(255,193,7,0.06); border: 1px solid rgba(255,193,7,0.15); border-radius: 8px; margin-bottom: 12px; }
        .ep-doctrine-title { font-size: 14px; font-weight: 700; color: #ffc107; margin-bottom: 4px; }
        .ep-doctrine-subtitle { font-size: 10px; color: var(--text-muted); }
        .ep-doctrine-principles { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
        .ep-doctrine-principle { padding: 8px 10px; background: var(--surface-2); border-left: 2px solid #ffc107; border-radius: 0 6px 6px 0; }
        .ep-doctrine-principle-id { font-size: 9px; font-weight: 700; color: #ffc107; }
        .ep-doctrine-principle-name { font-size: 11px; font-weight: 600; color: var(--text-primary); }
        .ep-doctrine-principle-rule { font-size: 9px; color: var(--text-muted); line-height: 1.4; margin-top: 2px; }

        .ep-pipeline-section { margin-bottom: 14px; }
        .ep-pipeline-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .ep-pipeline-stage { padding: 10px; background: var(--surface-2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--text-muted); }
        .ep-pipeline-stage.alpha { border-left-color: #ff6b6b; }
        .ep-pipeline-stage.beta { border-left-color: #ffc107; }
        .ep-pipeline-stage.release { border-left-color: #4caf50; }
        .ep-pipeline-stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .ep-pipeline-stage-name { font-size: 12px; font-weight: 700; }
        .ep-pipeline-stage.alpha .ep-pipeline-stage-name { color: #ff6b6b; }
        .ep-pipeline-stage.beta .ep-pipeline-stage-name { color: #ffc107; }
        .ep-pipeline-stage.release .ep-pipeline-stage-name { color: #4caf50; }
        .ep-pipeline-stage-count { font-size: 10px; color: var(--text-muted); }
        .ep-pipeline-stage-desc { font-size: 9px; color: var(--text-muted); margin-bottom: 6px; }
        .ep-pipeline-features { display: flex; flex-wrap: wrap; gap: 4px; }
        .ep-pipeline-feature-tag { font-size: 8px; padding: 2px 6px; background: var(--surface-3); border-radius: 4px; color: var(--text-secondary); }

        .ep-dod-section { margin-bottom: 14px; }
        .ep-dod-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .ep-dod-summary { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--surface-2); border-radius: 8px; margin-bottom: 8px; }
        .ep-dod-score { font-size: 20px; font-weight: 700; color: #ffc107; }
        .ep-dod-label { font-size: 9px; color: var(--text-muted); }
        .ep-dod-feature { padding: 8px 10px; background: var(--surface-2); border-radius: 6px; margin-bottom: 6px; }
        .ep-dod-feature-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .ep-dod-feature-name { font-size: 11px; font-weight: 600; color: var(--text-primary); }
        .ep-dod-feature-score { font-size: 10px; font-weight: 700; }
        .ep-dod-feature-score.passing { color: #4caf50; }
        .ep-dod-feature-score.failing { color: #ff6b6b; }
        .ep-dod-checks { display: flex; gap: 4px; flex-wrap: wrap; }
        .ep-dod-check { font-size: 8px; padding: 1px 5px; border-radius: 3px; }
        .ep-dod-check.pass { background: rgba(76,175,80,0.15); color: #4caf50; }
        .ep-dod-check.fail { background: rgba(255,107,107,0.15); color: #ff6b6b; }

        .ep-arch-section { margin-bottom: 14px; }
        .ep-arch-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .ep-arch-layer { padding: 8px 10px; background: var(--surface-2); border-radius: 6px; margin-bottom: 6px; }
        .ep-arch-layer-name { font-size: 11px; font-weight: 700; color: #ffc107; }
        .ep-arch-layer-desc { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
        .ep-arch-layer-rule { font-size: 9px; color: var(--text-secondary); font-style: italic; margin-top: 4px; padding: 4px 6px; background: rgba(255,193,7,0.06); border-radius: 4px; }
        .ep-arch-arrow { text-align: center; color: #ffc107; font-size: 14px; margin: 2px 0; }

        .ep-obs-section { margin-bottom: 14px; }
        .ep-obs-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .ep-obs-health { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--surface-2); border-radius: 8px; margin-bottom: 8px; }
        .ep-obs-dot { width: 10px; height: 10px; border-radius: 50%; }
        .ep-obs-dot.healthy { background: #4caf50; box-shadow: 0 0 6px rgba(76,175,80,0.5); }
        .ep-obs-dot.warning { background: #ffc107; box-shadow: 0 0 6px rgba(255,193,7,0.5); }
        .ep-obs-dot.degraded { background: #ff9800; box-shadow: 0 0 6px rgba(255,152,0,0.5); }
        .ep-obs-dot.critical { background: #ff6b6b; box-shadow: 0 0 6px rgba(255,107,107,0.5); }
        .ep-obs-status { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .ep-obs-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .ep-obs-metric { padding: 6px 8px; background: var(--surface-3); border-radius: 6px; text-align: center; }
        .ep-obs-metric-val { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .ep-obs-metric-label { font-size: 8px; color: var(--text-muted); }
        .ep-obs-events { max-height: 150px; overflow-y: auto; }
        .ep-obs-event { padding: 4px 6px; border-bottom: 1px solid var(--border-subtle); font-size: 9px; }
        .ep-obs-event-name { color: var(--text-secondary); font-weight: 600; }
        .ep-obs-event-detail { color: var(--text-muted); }
        .ep-obs-event-time { color: var(--text-muted); font-size: 8px; }

        .ep-truth-section { margin-bottom: 14px; }
        .ep-truth-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .ep-truth-feature { padding: 8px 10px; background: var(--surface-2); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: background 0.2s; }
        .ep-truth-feature:hover { background: var(--surface-3); }
        .ep-truth-feature-header { display: flex; justify-content: space-between; align-items: center; }
        .ep-truth-feature-name { font-size: 11px; font-weight: 600; color: var(--text-primary); }
        .ep-truth-feature-id { font-size: 8px; color: var(--text-muted); font-family: monospace; }
        .ep-truth-feature-layer { font-size: 8px; padding: 1px 5px; border-radius: 3px; background: rgba(255,193,7,0.1); color: #ffc107; }
        .ep-truth-detail { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle); }
        .ep-truth-detail.open { display: block; }
        .ep-truth-row { margin-bottom: 6px; }
        .ep-truth-row-label { font-size: 9px; font-weight: 700; color: #ffc107; text-transform: uppercase; letter-spacing: 0.3px; }
        .ep-truth-row-value { font-size: 9px; color: var(--text-secondary); line-height: 1.4; margin-top: 1px; }

        #epTabSupervisor.active-supervisor {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
            border-color: #64c8ff;
        }
        .ep-supervisor-header {
            text-align: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: var(--space-4);
        }
        .ep-supervisor-title {
            font-size: 16px;
            font-weight: var(--weight-bold);
            color: var(--text-primary);
            letter-spacing: 1px;
        }
        .ep-supervisor-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .ep-sv-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: var(--space-4);
        }
        .ep-sv-stat {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 8px;
            text-align: center;
        }
        .ep-sv-stat-val {
            font-size: 18px;
            font-weight: var(--weight-bold);
            color: var(--text-primary);
        }
        .ep-sv-stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .ep-sv-stat.pending .ep-sv-stat-val { color: #ffc107; }
        .ep-sv-stat.approved .ep-sv-stat-val { color: var(--success); }
        .ep-sv-stat.rejected .ep-sv-stat-val { color: #ff4444; }
        .ep-sv-stat.revision .ep-sv-stat-val { color: #ff9800; }

        .ep-sv-stage-bar {
            display: flex;
            gap: 4px;
            margin-bottom: var(--space-4);
            padding: 8px;
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
        }
        .ep-sv-stage-pip {
            flex: 1;
            text-align: center;
            padding: 4px;
            font-size: 9px;
            color: var(--text-muted);
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .ep-sv-stage-pip.has-projects { background: rgba(100,200,255,0.1); color: #64c8ff; }

        .ep-sv-queue-title {
            font-size: var(--font-xs);
            font-weight: var(--weight-semibold);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--space-3);
        }

        .ep-sv-card {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .ep-sv-card:hover { border-color: var(--border-strong); }
        .ep-sv-card.expanded { border-color: var(--accent-primary); }

        .ep-sv-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .ep-sv-card-name {
            font-size: var(--font-sm);
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
        }
        .ep-sv-card-stage {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .ep-sv-card-stage.concept { background: rgba(255,193,7,0.15); color: #ffc107; }
        .ep-sv-card-stage.simulation { background: rgba(100,200,255,0.15); color: #64c8ff; }
        .ep-sv-card-stage.digital_proto { background: rgba(156,39,176,0.15); color: #ce93d8; }
        .ep-sv-card-stage.physical_proto { background: rgba(76,175,80,0.15); color: #81c784; }
        .ep-sv-card-stage.refinement { background: rgba(0,200,83,0.15); color: #00c853; }

        .ep-sv-card-meta {
            font-size: 10px;
            color: var(--text-muted);
            font-family: monospace;
            margin-bottom: 8px;
        }

        .ep-sv-card-persona {
            display: inline-block;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 3px;
            margin-right: 6px;
        }
        .ep-sv-card-persona.ajani { background: rgba(220,53,69,0.15); color: var(--ajani); }
        .ep-sv-card-persona.minerva { background: rgba(0,200,170,0.15); color: var(--minerva); }
        .ep-sv-card-persona.hermes { background: rgba(200,200,200,0.15); color: var(--hermes); }

        .ep-sv-detail { display: none; margin-top: var(--space-3); }
        .ep-sv-card.expanded .ep-sv-detail { display: block; }

        .ep-sv-field {
            margin-bottom: var(--space-3);
        }
        .ep-sv-field-label {
            font-size: 9px;
            font-weight: var(--weight-semibold);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }
        .ep-sv-field-value {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            line-height: 1.5;
            padding: 6px 8px;
            background: var(--surface-3);
            border-radius: var(--radius-sm);
            border-left: 2px solid var(--border-default);
        }
        .ep-sv-field-value.safety {
            border-left-color: #ff4444;
            background: rgba(255,68,68,0.05);
        }
        .ep-sv-field-value.unknown {
            border-left-color: #ffc107;
            background: rgba(255,193,7,0.05);
        }

        .ep-sv-questions {
            margin: var(--space-3) 0;
            padding: 8px;
            background: rgba(100,200,255,0.05);
            border: 1px solid rgba(100,200,255,0.15);
            border-radius: var(--radius-sm);
        }
        .ep-sv-question {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 3px 0;
        }
        .ep-sv-question::before { content: '? '; color: #64c8ff; font-weight: bold; }

        .ep-sv-actions {
            display: flex;
            gap: 6px;
            margin-top: var(--space-3);
            flex-wrap: wrap;
        }
        .ep-sv-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: var(--surface-3);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .ep-sv-btn:hover { border-color: var(--border-strong); }
        .ep-sv-btn.reject { border-color: #ff4444; color: #ff4444; }
        .ep-sv-btn.reject:hover { background: rgba(255,68,68,0.15); }
        .ep-sv-btn.revise { border-color: #ff9800; color: #ff9800; }
        .ep-sv-btn.revise:hover { background: rgba(255,152,0,0.15); }
        .ep-sv-btn.approve { border-color: var(--success); color: var(--success); }
        .ep-sv-btn.approve:hover { background: rgba(74,138,90,0.15); }

        .ep-sv-notes-input {
            width: 100%;
            background: var(--surface-3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px 8px;
            font-size: 11px;
            color: var(--text-primary);
            margin-top: 6px;
            outline: none;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
        }
        .ep-sv-notes-input:focus { border-color: var(--border-strong); }
        .ep-sv-notes-input::placeholder { color: var(--text-muted); }

        .ep-sv-history-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 11px;
        }
        .ep-sv-history-item:last-child { border-bottom: none; }
        .ep-sv-decision-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
            white-space: nowrap;
        }
        .ep-sv-decision-badge.reject { background: rgba(255,68,68,0.15); color: #ff4444; }
        .ep-sv-decision-badge.revise { background: rgba(255,152,0,0.15); color: #ff9800; }
        .ep-sv-decision-badge.approve_sim,
        .ep-sv-decision-badge.approve_prototype,
        .ep-sv-decision-badge.approve_full { background: rgba(74,138,90,0.15); color: var(--success); }

        .ep-sv-rules-section {
            margin-top: var(--space-4);
            padding: var(--space-3);
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
        }
        .ep-sv-rules-title {
            font-size: 11px;
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
            margin-bottom: 6px;
            cursor: pointer;
        }
        .ep-sv-rules-body { display: none; }
        .ep-sv-rules-body.open { display: block; }
        .ep-sv-rule {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 2px 0;
        }
        .ep-sv-rule.allowed::before { content: 'âœ“ '; color: var(--success); }
        .ep-sv-rule.forbidden::before { content: 'âœ— '; color: #ff4444; }

        .ep-sv-confirm-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .ep-sv-confirm-box {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--space-5);
            max-width: 350px;
            width: 90%;
        }
        .ep-sv-confirm-title {
            font-size: 14px;
            font-weight: var(--weight-bold);
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .ep-sv-confirm-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .ep-sv-confirm-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
    </style>

    <div class="edge-panel-tab" id="edgePanelTab" onclick="toggleEdgePanel()">
        <span class="tab-icon">ğŸ”¬</span>
        LAB
    </div>

    <div class="edge-panel-overlay" id="edgePanelOverlay" onclick="toggleEdgePanel()"></div>

    <div class="edge-panel" id="edgePanel">
        <div class="edge-panel-header">
            <h3>ğŸ”¬ Hypothesis Lab</h3>
            <button class="edge-panel-close" onclick="toggleEdgePanel()">âœ•</button>
        </div>
        <div class="edge-panel-tabs" id="edgePanelTabs">
            <button onclick="switchResearchTab('ajani')" id="epTabAjani">Ajani</button>
            <button onclick="switchResearchTab('minerva')" id="epTabMinerva">Minerva</button>
            <button onclick="switchResearchTab('hermes')" id="epTabHermes">Hermes</button>
            <button onclick="switchResearchTab('doctrine')" id="epTabDoctrine">Doctrine</button>
            <button onclick="switchResearchTab('supervisor')" id="epTabSupervisor">Lab</button>
            <button onclick="switchResearchTab('figma')" id="epTabFigma">Figma</button>
            <button onclick="switchResearchTab('reality')" id="epTabReality">Reality</button>
            <button onclick="switchResearchTab('pipeline')" id="epTabPipeline">Pipeline</button>
            <button onclick="switchResearchTab('validation')" id="epTabValidation">Validate</button>
            <button onclick="switchResearchTab('blueprints')" id="epTabBlueprints">Blueprints</button>
        </div>
        <div class="edge-panel-body" id="edgePanelBody">
            <div class="ep-loading">Loading research dataâ€¦</div>
        </div>
    </div>

    <script>
    (function() {
        let epOpen = false;
        let epCurrentPersona = 'ajani';
        let epDashboardData = null;
        let epResourcesCache = {};
        let epEngSpecsCache = {};
        let epRefreshInterval = null;
        const EP_PHASES = ['philosophy', 'concept', 'research', 'blueprint', 'simulation', 'digital_proto', 'physical_proto', 'refinement'];
        const EP_PHASE_LABELS = { philosophy: 'Phil', concept: 'Concept', research: 'Res', blueprint: 'Blue', simulation: 'Sim', digital_proto: 'Digital', physical_proto: 'Physical', refinement: 'Refine' };
        const EP_PERSONA_COLORS = { ajani: 'var(--ajani)', minerva: 'var(--minerva)', hermes: 'var(--hermes)' };
        const EP_TIER_LABELS = {
            conceptual_sandbox: 'TIER 1: CONCEPTUAL SANDBOX',
            validation_prep: 'TIER 2: VALIDATION PREP',
            empirical_bridge: 'TIER 3: EMPIRICAL BRIDGE'
        };
        const EP_TIER_DESCS = {
            conceptual_sandbox: 'Theoretical / Simulated \u2014 Hypotheses, logic chains, risk analysis',
            validation_prep: 'Path-to-Proof \u2014 Real-world references, required data & tools identified',
            empirical_bridge: 'Manual Input Only \u2014 Real measurements and verified test results'
        };

        window.toggleEdgePanel = function() {
            epOpen = !epOpen;
            document.getElementById('edgePanel').classList.toggle('open', epOpen);
            document.getElementById('edgePanelOverlay').classList.toggle('open', epOpen);
            document.getElementById('edgePanelTab').classList.toggle('hidden', epOpen);
            if (epOpen) {
                epInitialLoadDone = false;
                loadResearchDashboard();
                epRefreshInterval = setInterval(function() { loadResearchDashboard(); }, 120000);
            } else {
                if (epRefreshInterval) { clearInterval(epRefreshInterval); epRefreshInterval = null; }
            }
        };

        window.switchResearchTab = function(persona) {
            epCurrentPersona = persona;
            document.querySelectorAll('#edgePanelTabs button').forEach(function(btn) {
                btn.className = '';
            });
            var tabBtn = document.getElementById('epTab' + persona.charAt(0).toUpperCase() + persona.slice(1));
            if (tabBtn) tabBtn.className = 'active-' + persona;
            if (persona === 'doctrine') {
                renderDoctrinePanel();
            } else if (persona === 'supervisor') {
                renderSupervisorPanel();
            } else if (persona === 'figma') {
                renderFigmaPanel();
            } else if (persona === 'reality') {
                renderRealityPanel();
            } else if (persona === 'pipeline') {
                renderPipelinePanel();
            } else if (persona === 'validation') {
                renderValidationPanel();
            } else if (persona === 'blueprints') {
                renderBlueprintEnginePanel();
            } else {
                if (!epDashboardData) {
                    var body = document.getElementById('edgePanelBody');
                    body.innerHTML = '<div class="ep-loading">Loading ' + persona + ' research data\u2026</div>';
                    loadResearchDashboard();
                    return;
                }
                renderPersonaPanel();
                loadActivityFeed(persona);
            }
        };

        var epInitialLoadDone = false;
        window.loadResearchDashboard = function() {
            fetch('/research-tracker/dashboard')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    epDashboardData = data;
                    if (!data.personas || Object.keys(data.personas).length === 0) {
                        fetch('/research-tracker/seed', { method: 'POST' })
                            .then(function() { return fetch('/research-tracker/dashboard'); })
                            .then(function(r) { return r.json(); })
                            .then(function(d) { epDashboardData = d; epInitialLoadDone = true; switchResearchTab(epCurrentPersona); });
                        return;
                    }
                    var needsRender = !epInitialLoadDone;
                    epInitialLoadDone = true;
                    if (needsRender || ['ajani','minerva','hermes'].indexOf(epCurrentPersona) !== -1) {
                        switchResearchTab(epCurrentPersona);
                    }
                })
                .catch(function(err) {
                    if (!epInitialLoadDone) {
                        document.getElementById('edgePanelBody').innerHTML = '<div class="ep-loading" style="cursor:pointer;">Error loading data. Tap to retry.</div>';
                        document.getElementById('edgePanelBody').onclick = function() { loadResearchDashboard(); };
                    }
                });
        };

        window.loadActivityFeed = function(persona) {
            fetch('/research-tracker/' + persona + '/activity')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var container = document.getElementById('epActivityFeed');
                    if (!container) return;
                    if (!data.activities || data.activities.length === 0) {
                        container.innerHTML = '<div class="ep-loading">No activity yet</div>';
                        return;
                    }
                    container.innerHTML = data.activities.map(function(a) {
                        var timeStr = '';
                        if (a.created_at) {
                            var d = new Date(a.created_at);
                            timeStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        }
                        return '<div class="ep-activity-item ep-activity-clickable" onclick="navigateToProject(\'' + (a.project_id || '') + '\')">' +
                            '<span class="ep-activity-badge ep-badge-' + a.activity_type + '">' + a.activity_type.replace('_',' ') + '</span>' +
                            '<div class="ep-activity-content">' +
                                '<div class="ep-activity-title">' + escapeHtmlEP(a.title) + '</div>' +
                                '<div class="ep-activity-desc">' + escapeHtmlEP(a.description) + '</div>' +
                                (timeStr ? '<div class="ep-activity-time">' + timeStr + '</div>' : '') +
                            '</div>' +
                        '</div>';
                    }).join('');
                });
        };

        window.toggleProjectCard = function(projectId) {
            var card = document.getElementById('ep-card-' + projectId);
            if (!card) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;
            card.classList.toggle('ep-card-expanded');
            var arrow = card.querySelector('.ep-card-collapse-arrow');
            if (arrow) arrow.textContent = card.classList.contains('ep-card-expanded') ? '\u25BE' : '\u25B8';
            if (card.classList.contains('ep-card-expanded')) {
                loadEmpiricalData(projectId);
            }
            if (panelBody) {
                requestAnimationFrame(function() {
                    panelBody.scrollTop = scrollBefore;
                    var cardTop = card.offsetTop - panelBody.offsetTop;
                    var cardBottom = cardTop + card.offsetHeight;
                    var viewTop = panelBody.scrollTop;
                    var viewBottom = viewTop + panelBody.clientHeight;
                    if (cardTop < viewTop) {
                        panelBody.scrollTop = cardTop - 8;
                    } else if (card.classList.contains('ep-card-expanded') && cardTop > viewTop + 50) {
                        panelBody.scrollTo({ top: cardTop - 8, behavior: 'smooth' });
                    }
                });
            }
        };


        window.navigateToProject = function(projectId) {
            if (!projectId) return;
            var card = document.getElementById('ep-card-' + projectId);
            if (!card) return;
            if (!card.classList.contains('ep-card-expanded')) {
                card.classList.add('ep-card-expanded');
                var arrow = card.querySelector('.ep-card-collapse-arrow');
                if (arrow) arrow.textContent = '\u25BE';
            }
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('ep-card-highlighted');
            setTimeout(function() { card.classList.remove('ep-card-highlighted'); }, 2000);
        };

        window.epFilterProjects = function(query) {
            var q = query.toLowerCase().trim();
            var cards = document.querySelectorAll('.ep-project-card');
            var visible = 0;
            cards.forEach(function(card) {
                var name = (card.querySelector('.ep-project-name') || {}).textContent || '';
                var codename = (card.querySelector('.ep-project-codename') || {}).textContent || '';
                var focus = (card.querySelector('.ep-focus') || {}).textContent || '';
                var match = !q || name.toLowerCase().includes(q) || codename.toLowerCase().includes(q) || focus.toLowerCase().includes(q);
                card.style.display = match ? '' : 'none';
                if (match) visible++;
            });
            var countEl = document.getElementById('epSearchCount');
            if (countEl) {
                countEl.textContent = q ? visible + ' found' : '';
            }
        };

        var epHandbookCache = {};
        var epHandbookPage = {};

        window.toggleHandbook = function(projectId) {
            var toggleBtn = document.getElementById('epHbTog-' + projectId);
            var content = document.getElementById('epHbContent-' + projectId);
            if (!toggleBtn || !content) return;
            var isOpen = toggleBtn.classList.contains('open');
            if (isOpen) {
                toggleBtn.classList.remove('open');
                content.classList.remove('open');
            } else {
                toggleBtn.classList.add('open');
                content.classList.add('open');
                if (!epHandbookCache[projectId]) {
                    loadHandbook(projectId);
                }
            }
        };

        function loadHandbook(projectId) {
            var container = document.getElementById('epHbContent-' + projectId);
            if (!container) return;
            container.innerHTML = '<div class="ep-res-loading">Loading blueprint handbook\u2026</div>';
            fetch('/research-tracker/blueprint-handbook/' + projectId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.handbook) {
                        container.innerHTML = '<div class="ep-res-loading">No visual handbook available yet</div>';
                        return;
                    }
                    epHandbookCache[projectId] = data.handbook;
                    epHandbookPage[projectId] = 0;
                    renderHandbookPage(projectId);
                })
                .catch(function() {
                    container.innerHTML = '<div class="ep-res-loading">Failed to load handbook</div>';
                });
        }

        window.hbPageNav = function(projectId, delta) {
            var hb = epHandbookCache[projectId];
            if (!hb) return;
            var cur = epHandbookPage[projectId] || 0;
            var next = cur + delta;
            if (next < 0 || next >= hb.pages.length) return;
            epHandbookPage[projectId] = next;
            renderHandbookPage(projectId);
        };

        function renderHandbookPage(projectId) {
            var container = document.getElementById('epHbContent-' + projectId);
            if (!container) return;
            var hb = epHandbookCache[projectId];
            var pageIdx = epHandbookPage[projectId] || 0;
            var page = hb.pages[pageIdx];
            var color = hb.cover_color || '#888';

            var html = '<div class="ep-handbook-viewer" style="border-color:' + color + '33;">';
            html += '<div class="ep-hb-nav">';
            html += '<button class="ep-hb-nav-btn" onclick="event.stopPropagation(); hbPageNav(\'' + projectId + '\', -1)"' + (pageIdx === 0 ? ' disabled' : '') + '>\u25C0 Prev</button>';
            html += '<span class="ep-hb-page-info">Page ' + (pageIdx + 1) + ' / ' + hb.pages.length + '</span>';
            html += '<button class="ep-hb-nav-btn" onclick="event.stopPropagation(); hbPageNav(\'' + projectId + '\', 1)"' + (pageIdx >= hb.pages.length - 1 ? ' disabled' : '') + '>Next \u25B6</button>';
            html += '</div>';
            html += '<div class="ep-hb-page">';

            if (page.type === 'cover') {
                html += renderHbCover(page, color, hb);
            } else if (page.type === 'overview') {
                html += renderHbOverview(page, color);
            } else if (page.type === 'parts_layout') {
                html += renderHbPartsLayout(page, color);
            } else if (page.type === 'assembly_step') {
                html += renderHbAssemblyStep(page, color);
            } else if (page.type === 'wiring') {
                html += renderHbWiring(page, color);
            } else if (page.type === 'final_assembly') {
                html += renderHbFinal(page, color);
            } else if (page.type === 'machine_profile') {
                html += renderHbMachineProfile(page, color);
            } else if (page.type === 'charter') {
                html += renderHbCharter(page, color);
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderHbCover(page, color, hb) {
            return '<div class="ep-hb-cover">' +
                '<div style="width:80px;height:80px;border:3px solid ' + color + ';border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:16px;">' +
                    '<svg width="40" height="40" viewBox="0 0 40 40"><rect x="5" y="8" width="30" height="24" rx="2" fill="none" stroke="' + color + '" stroke-width="2"/><line x1="10" y1="14" x2="30" y2="14" stroke="' + color + '" stroke-width="1.5"/><line x1="10" y1="19" x2="25" y2="19" stroke="' + color + '" stroke-width="1"/><line x1="10" y1="23" x2="28" y2="23" stroke="' + color + '" stroke-width="1"/><line x1="10" y1="27" x2="20" y2="27" stroke="' + color + '" stroke-width="1"/></svg>' +
                '</div>' +
                '<div class="ep-hb-cover-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>' +
                '<div class="ep-hb-cover-subtitle">' + escapeHtmlEP(page.subtitle) + '</div>' +
                '<div class="ep-hb-cover-badge">' + escapeHtmlEP(page.version) + '</div>' +
                '<div class="ep-hb-cover-badge" style="margin-top:4px;">' + escapeHtmlEP(page.classification) + '</div>' +
                '<div style="margin-top:16px;font-size:9px;color:var(--text-muted);">ATLAS CORE \u2014 Visual Blueprint Handbook</div>' +
            '</div>';
        }

        function renderSvgBlockFlow(diagram, color) {
            var svg = '<svg viewBox="0 0 660 300" xmlns="http://www.w3.org/2000/svg">';
            svg += '<defs><marker id="arrowH" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="' + color + '" opacity="0.6"/></marker></defs>';

            (diagram.arrows || []).forEach(function(a) {
                var fromBlock = null, toBlock = null;
                (diagram.blocks || []).forEach(function(b) {
                    if (b.id === a.from) fromBlock = b;
                    if (b.id === a.to) toBlock = b;
                });
                if (fromBlock && toBlock) {
                    var x1 = fromBlock.x + fromBlock.w / 2;
                    var y1 = fromBlock.y + fromBlock.h / 2;
                    var x2 = toBlock.x + toBlock.w / 2;
                    var y2 = toBlock.y + toBlock.h / 2;
                    var dash = a.style === 'dashed' ? ' stroke-dasharray="4,3"' : '';
                    svg += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="' + color + '" stroke-width="1.5" opacity="0.4" marker-end="url(#arrowH)"' + dash + '/>';
                    var mx = (x1 + x2) / 2;
                    var my = (y1 + y2) / 2 - 6;
                    svg += '<text x="' + mx + '" y="' + my + '" text-anchor="middle" fill="' + color + '" font-size="8" opacity="0.7">' + escapeHtmlEP(a.label) + '</text>';
                }
            });

            (diagram.blocks || []).forEach(function(b) {
                svg += '<rect x="' + b.x + '" y="' + b.y + '" width="' + b.w + '" height="' + b.h + '" rx="6" fill="' + b.color + '22" stroke="' + b.color + '" stroke-width="1.5"/>';
                var lines = b.label.split('\n');
                var ty = b.y + b.h / 2 - (lines.length - 1) * 6;
                lines.forEach(function(line, i) {
                    svg += '<text x="' + (b.x + b.w / 2) + '" y="' + (ty + i * 13) + '" text-anchor="middle" fill="#e0e0e0" font-size="10" font-weight="600">' + escapeHtmlEP(line) + '</text>';
                });
            });
            svg += '</svg>';
            return '<div class="ep-hb-svg-container">' + svg + '</div>';
        }

        function renderSvgPartsLayout(parts, color) {
            var svg = '<svg viewBox="0 0 660 310" xmlns="http://www.w3.org/2000/svg">';
            svg += '<text x="330" y="15" text-anchor="middle" fill="' + color + '" font-size="10" font-weight="600" opacity="0.6">EXPLODED VIEW</text>';
            (parts || []).forEach(function(p, i) {
                svg += '<rect x="' + p.x + '" y="' + p.y + '" width="' + p.w + '" height="' + p.h + '" rx="3" fill="' + p.color + '33" stroke="' + p.color + '" stroke-width="1.5"/>';
                svg += '<text x="' + (p.x + p.w / 2) + '" y="' + (p.y + p.h / 2 + 3) + '" text-anchor="middle" fill="#e0e0e0" font-size="8" font-weight="600">' + escapeHtmlEP(p.name) + '</text>';
                svg += '<circle cx="' + (p.x + 8) + '" cy="' + (p.y + 8) + '" r="7" fill="' + color + '" opacity="0.8"/>';
                svg += '<text x="' + (p.x + 8) + '" y="' + (p.y + 11) + '" text-anchor="middle" fill="#fff" font-size="7" font-weight="700">' + p.id + '</text>';
            });
            svg += '</svg>';
            return '<div class="ep-hb-svg-container">' + svg + '</div>';
        }

        function renderSvgStepVisual(elements, color) {
            var svg = '<svg viewBox="0 0 660 280" xmlns="http://www.w3.org/2000/svg">';
            svg += '<defs><marker id="arrowS" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0,6 2.5,0 5" fill="#ffaa00"/></marker></defs>';
            (elements || []).forEach(function(el) {
                if (el.shape === 'rect') {
                    svg += '<rect x="' + el.x + '" y="' + el.y + '" width="' + el.w + '" height="' + el.h + '" rx="3" fill="' + el.color + '33" stroke="' + el.color + '" stroke-width="1.5"/>';
                    if (el.label) {
                        svg += '<text x="' + (el.x + el.w / 2) + '" y="' + (el.y + el.h / 2 + 4) + '" text-anchor="middle" fill="#e0e0e0" font-size="9" font-weight="600">' + escapeHtmlEP(el.label) + '</text>';
                    }
                } else if (el.shape === 'circle') {
                    svg += '<circle cx="' + el.x + '" cy="' + el.y + '" r="' + el.r + '" fill="' + el.color + '44" stroke="' + el.color + '" stroke-width="1.5"/>';
                    if (el.label) {
                        svg += '<text x="' + el.x + '" y="' + (el.y + 3) + '" text-anchor="middle" fill="#e0e0e0" font-size="7">' + escapeHtmlEP(el.label) + '</text>';
                    }
                } else if (el.shape === 'wire') {
                    svg += '<line x1="' + el.x1 + '" y1="' + el.y1 + '" x2="' + el.x2 + '" y2="' + el.y2 + '" stroke="' + el.color + '" stroke-width="2" stroke-linecap="round"/>';
                } else if (el.shape === 'dimension') {
                    svg += '<line x1="' + el.x1 + '" y1="' + el.y1 + '" x2="' + el.x2 + '" y2="' + el.y2 + '" stroke="#888" stroke-width="1" stroke-dasharray="3,2"/>';
                    svg += '<text x="' + ((el.x1 + el.x2) / 2) + '" y="' + (el.y1 - 4) + '" text-anchor="middle" fill="#aaa" font-size="9">' + escapeHtmlEP(el.label) + '</text>';
                } else if (el.shape === 'arrow_down') {
                    svg += '<line x1="' + el.x + '" y1="' + el.y + '" x2="' + el.x + '" y2="' + (el.y + el.len) + '" stroke="' + el.color + '" stroke-width="2" marker-end="url(#arrowS)"/>';
                }
            });
            svg += '</svg>';
            return '<div class="ep-hb-svg-container">' + svg + '</div>';
        }

        function renderSvgMachineSchematic(components, color) {
            var svg = '<svg viewBox="0 0 660 310" xmlns="http://www.w3.org/2000/svg">';
            svg += '<text x="330" y="15" text-anchor="middle" fill="' + color + '" font-size="10" font-weight="600" opacity="0.6">MACHINE SCHEMATIC</text>';
            (components || []).forEach(function(c) {
                svg += '<rect x="' + c.x + '" y="' + c.y + '" width="' + c.w + '" height="' + c.h + '" rx="3" fill="' + c.color + '33" stroke="' + c.color + '" stroke-width="1.5"/>';
                var fontSize = c.name.length > 15 ? 7 : 8;
                svg += '<text x="' + (c.x + c.w / 2) + '" y="' + (c.y + c.h / 2 + 3) + '" text-anchor="middle" fill="#e0e0e0" font-size="' + fontSize + '" font-weight="600">' + escapeHtmlEP(c.name) + '</text>';
            });
            svg += '</svg>';
            return '<div class="ep-hb-svg-container">' + svg + '</div>';
        }

        function renderHbOverview(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>';
            html += '<div class="ep-hb-desc">' + escapeHtmlEP(page.desc) + '</div>';
            if (page.diagram) html += renderSvgBlockFlow(page.diagram, color);
            return html;
        }

        function renderHbPartsLayout(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>';
            html += '<div class="ep-hb-desc">' + escapeHtmlEP(page.desc) + '</div>';
            html += renderSvgPartsLayout(page.parts, color);
            html += '<div class="ep-hb-parts-grid">';
            (page.parts || []).forEach(function(p) {
                html += '<div class="ep-hb-part-tag"><span class="ep-hb-part-tag-name">' + escapeHtmlEP(p.id) + ': ' + escapeHtmlEP(p.name) + '</span><br><span class="ep-hb-part-tag-spec">' + escapeHtmlEP(p.spec) + '</span></div>';
            });
            html += '</div>';
            return html;
        }

        function renderHbAssemblyStep(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">Step ' + page.step_number + ': ' + escapeHtmlEP(page.title.replace(/^Step \d+:\s*/, '')) + '</div>';
            if (page.diagram) html += renderSvgStepVisual(page.diagram.elements, color);
            html += '<div class="ep-hb-step-instruction">' + escapeHtmlEP(page.instruction) + '</div>';
            if (page.tools && page.tools.length) {
                html += '<div style="font-size:9px;color:var(--text-muted);font-weight:600;margin-top:6px;">\uD83E\uDDF0 TOOLS NEEDED</div>';
                html += '<div class="ep-hb-tools-list">';
                page.tools.forEach(function(t) {
                    html += '<span class="ep-hb-tool-tag">' + escapeHtmlEP(t) + '</span>';
                });
                html += '</div>';
            }
            if (page.safety) html += '<div class="ep-hb-safety">\u26A0\uFE0F ' + escapeHtmlEP(page.safety) + '</div>';
            if (page.checkpoint) html += '<div class="ep-hb-checkpoint">\u2705 CHECKPOINT: ' + escapeHtmlEP(page.checkpoint) + '</div>';
            return html;
        }

        function renderHbWiring(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>';
            html += '<div class="ep-hb-desc">' + escapeHtmlEP(page.desc) + '</div>';
            var svg = '<svg viewBox="0 0 660 ' + Math.max(200, (page.connections || []).length * 28 + 40) + '" xmlns="http://www.w3.org/2000/svg">';
            (page.connections || []).forEach(function(c, i) {
                var y = 20 + i * 28;
                var isPower = c.type === 'power';
                var sw = isPower ? 3 : 1.5;
                svg += '<rect x="20" y="' + y + '" width="140" height="20" rx="3" fill="' + c.color + '22" stroke="' + c.color + '" stroke-width="1"/>';
                svg += '<text x="90" y="' + (y + 13) + '" text-anchor="middle" fill="#e0e0e0" font-size="8">' + escapeHtmlEP(c.from) + '</text>';
                svg += '<line x1="160" y1="' + (y + 10) + '" x2="340" y2="' + (y + 10) + '" stroke="' + c.color + '" stroke-width="' + sw + '"' + (isPower ? '' : ' stroke-dasharray="4,2"') + '/>';
                svg += '<text x="250" y="' + (y + 6) + '" text-anchor="middle" fill="#aaa" font-size="7">' + escapeHtmlEP(c.gauge) + '</text>';
                svg += '<rect x="340" y="' + y + '" width="140" height="20" rx="3" fill="' + c.color + '22" stroke="' + c.color + '" stroke-width="1"/>';
                svg += '<text x="410" y="' + (y + 13) + '" text-anchor="middle" fill="#e0e0e0" font-size="8">' + escapeHtmlEP(c.to) + '</text>';
                svg += '<circle cx="510" cy="' + (y + 10) + '" r="6" fill="' + (isPower ? '#ff444444' : '#4488ff44') + '" stroke="' + (isPower ? '#ff4444' : '#4488ff') + '" stroke-width="1"/>';
                svg += '<text x="525" y="' + (y + 13) + '" fill="#aaa" font-size="7">' + escapeHtmlEP(c.type) + '</text>';
            });
            svg += '</svg>';
            html += '<div class="ep-hb-svg-container">' + svg + '</div>';
            return html;
        }

        function renderHbFinal(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>';
            html += '<div class="ep-hb-desc">' + escapeHtmlEP(page.desc) + '</div>';
            (page.checklist || []).forEach(function(item) {
                var icon = item.critical ? '\u26A0\uFE0F' : '\u2610';
                var cls = item.critical ? ' ep-hb-critical' : '';
                html += '<div class="ep-hb-checklist-item' + cls + '">';
                html += '<span class="ep-hb-check-icon">' + icon + '</span>';
                html += '<span>' + (item.critical ? '<strong>CRITICAL:</strong> ' : '') + escapeHtmlEP(item.item) + '</span>';
                html += '</div>';
            });
            return html;
        }

        function renderHbMachineProfile(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:' + color + ';">' + escapeHtmlEP(page.title) + '</div>';
            if (page.diagram) html += renderSvgMachineSchematic(page.diagram.components, color);
            html += '<div class="ep-hb-machine-specs">';
            html += '<span class="ep-hb-spec-label">Form</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.form_factor) + '</span>';
            html += '<span class="ep-hb-spec-label">Size</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.dimensions) + '</span>';
            html += '<span class="ep-hb-spec-label">Weight</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.weight) + '</span>';
            html += '<span class="ep-hb-spec-label">Power</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.power) + '</span>';
            html += '<span class="ep-hb-spec-label">Speed</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.speed) + '</span>';
            html += '<span class="ep-hb-spec-label">Endurance</span><span class="ep-hb-spec-value">' + escapeHtmlEP(page.endurance) + '</span>';
            html += '</div>';
            if (page.sensors && page.sensors.length) {
                html += '<div style="font-size:9px;color:var(--text-muted);font-weight:600;margin-top:6px;">SENSORS</div>';
                html += '<div class="ep-hb-sensor-list">';
                page.sensors.forEach(function(s) { html += '<span class="ep-hb-sensor-tag">' + escapeHtmlEP(s) + '</span>'; });
                html += '</div>';
            }
            if (page.tools && page.tools.length) {
                html += '<div style="font-size:9px;color:var(--text-muted);font-weight:600;margin-top:6px;">TOOLS / ATTACHMENTS</div>';
                html += '<div class="ep-hb-tools-list">';
                page.tools.forEach(function(t) { html += '<span class="ep-hb-tool-tag">' + escapeHtmlEP(t) + '</span>'; });
                html += '</div>';
            }
            return html;
        }

        function renderHbCharter(page, color) {
            var html = '<div class="ep-hb-page-title" style="color:#ff4444;">' + escapeHtmlEP(page.title) + '</div>';
            html += '<div class="ep-hb-desc">' + escapeHtmlEP(page.desc) + '</div>';
            (page.rules || []).forEach(function(r) {
                html += '<div class="ep-hb-charter-rule">';
                html += '<span class="ep-hb-charter-number">' + r.number + '</span>';
                html += '<div class="ep-hb-charter-name">' + escapeHtmlEP(r.rule) + '</div>';
                html += '<div class="ep-hb-charter-desc">' + escapeHtmlEP(r.desc) + '</div>';
                html += '</div>';
            });
            return html;
        }

        function loadPersonaSchedule() {
            fetch('/research-tracker/persona-schedule')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var el = document.getElementById('epScheduleIndicator');
                    if (!el) return;
                    var modeIcons = { deep_work: '\uD83E\uDDE0', active_work: '\uD83D\uDD28', rest_break: '\uD83C\uDF19', web_research: '\uD83D\uDD0D' };
                    var modeColors = { deep_work: '#a366ff', active_work: '#00cc66', rest_break: '#5588aa', web_research: '#ffaa00' };
                    var icon = modeIcons[data.current_mode] || '\u23F0';
                    var mColor = modeColors[data.current_mode] || '#888';

                    var html = '<div class="ep-sched-bar" style="border-left:3px solid ' + mColor + ';">';
                    html += '<div class="ep-sched-status">';
                    html += '<span class="ep-sched-icon">' + icon + '</span>';
                    html += '<span class="ep-sched-label" style="color:' + mColor + ';">' + data.label + '</span>';
                    html += '<span class="ep-sched-next">\u2192 ' + data.next_shift + '</span>';
                    html += '</div>';
                    html += '<div class="ep-sched-desc">' + data.description + '</div>';

                    html += '<div class="ep-sched-timeline">';
                    data.schedule.forEach(function(block) {
                        var isActive = block.mode === data.current_mode;
                        var bColor = modeColors[block.mode] || '#888';
                        var bIcon = modeIcons[block.mode] || '';
                        html += '<div class="ep-sched-block' + (isActive ? ' active' : '') + '" style="' + (isActive ? 'background:' + bColor + '22;border-color:' + bColor + ';' : '') + '">';
                        html += '<span class="ep-sched-block-icon">' + bIcon + '</span>';
                        html += '<span class="ep-sched-block-time">' + block.start + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '</div>';
                    el.innerHTML = html;
                })
                .catch(function() {
                    var el = document.getElementById('epScheduleIndicator');
                    if (el) el.innerHTML = '';
                });
        }

        window.toggleNodeDetail = function(nodeUid, nodeId, nodeLabel, color) {
            var existing = document.getElementById('epNodePopup-' + nodeUid);
            var allPopups = document.querySelectorAll('.ep-node-detail-popup');
            var allActive = document.querySelectorAll('.ep-node-active');
            allPopups.forEach(function(p) { p.remove(); });
            allActive.forEach(function(a) { a.classList.remove('ep-node-active'); });

            if (existing) return;

            var nodeEl = document.getElementById(nodeUid);
            if (!nodeEl) return;
            nodeEl.classList.add('ep-node-active');

            var desc = (window._epNodeDescs && window._epNodeDescs[nodeUid]) || nodeLabel;
            var conns = (window._epArrowMap && window._epArrowMap[nodeUid]) || [];

            var popup = document.createElement('div');
            popup.id = 'epNodePopup-' + nodeUid;
            popup.className = 'ep-node-detail-popup';
            var popHtml = '<div class="ep-node-popup-title" style="color:' + color + ';">' + nodeLabel + '</div>';
            popHtml += '<div class="ep-node-popup-id">' + nodeId + '</div>';
            popHtml += '<div class="ep-node-popup-desc">' + desc + '</div>';
            if (conns.length > 0) {
                popHtml += '<div class="ep-node-popup-connections"><strong>Connections:</strong><br>';
                conns.forEach(function(c) { popHtml += '\u2022 ' + c + '<br>'; });
                popHtml += '</div>';
            }
            popup.innerHTML = popHtml;
            nodeEl.appendChild(popup);

            setTimeout(function() {
                document.addEventListener('click', function closePopup() {
                    popup.remove();
                    nodeEl.classList.remove('ep-node-active');
                    document.removeEventListener('click', closePopup);
                }, { once: true });
            }, 10);
        };

        var epBuildPlansCache = {};

        window.toggleBuildPlans = function(projectId) {
            var toggleBtn = document.getElementById('epBuildTog-' + projectId);
            var content = document.getElementById('epBuildContent-' + projectId);
            if (!toggleBtn || !content) return;

            var isOpen = toggleBtn.classList.contains('open');
            if (isOpen) {
                toggleBtn.classList.remove('open');
                content.classList.remove('open');
            } else {
                toggleBtn.classList.add('open');
                content.classList.add('open');
                if (!epBuildPlansCache[projectId]) {
                    loadBuildPlans(projectId);
                }
            }
        };

        function loadBuildPlans(projectId) {
            var container = document.getElementById('epBuildContent-' + projectId);
            if (!container) return;
            container.innerHTML = '<div class="ep-res-loading">Loading build plans\u2026</div>';

            fetch('/build/plans/' + projectId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    epBuildPlansCache[projectId] = data;
                    renderBuildPlans(projectId);
                })
                .catch(function() {
                    container.innerHTML = '<div class="ep-res-loading">Failed to load build plans</div>';
                });
        }

        function renderBuildPlans(projectId) {
            var container = document.getElementById('epBuildContent-' + projectId);
            if (!container) return;
            var data = epBuildPlansCache[projectId];
            var plans = data.build_plans || data.plans || data || [];
            if (!Array.isArray(plans)) plans = [];
            if (plans.length === 0) {
                container.innerHTML = '<div class="ep-res-loading">No build plans yet \u2014 project needs to reach blueprint phase</div>';
                return;
            }
            var color = EP_PERSONA_COLORS[epCurrentPersona] || '#888';
            var html = '';

            html += '<div class="ep-build-images-row" style="display:flex;gap:8px;margin-bottom:10px;overflow-x:auto;">';
            var bpImg = '/static/images/blueprints/' + projectId + '.png';
            var ptImg = '/static/images/prototypes/' + projectId + '.png';
            html += '<div class="ep-build-img-card" style="flex:0 0 auto;width:140px;">';
            html += '<div style="font-size:8px;color:#818cf8;font-weight:600;text-transform:uppercase;margin-bottom:3px;text-align:center;">Blueprint</div>';
            html += '<img src="' + bpImg + '" alt="Blueprint" style="width:100%;border-radius:6px;border:1px solid rgba(129,140,248,0.3);background:#0a0a12;" loading="lazy" onerror="this.parentElement.innerHTML=\'<div style=\\\'height:80px;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--text-muted);border:1px dashed rgba(255,255,255,0.1);border-radius:6px;\\\'>No blueprint image yet</div>\'">';
            html += '</div>';
            html += '<div class="ep-build-img-card" style="flex:0 0 auto;width:140px;">';
            html += '<div style="font-size:8px;color:#f97316;font-weight:600;text-transform:uppercase;margin-bottom:3px;text-align:center;">Prototype</div>';
            html += '<img src="' + ptImg + '" alt="Prototype" style="width:100%;border-radius:6px;border:1px solid rgba(249,115,22,0.3);background:#0a0a12;" loading="lazy" onerror="this.parentElement.innerHTML=\'<div style=\\\'height:80px;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--text-muted);border:1px dashed rgba(255,255,255,0.1);border-radius:6px;\\\'>No prototype image yet</div>\'">';
            html += '</div>';

            var statusCounts = {designing:0, in_progress:0, completed:0, paused:0};
            plans.forEach(function(p) { statusCounts[p.status || 'designing'] = (statusCounts[p.status || 'designing'] || 0) + 1; });
            html += '<div style="flex:1;min-width:120px;display:flex;flex-direction:column;justify-content:center;gap:4px;padding:4px 8px;background:rgba(255,255,255,0.02);border-radius:6px;border:1px solid rgba(255,255,255,0.06);">';
            html += '<div style="font-size:8px;color:' + color + ';font-weight:600;text-transform:uppercase;">Build Overview</div>';
            html += '<div style="font-size:11px;color:var(--text-primary);font-weight:600;">' + plans.length + ' Plan' + (plans.length !== 1 ? 's' : '') + '</div>';
            var sColors = {designing:'#818cf8',in_progress:'#facc15',completed:'#4ade80',paused:'#888'};
            var sLabels = {designing:'Designing',in_progress:'In Progress',completed:'Completed',paused:'Paused'};
            Object.keys(statusCounts).forEach(function(s) {
                if (statusCounts[s] > 0) {
                    html += '<div style="display:flex;align-items:center;gap:4px;">';
                    html += '<span style="width:6px;height:6px;border-radius:50%;background:' + (sColors[s]||'#888') + ';display:inline-block;"></span>';
                    html += '<span style="font-size:9px;color:' + (sColors[s]||'#888') + ';">' + statusCounts[s] + ' ' + (sLabels[s]||s) + '</span>';
                    html += '</div>';
                }
            });
            var totalCost = 0;
            plans.forEach(function(p) { totalCost += (p.estimated_total_cost || 0); });
            if (totalCost > 0) {
                html += '<div style="font-size:10px;color:#4ade80;font-weight:600;margin-top:2px;">$' + totalCost.toFixed(2) + ' total</div>';
            }
            html += '</div>';
            html += '</div>';

            plans.forEach(function(plan, idx) {
                var planId = 'epBuildPlan-' + projectId + '-' + idx;
                var completedSteps = plan.completed_steps || 0;
                var totalSteps = plan.total_steps || 0;
                var stepPct = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
                var statusIcon = plan.status === 'completed' ? '\u2705' : (plan.status === 'in_progress' ? '\u23F3' : '\uD83D\uDCD0');
                var statusColor = plan.status === 'completed' ? '#4ade80' : (plan.status === 'in_progress' ? '#facc15' : '#818cf8');
                var statusLabel = plan.status === 'completed' ? 'COMPLETED' : (plan.status === 'in_progress' ? 'IN PROGRESS' : 'DESIGNING');

                html += '<div class="ep-build-plan-card" style="border-left:3px solid ' + color + ';">';
                html += '<div class="ep-build-plan-header" onclick="event.stopPropagation(); toggleResExpandable(\'' + planId + '\')">';
                html += '<span>' + statusIcon + ' ' + escapeHtmlEP(plan.plan_name || 'Build Plan') + '</span>';
                html += '<span style="font-size:7px;padding:1px 6px;border-radius:3px;background:' + statusColor + '22;color:' + statusColor + ';border:1px solid ' + statusColor + '44;margin-left:auto;margin-right:6px;">' + statusLabel + '</span>';
                html += '<span class="ep-res-arrow">\u25BC</span>';
                html += '</div>';
                html += '<div class="ep-build-plan-meta">';
                html += '<span class="ep-build-type-badge">' + escapeHtmlEP(plan.build_type || 'component') + '</span>';
                if (plan.difficulty_level) {
                    var diffColors = {beginner:'#4ade80',intermediate:'#facc15',advanced:'#f97316',expert:'#ef4444'};
                    html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:' + (diffColors[plan.difficulty_level]||'#888') + '22;color:' + (diffColors[plan.difficulty_level]||'#888') + ';border:1px solid ' + (diffColors[plan.difficulty_level]||'#888') + '44;margin-left:4px;">' + plan.difficulty_level.toUpperCase() + '</span>';
                }
                if (plan.estimated_total_cost) {
                    html += '<span style="font-size:9px;color:#4ade80;margin-left:4px;">$' + plan.estimated_total_cost.toFixed(2) + '</span>';
                }
                html += '<span style="font-size:9px;color:var(--text-muted);"> ' + completedSteps + '/' + totalSteps + ' steps</span>';
                html += '</div>';
                html += '<div class="ep-progress-bar" style="margin:4px 0;"><div class="ep-progress-fill" style="width:' + stepPct + '%;background:' + color + ';"></div></div>';

                html += '<div class="ep-res-expandable" id="' + planId + '">';

                if (plan.description) {
                    html += '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:8px;padding:4px 6px;background:rgba(255,255,255,0.03);border-radius:4px;">' + escapeHtmlEP(plan.description) + '</div>';
                }

                if (plan.tools_required_summary && Array.isArray(plan.tools_required_summary) && plan.tools_required_summary.length > 0) {
                    html += '<div style="font-size:9px;padding:6px 8px;margin-bottom:8px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:4px;">';
                    html += '<div style="color:#818cf8;font-weight:600;margin-bottom:3px;">TOOLS REQUIRED</div>';
                    html += '<div style="color:var(--text-secondary);line-height:1.5;">' + plan.tools_required_summary.map(function(t){return escapeHtmlEP(t);}).join(' &bull; ') + '</div>';
                    html += '</div>';
                }

                if (plan.fabrication_notes) {
                    html += '<div style="font-size:9px;padding:6px 8px;margin-bottom:8px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:4px;">';
                    html += '<div style="color:#fbbf24;font-weight:600;margin-bottom:3px;">FABRICATION NOTES</div>';
                    html += '<div style="color:var(--text-secondary);">' + escapeHtmlEP(plan.fabrication_notes) + '</div>';
                    html += '</div>';
                }

                if (plan.estimated_total_cost) {
                    html += '<div style="font-size:9px;padding:6px 8px;margin-bottom:8px;background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.15);border-radius:4px;">';
                    html += '<div style="color:#4ade80;font-weight:600;margin-bottom:3px;">COST ESTIMATE: $' + plan.estimated_total_cost.toFixed(2) + ' ' + (plan.cost_currency || 'USD') + '</div>';
                    html += '</div>';
                }

                html += '<div style="text-align:right;margin-bottom:6px;">';
                html += '<button onclick="event.stopPropagation(); exportFabPackage(' + plan.id + ')" style="font-size:8px;padding:3px 8px;background:rgba(99,102,241,0.15);color:#818cf8;border:1px solid rgba(99,102,241,0.3);border-radius:3px;cursor:pointer;">Export Fabrication Package</button>';
                html += '</div>';

                var parts = plan.parts || [];
                if (parts.length > 0) {
                    html += '<div class="ep-build-section-title" style="color:' + color + ';">\uD83D\uDD29 Parts List (' + parts.length + ')</div>';
                    html += '<div class="ep-parts-grid">';
                    parts.forEach(function(part) {
                        var partStatus = part.status || 'needed';
                        var partIcon = partStatus === 'acquired' ? '\u2705' : (partStatus === 'ordered' ? '\uD83D\uDCE6' : '\u26AA');
                        var methodBadge = '';
                        if (part.fabrication_method) {
                            var mColors = {'3d_print':'#a78bfa','cnc_mill':'#f97316','laser_cut':'#ef4444','hand_fabricate':'#facc15','off_the_shelf':'#4ade80','pcb_fabrication':'#06b6d4','cast_mold':'#ec4899'};
                            var mc = mColors[part.fabrication_method] || '#888';
                            methodBadge = '<span style="font-size:7px;padding:1px 4px;border-radius:2px;background:' + mc + '22;color:' + mc + ';border:1px solid ' + mc + '33;margin-left:4px;">' + part.fabrication_method.replace(/_/g,' ').toUpperCase() + '</span>';
                        }
                        html += '<div class="ep-part-item">';
                        html += '<div class="ep-part-name">' + partIcon + ' ' + escapeHtmlEP(part.part_name) + ' <span style="opacity:0.5;">x' + (part.quantity || 1) + '</span>' + methodBadge + '</div>';
                        if (part.estimated_cost) html += '<div style="font-size:8px;color:#4ade80;">$' + part.estimated_cost.toFixed(2) + ' each</div>';
                        if (part.material_spec) html += '<div style="font-size:8px;color:#a78bfa;">' + escapeHtmlEP(part.material_spec) + '</div>';
                        if (part.dimensions) html += '<div style="font-size:8px;color:var(--text-muted);">' + escapeHtmlEP(part.dimensions) + '</div>';
                        if (part.file_format) html += '<div style="font-size:8px;color:#06b6d4;">File: ' + escapeHtmlEP(part.file_format) + '</div>';
                        if (part.specification) html += '<div class="ep-part-spec">' + escapeHtmlEP(part.specification) + '</div>';
                        if (part.supplier_url) html += '<div style="font-size:8px;color:#818cf8;">' + escapeHtmlEP(part.supplier_url) + '</div>';
                        if (part.sourcing_notes) html += '<div class="ep-part-source">' + escapeHtmlEP(part.sourcing_notes) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                var steps = plan.steps || [];
                if (steps.length > 0) {
                    html += '<div class="ep-build-section-title" style="color:' + color + ';margin-top:8px;">\uD83D\uDEE0\uFE0F Fabrication Steps (' + steps.length + ')</div>';
                    steps.forEach(function(step) {
                        var stepIcon = step.status === 'completed' ? '\u2705' : '\u25CB';
                        var stepClass = step.status === 'completed' ? 'ep-step-done' : '';
                        html += '<div class="ep-build-step ' + stepClass + '">';
                        html += '<div class="ep-step-header">' + stepIcon + ' <strong>Step ' + step.step_number + ':</strong> ' + escapeHtmlEP(step.title) + '</div>';
                        if (step.description) html += '<div class="ep-step-desc">' + escapeHtmlEP(step.description) + '</div>';
                        if (step.tools_needed) html += '<div class="ep-step-tools">\uD83E\uDDF0 ' + escapeHtmlEP(step.tools_needed) + '</div>';
                        if (step.safety_notes) html += '<div class="ep-step-safety">\u26A0\uFE0F ' + escapeHtmlEP(step.safety_notes) + '</div>';
                        if (step.expected_outcome) html += '<div class="ep-step-outcome">\u2192 ' + escapeHtmlEP(step.expected_outcome) + '</div>';
                        html += '</div>';
                    });
                }

                html += '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        window.exportFabPackage = function(planId) {
            fetch('/build/plan/' + planId + '/fabrication-package')
                .then(function(r) {
                    if (!r.ok) {
                        if (r.status === 404) throw new Error('Build plan not found. It may have been removed or not yet created.');
                        throw new Error('Server error (' + r.status + ')');
                    }
                    return r.json();
                })
                .then(function(data) {
                    if (!data) {
                        alert('Could not load fabrication package â€” no data returned.');
                        return;
                    }
                    if (data.status === 'blocked') {
                        var tier = data.feasibility_tier || '?';
                        var msg = 'Fabrication Package Blocked (Tier ' + tier + ')\n\n';
                        msg += data.message || 'This project must advance its feasibility tier before fabrication data can be exported.';
                        msg += '\n\nUse the Validate tab in the Edge Panel to check engineering readiness.';
                        alert(msg);
                        return;
                    }
                    if (data.status !== 'ok' || !data.fabrication_package) {
                        alert('Could not load fabrication package: ' + (data.detail || data.message || 'Unknown error'));
                        return;
                    }
                    var pkg = data.fabrication_package;
                    var lines = [];
                    lines.push('=' .repeat(60));
                    lines.push('FABRICATION PACKAGE');
                    lines.push('=' .repeat(60));
                    lines.push('Plan: ' + (pkg.plan_name || ''));
                    lines.push('Project: ' + (pkg.project_id || ''));
                    lines.push('Persona: ' + (pkg.persona || ''));
                    lines.push('Type: ' + (pkg.build_type || ''));
                    lines.push('Difficulty: ' + (pkg.difficulty_level || 'N/A'));
                    lines.push('');
                    if (pkg.description) lines.push('Description: ' + pkg.description);
                    lines.push('');
                    lines.push('-'.repeat(40));
                    lines.push('COST SUMMARY');
                    lines.push('-'.repeat(40));
                    var cs = pkg.cost_summary || {};
                    lines.push('Estimated Total: $' + (cs.estimated_total || 0).toFixed(2) + ' ' + (cs.currency || 'USD'));
                    (cs.parts_breakdown || []).forEach(function(p) {
                        lines.push('  ' + p.part_name + ' x' + p.qty + ' @ $' + (p.unit_cost||0).toFixed(2) + ' = $' + (p.line_total||0).toFixed(2));
                    });
                    lines.push('');
                    var ws = pkg.weight_summary || {};
                    lines.push('Total Weight: ' + (ws.total_grams||0) + 'g (' + (ws.total_kg||0) + 'kg)');
                    lines.push('');
                    lines.push('-'.repeat(40));
                    lines.push('TOOLS REQUIRED');
                    lines.push('-'.repeat(40));
                    (pkg.tools_required || []).forEach(function(t) { lines.push('  - ' + t); });
                    lines.push('');
                    if (pkg.fabrication_notes) {
                        lines.push('-'.repeat(40));
                        lines.push('FABRICATION NOTES');
                        lines.push('-'.repeat(40));
                        lines.push(pkg.fabrication_notes);
                        lines.push('');
                    }
                    lines.push('-'.repeat(40));
                    lines.push('SHOPPING LIST (Off-the-Shelf)');
                    lines.push('-'.repeat(40));
                    (pkg.shopping_list || []).forEach(function(item) {
                        lines.push('  [ ] ' + item.part_name + ' x' + item.quantity + ' ' + (item.unit||'') + ' - $' + (item.estimated_cost||0).toFixed(2));
                        if (item.supplier_url) lines.push('      Supplier: ' + item.supplier_url);
                        if (item.specification) lines.push('      Spec: ' + item.specification);
                    });
                    lines.push('');
                    lines.push('-'.repeat(40));
                    lines.push('DIGITAL FABRICATION QUEUE');
                    lines.push('-'.repeat(40));
                    (pkg.digital_fabrication_queue || []).forEach(function(item) {
                        lines.push('  [' + (item.method||'').replace(/_/g,' ').toUpperCase() + '] ' + item.part_name + ' x' + item.quantity);
                        if (item.material_spec) lines.push('      Material: ' + item.material_spec);
                        if (item.dimensions) lines.push('      Dimensions: ' + item.dimensions);
                        if (item.tolerance) lines.push('      Tolerance: ' + item.tolerance);
                        if (item.file_format) lines.push('      File Format: ' + item.file_format);
                    });
                    lines.push('');
                    lines.push('-'.repeat(40));
                    lines.push('BUILD STEPS');
                    lines.push('-'.repeat(40));
                    (pkg.steps || []).forEach(function(s) {
                        lines.push('');
                        lines.push('Step ' + s.step_number + ': ' + s.title);
                        if (s.description) lines.push('  ' + s.description);
                        if (s.tools_needed) lines.push('  Tools: ' + s.tools_needed);
                        if (s.safety_notes) lines.push('  SAFETY: ' + s.safety_notes);
                        if (s.expected_outcome) lines.push('  Expected: ' + s.expected_outcome);
                    });
                    lines.push('');
                    lines.push('=' .repeat(60));
                    lines.push('Generated by Atlas Core - Fabrication Package System');
                    lines.push('=' .repeat(60));

                    var text = lines.join('\n');
                    var blob = new Blob([text], {type: 'text/plain'});
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'fabrication-package-' + (pkg.project_id || 'plan') + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                })
                .catch(function(err) {
                    alert('Fabrication package error: ' + (err.message || 'Unknown error'));
                });
        };

        window.toggleProjectResources = function(projectId) {
            var toggleBtn = document.getElementById('epResTog-' + projectId);
            var content = document.getElementById('epResContent-' + projectId);
            if (!toggleBtn || !content) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;

            var isOpen = toggleBtn.classList.contains('open');
            if (isOpen) {
                toggleBtn.classList.remove('open');
                content.classList.remove('open');
            } else {
                toggleBtn.classList.add('open');
                content.classList.add('open');
                if (!epResourcesCache[projectId]) {
                    loadProjectResources(projectId);
                }
            }
            if (panelBody) {
                requestAnimationFrame(function() {
                    panelBody.scrollTop = scrollBefore;
                });
            }
        };

        window.loadProjectResources = function(projectId) {
            var container = document.getElementById('epResContent-' + projectId);
            if (!container) return;
            container.innerHTML = '<div class="ep-res-loading">Loading resources\u2026</div>';

            fetch('/research-tracker/resources/' + projectId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    epResourcesCache[projectId] = data.resources || {};
                    renderProjectResources(projectId);
                })
                .catch(function() {
                    container.innerHTML = '<div class="ep-res-loading">Failed to load resources</div>';
                });
        };

        window.toggleResExpandable = function(elId) {
            var el = document.getElementById(elId);
            if (!el) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;
            el.classList.toggle('open');
            if (panelBody) {
                requestAnimationFrame(function() {
                    panelBody.scrollTop = scrollBefore;
                });
            }
        };

        window.togglePrototype = function(projectId) {
            var el = document.getElementById('epProto-' + projectId);
            if (!el) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;
            el.classList.toggle('open');
            if (el.classList.contains('open') && !epEngSpecsCache[projectId]) {
                loadEngineeringSpecs(projectId);
            }
            if (panelBody) {
                requestAnimationFrame(function() {
                    panelBody.scrollTop = scrollBefore;
                });
            }
        };

        function loadEngineeringSpecs(projectId) {
            var container = document.getElementById('epEngView-' + projectId);
            if (!container) return;
            if (epEngSpecsCache[projectId]) {
                renderEngineeringView(projectId, epEngSpecsCache[projectId]);
                return;
            }
            container.innerHTML = '<div class="ep-eng-loading">Loading engineering specs\u2026</div>';
            fetch('/research-tracker/engineering-specs/' + projectId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.specs) {
                        epEngSpecsCache[projectId] = data.specs;
                        renderEngineeringView(projectId, data.specs);
                    } else {
                        container.innerHTML = '<div class="ep-eng-loading">No engineering specs available</div>';
                    }
                })
                .catch(function() {
                    container.innerHTML = '<div class="ep-eng-loading">Failed to load engineering specs</div>';
                });
        }

        function renderBlockDiagram(nodes, arrows, color, modules) {
            modules = modules || [];
            var maxRow = 0, maxCol = 0;
            nodes.forEach(function(n) {
                if (n.row > maxRow) maxRow = n.row;
                if (n.col > maxCol) maxCol = n.col;
            });
            var grid = [];
            for (var r = 0; r <= maxRow; r++) {
                grid[r] = [];
                for (var c = 0; c <= maxCol; c++) {
                    grid[r][c] = null;
                }
            }
            nodes.forEach(function(n) { grid[n.row][n.col] = n; });

            var moduleMap = {};
            modules.forEach(function(m) { moduleMap[m.id] = m; });

            var nodeDescMap = {};
            nodes.forEach(function(n) {
                if (n.desc) {
                    nodeDescMap[n.id] = n.desc;
                } else if (moduleMap[n.id]) {
                    nodeDescMap[n.id] = moduleMap[n.id].name + ' â€” ' + moduleMap[n.id].function;
                }
            });

            var arrowMap = {};
            (arrows || []).forEach(function(a) {
                if (!arrowMap[a.from]) arrowMap[a.from] = [];
                arrowMap[a.from].push(a.to + ': ' + a.label);
                if (!arrowMap[a.to]) arrowMap[a.to] = [];
                arrowMap[a.to].push(a.from + ' \u2190 ' + a.label);
            });

            var diagId = 'epDiag-' + Math.random().toString(36).substr(2,6);
            var html = '<div class="ep-block-diagram" id="' + diagId + '" style="grid-template-columns:repeat(' + (maxCol+1) + ',1fr);">';
            for (var r = 0; r <= maxRow; r++) {
                for (var c = 0; c <= maxCol; c++) {
                    var node = grid[r][c];
                    if (node) {
                        var nodeUid = diagId + '-' + node.id.replace(/[^a-zA-Z0-9]/g,'');
                        html += '<div class="ep-block-node" id="' + nodeUid + '" style="border-color:' + color + ';position:relative;" ' +
                            'onclick="event.stopPropagation(); toggleNodeDetail(\'' + nodeUid + '\', \'' + escapeHtmlEP(node.id) + '\', \'' + escapeHtmlEP(node.label) + '\', \'' + color + '\')">' +
                            '<div class="ep-block-node-id" style="color:' + color + ';">' + escapeHtmlEP(node.id) + '</div>' +
                            '<div class="ep-block-node-label">' + escapeHtmlEP(node.label) + '</div>' +
                        '</div>';
                    } else {
                        html += '<div class="ep-block-node ep-block-node-empty"></div>';
                    }
                }
            }
            html += '</div>';

            window._epNodeDescs = window._epNodeDescs || {};
            window._epArrowMap = window._epArrowMap || {};
            nodes.forEach(function(n) {
                window._epNodeDescs[diagId + '-' + n.id.replace(/[^a-zA-Z0-9]/g,'')] = nodeDescMap[n.id] || n.label;
            });
            Object.keys(arrowMap).forEach(function(k) {
                window._epArrowMap[diagId + '-' + k.replace(/[^a-zA-Z0-9]/g,'')] = arrowMap[k];
            });

            if (arrows && arrows.length > 0) {
                html += '<div class="ep-block-arrows">';
                arrows.forEach(function(a) {
                    html += '<span class="ep-block-arrow" style="color:' + color + ';">' +
                        a.from + ' \u2192 ' + a.to + ': ' + escapeHtmlEP(a.label) +
                    '</span>';
                });
                html += '</div>';
            }
            return html;
        }

        function renderEngineeringView(projectId, specs) {
            var container = document.getElementById('epEngView-' + projectId);
            if (!container) return;
            var color = EP_PERSONA_COLORS[epCurrentPersona] || '#888';
            var html = '';

            html += '<div class="ep-eng-section">';
            html += '<div class="ep-eng-section-title">\u2592 System Block Diagram</div>';
            html += renderBlockDiagram(specs.block_diagram_nodes || [], specs.block_diagram_arrows || [], color, specs.modules || []);
            html += '</div>';

            html += '<div class="ep-eng-section">';
            html += '<div class="ep-eng-section-title">\u2630 Modules</div>';
            html += '<table class="ep-eng-table"><thead><tr><th>ID</th><th>Module</th><th>Function</th><th>Status</th></tr></thead><tbody>';
            (specs.modules || []).forEach(function(m) {
                html += '<tr>' +
                    '<td class="ep-mono">' + escapeHtmlEP(m.id) + '</td>' +
                    '<td>' + escapeHtmlEP(m.name) + '</td>' +
                    '<td>' + escapeHtmlEP(m.function) + '</td>' +
                    '<td><span class="ep-status-' + m.status + '">' + escapeHtmlEP(m.status) + '</span></td>' +
                '</tr>';
            });
            html += '</tbody></table></div>';

            html += '<div class="ep-eng-section">';
            html += '<div class="ep-eng-section-title">\u2194 Interfaces</div>';
            html += '<table class="ep-eng-table"><thead><tr><th>From</th><th>To</th><th>Type</th><th>Protocol</th></tr></thead><tbody>';
            (specs.interfaces || []).forEach(function(iface) {
                html += '<tr>' +
                    '<td class="ep-mono">' + escapeHtmlEP(iface.from) + '</td>' +
                    '<td class="ep-mono">' + escapeHtmlEP(iface.to) + '</td>' +
                    '<td>' + escapeHtmlEP(iface.type) + '</td>' +
                    '<td>' + escapeHtmlEP(iface.protocol) + '</td>' +
                '</tr>';
            });
            html += '</tbody></table></div>';

            html += '<div class="ep-eng-section">';
            html += '<div class="ep-eng-section-title">\u26A0 Failure Modes</div>';
            html += '<table class="ep-eng-table"><thead><tr><th>ID</th><th>Mode</th><th>Cause</th><th>Effect</th><th>Sev.</th><th>Mitigation</th></tr></thead><tbody>';
            (specs.failure_modes || []).forEach(function(f) {
                html += '<tr>' +
                    '<td class="ep-mono">' + escapeHtmlEP(f.id) + '</td>' +
                    '<td>' + escapeHtmlEP(f.mode) + '</td>' +
                    '<td>' + escapeHtmlEP(f.cause) + '</td>' +
                    '<td>' + escapeHtmlEP(f.effect) + '</td>' +
                    '<td><span class="ep-severity-' + f.severity + '">' + escapeHtmlEP(f.severity) + '</span></td>' +
                    '<td>' + escapeHtmlEP(f.mitigation) + '</td>' +
                '</tr>';
            });
            html += '</tbody></table></div>';

            html += '<div class="ep-eng-section">';
            html += '<div class="ep-eng-section-title">\uD83D\uDEE1 Safety Gates</div>';
            html += '<table class="ep-eng-table"><thead><tr><th>ID</th><th>Gate</th><th>Condition</th><th>Action If Fail</th></tr></thead><tbody>';
            (specs.safety_gates || []).forEach(function(sg) {
                html += '<tr>' +
                    '<td class="ep-mono">' + escapeHtmlEP(sg.id) + '</td>' +
                    '<td>' + escapeHtmlEP(sg.gate) + '</td>' +
                    '<td>' + escapeHtmlEP(sg.condition) + '</td>' +
                    '<td>' + escapeHtmlEP(sg.action_if_fail) + '</td>' +
                '</tr>';
            });
            html += '</tbody></table></div>';

            if (specs.lifecycle) {
                html += '<div class="ep-eng-section">';
                html += '<div class="ep-eng-section-title">\u267B Lifecycle</div>';
                html += '<div class="ep-lifecycle-grid">';
                var lcKeys = [
                    {k: 'design_lifespan', label: 'Design Lifespan'},
                    {k: 'maintenance_interval', label: 'Maintenance'},
                    {k: 'degradation_model', label: 'Degradation Model'},
                    {k: 'end_of_life', label: 'End of Life'},
                    {k: 'environmental_constraints', label: 'Environment'}
                ];
                lcKeys.forEach(function(lc) {
                    if (specs.lifecycle[lc.k]) {
                        html += '<div class="ep-lifecycle-item" style="border-left-color:' + color + ';">' +
                            '<div class="ep-lifecycle-key">' + lc.label + '</div>' +
                            '<div class="ep-lifecycle-val">' + escapeHtmlEP(specs.lifecycle[lc.k]) + '</div>' +
                        '</div>';
                    }
                });
                html += '</div></div>';
            }

            container.innerHTML = html;
        }

        function renderProjectResources(projectId) {
            var container = document.getElementById('epResContent-' + projectId);
            if (!container) return;
            var resources = epResourcesCache[projectId];
            if (!resources || Object.keys(resources).length === 0) {
                container.innerHTML = '<div class="ep-res-loading">No resources available</div>';
                return;
            }

            var TYPE_ICONS = { video: '\uD83C\uDFAC', document: '\uD83D\uDCC4', paper: '\uD83D\uDCC4', blueprint: '\uD83D\uDCD0', theory: '\uD83E\uDDEC' };
            var TYPE_LABELS = { video: 'Videos', document: 'Documents', paper: 'Papers', blueprint: 'Blueprints', theory: 'Theories' };
            var TYPE_ORDER = ['blueprint', 'theory', 'video', 'document', 'paper'];

            var BLUEPRINT_STEPS = [
                { num: '1', label: 'Concept' },
                { num: '2', label: 'Design' },
                { num: '3', label: 'Validate' },
                { num: '4', label: 'Simulate' },
                { num: '5', label: 'Refine' },
                { num: '6', label: 'Finalize' }
            ];

            var projProgress = 0;
            if (epDashboardData && epDashboardData.personas) {
                var pData = epDashboardData.personas[epCurrentPersona];
                if (pData && pData.projects) {
                    pData.projects.forEach(function(p) {
                        if (p.project_id === projectId) projProgress = p.progress_percent || 0;
                    });
                }
            }
            var completedSteps = Math.floor((projProgress / 100) * BLUEPRINT_STEPS.length);

            var html = '';
            TYPE_ORDER.forEach(function(rtype) {
                var items = resources[rtype];
                if (!items || items.length === 0) return;
                var icon = TYPE_ICONS[rtype] || '\uD83D\uDCCB';
                var label = TYPE_LABELS[rtype] || rtype;

                html += '<div class="ep-res-group">';
                html += '<div class="ep-res-group-title">' + icon + ' ' + label + '</div>';

                if (rtype === 'blueprint') {
                    html += '<div class="ep-blueprint-visual" style="position:relative;">' +
                        '<div class="ep-ref-label">Industrial Design Study \u2014 Reference Only</div>' +
                        '<img class="ep-blueprint-img" src="/static/images/blueprints/' + projectId + '.png" alt="' + projectId + ' Blueprint" loading="lazy" onerror="this.style.display=\'none\'">' +
                        '<div class="ep-blueprint-steps">';
                    BLUEPRINT_STEPS.forEach(function(step, i) {
                        var stepCls = 'ep-blueprint-step';
                        if (i < completedSteps) stepCls += ' completed';
                        if (i === completedSteps) stepCls += ' active';
                        var personaColor = EP_PERSONA_COLORS[epCurrentPersona] || '#888';
                        var stepStyle = (i <= completedSteps) ? 'color:' + personaColor + ';' : '';
                        html += '<div class="' + stepCls + '" style="' + stepStyle + '">' +
                            '<div class="step-fill"></div>' +
                            '<span class="step-num">' + step.num + '</span>' +
                            '<span class="step-label">' + step.label + '</span>' +
                        '</div>';
                    });
                    html += '</div>';
                    html += '<div class="ep-blueprint-caption">' + completedSteps + ' of ' + BLUEPRINT_STEPS.length + ' steps completed \u2014 ' + projProgress + '% overall</div>';
                    html += '</div>';
                }

                items.forEach(function(item, idx) {
                    if (rtype === 'video' || rtype === 'document' || rtype === 'paper') {
                        if (item.url) {
                            html += '<div class="ep-res-item">' +
                                '<a class="ep-res-link" href="' + escapeHtmlEP(item.url) + '" target="_blank" rel="noopener">' +
                                    '<div class="ep-res-title">' + escapeHtmlEP(item.title) + '</div>' +
                                    '<div class="ep-res-meta">' + escapeHtmlEP(item.source || '') + (item.year ? ' \u00B7 ' + item.year : '') + '</div>' +
                                '</a></div>';
                        } else {
                            html += '<div class="ep-res-item">' +
                                '<div class="ep-res-title">' + escapeHtmlEP(item.title) + '</div>' +
                                '<div class="ep-res-meta">' + escapeHtmlEP(item.source || '') + (item.year ? ' \u00B7 ' + item.year : '') + '</div>' +
                            '</div>';
                        }
                    } else {
                        var elId = 'epResExp-' + projectId + '-' + rtype + '-' + idx;
                        html += '<div class="ep-res-expandable" id="' + elId + '" onclick="toggleResExpandable(\'' + elId + '\')">' +
                            '<div class="ep-res-expand-header">' +
                                '<div class="ep-res-title">' + escapeHtmlEP(item.title) + '</div>' +
                                '<span class="ep-res-expand-arrow">\u25BC</span>' +
                            '</div>' +
                            '<div class="ep-res-expand-body">' + escapeHtmlEP(item.description) + '</div>' +
                        '</div>';
                    }
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        var EP_PHASE_FULL = {
            philosophy: { name: 'Philosophy', desc: 'Define core principles and approach', next: 'Complete philosophical framework' },
            concept: { name: 'Concept', desc: 'Form initial hypothesis and concept design', next: 'Validate concept feasibility' },
            research: { name: 'Research', desc: 'Gather knowledge and analyze data', next: 'Finish literature review & data collection' },
            blueprint: { name: 'Blueprint', desc: 'Design system architecture', next: 'Complete technical design documents' },
            simulation: { name: 'Simulation', desc: 'Test in virtual environment', next: 'Pass all simulation benchmarks' },
            digital_proto: { name: 'Digital Prototype', desc: 'Build digital prototype model', next: 'Validate digital prototype' },
            physical_proto: { name: 'Physical Prototype', desc: 'Propose physical implementation', next: 'Finalize implementation plan' },
            refinement: { name: 'Refinement', desc: 'Optimize and document final results', next: 'Complete \u2014 refined & archived' }
        };

        var EP_BUILD_ORDER = {
            'insert-cell': { tier: 'foundation', label: 'PLATFORM FOUNDATION', order: 0 },
            'hydra-core': { tier: 'cell-type', label: 'CELL ENGINE â€” HYDROGEN', order: 1 },
            'resonance-engine': { tier: 'cell-type', label: 'CELL ENGINE â€” ACOUSTIC', order: 2 },
            'photon-sink': { tier: 'cell-type', label: 'CELL ENGINE â€” PHOTONIC', order: 2 },
            'wave-rider': { tier: 'cell-type', label: 'CELL ENGINE â€” RF/EM', order: 2 },
            'kinetic-forge': { tier: 'alternate', label: 'ENERGY RESEARCH', order: 3 },
            'solar-gem': { tier: 'alternate', label: 'ENERGY RESEARCH', order: 3 },
            'element-synthesis': { tier: 'alternate', label: 'ENERGY RESEARCH', order: 3 },
        };

        function renderPersonaPanel() {
            var body = document.getElementById('edgePanelBody');
            if (!epDashboardData || !epDashboardData.personas) {
                body.innerHTML = '<div class="ep-loading">No data available</div>';
                return;
            }
            var pData = epDashboardData.personas[epCurrentPersona];
            if (!pData || !pData.projects) {
                body.innerHTML = '<div class="ep-loading">No projects for ' + epCurrentPersona + '</div>';
                return;
            }
            var color = EP_PERSONA_COLORS[epCurrentPersona] || 'var(--text-primary)';
            var html = '';

            if (epCurrentPersona === 'ajani') {
                html += '<div class="ep-build-order-banner">' +
                    '<div class="ep-bo-title">\u26A0 Platform Build Order (Non-Negotiable)</div>' +
                    '<div class="ep-bo-chain">' +
                        '<span class="ep-bo-step foundation">INSERT-CELL</span>' +
                        '<span class="ep-bo-arrow">\u2192</span>' +
                        '<span class="ep-bo-step">HYDRA-CORE</span>' +
                        '<span class="ep-bo-arrow">\u2192</span>' +
                        '<span class="ep-bo-step">CELL ENGINES</span>' +
                        '<span class="ep-bo-arrow">\u2192</span>' +
                        '<span class="ep-bo-step">RESEARCH</span>' +
                    '</div>' +
                    '<div style="margin-top:6px;font-size:10px;color:var(--text-muted);">' +
                        'No engine may bypass INSERT-CELL. All power sources must negotiate through it.' +
                    '</div>' +
                    '<div style="margin-top:8px;padding:6px 8px;background:rgba(255,193,7,0.08);border-left:2px solid #ffc107;border-radius:4px;">' +
                        '<div style="font-size:10px;font-weight:600;color:#ffc107;margin-bottom:4px;">DESIGN PHILOSOPHY</div>' +
                        '<div style="font-size:9px;color:var(--text-muted);line-height:1.5;">' +
                            '<span style="color:#e0e0e0;">1.</span> Non-Combustion First &mdash; prefer clean conversion<br>' +
                            '<span style="color:#e0e0e0;">2.</span> Hybrid Buffering &mdash; smooth, store, schedule<br>' +
                            '<span style="color:#e0e0e0;">3.</span> Refusal by Design &mdash; unknown source = no power<br>' +
                            '<span style="color:#e0e0e0;">4.</span> Learning Loop &mdash; every cycle improves the next' +
                        '</div>' +
                    '</div>' +
                    '<div style="margin-top:6px;font-size:9px;color:var(--text-muted);font-style:italic;">' +
                        'Engines are energy interpreters (Source \u2192 Signal \u2192 Control \u2192 Output), not fuel burners.' +
                    '</div>' +
                '</div>';
            }

            html += '<div class="ep-schedule-indicator" id="epScheduleIndicator"><div class="ep-res-loading">Loading schedule\u2026</div></div>';

            html += '<div class="ep-search-bar" style="display:flex;gap:6px;align-items:center;">' +
                '<input type="text" class="ep-search-input" id="epSearchInput" placeholder="Search projects..." oninput="epFilterProjects(this.value)" onclick="event.stopPropagation()" style="flex:1;">' +
                '<span class="ep-search-count" id="epSearchCount"></span>' +
                '<button onclick="event.stopPropagation(); runAllValidations()" style="flex:0 0 auto;font-size:8px;padding:4px 8px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);border-radius:4px;cursor:pointer;white-space:nowrap;" title="Validate all projects with domain-aware checks">Validate All</button>' +
            '</div>';

            pData.projects.forEach(function(proj) {
                var phaseIdx = EP_PHASES.indexOf(proj.current_phase);
                var dots = EP_PHASES.map(function(p, i) {
                    var cls = 'ep-phase-dot';
                    if (i <= phaseIdx) cls += ' filled';
                    if (i === phaseIdx) cls += ' current';
                    var bg = i <= phaseIdx ? color : '';
                    var style = bg ? 'background:' + bg + ';color:' + bg + ';' : '';
                    var phaseInfo = EP_PHASE_FULL[EP_PHASES[i]] || {};
                    var tooltipHtml = '<div class="ep-phase-tooltip">' +
                        '<div class="ep-phase-tooltip-name">' + (phaseInfo.name || EP_PHASES[i]) + '</div>' +
                        '<div class="ep-phase-tooltip-desc">' + (phaseInfo.desc || '') + '</div>' +
                        '<div class="ep-phase-tooltip-desc" style="margin-top:2px;color:var(--text-muted);">Next: ' + (phaseInfo.next || '\u2014') + '</div>' +
                    '</div>';
                    return '<span class="' + cls + '" style="' + style + '">' + tooltipHtml + '</span>';
                }).join('');
                var phaseLabel = EP_PHASE_LABELS[proj.current_phase] || proj.current_phase;
                var resBadge = proj.resource_count ? '<span class="ep-res-badge">' + proj.resource_count + '</span>' : '';

                var protoDots = EP_PHASES.map(function(p, i) {
                    var cls = 'ep-proto-dot';
                    if (i <= phaseIdx) cls += ' filled';
                    if (i === phaseIdx) cls += ' current';
                    var bg = i <= phaseIdx ? color : '';
                    var style = bg ? 'background:' + bg + ';color:' + bg + ';' : '';
                    return '<span class="' + cls + '" style="' + style + '"></span>';
                }).join('');

                var boInfo = EP_BUILD_ORDER[proj.project_id];
                var cardClass = 'ep-project-card';
                if (boInfo) {
                    if (boInfo.tier === 'foundation') cardClass += ' ep-foundation-card';
                    else if (boInfo.tier === 'cell-type') cardClass += ' ep-cell-card';
                }
                var badgeHtml = '';
                if (boInfo) {
                    badgeHtml = '<div class="ep-platform-badge ' + boInfo.tier + '">' + boInfo.label + '</div>';
                }

                html += '<div class="' + cardClass + '" id="ep-card-' + proj.project_id + '" onclick="toggleProjectCard(\'' + proj.project_id + '\')">' +
                    '<span class="ep-card-collapse-arrow">\u25B8</span>' +
                    badgeHtml +
                    '<div class="ep-project-name">' + escapeHtmlEP(proj.project_name) + '</div>' +
                    '<div class="ep-project-codename">' + escapeHtmlEP(proj.codename) + '</div>' +
                    '<div class="ep-tier-badge ' + (proj.knowledge_tier || 'conceptual_sandbox') + '">' + EP_TIER_LABELS[proj.knowledge_tier || 'conceptual_sandbox'] + '</div>' +
                    (function() {
                        var domainBadge = '';
                        var v = proj.engineering_validation;
                        if (v && v.domain) {
                            var domainLabel = v.domain.replace(/_/g, ' ');
                            domainBadge = '<div style="display:inline-block;font-size:7px;padding:1px 6px;border-radius:3px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px;font-weight:600;">' + escapeHtmlEP(domainLabel) + '</div>';
                        }
                        var ft = proj.feasibility_tier;
                        if (!ft) return domainBadge + '<div class="ep-feasibility-badge ep-ft-unvalidated" onclick="event.stopPropagation(); runValidation(\'' + proj.project_id + '\', \'' + epCurrentPersona + '\')">NOT VALIDATED â€” Click to Run</div>';
                        var ftNames = {1:'TIER 1: BUILDABLE NOW',2:'TIER 2: RESEARCH GRADE',3:'TIER 3: FRONTIER',4:'TIER 4: SPECULATIVE'};
                        var ftColors = {1:'#4ade80',2:'#818cf8',3:'#f97316',4:'#ef4444'};
                        var ftClass = 'ep-ft-' + ft;
                        return domainBadge + '<div class="ep-feasibility-badge ' + ftClass + '" style="border-color:' + ftColors[ft] + '44;background:' + ftColors[ft] + '15;color:' + ftColors[ft] + ';" onclick="event.stopPropagation(); runValidation(\'' + proj.project_id + '\', \'' + epCurrentPersona + '\')">' + ftNames[ft] + '</div>';
                    })() +
                    '<div class="ep-phase-dots">' + dots + '<span class="ep-phase-label">' + phaseLabel + '</span></div>' +
                    '<div class="ep-progress-bar"><div class="ep-progress-fill" style="width:' + proj.progress_percent + '%;background:' + color + ';"></div></div>' +
                    '<div class="ep-progress-text">' + proj.progress_percent + '%</div>' +
                    '<div class="ep-card-detail">' +
                        '<div class="ep-focus-label">Current Focus</div>' +
                        '<div class="ep-focus">' + escapeHtmlEP(proj.current_focus) + '</div>' +
                        (proj.last_breakthrough ? '<div class="ep-hypothesis">\u26A1 Key Hypothesis: ' + escapeHtmlEP(proj.last_breakthrough) + '</div>' : '') +
                        '<div class="ep-prototype-section" id="epProto-' + proj.project_id + '">' +
                            '<div class="ep-prototype-header" onclick="event.stopPropagation(); togglePrototype(\'' + proj.project_id + '\')">' +
                                '<span class="ep-prototype-title">\uD83D\uDD27 Engineering View</span>' +
                                '<span class="ep-prototype-arrow">\u25BC</span>' +
                            '</div>' +
                            '<div class="ep-prototype-body">' +
                                '<div class="ep-prototype-img-wrap">' +
                                    '<div class="ep-ref-label">Industrial Design Study \u2014 Reference Only</div>' +
                                    '<img class="ep-prototype-img" src="/static/images/prototypes/' + proj.project_id + '.png" alt="' + escapeHtmlEP(proj.project_name) + ' Prototype" loading="lazy" onerror="this.style.display=\'none\'">' +
                                    '<div class="ep-prototype-overlay">' +
                                        '<div class="ep-prototype-completion">' +
                                            '<div class="ep-prototype-bar-track">' +
                                                '<div class="ep-prototype-bar-fill" style="width:' + proj.progress_percent + '%;background:' + color + ';"></div>' +
                                            '</div>' +
                                            '<span class="ep-prototype-pct">' + proj.progress_percent + '%</span>' +
                                        '</div>' +
                                        '<div class="ep-prototype-phase">Phase: ' + phaseLabel + '</div>' +
                                        '<div class="ep-prototype-status-dots">' + protoDots + '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="ep-eng-view" id="epEngView-' + proj.project_id + '">' +
                                    '<div class="ep-eng-loading">Loading engineering specs\u2026</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<button class="ep-resources-toggle" id="epResTog-' + proj.project_id + '" onclick="event.stopPropagation(); toggleProjectResources(\'' + proj.project_id + '\')">' +
                            '<span>\uD83D\uDCDA Resources & Knowledge</span>' +
                            resBadge +
                            '<span class="ep-res-arrow">\u25BC</span>' +
                        '</button>' +
                        '<div class="ep-resources-content" id="epResContent-' + proj.project_id + '">' +
                            '<div class="ep-res-loading">Click to load resources</div>' +
                        '</div>' +
                        '<div class="ep-eng-validation-card" id="epValCard-' + proj.project_id + '">' +
                            (function() {
                                var v = proj.engineering_validation;
                                if (!v) return '<div style="font-size:9px;color:var(--text-muted);padding:8px;text-align:center;">Engineering validation not yet run.<br><button onclick="event.stopPropagation(); runValidation(\'' + proj.project_id + '\', \'' + epCurrentPersona + '\')" style="margin-top:4px;font-size:9px;padding:3px 10px;background:rgba(99,102,241,0.15);color:#818cf8;border:1px solid rgba(99,102,241,0.3);border-radius:4px;cursor:pointer;">Run Engineering Validation</button></div>';
                                var checks = ['scale_check','energy_check','material_check','fabrication_check','physics_check'];
                                var checkLabels = {scale_check:'Scale',energy_check:'Energy',material_check:'Material',fabrication_check:'Fabrication',physics_check:'Physics'};
                                var h = '';
                                if (v.domain) {
                                    var domainLabel = v.domain.replace(/_/g, ' ');
                                    h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">';
                                    h += '<span style="font-size:7px;padding:2px 6px;border-radius:3px;background:rgba(139,92,246,0.15);color:#a78bfa;border:1px solid rgba(139,92,246,0.3);text-transform:uppercase;font-weight:600;letter-spacing:0.5px;">' + escapeHtmlEP(domainLabel) + '</span>';
                                    if (v.overall_score !== undefined) {
                                        var scoreColor = v.overall_score >= 0.8 ? '#4ade80' : v.overall_score >= 0.5 ? '#f97316' : '#ef4444';
                                        h += '<span style="font-size:8px;color:' + scoreColor + ';font-weight:600;">' + Math.round(v.overall_score * 100) + '% Ready</span>';
                                    }
                                    h += '</div>';
                                }
                                h += '<div style="font-size:8px;color:#818cf8;font-weight:600;text-transform:uppercase;margin-bottom:6px;">Engineering Validation Protocol</div>';
                                h += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">';
                                checks.forEach(function(ck) {
                                    var c = v[ck] || {};
                                    var passed = c.pass;
                                    var statusText = c.status || (passed ? 'PASS' : 'FAIL');
                                    var col = passed ? '#4ade80' : (statusText === 'PARTIAL' ? '#f97316' : '#ef4444');
                                    var icon = passed ? '\u2705' : (statusText === 'PARTIAL' ? '\u26A0\uFE0F' : '\u274C');
                                    h += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:' + col + '15;color:' + col + ';border:1px solid ' + col + '33;">' + icon + ' ' + checkLabels[ck] + '</span>';
                                });
                                h += '</div>';
                                h += '<div style="font-size:9px;color:var(--text-secondary);margin-bottom:4px;">' + (v.checks_passed || 0) + '/' + (v.total_checks || 5) + ' checks passed</div>';
                                if (v.tier_justification) h += '<div style="font-size:9px;color:var(--text-muted);padding:4px 6px;background:rgba(255,255,255,0.02);border-radius:3px;margin-bottom:4px;">' + escapeHtmlEP(v.tier_justification) + '</div>';
                                if (v.critical_blockers && v.critical_blockers.length > 0) {
                                    h += '<div style="font-size:8px;color:#ef4444;font-weight:600;margin-top:4px;">BLOCKERS:</div>';
                                    v.critical_blockers.forEach(function(b) { h += '<div style="font-size:8px;color:#ef4444;padding-left:8px;">- ' + escapeHtmlEP(b) + '</div>'; });
                                }
                                if (v.recommendations && v.recommendations.length > 0) {
                                    h += '<div style="font-size:8px;color:#4ade80;font-weight:600;margin-top:4px;">RECOMMENDATIONS:</div>';
                                    v.recommendations.forEach(function(r) { h += '<div style="font-size:8px;color:var(--text-secondary);padding-left:8px;">- ' + escapeHtmlEP(r) + '</div>'; });
                                }
                                if (v.missing_fields && v.missing_fields.length > 0) {
                                    h += '<div style="font-size:8px;color:#f97316;font-weight:600;margin-top:4px;">MISSING DATA:</div>';
                                    v.missing_fields.forEach(function(f) { h += '<div style="font-size:8px;color:var(--text-muted);padding-left:8px;">- ' + escapeHtmlEP(f) + '</div>'; });
                                }
                                if (v.validated_at) {
                                    var vDate = new Date(v.validated_at);
                                    h += '<div style="font-size:7px;color:var(--text-muted);margin-top:4px;opacity:0.7;">Validated: ' + vDate.toLocaleDateString() + ' ' + vDate.toLocaleTimeString() + '</div>';
                                }
                                h += '<div style="text-align:right;margin-top:6px;"><button onclick="event.stopPropagation(); runValidation(\'' + proj.project_id + '\', \'' + epCurrentPersona + '\')" style="font-size:8px;padding:2px 8px;background:rgba(99,102,241,0.1);color:#818cf8;border:1px solid rgba(99,102,241,0.2);border-radius:3px;cursor:pointer;">Re-Validate</button></div>';
                                return h;
                            })() +
                        '</div>' +
                        '<button class="ep-resources-toggle" id="epBuildTog-' + proj.project_id + '" onclick="event.stopPropagation(); toggleBuildPlans(\'' + proj.project_id + '\')">' +
                            '<span>\uD83D\uDEE0\uFE0F Build Plans</span>' +
                            '<span class="ep-res-arrow">\u25BC</span>' +
                        '</button>' +
                        '<div class="ep-resources-content" id="epBuildContent-' + proj.project_id + '">' +
                            '<div class="ep-res-loading">Click to load build plans</div>' +
                        '</div>' +
                        '<button class="ep-resources-toggle" id="epHbTog-' + proj.project_id + '" onclick="event.stopPropagation(); toggleHandbook(\'' + proj.project_id + '\')" style="border-color:rgba(255,170,0,0.3);background:rgba(255,170,0,0.05);">' +
                            '<span>\uD83D\uDCD0 Visual Blueprint Handbook</span>' +
                            '<span class="ep-res-arrow">\u25BC</span>' +
                        '</button>' +
                        '<div class="ep-resources-content" id="epHbContent-' + proj.project_id + '">' +
                            '<div class="ep-res-loading">Click to load visual handbook</div>' +
                        '</div>' +
                        '<div class="ep-validation-section">' +
                            '<div class="ep-validation-title">Validation Prep Layer</div>' +
                            '<div id="epValPrep-' + proj.project_id + '" class="ep-validation-content">' +
                                '<div style="font-size:9px;color:var(--text-muted);cursor:pointer;" onclick="event.stopPropagation();loadValidationPrep(\'' + proj.project_id + '\')">Click to load path-to-proof data</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="ep-empirical-section">' +
                            '<div class="ep-empirical-title" style="display:flex;justify-content:space-between;align-items:center;">Empirical Bridge <span style="font-size:8px;cursor:pointer;color:#4caf50;opacity:0.7;font-weight:400;" onclick="event.stopPropagation();loadEmpiricalData(\'' + proj.project_id + '\')">Refresh</span></div>' +
                            '<div id="epEmpirical-' + proj.project_id + '">' +
                                '<div class="ep-empirical-locked"><span class="lock-icon">&#128274;</span>Manual Input Only \u2014 AI cannot write here.</div>' +
                                '<div id="epEmpiricalEntries-' + proj.project_id + '"></div>' +
                                '<details style="margin-top:6px;"><summary style="cursor:pointer;font-size:9px;color:#4caf50;font-weight:600;">+ Add Measurement / Test Result</summary>' +
                                '<div style="padding:6px 0;">' +
                                    '<input id="empTitle-' + proj.project_id + '" type="text" placeholder="Measurement title (e.g. Tensile Strength Test #1)" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;margin-bottom:4px;font-size:10px;box-sizing:border-box;" />' +
                                    '<div style="display:flex;gap:4px;margin-bottom:4px;">' +
                                        '<input id="empValue-' + proj.project_id + '" type="text" placeholder="Value (e.g. 45.2)" style="flex:2;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;font-size:10px;box-sizing:border-box;" />' +
                                        '<input id="empUnit-' + proj.project_id + '" type="text" placeholder="Unit (MPa)" style="flex:1;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;font-size:10px;box-sizing:border-box;" />' +
                                    '</div>' +
                                    '<input id="empMethod-' + proj.project_id + '" type="text" placeholder="Methodology (e.g. ASTM D638, 3 samples)" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;margin-bottom:4px;font-size:10px;box-sizing:border-box;" />' +
                                    '<select id="empType-' + proj.project_id + '" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;margin-bottom:4px;font-size:10px;">' +
                                        '<option value="measurement">Measurement</option>' +
                                        '<option value="test_result">Test Result</option>' +
                                        '<option value="observation">Observation</option>' +
                                        '<option value="calibration">Calibration</option>' +
                                    '</select>' +
                                    '<textarea id="empNotes-' + proj.project_id + '" rows="2" placeholder="Notes (optional)" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid rgba(76,175,80,0.3);border-radius:4px;padding:5px 8px;margin-bottom:6px;font-size:10px;box-sizing:border-box;resize:vertical;font-family:inherit;"></textarea>' +
                                    '<button onclick="event.stopPropagation();submitEmpiricalEntry(\'' + proj.project_id + '\')" style="width:100%;padding:6px;background:rgba(76,175,80,0.2);color:#4caf50;border:1px solid rgba(76,175,80,0.4);border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;">Submit Entry</button>' +
                                '</div>' +
                                '</details>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            html += '<div class="ep-section-title">Activity Feed</div>';
            html += '<div id="epActivityFeed"><div class="ep-loading">Loading\u2026</div></div>';

            body.innerHTML = html;
            loadPersonaSchedule();
        }

        function renderDoctrinePanel() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Loading doctrine data...</div>';

            function safeFetch(url, fallback) {
                return fetch(url).then(function(r) {
                    if (!r.ok) return fallback;
                    return r.json();
                }).catch(function() { return fallback; });
            }

            Promise.all([
                safeFetch('/engineering/doctrine', {doctrine:{principles:[]}, architecture_layers:{}, release_stages:{}}),
                safeFetch('/engineering/dod', {features:[], fully_passing:0, total_features:0, checklist:[]}),
                safeFetch('/engineering/pipeline', {stages:{}}),
                safeFetch('/engineering/observability/health', {status:'unknown', total_events:0, events_last_5min:0, errors_last_5min:0, total_crash_reports:0}),
                safeFetch('/engineering/observability/events?limit=10', {events:[]}),
                safeFetch('/engineering/truth-doc', {features:[], total_features:0})
            ]).then(function(results) {
                var doctrine = results[0];
                var dod = results[1];
                var pipeline = results[2];
                var health = results[3];
                var obsEvents = results[4];
                var truthDoc = results[5];

                var html = '';

                html += '<div class="ep-doctrine-header">';
                html += '<div class="ep-doctrine-title">BUILD \u2192 PROVE \u2192 LOCK</div>';
                html += '<div class="ep-doctrine-subtitle">Engineering Doctrine \u2014 Every feature has a spec, guards, and proof</div>';
                html += '</div>';

                html += '<div class="ep-doctrine-principles">';
                (doctrine.doctrine.principles || []).forEach(function(p, pIdx) {
                    var detId = 'epPrinciple-' + pIdx;
                    html += '<div class="ep-doctrine-principle ep-doctrine-expandable" onclick="toggleDoctrineItem(\'' + detId + '\')">' +
                        '<div class="ep-doctrine-principle-id">' + escapeHtmlEP(p.id) + '</div>' +
                        '<div class="ep-doctrine-principle-name">' + escapeHtmlEP(p.name) + ' <span class="ep-expand-arrow">\u25B8</span></div>' +
                        '<div class="ep-doctrine-detail" id="' + detId + '">' +
                            '<div class="ep-doctrine-principle-rule">' + escapeHtmlEP(p.rule) + '</div>' +
                        '</div>' +
                    '</div>';
                });
                html += '</div>';

                html += '<div class="ep-obs-section">';
                html += '<div class="ep-obs-title">System Health</div>';
                var healthStatus = health.status || 'healthy';
                html += '<div class="ep-obs-health">';
                html += '<div class="ep-obs-dot ' + healthStatus + '"></div>';
                html += '<div class="ep-obs-status">' + healthStatus.charAt(0).toUpperCase() + healthStatus.slice(1) + '</div>';
                html += '</div>';
                html += '<div class="ep-obs-metrics">';
                html += '<div class="ep-obs-metric"><div class="ep-obs-metric-val">' + (health.total_events || 0) + '</div><div class="ep-obs-metric-label">Total Events</div></div>';
                html += '<div class="ep-obs-metric"><div class="ep-obs-metric-val">' + (health.events_last_5min || 0) + '</div><div class="ep-obs-metric-label">Last 5 Min</div></div>';
                html += '<div class="ep-obs-metric"><div class="ep-obs-metric-val">' + (health.errors_last_5min || 0) + '</div><div class="ep-obs-metric-label">Errors (5m)</div></div>';
                html += '<div class="ep-obs-metric"><div class="ep-obs-metric-val">' + (health.total_crash_reports || 0) + '</div><div class="ep-obs-metric-label">Crashes</div></div>';
                html += '</div>';
                if (obsEvents.events && obsEvents.events.length > 0) {
                    html += '<div class="ep-obs-events" style="margin-top:8px;">';
                    obsEvents.events.forEach(function(ev) {
                        var t = new Date(ev.timestamp * 1000);
                        var timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                        html += '<div class="ep-obs-event">' +
                            '<span class="ep-obs-event-name">' + escapeHtmlEP(ev.event_name) + '</span> ' +
                            '<span class="ep-obs-event-detail">' + escapeHtmlEP(ev.detail || '') + '</span> ' +
                            '<span class="ep-obs-event-time">' + timeStr + '</span>' +
                        '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';

                html += '<div class="ep-pipeline-section">';
                html += '<div class="ep-pipeline-title">Release Pipeline</div>';
                var stageOrder = ['alpha', 'beta', 'release'];
                stageOrder.forEach(function(stageId) {
                    var stage = pipeline.stages[stageId];
                    if (!stage) return;
                    var pipeId = 'epPipe-' + stageId;
                    html += '<div class="ep-pipeline-stage ' + stageId + ' ep-doctrine-expandable" onclick="toggleDoctrineItem(\'' + pipeId + '\')">';
                    html += '<div class="ep-pipeline-stage-header">';
                    html += '<span class="ep-pipeline-stage-name">' + escapeHtmlEP(stage.name) + ' <span class="ep-expand-arrow">\u25B8</span></span>';
                    html += '<span class="ep-pipeline-stage-count">' + stage.feature_count + ' features</span>';
                    html += '</div>';
                    html += '<div class="ep-doctrine-detail" id="' + pipeId + '">';
                    html += '<div class="ep-pipeline-stage-desc">' + escapeHtmlEP(stage.description) + '</div>';
                    html += '<div class="ep-pipeline-features">';
                    (stage.features || []).forEach(function(f) {
                        html += '<span class="ep-pipeline-feature-tag">' + escapeHtmlEP(f.name) + '</span>';
                    });
                    html += '</div></div>';
                    html += '</div>';
                });
                html += '</div>';

                html += '<div class="ep-dod-section">';
                html += '<div class="ep-dod-title">Definition of Done</div>';
                var passingCount = dod.fully_passing || 0;
                var totalFeatures = dod.total_features || 0;
                html += '<div class="ep-dod-summary">';
                html += '<div><div class="ep-dod-score">' + passingCount + '/' + totalFeatures + '</div><div class="ep-dod-label">Features Fully Passing</div></div>';
                html += '</div>';

                var DOD_LABELS = {
                    'real_device': 'Device',
                    'handles_permission_denied': 'Perms',
                    'handles_offline': 'Offline',
                    'handles_repeated_use': '10x Use',
                    'has_test': 'Test',
                    'logs_errors': 'Logs'
                };

                (dod.features || []).forEach(function(f, fIdx) {
                    var scoreClass = f.passing ? 'passing' : 'failing';
                    var dodId = 'epDod-' + fIdx;
                    html += '<div class="ep-dod-feature ep-doctrine-expandable" onclick="toggleDoctrineItem(\'' + dodId + '\')">';
                    html += '<div class="ep-dod-feature-header">';
                    html += '<span class="ep-dod-feature-name">' + escapeHtmlEP(f.name) + ' <span class="ep-expand-arrow">\u25B8</span></span>';
                    html += '<span class="ep-dod-feature-score ' + scoreClass + '">' + f.checks_passed + '/' + f.total_checks + '</span>';
                    html += '</div>';
                    html += '<div class="ep-doctrine-detail" id="' + dodId + '">';
                    html += '<div class="ep-dod-checks">';
                    var details = f.details || {};
                    Object.keys(details).forEach(function(key) {
                        var checkClass = details[key] ? 'pass' : 'fail';
                        var label = DOD_LABELS[key] || key;
                        var icon = details[key] ? '\u2713' : '\u2717';
                        html += '<span class="ep-dod-check ' + checkClass + '">' + icon + ' ' + label + '</span>';
                    });
                    html += '</div></div>';
                    html += '</div>';
                });
                html += '</div>';

                html += '<div class="ep-arch-section">';
                html += '<div class="ep-arch-title">4-Layer Architecture</div>';
                var layerOrder = ['ui', 'app_logic', 'service', 'data'];
                layerOrder.forEach(function(layerId, idx) {
                    var layer = doctrine.architecture_layers[layerId];
                    if (!layer) return;
                    if (idx > 0) {
                        html += '<div class="ep-arch-arrow">\u2193</div>';
                    }
                    html += '<div class="ep-arch-layer">';
                    html += '<div class="ep-arch-layer-name">' + escapeHtmlEP(layer.name) + '</div>';
                    html += '<div class="ep-arch-layer-desc">' + escapeHtmlEP(layer.description) + '</div>';
                    html += '<div class="ep-arch-layer-rule">' + escapeHtmlEP(layer.rule) + '</div>';
                    html += '</div>';
                });
                html += '</div>';

                html += '<div class="ep-truth-section">';
                html += '<div class="ep-truth-title">Truth Doc \u2014 Feature Specs (' + (truthDoc.total_features || 0) + ')</div>';
                (truthDoc.features || []).forEach(function(f, idx) {
                    var detailId = 'epTruthDetail-' + idx;
                    html += '<div class="ep-truth-feature" onclick="toggleTruthDetail(\'' + detailId + '\')">';
                    html += '<div class="ep-truth-feature-header">';
                    html += '<span class="ep-truth-feature-name">' + escapeHtmlEP(f.name) + '</span>';
                    html += '<span class="ep-truth-feature-layer">' + escapeHtmlEP(f.layer) + '</span>';
                    html += '</div>';
                    html += '<div class="ep-truth-feature-id">' + escapeHtmlEP(f.id) + '</div>';
                    html += '<div class="ep-truth-detail" id="' + detailId + '">';
                    html += '<div class="ep-truth-row"><div class="ep-truth-row-label">Inputs</div><div class="ep-truth-row-value">' + escapeHtmlEP(f.inputs) + '</div></div>';
                    html += '<div class="ep-truth-row"><div class="ep-truth-row-label">Expected Output</div><div class="ep-truth-row-value">' + escapeHtmlEP(f.expected_output) + '</div></div>';
                    html += '<div class="ep-truth-row"><div class="ep-truth-row-label">Failure Behavior</div><div class="ep-truth-row-value">' + escapeHtmlEP(f.failure_behavior) + '</div></div>';
                    html += '<div class="ep-truth-row"><div class="ep-truth-row-label">Acceptance Test</div><div class="ep-truth-row-value">' + escapeHtmlEP(f.acceptance_test) + '</div></div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';

                body.innerHTML = html;
            }).catch(function(err) {
                body.innerHTML = '<div class="ep-loading">Error loading doctrine: ' + err.message + '</div>';
            });
        }

        window.toggleTruthDetail = function(id) {
            var el = document.getElementById(id);
            if (!el) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;
            el.classList.toggle('open');
            if (panelBody) {
                requestAnimationFrame(function() { panelBody.scrollTop = scrollBefore; });
            }
        };

        window.toggleDoctrineItem = function(id) {
            var el = document.getElementById(id);
            if (!el) return;
            var panelBody = document.getElementById('edgePanelBody');
            var scrollBefore = panelBody ? panelBody.scrollTop : 0;
            el.classList.toggle('open');
            var parent = el.parentElement;
            if (parent) {
                var arrow = parent.querySelector('.ep-expand-arrow');
                if (arrow) arrow.textContent = el.classList.contains('open') ? '\u25BE' : '\u25B8';
            }
            if (panelBody) {
                requestAnimationFrame(function() { panelBody.scrollTop = scrollBefore; });
            }
        };

        function escapeHtmlEP(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        window.escapeHtmlEP = escapeHtmlEP;

        var epSupervisorData = null;
        var svSubView = 'overview';

        window.renderSupervisorPanel = function() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Loading research data...</div>';

            function svFetch(url, fallback) {
                return fetch(url).then(function(r) {
                    if (!r.ok) return fallback;
                    return r.json();
                }).catch(function() { return fallback; });
            }

            Promise.all([
                svFetch('/supervisor/stats', {total_projects:0, pending_review:0, approved:0, rejected:0, revision_requested:0, total_reviews:0, by_stage:{}}),
                svFetch('/supervisor/queue', {queue:[], total:0}),
                svFetch('/supervisor/protocol', {protocol:{stages:[], guardrail_checks:[], ai_rules:{allowed:[], guardrails:[]}, enforcement:''}}),
                svFetch('/build/summary', {total_build_plans:0, active_builds:0, completed_builds:0, total_daily_research_logs:0, active_projects:0, flagged_builds:0}),
                svFetch('/research-tracker/activity', {activities:[]})
            ]).then(function(results) {
                var stats = results[0];
                var queue = results[1];
                var protocol = results[2].protocol || {};
                var buildSummary = results[3];
                var activity = results[4];
                epSupervisorData = { stats: stats, queue: queue, protocol: protocol, buildSummary: buildSummary, activity: activity };

                var html = '';

                html += '<div class="ep-supervisor-header">';
                html += '<div class="ep-supervisor-title">HYPOTHESIS DEVELOPMENT LAB</div>';
                html += '<div class="ep-supervisor-subtitle">AIs develop hypotheses and feasibility analyses freely. Guardrails keep them safe. You monitor.</div>';
                html += '</div>';

                html += '<div style="display:flex;gap:4px;padding:0 8px 8px 8px;">';
                html += '<button class="ep-sv-btn' + (svSubView === 'overview' ? ' approve' : '') + '" style="flex:1;padding:6px;font-size:10px;" onclick="svSubView=\'overview\';renderSupervisorPanel();">Overview</button>';
                html += '<button class="ep-sv-btn' + (svSubView === 'builds' ? ' approve' : '') + '" style="flex:1;padding:6px;font-size:10px;" onclick="svSubView=\'builds\';renderSupervisorPanel();">Builds</button>';
                html += '<button class="ep-sv-btn' + (svSubView === 'activity' ? ' approve' : '') + '" style="flex:1;padding:6px;font-size:10px;" onclick="svSubView=\'activity\';renderSupervisorPanel();">Activity</button>';
                html += '<button class="ep-sv-btn' + (svSubView === 'rules' ? ' approve' : '') + '" style="flex:1;padding:6px;font-size:10px;" onclick="svSubView=\'rules\';renderSupervisorPanel();">Rules</button>';
                html += '</div>';

                if (svSubView === 'overview') {
                    html += renderSvOverview(stats, queue, buildSummary);
                } else if (svSubView === 'builds') {
                    html += renderSvBuilds(queue);
                } else if (svSubView === 'activity') {
                    html += renderSvActivity(activity);
                } else if (svSubView === 'rules') {
                    html += renderSvRules(protocol);
                }

                body.innerHTML = html;
            });
        };

        function renderSvOverview(stats, queue, buildSummary) {
            var html = '';

            html += '<div class="ep-sv-stats">';
            html += '<div class="ep-sv-stat approved"><div class="ep-sv-stat-val">' + (stats.total_projects || 0) + '</div><div class="ep-sv-stat-label">Projects</div></div>';
            html += '<div class="ep-sv-stat pending"><div class="ep-sv-stat-val">' + (buildSummary.active_builds || 0) + '</div><div class="ep-sv-stat-label">Builds</div></div>';
            html += '<div class="ep-sv-stat approved"><div class="ep-sv-stat-val">' + (buildSummary.completed_builds || 0) + '</div><div class="ep-sv-stat-label">Done</div></div>';
            html += '<div class="ep-sv-stat' + ((buildSummary.flagged_builds || 0) > 0 ? ' rejected' : '') + '"><div class="ep-sv-stat-val">' + (buildSummary.flagged_builds || 0) + '</div><div class="ep-sv-stat-label">Flagged</div></div>';
            html += '</div>';

            var stageNames = {philosophy:'Phil', concept:'Concept', research:'Research', blueprint:'Blueprint', simulation:'Sim', digital_proto:'Digital', physical_proto:'Physical', refinement:'Refine'};
            var byStage = stats.by_stage || {};
            html += '<div class="ep-sv-stage-bar">';
            ['philosophy','concept','research','blueprint','simulation','digital_proto','physical_proto','refinement'].forEach(function(s) {
                var count = byStage[s] || 0;
                var cls = 'ep-sv-stage-pip' + (count > 0 ? ' has-projects' : '');
                html += '<div class="' + cls + '">' + (stageNames[s] || s) + '<br>' + count + '</div>';
            });
            html += '</div>';

            html += '<div class="ep-sv-queue-title">Active Hypothesis Development (' + (queue.total || 0) + ' projects)</div>';

            (queue.queue || []).forEach(function(proj, idx) {
                var cardId = 'svCard-' + idx;
                var statusColor = proj.supervisor_status === 'active' ? 'var(--success)' : proj.supervisor_status === 'rejected' ? '#ff4444' : 'var(--warning)';
                var statusLabel = proj.supervisor_status === 'active' ? 'ACTIVE' : proj.supervisor_status === 'rejected' ? 'HALTED' : proj.supervisor_status.toUpperCase();
                html += '<div class="ep-sv-card" id="' + cardId + '" onclick="toggleSvCard(\'' + cardId + '\')">';
                html += '<div class="ep-sv-card-header">';
                html += '<div><div class="ep-sv-card-name">' + escapeHtmlEP(proj.project_name) + '</div>';
                html += '<div class="ep-sv-card-meta">';
                html += '<span class="ep-sv-card-persona ' + proj.persona + '">' + proj.persona.toUpperCase() + '</span>';
                html += '<span style="color:' + statusColor + ';font-weight:600;font-size:9px;">' + statusLabel + '</span>';
                html += '</div></div>';
                html += '<div style="display:flex;align-items:center;gap:4px;flex-direction:column;">';
                html += '<span class="ep-sv-card-stage ' + (proj.review_stage || 'concept') + '">' + (stageNames[proj.review_stage] || proj.review_stage || 'concept') + '</span>';
                html += '<span class="ep-tier-badge ' + (proj.knowledge_tier || 'conceptual_sandbox') + '" style="font-size:7px;padding:1px 4px;">' + (EP_TIER_LABELS[proj.knowledge_tier || 'conceptual_sandbox'] || 'T1').split(':')[0] + '</span>';
                html += '</div>';
                html += '</div>';

                html += '<div class="ep-progress-bar"><div class="ep-progress-fill" style="width:' + proj.progress_percent + '%;background:var(--accent-primary);"></div></div>';
                html += '<div class="ep-progress-text">' + proj.progress_percent + '%</div>';

                html += '<div class="ep-sv-detail">';

                if (proj.current_focus) {
                    html += '<div class="ep-sv-field"><div class="ep-sv-field-label">Current Focus</div><div class="ep-sv-field-value">' + escapeHtmlEP(proj.current_focus) + '</div></div>';
                }
                if (proj.last_breakthrough) {
                    html += '<div class="ep-sv-field"><div class="ep-sv-field-label">Key Hypothesis</div><div class="ep-sv-field-value" style="border-left-color:var(--success);">' + escapeHtmlEP(proj.last_breakthrough) + '</div></div>';
                }
                if (proj.safety_constraints) {
                    html += '<div class="ep-sv-field"><div class="ep-sv-field-label">Safety Guardrails</div><div class="ep-sv-field-value safety">' + escapeHtmlEP(proj.safety_constraints) + '</div></div>';
                }

                html += '<div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;" onclick="event.stopPropagation()">';
                html += '<button class="ep-sv-btn approve" style="font-size:9px;padding:4px 8px;" onclick="loadProjectBuilds(\'' + proj.project_id + '\')">View Builds</button>';
                html += '<button class="ep-sv-btn" style="font-size:9px;padding:4px 8px;" onclick="loadDailyLog(\'' + proj.project_id + '\')">Daily Log</button>';
                if (proj.supervisor_status !== 'rejected') {
                    html += '<button class="ep-sv-btn reject" style="font-size:9px;padding:4px 8px;" onclick="submitSvDecision(\'' + proj.project_id + '\', \'reject\')">Halt</button>';
                }
                html += '</div>';

                html += '<div id="svDetail-' + proj.project_id + '"></div>';
                html += '</div>';
                html += '</div>';
            });

            return html;
        }

        function renderSvBuilds(queue) {
            var html = '';
            html += '<div class="ep-sv-queue-title">Build Plans by Project</div>';
            html += '<div id="svBuildsContent"><div class="ep-loading">Select a project or loading builds...</div></div>';

            var projects = {};
            (queue.queue || []).forEach(function(p) {
                if (!projects[p.project_id]) projects[p.project_id] = p;
            });

            html += '<div style="padding:4px 8px;">';
            Object.keys(projects).forEach(function(pid) {
                html += '<button class="ep-sv-btn" style="font-size:10px;padding:4px 8px;margin:2px;" onclick="loadProjectBuilds(\'' + pid + '\')">' + escapeHtmlEP(projects[pid].codename || pid) + '</button>';
            });
            html += '</div>';

            return html;
        }

        function renderSvActivity(activity) {
            var html = '';
            html += '<div class="ep-sv-queue-title">Recent Hypothesis Activity</div>';

            var acts = activity.activities || [];
            if (acts.length === 0) {
                html += '<div style="padding:12px;color:var(--text-muted);font-size:11px;">No activity yet. AIs will log their daily research here.</div>';
            }

            acts.forEach(function(a) {
                var timeStr = a.created_at ? new Date(a.created_at).toLocaleString() : '';
                var typeColors = {
                    daily_research: 'var(--accent-primary)',
                    build_started: 'var(--success)',
                    build_step_complete: 'var(--success)',
                    phase_advance: '#ffaa00',
                    breakthrough: '#ff6600',
                    hypothesis: '#ff6600',
                    project_init: 'var(--text-muted)',
                    daily_update: 'var(--text-muted)',
                    supervisor_review: '#9b59b6',
                };
                var dotColor = typeColors[a.activity_type] || 'var(--text-muted)';
                var typeRenames = {breakthrough: 'HYPOTHESIS', daily_research: 'DAILY ANALYSIS', findings: 'FEASIBILITY NOTE'};
                var typeLabel = typeRenames[a.activity_type] || (a.activity_type || '').replace(/_/g, ' ').toUpperCase();

                html += '<div class="ep-sv-history-item">';
                html += '<div style="width:8px;height:8px;border-radius:50%;background:' + dotColor + ';flex-shrink:0;margin-top:4px;"></div>';
                html += '<div style="flex:1;min-width:0;">';
                html += '<div style="display:flex;align-items:center;gap:4px;">';
                html += '<span class="ep-sv-card-persona ' + a.persona + '" style="font-size:8px;">' + (a.persona || '').toUpperCase() + '</span>';
                html += '<span style="font-size:8px;color:' + dotColor + ';font-weight:600;">' + typeLabel + '</span>';
                html += '</div>';
                html += '<div style="color:var(--text-primary);font-weight:500;font-size:11px;">' + escapeHtmlEP(a.title || '') + '</div>';
                html += '<div style="color:var(--text-muted);font-size:10px;">' + escapeHtmlEP((a.description || '').substring(0, 200)) + '</div>';
                html += '</div>';
                html += '<div style="font-size:9px;color:var(--text-muted);white-space:nowrap;">' + timeStr + '</div>';
                html += '</div>';
            });

            return html;
        }

        function renderSvRules(protocol) {
            var html = '';
            html += '<div class="ep-supervisor-header" style="padding:8px;">';
            html += '<div class="ep-supervisor-title" style="font-size:12px;">HYPOTHESIS DEVELOPMENT RULES</div>';
            html += '<div class="ep-supervisor-subtitle">' + escapeHtmlEP(protocol.philosophy || '') + '</div>';
            html += '</div>';

            html += '<div style="padding:8px;">';
            html += '<div style="font-size:10px;font-weight:600;color:var(--success);margin:8px 0 4px 0;">WHAT AIs CAN DO</div>';
            (protocol.ai_rules.allowed || []).forEach(function(r) {
                html += '<div class="ep-sv-rule allowed">' + escapeHtmlEP(r) + '</div>';
            });

            html += '<div style="font-size:10px;font-weight:600;color:#ffaa00;margin:12px 0 4px 0;">GUARDRAILS</div>';
            (protocol.ai_rules.guardrails || []).forEach(function(r) {
                html += '<div class="ep-sv-rule" style="border-left-color:#ffaa00;">' + escapeHtmlEP(r) + '</div>';
            });

            if (protocol.ai_rules.golden_rule) {
                html += '<div style="margin-top:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;border:1px solid rgba(255,255,255,0.08);">';
                html += '<div style="font-size:10px;font-weight:600;color:var(--accent-primary);margin-bottom:4px;">GOLDEN RULE</div>';
                html += '<div style="font-size:11px;font-style:italic;color:var(--text-primary);">"' + escapeHtmlEP(protocol.ai_rules.golden_rule) + '"</div>';
                html += '</div>';
            }

            html += '<div style="font-size:10px;font-weight:600;color:var(--text-muted);margin:12px 0 4px 0;">GUARDRAIL CHECKS</div>';
            (protocol.guardrail_checks || []).forEach(function(q) {
                html += '<div class="ep-sv-question">' + escapeHtmlEP(q) + '</div>';
            });

            html += '<div style="margin-top:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;">';
            html += '<div style="font-size:10px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">ENFORCEMENT</div>';
            html += '<div style="font-size:11px;color:var(--text-primary);">' + escapeHtmlEP(protocol.enforcement || '') + '</div>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        window.runValidation = function(projectId, persona) {
            var card = document.getElementById('epValCard-' + projectId);
            if (card) card.innerHTML = '<div style="font-size:9px;color:#818cf8;padding:12px;text-align:center;">Running Domain-Aware Validation...<br><span style="font-size:8px;color:var(--text-muted);">Mapping domain + checking Scale, Energy, Materials, Fabrication, Physics</span></div>';
            fetch('/engineering/validate-project/' + projectId + '?persona=' + (persona || 'ajani'), { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'ok') {
                        var domainLabel = (data.domain || '').replace(/_/g, ' ');
                        showNotification('Validated: ' + domainLabel + ' â€” Tier ' + data.feasibility_tier + ' (' + data.tier_name + ') â€” ' + data.checks_passed + '/' + data.total_checks + ' checks', 'success');
                        epDashboardData = null;
                        epInitialLoadDone = false;
                        switchResearchTab(epCurrentPersona);
                    } else {
                        showNotification('Validation failed: ' + (data.detail || data.message || 'Unknown error'), 'error');
                        if (card) card.innerHTML = '<div style="font-size:9px;color:#ef4444;padding:8px;">Validation failed. Try again later.</div>';
                    }
                })
                .catch(function(e) {
                    showNotification('Validation error', 'error');
                    if (card) card.innerHTML = '<div style="font-size:9px;color:#ef4444;padding:8px;">Error running validation.</div>';
                });
        };

        window.runAllValidations = function() {
            showNotification('Validating all projects with domain mapping...', 'info');
            fetch('/engineering/validate-all-projects', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'ok') {
                        var okCount = data.results.filter(function(r) { return r.status === 'ok'; }).length;
                        showNotification('Validated ' + okCount + '/' + data.validated + ' projects with domain-aware checks', 'success');
                        epDashboardData = null;
                        epInitialLoadDone = false;
                        switchResearchTab(epCurrentPersona);
                    } else {
                        showNotification('Batch validation failed: ' + (data.detail || 'Unknown error'), 'error');
                    }
                })
                .catch(function(e) {
                    showNotification('Batch validation error', 'error');
                });
        };

        window.loadValidationPrep = function(projectId) {
            var container = document.getElementById('epValPrep-' + projectId);
            if (!container) return;
            container.innerHTML = '<div style="font-size:9px;color:var(--text-muted);">Loading...</div>';

            fetch('/build/validation-prep/' + projectId).then(function(r) { return r.json(); }).then(function(data) {
                var entries = data.entries || [];
                var html = '';
                if (entries.length === 0) {
                    html += '<div style="font-size:9px;color:var(--text-muted);padding:4px 0;">No validation prep entries yet. AIs can add real-world references, required data, and path-to-proof items.</div>';
                    html += '<div style="font-size:8px;color:var(--text-muted);padding:2px 0;opacity:0.7;">Outputs: Known references, data requirements, tools/labs needed. Still no claims \u2014 just paths to proof.</div>';
                }
                entries.forEach(function(e) {
                    var statusColor = e.proof_status === 'verified' ? '#4caf50' : e.proof_status === 'in_progress' ? '#ffaa00' : 'var(--text-muted)';
                    html += '<div class="ep-validation-item">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<span style="font-weight:600;font-size:10px;">' + escapeHtmlEP(e.title) + '</span>';
                    html += '<span style="font-size:8px;color:' + statusColor + ';font-weight:600;">' + (e.proof_status || 'not_started').replace(/_/g,' ').toUpperCase() + '</span>';
                    html += '</div>';
                    if (e.description) html += '<div style="font-size:9px;color:var(--text-secondary);">' + escapeHtmlEP(e.description) + '</div>';
                    if (e.data_required) html += '<div class="ep-validation-label">Data Required:</div><div style="font-size:9px;color:var(--text-secondary);">' + escapeHtmlEP(e.data_required) + '</div>';
                    if (e.tools_required) html += '<div class="ep-validation-label">Tools/Labs:</div><div style="font-size:9px;color:var(--text-secondary);">' + escapeHtmlEP(e.tools_required) + '</div>';
                    if (e.url) html += '<div style="font-size:9px;"><a href="' + escapeHtmlEP(e.url) + '" target="_blank" style="color:#ffaa00;">Reference Link</a></div>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }).catch(function() {
                container.innerHTML = '<div style="color:#ff4444;font-size:9px;">Failed to load</div>';
            });
        };

        window.loadEmpiricalData = function(projectId) {
            var container = document.getElementById('epEmpiricalEntries-' + projectId);
            if (!container) container = document.getElementById('epEmpirical-' + projectId);
            if (!container) return;
            container.innerHTML = '<div style="font-size:9px;color:var(--text-muted);">Loading...</div>';

            fetch('/build/empirical/' + projectId).then(function(r) { return r.json(); }).then(function(data) {
                var entries = data.entries || [];
                var html = '';
                if (entries.length === 0) {
                    html += '<div style="font-size:9px;color:var(--text-muted);text-align:center;padding:4px;">No entries yet \u2014 add your first measurement below.</div>';
                } else {
                    html += '<div style="font-size:8px;color:#4caf50;font-weight:600;margin-bottom:4px;">' + entries.length + ' ENTRY' + (entries.length > 1 ? 'S' : '') + ' RECORDED</div>';
                    entries.forEach(function(e) {
                        html += '<div class="ep-empirical-entry" style="padding:6px;margin-bottom:4px;background:rgba(76,175,80,0.05);border-radius:4px;border-left:2px solid rgba(76,175,80,0.4);">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">';
                        html += '<span style="font-weight:600;font-size:10px;color:var(--text-primary);">' + escapeHtmlEP(e.title) + '</span>';
                        if (e.verified) html += '<span class="ep-empirical-verified">VERIFIED</span>';
                        html += '</div>';
                        if (e.value) html += '<div style="font-size:11px;color:#4caf50;font-weight:600;">' + escapeHtmlEP(e.value) + (e.unit ? ' ' + escapeHtmlEP(e.unit) : '') + '</div>';
                        if (e.methodology) html += '<div style="font-size:9px;color:var(--text-muted);">Method: ' + escapeHtmlEP(e.methodology) + '</div>';
                        if (e.notes) html += '<div style="font-size:9px;color:var(--text-muted);font-style:italic;">' + escapeHtmlEP(e.notes) + '</div>';
                        html += '<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">By: ' + escapeHtmlEP(e.entered_by || 'user') + ' \u2022 ' + escapeHtmlEP(e.entry_type || '') + '</div>';
                        html += '</div>';
                    });
                }
                container.innerHTML = html;
            }).catch(function() {
                container.innerHTML = '<div style="color:#ff4444;font-size:9px;">Failed to load empirical data</div>';
            });
        };

        window.submitEmpiricalEntry = function(projectId) {
            var title = document.getElementById('empTitle-' + projectId);
            var value = document.getElementById('empValue-' + projectId);
            var unit = document.getElementById('empUnit-' + projectId);
            var method = document.getElementById('empMethod-' + projectId);
            var entryType = document.getElementById('empType-' + projectId);
            var notes = document.getElementById('empNotes-' + projectId);

            if (!title || !title.value.trim()) {
                alert('Please enter a measurement title.');
                return;
            }

            var payload = {
                project_id: projectId,
                entered_by: 'user',
                entry_type: entryType ? entryType.value : 'measurement',
                title: title.value.trim(),
                value: value ? value.value.trim() : null,
                unit: unit ? unit.value.trim() : null,
                methodology: method ? method.value.trim() : null,
                notes: notes ? notes.value.trim() : null
            };

            fetch('/build/empirical', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'ok') {
                    if (title) title.value = '';
                    if (value) value.value = '';
                    if (unit) unit.value = '';
                    if (method) method.value = '';
                    if (notes) notes.value = '';
                    loadEmpiricalData(projectId);
                } else {
                    alert('Error: ' + (data.detail || data.message || 'Unknown error'));
                }
            })
            .catch(function(err) {
                alert('Failed to submit: ' + err.message);
            });
        };

        window.loadProjectBuilds = function(projectId) {
            var target = document.getElementById('svDetail-' + projectId) || document.getElementById('svBuildsContent');
            if (!target) return;
            target.innerHTML = '<div class="ep-loading" style="padding:8px;">Loading builds...</div>';

            fetch('/build/plans/' + projectId).then(function(r) { return r.json(); }).then(function(data) {
                var plans = data.build_plans || [];
                var html = '';
                if (plans.length === 0) {
                    html += '<div style="padding:8px;color:var(--text-muted);font-size:10px;">No build plans yet. AIs will create builds as they research.</div>';
                }
                plans.forEach(function(plan) {
                    var pct = plan.total_steps > 0 ? Math.round((plan.completed_steps / plan.total_steps) * 100) : 0;
                    var statusColor = plan.status === 'completed' ? 'var(--success)' : plan.status === 'designing' ? 'var(--accent-primary)' : 'var(--warning)';
                    html += '<div style="margin:6px 0;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;border-left:3px solid ' + statusColor + ';">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<div style="font-weight:600;font-size:11px;color:var(--text-primary);">' + escapeHtmlEP(plan.plan_name) + '</div>';
                    html += '<span style="font-size:9px;color:' + statusColor + ';font-weight:600;">' + plan.status.toUpperCase() + '</span>';
                    html += '</div>';
                    if (plan.description) html += '<div style="font-size:10px;color:var(--text-muted);margin:2px 0;">' + escapeHtmlEP(plan.description) + '</div>';
                    html += '<div class="ep-progress-bar" style="margin:4px 0;"><div class="ep-progress-fill" style="width:' + pct + '%;background:' + statusColor + ';"></div></div>';
                    html += '<div style="font-size:9px;color:var(--text-muted);">' + plan.completed_steps + '/' + plan.total_steps + ' steps | ' + plan.parts.length + ' parts | Type: ' + plan.build_type + '</div>';

                    if (plan.safety_flags && plan.safety_flags.length > 0) {
                        html += '<div style="margin-top:4px;padding:4px;background:rgba(255,0,0,0.1);border-radius:4px;font-size:9px;color:#ff4444;">FLAGGED: ' + plan.safety_flags.join('; ') + '</div>';
                    }

                    if (plan.parts.length > 0) {
                        html += '<div style="margin-top:4px;font-size:9px;font-weight:600;color:var(--text-muted);">PARTS:</div>';
                        plan.parts.forEach(function(p) {
                            html += '<div style="font-size:9px;color:var(--text-secondary);padding:1px 0;">- ' + p.quantity + ' ' + p.unit + ' ' + escapeHtmlEP(p.part_name) + (p.specification ? ' (' + escapeHtmlEP(p.specification) + ')' : '') + '</div>';
                        });
                    }

                    if (plan.steps.length > 0) {
                        html += '<div style="margin-top:4px;font-size:9px;font-weight:600;color:var(--text-muted);">STEPS:</div>';
                        plan.steps.forEach(function(s) {
                            var stepIcon = s.status === 'completed' ? '&#10003;' : '&#9679;';
                            var stepColor = s.status === 'completed' ? 'var(--success)' : 'var(--text-muted)';
                            html += '<div style="font-size:9px;color:' + stepColor + ';padding:1px 0;">' + stepIcon + ' Step ' + s.step_number + ': ' + escapeHtmlEP(s.title) + '</div>';
                        });
                    }

                    html += '</div>';
                });
                target.innerHTML = html;
            }).catch(function() {
                target.innerHTML = '<div style="color:#ff4444;font-size:10px;padding:8px;">Failed to load builds</div>';
            });
        };

        window.loadDailyLog = function(projectId) {
            var target = document.getElementById('svDetail-' + projectId);
            if (!target) return;
            target.innerHTML = '<div class="ep-loading" style="padding:8px;">Loading daily log...</div>';

            fetch('/build/daily-log/' + projectId + '?limit=10').then(function(r) { return r.json(); }).then(function(data) {
                var logs = data.daily_logs || [];
                var html = '';
                if (logs.length === 0) {
                    html += '<div style="padding:8px;color:var(--text-muted);font-size:10px;">No daily logs yet. AIs will record their research progress here.</div>';
                }
                logs.forEach(function(l) {
                    var timeStr = l.research_date ? new Date(l.research_date).toLocaleDateString() : '';
                    html += '<div style="margin:4px 0;padding:6px;background:rgba(255,255,255,0.03);border-radius:4px;border-left:2px solid var(--accent-primary);">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<span class="ep-sv-card-persona ' + l.persona + '" style="font-size:8px;">' + l.persona.toUpperCase() + '</span>';
                    html += '<span style="font-size:9px;color:var(--text-muted);">' + timeStr + '</span>';
                    html += '</div>';
                    html += '<div style="font-size:10px;font-weight:600;color:var(--text-primary);margin:2px 0;">' + escapeHtmlEP(l.focus_area) + '</div>';
                    html += '<div style="font-size:10px;color:var(--text-secondary);">' + escapeHtmlEP((l.findings || l.hypothesis_notes || '').substring(0, 300)) + '</div>';
                    if (l.next_steps) html += '<div style="font-size:9px;color:var(--accent-primary);margin-top:2px;">Next: ' + escapeHtmlEP(l.next_steps.substring(0, 200)) + '</div>';
                    if (l.phase_before !== l.phase_after) {
                        html += '<div style="font-size:9px;color:#ffaa00;margin-top:2px;">Phase: ' + l.phase_before + ' -> ' + l.phase_after + '</div>';
                    }
                    if (l.guardrail_flags && l.guardrail_flags.length > 0) {
                        html += '<div style="font-size:9px;color:#ff4444;margin-top:2px;">FLAGGED: ' + l.guardrail_flags.join('; ') + '</div>';
                    }
                    html += '</div>';
                });
                target.innerHTML = html;
            }).catch(function() {
                target.innerHTML = '<div style="color:#ff4444;font-size:10px;padding:8px;">Failed to load daily log</div>';
            });
        };

        window.toggleSvCard = function(cardId) {
            var card = document.getElementById(cardId);
            if (!card) return;
            card.classList.toggle('expanded');
        };

        window.submitSvDecision = function(projectId, decision) {
            var label = decision === 'reject' ? 'HALT this project' : decision;
            if (!confirm('Are you sure you want to ' + label + '?')) return;
            fetch('/supervisor/project/' + projectId + '/decide', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ decision: decision, notes: 'Supervisor action from dashboard' })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'ok') renderSupervisorPanel();
                else alert('Action failed: ' + (data.detail || 'Unknown error'));
            })
            .catch(function(err) { alert('Error: ' + err.message); });
        };
    })();
    </script>

    <!-- Figma Integration Panel -->
    <script>
    (function() {
        var figmaFilesCache = [];

        function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        window.renderFigmaPanel = function() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Checking Figma connection...</div>';

            fetch('/figma/status')
                .then(function(r) { return r.json(); })
                .then(function(status) {
                    var html = '';
                    html += '<div style="padding:10px;">';

                    if (status.connected) {
                        html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(162,89,255,0.1);border:1px solid rgba(162,89,255,0.3);border-radius:8px;margin-bottom:10px;">';
                        if (status.user && status.user.img_url) {
                            html += '<img src="' + escHtml(status.user.img_url) + '" style="width:28px;height:28px;border-radius:50%;" />';
                        }
                        html += '<div style="flex:1;">';
                        html += '<div style="font-size:11px;font-weight:600;color:#a259ff;">Connected to Figma</div>';
                        if (status.user) {
                            html += '<div style="font-size:10px;color:var(--text-muted);">' + escHtml(status.user.handle || status.user.email || '') + '</div>';
                        }
                        html += '</div>';
                        html += '<div style="width:8px;height:8px;background:#4caf50;border-radius:50%;"></div>';
                        html += '</div>';
                    } else {
                        html += '<div style="padding:10px;background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);border-radius:8px;margin-bottom:10px;">';
                        html += '<div style="font-size:11px;font-weight:600;color:#ff4444;">Not Connected</div>';
                        html += '<div style="font-size:10px;color:var(--text-muted);">' + escHtml(status.reason || 'Check API key') + '</div>';
                        html += '</div>';
                    }

                    html += '<div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin:12px 0 6px 0;text-transform:uppercase;letter-spacing:0.5px;">Load a Design File</div>';
                    html += '<div style="display:flex;gap:6px;margin-bottom:12px;">';
                    html += '<input type="text" id="figmaUrlInput" placeholder="Paste Figma file URL or key..." style="flex:1;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text-primary);font-size:11px;outline:none;" />';
                    html += '<button onclick="loadFigmaFile()" style="background:#a259ff;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer;">Load</button>';
                    html += '</div>';

                    if (figmaFilesCache.length > 0) {
                        figmaFilesCache.forEach(function(file, idx) {
                            html += renderFigmaFileCard(file, idx);
                        });
                    } else {
                        html += '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">';
                        html += '<div style="font-size:24px;margin-bottom:8px;opacity:0.5;">F</div>';
                        html += 'Paste a Figma file URL above to load your designs.<br>';
                        html += '<span style="font-size:10px;opacity:0.7;">Example: https://www.figma.com/design/ABC123/MyFile</span>';
                        html += '</div>';
                    }

                    html += '</div>';
                    body.innerHTML = html;
                })
                .catch(function(err) {
                    body.innerHTML = '<div class="ep-loading">Error connecting: ' + escHtml(err.message) + '</div>';
                });
        };

        function renderFigmaFileCard(file, idx) {
            var html = '';
            html += '<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;">';

            if (file.thumbnailUrl) {
                html += '<div style="width:100%;height:120px;overflow:hidden;border-bottom:1px solid var(--border);background:var(--surface-1);position:relative;">';
                html += '<img src="' + escHtml(file.thumbnailUrl) + '" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display=\'none\'" />';
                html += '</div>';
            }

            html += '<div style="padding:10px;">';
            html += '<div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:4px;">' + escHtml(file.name) + '</div>';
            html += '<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">Key: ' + escHtml(file.file_key) + '</div>';

            if (file.lastModified) {
                var d = new Date(file.lastModified);
                html += '<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">Last modified: ' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString() + '</div>';
            }

            if (file.pages && file.pages.length > 0) {
                html += '<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin:8px 0 4px 0;text-transform:uppercase;letter-spacing:0.5px;">Pages (' + file.pages.length + ')</div>';
                file.pages.forEach(function(page) {
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;background:var(--surface-1);border-radius:4px;margin-bottom:3px;cursor:pointer;" onclick="renderPageFrames(\'' + escHtml(file.file_key) + '\', \'' + escHtml(page.id) + '\', this)">';
                    html += '<span style="font-size:10px;color:var(--text-primary);">' + escHtml(page.name) + '</span>';
                    html += '<span style="font-size:9px;color:var(--text-muted);">' + (page.children_count || 0) + ' frames â–¸</span>';
                    html += '</div>';
                });
            }

            if (file.components && file.components.length > 0) {
                html += '<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin:8px 0 4px 0;text-transform:uppercase;letter-spacing:0.5px;">Components (' + file.components.length + ')</div>';
                var showComps = file.components.slice(0, 10);
                showComps.forEach(function(comp) {
                    html += '<div style="padding:3px 8px;background:var(--surface-1);border-radius:4px;margin-bottom:2px;font-size:10px;color:var(--text-primary);">';
                    html += escHtml(comp.name);
                    if (comp.description) html += ' <span style="color:var(--text-muted);">â€” ' + escHtml(comp.description) + '</span>';
                    html += '</div>';
                });
                if (file.components.length > 10) {
                    html += '<div style="font-size:9px;color:var(--text-muted);padding:2px 8px;">+ ' + (file.components.length - 10) + ' more</div>';
                }
            }

            if (file.styles && file.styles.length > 0) {
                html += '<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin:8px 0 4px 0;text-transform:uppercase;letter-spacing:0.5px;">Styles (' + file.styles.length + ')</div>';
                var styleGroups = {};
                file.styles.forEach(function(s) {
                    var t = s.type || 'OTHER';
                    if (!styleGroups[t]) styleGroups[t] = [];
                    styleGroups[t].push(s);
                });
                Object.keys(styleGroups).forEach(function(type) {
                    var typeLabel = {FILL:'Colors', TEXT:'Typography', EFFECT:'Effects', GRID:'Grids'}[type] || type;
                    html += '<div style="font-size:9px;color:#a259ff;padding:2px 8px;font-weight:600;">' + typeLabel + ' (' + styleGroups[type].length + ')</div>';
                    styleGroups[type].slice(0, 5).forEach(function(s) {
                        html += '<div style="padding:2px 8px 2px 16px;font-size:10px;color:var(--text-primary);">' + escHtml(s.name) + '</div>';
                    });
                    if (styleGroups[type].length > 5) {
                        html += '<div style="font-size:9px;color:var(--text-muted);padding:2px 16px;">+ ' + (styleGroups[type].length - 5) + ' more</div>';
                    }
                });
            }

            html += '<div style="display:flex;gap:6px;margin-top:8px;">';
            html += '<button onclick="renderFileImages(\'' + escHtml(file.file_key) + '\', ' + idx + ')" style="flex:1;background:var(--surface-3);color:var(--text-secondary);border:1px solid var(--border);border-radius:4px;padding:5px;font-size:10px;cursor:pointer;">Render Pages</button>';
            html += '<button onclick="removeFigmaFile(' + idx + ')" style="background:var(--surface-3);color:var(--text-muted);border:1px solid var(--border);border-radius:4px;padding:5px 10px;font-size:10px;cursor:pointer;">Remove</button>';
            html += '</div>';

            html += '</div>';
            html += '</div>';
            return html;
        }

        window.loadFigmaFile = function() {
            var input = document.getElementById('figmaUrlInput');
            if (!input) return;
            var val = input.value.trim();
            if (!val) return;

            input.disabled = true;
            var isUrl = val.includes('figma.com');
            var payload = isUrl ? { url: val } : { file_key: val };

            fetch('/figma/file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) {
                if (!r.ok) return r.json().then(function(e) { throw new Error(e.detail || 'Failed'); });
                return r.json();
            })
            .then(function(data) {
                figmaFilesCache.push(data);
                input.value = '';
                input.disabled = false;
                renderFigmaPanel();
            })
            .catch(function(err) {
                input.disabled = false;
                alert('Could not load file: ' + err.message);
            });
        };

        window.removeFigmaFile = function(idx) {
            figmaFilesCache.splice(idx, 1);
            renderFigmaPanel();
        };

        window.renderFileImages = function(fileKey, cacheIdx) {
            var file = figmaFilesCache[cacheIdx];
            if (!file || !file.pages) return;

            var nodeIds = file.pages.map(function(p) { return p.id; });
            fetch('/figma/images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_key: fileKey, node_ids: nodeIds, format: 'png', scale: 2 })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.images) {
                    file._renderedImages = data.images;
                    renderFigmaPanel();
                }
            })
            .catch(function(err) { alert('Render failed: ' + err.message); });
        };

        window.renderPageFrames = function(fileKey, pageId, el) {
            var existing = el.nextElementSibling;
            if (existing && existing.classList && existing.classList.contains('figma-page-frames')) {
                existing.remove();
                return;
            }

            var framesDiv = document.createElement('div');
            framesDiv.className = 'figma-page-frames';
            framesDiv.style.cssText = 'padding:4px 0 4px 12px;';
            framesDiv.innerHTML = '<div style="font-size:9px;color:var(--text-muted);padding:4px;">Loading frames...</div>';
            el.parentNode.insertBefore(framesDiv, el.nextSibling);

            fetch('/figma/images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_key: fileKey, node_ids: [pageId], format: 'png', scale: 1 })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.images && data.images[pageId]) {
                    framesDiv.innerHTML = '<img src="' + data.images[pageId] + '" style="width:100%;border-radius:4px;border:1px solid var(--border);" />';
                } else {
                    framesDiv.innerHTML = '<div style="font-size:9px;color:var(--text-muted);padding:4px;">No preview available</div>';
                }
            })
            .catch(function() {
                framesDiv.innerHTML = '<div style="font-size:9px;color:#ff4444;padding:4px;">Failed to render</div>';
            });
        };

        var realityHistory = [];

        var REALITY_SAMPLE = {
            "project_id": "bio01",
            "name": "Bio-Inspired Flagella Swimmer (Macro Demonstrator)",
            "domain": "robotics",
            "scale_m": 0.15,
            "target_power_w": 2.0,
            "duty_cycle": 0.2,
            "environment": "water",
            "materials": ["pla", "silicone", "magnets"],
            "fabrication": ["3d_print", "basic_electronics"],
            "assumptions": {
                "tail_frequency_hz": 2.5,
                "tail_amplitude_m": 0.03,
                "tail_length_m": 0.2,
                "actuation_power_w": 1.0
            }
        };

        window.renderRealityPanel = function() {
            var body = document.getElementById('edgePanelBody');
            var html = '<div style="padding:12px;">';
            html += '<div style="font-size:12px;font-weight:700;color:#f97316;margin-bottom:4px;">HERMES REALITY ENGINE</div>';
            html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:12px;">Deterministic physics validation â€” no LLM, pure math gates.<br>Paste a project spec as JSON, then hit Validate.</div>';

            html += '<textarea id="realityJsonInput" style="width:100%;height:160px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:9px;resize:vertical;box-sizing:border-box;" spellcheck="false">' + JSON.stringify(REALITY_SAMPLE, null, 2) + '</textarea>';

            html += '<div style="display:flex;gap:6px;margin-top:8px;">';
            html += '<button onclick="realityRunValidation()" style="flex:1;font-size:9px;padding:6px 0;background:rgba(249,115,22,0.15);color:#f97316;border:1px solid rgba(249,115,22,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Validate + Simulate</button>';
            html += '<button onclick="realityLoadSample()" style="font-size:8px;padding:6px 10px;background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid var(--border);border-radius:4px;cursor:pointer;">Load Sample</button>';
            html += '</div>';

            html += '<div id="realityResultPanel" style="margin-top:12px;"></div>';

            if (realityHistory.length > 0) {
                html += '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:10px;">';
                html += '<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">VALIDATION HISTORY (' + realityHistory.length + ')</div>';
                for (var i = realityHistory.length - 1; i >= 0; i--) {
                    var r = realityHistory[i];
                    var tierColors = { T1_BUILDABLE_NOW:'#4ade80', T2_RESEARCH_GRADE:'#818cf8', T3_FRONTIER:'#f97316', T4_SPECULATIVE:'#ef4444' };
                    var col = tierColors[r.tier] || '#888';
                    html += '<div style="padding:6px 8px;margin-bottom:4px;border-radius:4px;background:var(--surface-2);border:1px solid var(--border);cursor:pointer;" onclick="realityLoadFromHistory(' + i + ')">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                    html += '<span style="font-size:9px;font-weight:600;color:var(--text-primary);">' + escapeHtmlEP(r.name) + '</span>';
                    html += '<span style="font-size:7px;padding:1px 5px;border-radius:2px;background:' + col + '15;color:' + col + ';border:1px solid ' + col + '33;">' + r.tier.replace('_',' ') + '</span>';
                    html += '</div>';
                    html += '<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">' + r.project_id + ' | ' + r.confidence + ' | Blueprint: ' + (r.blueprint_allowed ? 'YES' : 'NO') + '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div>';
            body.innerHTML = html;
        };

        window.realityLoadSample = function() {
            var el = document.getElementById('realityJsonInput');
            if (el) el.value = JSON.stringify(REALITY_SAMPLE, null, 2);
        };

        window.realityLoadFromHistory = function(idx) {
            if (idx >= 0 && idx < realityHistory.length) {
                var el = document.getElementById('realityJsonInput');
                if (el) el.value = JSON.stringify(realityHistory[idx]._input, null, 2);
            }
        };

        window.realityRunValidation = function() {
            var el = document.getElementById('realityJsonInput');
            var resultPanel = document.getElementById('realityResultPanel');
            if (!el || !resultPanel) return;

            var payload;
            try {
                payload = JSON.parse(el.value);
            } catch(e) {
                resultPanel.innerHTML = '<div style="font-size:9px;color:#ef4444;padding:8px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:4px;">Invalid JSON: ' + escapeHtmlEP(e.message) + '</div>';
                return;
            }

            resultPanel.innerHTML = '<div style="font-size:9px;color:#f97316;padding:12px;text-align:center;">Running physics gates + simulation...</div>';

            fetch('/api/reality/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) {
                if (!r.ok) return r.json().then(function(err) { throw new Error(err.detail || 'Validation failed'); });
                return r.json();
            })
            .then(function(report) {
                report._input = payload;
                realityHistory.push(report);

                var tierColors = { T1_BUILDABLE_NOW:'#4ade80', T2_RESEARCH_GRADE:'#818cf8', T3_FRONTIER:'#f97316', T4_SPECULATIVE:'#ef4444' };
                var tierLabels = { T1_BUILDABLE_NOW:'BUILDABLE NOW', T2_RESEARCH_GRADE:'RESEARCH GRADE', T3_FRONTIER:'FRONTIER', T4_SPECULATIVE:'SPECULATIVE' };
                var col = tierColors[report.tier] || '#888';

                var h = '<div style="padding:10px;border-radius:6px;background:' + col + '08;border:1px solid ' + col + '22;">';
                h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                h += '<span style="font-size:11px;font-weight:700;color:' + col + ';">' + (tierLabels[report.tier] || report.tier) + '</span>';
                h += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,0.06);color:var(--text-muted);">' + report.confidence + '</span>';
                h += '</div>';

                h += '<div style="font-size:9px;color:var(--text-secondary);margin-bottom:8px;">Blueprint allowed: <strong style="color:' + (report.blueprint_allowed ? '#4ade80' : '#ef4444') + ';">' + (report.blueprint_allowed ? 'YES' : 'NO') + '</strong></div>';

                if (report.failures && report.failures.length > 0) {
                    h += '<div style="font-size:8px;color:#ef4444;font-weight:600;margin-bottom:4px;">PHYSICS FAILURES:</div>';
                    report.failures.forEach(function(f) { h += '<div style="font-size:8px;color:#ef4444;padding:2px 0 2px 10px;">- ' + escapeHtmlEP(f) + '</div>'; });
                }
                if (report.warnings && report.warnings.length > 0) {
                    h += '<div style="font-size:8px;color:#fbbf24;font-weight:600;margin-top:6px;margin-bottom:4px;">WARNINGS:</div>';
                    report.warnings.forEach(function(w) { h += '<div style="font-size:8px;color:#fbbf24;padding:2px 0 2px 10px;">- ' + escapeHtmlEP(w) + '</div>'; });
                }

                if (report.simulation) {
                    h += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid ' + col + '22;">';
                    h += '<div style="font-size:9px;font-weight:600;color:#818cf8;margin-bottom:4px;">SIMULATION: ' + (report.simulation.model || 'unknown') + '</div>';
                    Object.keys(report.simulation).forEach(function(key) {
                        if (key === 'model') return;
                        var val = report.simulation[key];
                        if (typeof val === 'number') val = val.toFixed(6);
                        h += '<div style="font-size:8px;color:var(--text-secondary);display:flex;justify-content:space-between;padding:1px 0;">';
                        h += '<span>' + key.replace(/_/g, ' ') + '</span><span style="color:var(--text-primary);font-family:monospace;">' + val + '</span>';
                        h += '</div>';
                    });
                    h += '</div>';
                }

                if (report.inputs) {
                    h += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);">';
                    h += '<div style="font-size:8px;font-weight:600;color:var(--text-muted);margin-bottom:4px;">INPUTS USED:</div>';
                    Object.keys(report.inputs).forEach(function(key) {
                        var val = report.inputs[key];
                        if (Array.isArray(val)) val = val.join(', ');
                        h += '<div style="font-size:8px;color:var(--text-secondary);display:flex;justify-content:space-between;padding:1px 0;">';
                        h += '<span>' + key + '</span><span style="color:var(--text-primary);font-family:monospace;">' + val + '</span>';
                        h += '</div>';
                    });
                    h += '</div>';
                }

                h += '</div>';
                resultPanel.innerHTML = h;
                showNotification('Reality: ' + (tierLabels[report.tier] || report.tier) + ' (' + report.confidence + ')', report.blueprint_allowed ? 'success' : 'info');

                renderRealityPanel();
                document.getElementById('realityResultPanel').innerHTML = h;
            })
            .catch(function(err) {
                resultPanel.innerHTML = '<div style="font-size:9px;color:#ef4444;padding:8px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:4px;">' + escapeHtmlEP(err.message) + '</div>';
            });
        };

        var pipelineState = { step: 'start', project: null, projectType: null, constraints: null, pluginDefaults: null, dreamIdeas: [], iterations: [], validation: null, partsList: null, acceptanceTests: null, plugins: [] };

        function pipelineScoreBar(label, val, color) {
            return '<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">' +
                '<span style="font-size:7px;color:var(--text-muted);width:65px;text-align:right;">' + label + '</span>' +
                '<div style="flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;">' +
                '<div style="width:' + Math.min(100, Math.max(0, val)) + '%;height:100%;background:' + color + ';border-radius:2px;"></div></div>' +
                '<span style="font-size:7px;color:' + color + ';width:28px;font-family:monospace;">' + val + '</span></div>';
        }

        window.renderPipelinePanel = function() {
            var body = document.getElementById('edgePanelBody');
            var html = '<div style="padding:12px;">';
            html += '<div style="font-size:12px;font-weight:700;color:#a78bfa;margin-bottom:4px;">DESIGN ENGINE</div>';
            html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:12px;">Plugin-driven engineering pipeline: Dream \u2192 Constraints \u2192 Iterate \u2192 Validate</div>';

            var steps = ['start', 'dream', 'constraints', 'iterate', 'validate'];
            var stepLabels = ['Start', 'Dream', 'Constraints', 'Iterate', 'Validate'];
            var stepIdx = steps.indexOf(pipelineState.step);
            html += '<div style="display:flex;gap:4px;margin-bottom:14px;align-items:center;">';
            for (var si = 0; si < steps.length; si++) {
                var active = si <= stepIdx;
                var current = si === stepIdx;
                var sColor = active ? '#a78bfa' : 'var(--text-muted)';
                var sBg = current ? 'rgba(167,139,250,0.15)' : 'transparent';
                html += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:' + sBg + ';color:' + sColor + ';font-weight:' + (current ? '700' : '400') + ';border:1px solid ' + (current ? 'rgba(167,139,250,0.3)' : 'transparent') + ';">' + stepLabels[si] + '</span>';
                if (si < steps.length - 1) html += '<span style="color:var(--text-muted);font-size:8px;">\u203A</span>';
            }
            html += '</div>';

            if (pipelineState.step === 'start') {
                html += '<div style="margin-bottom:10px;">';
                html += '<label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:4px;">Project Type</label>';
                html += '<select id="pipelineType" onchange="pipelineTypeChanged()" style="width:100%;padding:6px 8px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;font-size:10px;box-sizing:border-box;">';
                html += '<option value="">Generic (no plugin)</option>';
                pipelineState.plugins.forEach(function(p) {
                    var sel = pipelineState.projectType === p.key ? ' selected' : '';
                    html += '<option value="' + p.key + '"' + sel + '>' + escapeHtmlEP(p.display_name) + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div style="margin-bottom:10px;">';
                html += '<label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:4px;">Project Name</label>';
                html += '<input type="text" id="pipelineName" placeholder="e.g. Bio-Powered Micro Drone" style="width:100%;padding:6px 8px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;font-size:10px;box-sizing:border-box;">';
                html += '</div>';
                html += '<div style="margin-bottom:10px;">';
                html += '<label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:4px;">Description</label>';
                html += '<textarea id="pipelineDesc" rows="3" placeholder="Describe your project concept..." style="width:100%;padding:6px 8px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;font-size:10px;resize:vertical;box-sizing:border-box;"></textarea>';
                html += '</div>';
                html += '<button onclick="pipelineDream()" style="width:100%;font-size:9px;padding:7px 0;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Enter Dream Mode</button>';
            }

            if (pipelineState.step === 'dream' && pipelineState.dreamIdeas.length > 0) {
                html += '<div style="font-size:9px;font-weight:600;color:#fbbf24;margin-bottom:6px;">DREAM MODE \u2014 ' + escapeHtmlEP(pipelineState.project.name) + '</div>';
                if (pipelineState.projectType) {
                    var pLabel = '';
                    pipelineState.plugins.forEach(function(p) { if (p.key === pipelineState.projectType) pLabel = p.display_name; });
                    html += '<div style="font-size:8px;padding:2px 6px;margin-bottom:6px;display:inline-block;border-radius:3px;background:rgba(167,139,250,0.1);color:#a78bfa;border:1px solid rgba(167,139,250,0.2);">' + escapeHtmlEP(pLabel) + '</div>';
                }
                html += '<div style="font-size:8px;color:var(--text-muted);margin-bottom:8px;padding:4px 6px;background:rgba(251,191,36,0.06);border-left:2px solid #fbbf24;border-radius:2px;">Unvalidated concepts. Tap one to select, then extract constraints.</div>';
                pipelineState.dreamIdeas.forEach(function(idea, idx) {
                    html += '<div style="padding:8px;margin-bottom:4px;border-radius:4px;background:var(--surface-2);border:1px solid var(--border);cursor:pointer;" onclick="pipelineSelectIdea(' + idx + ')">';
                    html += '<div style="font-size:9px;font-weight:600;color:var(--text-primary);">' + escapeHtmlEP(idea.concept) + '</div>';
                    html += '<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">' + escapeHtmlEP(idea.description) + '</div>';
                    html += '</div>';
                });
                html += '<button onclick="pipelineExtractConstraints()" style="width:100%;margin-top:8px;font-size:9px;padding:7px 0;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Extract Constraints</button>';
            }

            if (pipelineState.step === 'constraints' && pipelineState.constraints) {
                var c = pipelineState.constraints;
                html += '<div style="font-size:9px;font-weight:600;color:#818cf8;margin-bottom:8px;">CONSTRAINT EXTRACTION</div>';

                if (c.plugin) {
                    html += '<div style="font-size:8px;padding:2px 6px;margin-bottom:8px;display:inline-block;border-radius:3px;background:rgba(167,139,250,0.1);color:#a78bfa;border:1px solid rgba(167,139,250,0.2);">Plugin: ' + escapeHtmlEP(c.plugin) + '</div>';
                }

                ['ajani', 'minerva', 'hermes'].forEach(function(persona) {
                    var agent = c.agents[persona];
                    if (!agent) return;
                    var pColors = { ajani:'#ef4444', minerva:'#00d4aa', hermes:'#f97316' };
                    html += '<div style="margin-top:8px;padding:8px;border-radius:4px;background:rgba(255,255,255,0.02);border-left:2px solid ' + pColors[persona] + ';">';
                    html += '<div style="font-size:9px;font-weight:600;color:' + pColors[persona] + ';text-transform:uppercase;margin-bottom:3px;">' + persona + '</div>';
                    html += '<div style="font-size:8px;color:var(--text-secondary);">' + escapeHtmlEP(agent.suggestion) + '</div>';
                    html += '</div>';
                });

                html += '<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);">';

                if (c.default_constraints && pipelineState.projectType) {
                    html += '<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">PLUGIN CONSTRAINTS:</div>';
                    var dc = c.default_constraints;
                    Object.keys(dc).forEach(function(key) {
                        var val = dc[key];
                        var valStr = Array.isArray(val) ? val.join(', ') : String(val);
                        html += '<div style="margin-bottom:6px;">';
                        html += '<label style="font-size:8px;color:var(--text-muted);display:block;margin-bottom:2px;">' + key.replace(/_/g, ' ') + '</label>';
                        html += '<input type="text" id="pipeC_' + key + '" value="' + escapeHtmlEP(valStr) + '" style="width:100%;padding:5px 6px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:3px;font-size:9px;box-sizing:border-box;">';
                        html += '</div>';
                    });
                } else {
                    html += '<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">FILL CONSTRAINTS:</div>';
                    var fields = [
                        { id: 'pipeScale', label: 'Scale', ph: '0.15m macro demonstrator' },
                        { id: 'pipeEnergy', label: 'Energy/Power', ph: '2W LiPo battery' },
                        { id: 'pipeMaterials', label: 'Materials (comma-separated)', ph: 'PLA, silicone, magnets' },
                        { id: 'pipeFabrication', label: 'Fabrication (comma-separated)', ph: '3D print, basic electronics' },
                        { id: 'pipePhysics', label: 'Governing Physics', ph: 'Fluid dynamics' }
                    ];
                    fields.forEach(function(f) {
                        html += '<label style="font-size:8px;color:var(--text-muted);display:block;margin-bottom:2px;margin-top:6px;">' + f.label + '</label>';
                        html += '<input type="text" id="' + f.id + '" placeholder="' + f.ph + '" style="width:100%;padding:5px 6px;background:var(--surface-1);color:var(--text-primary);border:1px solid var(--border);border-radius:3px;font-size:9px;box-sizing:border-box;">';
                    });
                }
                html += '<button onclick="pipelineIterate()" style="width:100%;margin-top:10px;font-size:9px;padding:7px 0;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Generate Variants</button>';
                html += '</div>';
            }

            if (pipelineState.step === 'iterate' && pipelineState.iterations.length > 0) {
                html += '<div style="font-size:9px;font-weight:600;color:#4ade80;margin-bottom:8px;">DESIGN VARIANTS (' + pipelineState.iterations.length + ')</div>';
                pipelineState.iterations.forEach(function(v) {
                    var perf = v.performance || 0;
                    var perfColor = perf >= 80 ? '#4ade80' : perf >= 60 ? '#fbbf24' : '#ef4444';
                    html += '<div style="padding:10px;margin-bottom:6px;border-radius:5px;background:var(--surface-2);border:1px solid var(--border);">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
                    html += '<span style="font-size:9px;font-weight:600;color:var(--text-primary);">' + escapeHtmlEP(v.name) + '</span>';
                    html += '<span style="font-size:10px;font-weight:700;color:' + perfColor + ';">' + perf + '</span>';
                    html += '</div>';
                    if (v.architecture) {
                        html += '<div style="font-size:8px;color:#a78bfa;margin-bottom:6px;">' + escapeHtmlEP(v.architecture) + '</div>';
                    }
                    html += pipelineScoreBar('Performance', v.performance || 0, '#4ade80');
                    html += pipelineScoreBar('Safety', v.safety || 0, '#818cf8');
                    html += pipelineScoreBar('Buildability', v.manufacturability || 0, '#fbbf24');
                    html += pipelineScoreBar('Complexity', v.complexity || 0, '#f97316');
                    html += '<div style="display:flex;gap:12px;margin-top:6px;">';
                    if (v.cost !== undefined) html += '<span style="font-size:8px;color:var(--text-muted);">Cost: <strong style="color:var(--text-primary);">$' + v.cost + '</strong></span>';
                    if (v.weight !== undefined && v.weight > 0) html += '<span style="font-size:8px;color:var(--text-muted);">Weight: <strong style="color:var(--text-primary);">' + v.weight + 'kg</strong></span>';
                    html += '</div>';
                    if (v.derived) {
                        html += '<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:6px;">';
                        Object.keys(v.derived).forEach(function(k) {
                            html += '<span style="font-size:7px;padding:1px 4px;border-radius:2px;background:rgba(255,255,255,0.04);color:var(--text-muted);">' + k.replace(/_/g,' ') + ': ' + v.derived[k] + '</span>';
                        });
                        html += '</div>';
                    }
                    html += '<div style="font-size:7px;color:var(--text-muted);margin-top:4px;font-style:italic;">' + escapeHtmlEP(v.notes) + '</div>';
                    html += '</div>';
                });

                if (pipelineState.partsList && pipelineState.partsList.length > 0) {
                    html += '<div style="margin-top:10px;padding:8px;border-radius:4px;background:rgba(167,139,250,0.04);border:1px solid rgba(167,139,250,0.15);">';
                    html += '<div style="font-size:8px;font-weight:600;color:#a78bfa;margin-bottom:4px;">PARTS LIST</div>';
                    pipelineState.partsList.forEach(function(p) {
                        html += '<div style="font-size:8px;color:var(--text-secondary);padding:1px 0 1px 8px;">\u2022 ' + escapeHtmlEP(p) + '</div>';
                    });
                    html += '</div>';
                }

                if (pipelineState.acceptanceTests && pipelineState.acceptanceTests.length > 0) {
                    html += '<div style="margin-top:8px;padding:8px;border-radius:4px;background:rgba(74,222,128,0.04);border:1px solid rgba(74,222,128,0.15);">';
                    html += '<div style="font-size:8px;font-weight:600;color:#4ade80;margin-bottom:4px;">ACCEPTANCE TESTS</div>';
                    pipelineState.acceptanceTests.forEach(function(t) {
                        html += '<div style="font-size:8px;color:var(--text-secondary);padding:1px 0 1px 8px;">\u2713 ' + escapeHtmlEP(t) + '</div>';
                    });
                    html += '</div>';
                }

                html += '<button onclick="pipelineValidate()" style="width:100%;margin-top:10px;font-size:9px;padding:7px 0;background:rgba(74,222,128,0.15);color:#4ade80;border:1px solid rgba(74,222,128,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Run Validation Gate</button>';
            }

            if (pipelineState.step === 'validate' && pipelineState.validation) {
                var v = pipelineState.validation;
                var tierColors = { T1_PROTOTYPE_READY:'#4ade80', T2_SIMULATION_ONLY:'#818cf8', T4_CONCEPTUAL:'#ef4444' };
                var col = tierColors[v.tier] || '#888';
                html += '<div style="padding:10px;border-radius:6px;background:' + col + '08;border:1px solid ' + col + '22;margin-bottom:10px;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                html += '<span style="font-size:11px;font-weight:700;color:' + col + ';">' + v.tier_label + '</span>';
                html += '<span style="font-size:9px;color:var(--text-muted);">' + v.score + ' checks</span>';
                html += '</div>';
                html += '<div style="font-size:9px;color:var(--text-secondary);margin-bottom:6px;">Blueprint allowed: <strong style="color:' + (v.blueprint_allowed ? '#4ade80' : '#ef4444') + ';">' + (v.blueprint_allowed ? 'YES' : 'NO') + '</strong></div>';

                Object.keys(v.checks).forEach(function(key) {
                    var passed = v.checks[key];
                    html += '<div style="font-size:8px;padding:2px 0;display:flex;align-items:center;gap:6px;">';
                    html += '<span style="color:' + (passed ? '#4ade80' : '#ef4444') + ';">' + (passed ? '\u2713' : '\u2717') + '</span>';
                    html += '<span style="color:var(--text-secondary);">' + key.replace(/_/g, ' ') + '</span>';
                    html += '</div>';
                });
                html += '</div>';

                if (v.parts_list && v.parts_list.length > 0) {
                    html += '<div style="padding:8px;border-radius:4px;background:rgba(167,139,250,0.04);border:1px solid rgba(167,139,250,0.15);margin-bottom:8px;">';
                    html += '<div style="font-size:8px;font-weight:600;color:#a78bfa;margin-bottom:4px;">PARTS LIST</div>';
                    v.parts_list.forEach(function(p) { html += '<div style="font-size:8px;color:var(--text-secondary);padding:1px 0 1px 8px;">\u2022 ' + escapeHtmlEP(p) + '</div>'; });
                    html += '</div>';
                }

                if (v.acceptance_tests && v.acceptance_tests.length > 0) {
                    html += '<div style="padding:8px;border-radius:4px;background:rgba(74,222,128,0.04);border:1px solid rgba(74,222,128,0.15);margin-bottom:8px;">';
                    html += '<div style="font-size:8px;font-weight:600;color:#4ade80;margin-bottom:4px;">ACCEPTANCE TESTS</div>';
                    v.acceptance_tests.forEach(function(t) { html += '<div style="font-size:8px;color:var(--text-secondary);padding:1px 0 1px 8px;">\u2713 ' + escapeHtmlEP(t) + '</div>'; });
                    html += '</div>';
                }

                html += '<button onclick="pipelineReset()" style="width:100%;font-size:9px;padding:7px 0;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:4px;cursor:pointer;font-weight:600;">Start New Project</button>';
            }

            html += '</div>';
            body.innerHTML = html;
        };

        window.pipelineTypeChanged = function() {
            var sel = document.getElementById('pipelineType');
            pipelineState.projectType = sel ? sel.value || null : null;
        };

        window.pipelineDream = function() {
            var name = document.getElementById('pipelineName').value.trim();
            var desc = document.getElementById('pipelineDesc').value.trim();
            if (!name || !desc) { showNotification('Enter a project name and description', 'error'); return; }
            pipelineState.project = { name: name, description: desc, project_type: pipelineState.projectType };
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Entering dream mode\u2026</div>';

            fetch('/design-engine/project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pipelineState.project)
            }).catch(function() {});

            fetch('/design-engine/dream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pipelineState.project)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                pipelineState.dreamIdeas = data.ideas || [];
                pipelineState.step = 'dream';
                renderPipelinePanel();
                showNotification('Dream mode: ' + pipelineState.dreamIdeas.length + ' concepts generated', 'success');
            })
            .catch(function(err) {
                body.innerHTML = '<div class="ep-loading" style="color:#ef4444;">Dream mode failed: ' + err.message + '</div>';
            });
        };

        window.pipelineSelectIdea = function(idx) {
            if (idx >= 0 && idx < pipelineState.dreamIdeas.length) {
                var idea = pipelineState.dreamIdeas[idx];
                pipelineState.project.description = idea.description;
                showNotification('Selected: ' + idea.concept, 'info');
            }
        };

        window.pipelineExtractConstraints = function() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Extracting constraints with Tri-Core\u2026</div>';

            fetch('/design-engine/constraints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pipelineState.project)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                pipelineState.constraints = data;
                pipelineState.pluginDefaults = data.default_constraints || null;
                pipelineState.step = 'constraints';
                renderPipelinePanel();
            })
            .catch(function(err) {
                body.innerHTML = '<div class="ep-loading" style="color:#ef4444;">Constraint extraction failed: ' + err.message + '</div>';
            });
        };

        window.pipelineIterate = function() {
            var payload = { project_type: pipelineState.projectType, population: 3 };

            if (pipelineState.projectType && pipelineState.pluginDefaults) {
                var cDict = {};
                Object.keys(pipelineState.pluginDefaults).forEach(function(key) {
                    var el = document.getElementById('pipeC_' + key);
                    if (el) {
                        var raw = el.value.trim();
                        var defVal = pipelineState.pluginDefaults[key];
                        if (typeof defVal === 'number') {
                            cDict[key] = parseFloat(raw) || defVal;
                        } else if (Array.isArray(defVal)) {
                            cDict[key] = raw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
                            if (cDict[key].length > 0 && !isNaN(Number(cDict[key][0]))) {
                                cDict[key] = cDict[key].map(Number);
                            }
                        } else {
                            cDict[key] = raw || defVal;
                        }
                    }
                });
                payload.constraints = cDict;
                pipelineState.filledConstraints = payload;
            } else {
                var scale = document.getElementById('pipeScale');
                var energy = document.getElementById('pipeEnergy');
                var matsEl = document.getElementById('pipeMaterials');
                var fabEl = document.getElementById('pipeFabrication');
                var physEl = document.getElementById('pipePhysics');
                payload.scale = scale ? scale.value.trim() || null : null;
                payload.energy = energy ? energy.value.trim() || null : null;
                payload.materials = matsEl && matsEl.value.trim() ? matsEl.value.trim().split(',').map(function(s){ return s.trim(); }).filter(Boolean) : null;
                payload.fabrication = fabEl && fabEl.value.trim() ? fabEl.value.trim().split(',').map(function(s){ return s.trim(); }).filter(Boolean) : null;
                payload.physics = physEl ? physEl.value.trim() || null : null;
                payload.name = pipelineState.project ? pipelineState.project.name : 'unnamed';
                pipelineState.filledConstraints = payload;
            }

            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Generating design variants\u2026</div>';

            fetch('/design-engine/iterate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                pipelineState.iterations = data.variants || [];
                pipelineState.partsList = data.parts_list || null;
                pipelineState.acceptanceTests = data.acceptance_tests || null;
                pipelineState.step = 'iterate';
                renderPipelinePanel();
                showNotification(pipelineState.iterations.length + ' design variants generated', 'success');
            })
            .catch(function(err) {
                body.innerHTML = '<div class="ep-loading" style="color:#ef4444;">Iteration failed: ' + err.message + '</div>';
            });
        };

        window.pipelineValidate = function() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Running validation gate\u2026</div>';

            fetch('/design-engine/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pipelineState.filledConstraints || {})
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                pipelineState.validation = data;
                pipelineState.step = 'validate';
                renderPipelinePanel();
                showNotification('Validation: ' + data.tier_label + ' (' + data.score + ')', data.blueprint_allowed ? 'success' : 'info');
            })
            .catch(function(err) {
                body.innerHTML = '<div class="ep-loading" style="color:#ef4444;">Validation failed: ' + err.message + '</div>';
            });
        };

        window.pipelineReset = function() {
            pipelineState = { step: 'start', project: null, projectType: null, constraints: null, pluginDefaults: null, dreamIdeas: [], iterations: [], validation: null, partsList: null, acceptanceTests: null, plugins: pipelineState.plugins };
            renderPipelinePanel();
        };

        (function loadPipelinePlugins() {
            fetch('/design-engine/plugins')
                .then(function(r) { return r.json(); })
                .then(function(data) { pipelineState.plugins = data.plugins || []; })
                .catch(function() {});
        })();

        var validationState = { schema: null, lastReport: null, lastCard: null };

        window.renderValidationPanel = function() {
            var body = document.getElementById('edgePanelBody');
            var report = validationState.lastReport;

            var labDomains = [
                {id:'botany_pod', label:'Botany Pod'},
                {id:'bio_archive_flower', label:'Bio Archive Flower'},
                {id:'eco_robotics', label:'Eco Robotics'},
                {id:'medusa_transparent_mech', label:'Medusa Transparent Mech'},
                {id:'transparent_liquid_armor', label:'Transparent Liquid Armor'},
                {id:'crypto_security', label:'Crypto Security'},
                {id:'bio_sim_human_performance', label:'Bio Sim Human Perf'},
                {id:'biocompatible_microdevice_sim', label:'Biocompatible Microdevice Sim'}
            ];

            var html = '<div style="padding:12px;">';
            html += '<h4 style="margin:0 0 12px 0;color:#22d3ee;">Engineering Validator</h4>';

            html += '<div style="background:linear-gradient(135deg, rgba(34,211,238,0.08), rgba(34,211,238,0.02));border:1px solid rgba(34,211,238,0.2);border-radius:8px;padding:12px;margin-bottom:16px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Quick Start: Lab Domain</div>';
            html += '<p style="font-size:11px;color:var(--text-secondary);margin:0 0 8px 0;">Pick a lab domain to auto-generate a minimum build card with suggested materials, power, fabrication, and tests.</p>';
            html += '<select id="valLabDomain" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:0 0 8px 0;font-size:13px;">';
            html += '<option value="">-- pick a lab --</option>';
            labDomains.forEach(function(d) {
                html += '<option value="' + d.id + '">' + d.label + '</option>';
            });
            html += '</select>';
            html += '<input id="valQuickTitle" type="text" placeholder="Project title (e.g. My Botany Pod v1)" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:0 0 8px 0;font-size:13px;box-sizing:border-box;" />';
            html += '<button onclick="runSuggestAndValidate()" style="width:100%;padding:10px;background:#22d3ee;color:#000;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">Suggest + Validate</button>';
            html += '</div>';

            html += '<div style="background:linear-gradient(135deg, rgba(168,85,247,0.08), rgba(168,85,247,0.02));border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:12px;margin-bottom:16px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#a855f7;margin-bottom:8px;">Text Intake: Describe Your Project</div>';
            html += '<p style="font-size:11px;color:var(--text-secondary);margin:0 0 8px 0;">Describe your project idea in plain text. The system auto-detects the domain, extracts constraints, and generates a validated build card.</p>';
            html += '<textarea id="valFreeText" rows="5" placeholder="e.g. Medusa project: transparent plastic doc ock arms like spider-verse. Not metal. The liquid armor is transparent too. Green bots help the environment. Start small to medium." style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:8px;margin:0 0 8px 0;font-size:13px;box-sizing:border-box;resize:vertical;font-family:inherit;"></textarea>';
            html += '<div style="display:flex;gap:6px;">';
            html += '<button onclick="runTextIntake()" style="flex:1;padding:10px;background:#a855f7;color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">Single Project</button>';
            html += '<button onclick="runBatchIntake()" style="flex:1;padding:10px;background:rgba(168,85,247,0.3);color:#a855f7;border:1px solid rgba(168,85,247,0.4);border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">Batch (Multi-Project)</button>';
            html += '</div>';
            html += '<div style="font-size:9px;color:var(--text-muted);margin-top:4px;">Batch mode: separate projects with blank lines. Each gets its own domain, card, and validation.</div>';
            html += '</div>';

            html += '<details style="margin-bottom:16px;">';
            html += '<summary style="cursor:pointer;font-size:12px;color:var(--text-secondary);padding:4px 0;">Manual Spec Entry</summary>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin:8px 0 12px 0;">';
            html += '<label style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Project Title *</label>';
            html += '<input id="valTitle" type="text" placeholder="e.g. HYDRA-CORE membrane load cycling" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;box-sizing:border-box;" />';

            html += '<label style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Domain</label>';
            html += '<select id="valDomain" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;">';
            html += '<option value="">-- select --</option>';
            ['materials','robotics','bio','energy','crypto'].forEach(function(d) {
                html += '<option value="' + d + '">' + d.charAt(0).toUpperCase() + d.slice(1) + '</option>';
            });
            html += '</select>';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Scale</div>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Size Class</label>';
            html += '<select id="valSizeClass" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;">';
            html += '<option value="">-- select --</option>';
            ['micro','handheld','desktop','room','building'].forEach(function(s) {
                html += '<option value="' + s + '">' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>';
            });
            html += '</select>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Mass (kg)</label>';
            html += '<input id="valMass" type="number" step="0.01" placeholder="optional" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 0 0;font-size:13px;box-sizing:border-box;" />';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Energy</div>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Power Needed?</label>';
            html += '<select id="valPowerNeeded" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;">';
            html += '<option value="">-- select --</option><option value="true">Yes</option><option value="false">No</option>';
            html += '</select>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Source</label>';
            html += '<select id="valEnergySource" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;">';
            html += '<option value="">-- select --</option>';
            ['none','battery','wall','solar','other'].forEach(function(s) {
                html += '<option value="' + s + '">' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>';
            });
            html += '</select>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Watts</label>';
            html += '<input id="valWatts" type="number" step="0.1" placeholder="e.g. 30" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 0 0;font-size:13px;box-sizing:border-box;" />';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Material</div>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Material Family</label>';
            html += '<select id="valMatFamily" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;">';
            html += '<option value="">-- select --</option>';
            ['polymer','metal','composite','bio','ceramic'].forEach(function(m) {
                html += '<option value="' + m + '">' + m.charAt(0).toUpperCase() + m.slice(1) + '</option>';
            });
            html += '</select>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Candidates (comma-separated)</label>';
            html += '<input id="valMatCandidates" type="text" placeholder="e.g. aluminum_6061, carbon_fiber" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 0 0;font-size:13px;box-sizing:border-box;" />';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Fabrication</div>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Methods (comma-separated)</label>';
            html += '<input id="valFabMethods" type="text" placeholder="e.g. 3d_print, cnc" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;box-sizing:border-box;" />';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Tolerance</label>';
            html += '<select id="valTolerance" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 0 0;font-size:13px;">';
            html += '<option value="">-- select --</option>';
            ['loose','normal','tight'].forEach(function(t) {
                html += '<option value="' + t + '">' + t.charAt(0).toUpperCase() + t.slice(1) + '</option>';
            });
            html += '</select>';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:8px;">Physics</div>';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Mechanism (what makes it work)</label>';
            html += '<input id="valMechanism" type="text" placeholder="e.g. piezoelectric transduction" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;box-sizing:border-box;" />';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Test Method</label>';
            html += '<input id="valTestMethod" type="text" placeholder="e.g. bench test, simulation" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 8px 0;font-size:13px;box-sizing:border-box;" />';
            html += '<label style="font-size:11px;color:var(--text-secondary);">Success Metric</label>';
            html += '<input id="valSuccessMetric" type="text" placeholder="e.g. >20% filtration, <5C rise" style="width:100%;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin:4px 0 0 0;font-size:13px;box-sizing:border-box;" />';
            html += '</div>';

            html += '<div style="display:flex;gap:8px;margin-bottom:16px;">';
            html += '<button onclick="runValidation(false)" style="flex:1;padding:10px;background:#22d3ee;color:#000;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">Validate</button>';
            html += '<button onclick="runValidation(true)" style="flex:1;padding:10px;background:var(--surface-3);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:13px;">Autofill + Validate</button>';
            html += '</div>';
            html += '</details>';

            html += '<div id="valResults"></div>';
            html += '</div>';
            body.innerHTML = html;

            if (validationState.lastCard) renderBuildCard(validationState.lastCard);
            if (report) renderValidationResults(report);
        };

        window.runValidation = function(autofill) {
            var title = document.getElementById('valTitle').value.trim();
            if (!title) { alert('Project title is required.'); return; }
            validationState.lastCard = null;

            var domain = document.getElementById('valDomain').value || null;
            var powerVal = document.getElementById('valPowerNeeded').value;
            var powerNeeded = powerVal === '' ? null : powerVal === 'true';
            var wattsVal = document.getElementById('valWatts').value;
            var watts = wattsVal ? parseFloat(wattsVal) : null;
            var massVal = document.getElementById('valMass').value;
            var mass = massVal ? parseFloat(massVal) : null;

            var candidates = document.getElementById('valMatCandidates').value.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
            var methods = document.getElementById('valFabMethods').value.split(',').map(function(s){ return s.trim(); }).filter(Boolean);

            var payload = {
                title: title,
                domain: domain,
                scale: {
                    size_class: document.getElementById('valSizeClass').value || null,
                    mass_kg: mass
                },
                energy: {
                    power_needed: powerNeeded,
                    source: document.getElementById('valEnergySource').value || null,
                    watts: watts
                },
                material: {
                    material_family: document.getElementById('valMatFamily').value || null,
                    candidates: candidates
                },
                fabrication: {
                    methods: methods,
                    tolerance_level: document.getElementById('valTolerance').value || null
                },
                physics: {
                    mechanism: document.getElementById('valMechanism').value || null,
                    test_method: document.getElementById('valTestMethod').value || null,
                    success_metric: document.getElementById('valSuccessMetric').value || null,
                    flags: []
                }
            };

            var resultsDiv = document.getElementById('valResults');
            resultsDiv.innerHTML = '<div class="ep-loading">Running validation...</div>';

            fetch('/engineering/validate' + (autofill ? '?autofill=true' : ''), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                validationState.lastReport = data;
                resultsDiv.innerHTML = '';
                renderValidationResults(data);
            })
            .catch(function(err) {
                resultsDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">Error: ' + err.message + '</div>';
            });
        };

        window.runSuggestAndValidate = function() {
            var domain = document.getElementById('valLabDomain').value;
            var title = document.getElementById('valQuickTitle').value.trim();
            if (!domain) { alert('Pick a lab domain first.'); return; }
            if (!title) { alert('Enter a project title.'); return; }

            var resultsDiv = document.getElementById('valResults');
            resultsDiv.innerHTML = '<div class="ep-loading">Generating build card + validation...</div>';

            fetch('/engineering/suggest-and-validate?domain=' + encodeURIComponent(domain) + '&title=' + encodeURIComponent(title), {
                method: 'POST'
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                validationState.lastReport = data.validation_report;
                validationState.lastCard = data.minimum_build_card;
                document.getElementById('valResults').innerHTML = '';
                renderBuildCard(data.minimum_build_card);
                renderValidationResults(data.validation_report);
            })
            .catch(function(err) {
                resultsDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">Error: ' + err.message + '</div>';
            });
        };

        window.runTextIntake = function() {
            var text = document.getElementById('valFreeText').value.trim();
            if (!text) { alert('Describe your project idea first.'); return; }

            var resultsDiv = document.getElementById('valResults');
            resultsDiv.innerHTML = '<div class="ep-loading">Analyzing text, detecting domain, building card...</div>';

            fetch('/engineering/convert-from-text?autofill=true', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                validationState.lastReport = data.validation_report;
                validationState.lastCard = data.minimum_build_card;
                resultsDiv.innerHTML = '';
                renderIntakeMeta(data.intake, data.minimum_build_card);
                renderBuildCard(data.minimum_build_card);
                renderValidationResults(data.validation_report);
            })
            .catch(function(err) {
                resultsDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">Error: ' + err.message + '</div>';
            });
        };

        window.runBatchIntake = function() {
            var text = document.getElementById('valFreeText').value.trim();
            if (!text) { alert('Describe your projects first. Separate each project with a blank line.'); return; }

            var resultsDiv = document.getElementById('valResults');
            resultsDiv.innerHTML = '<div class="ep-loading">Splitting into projects, detecting domains, building cards...</div>';

            fetch('/engineering/convert-batch?autofill=true', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var items = data.items || [];
                var html = '<div style="font-size:13px;font-weight:700;color:#a855f7;margin-bottom:10px;">' + items.length + ' Projects Detected</div>';

                items.forEach(function(item, idx) {
                    var card = item.minimum_build_card;
                    var report = item.validation_report;
                    var intake = item.intake;
                    var tierColors = {1:'#4ade80',2:'#818cf8',3:'#f97316',4:'#ef4444'};
                    var tierLabels = {1:'Buildable Now',2:'Prototype Ready',3:'Engineering Track',4:'Speculative'};
                    var tc = tierColors[report.tier] || '#888';

                    html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid ' + tc + ';">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                    html += '<div style="font-size:12px;font-weight:700;color:var(--text-primary);">' + (card.title || 'Project ' + (idx + 1)) + '</div>';
                    html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:' + tc + '20;color:' + tc + ';border:1px solid ' + tc + '44;font-weight:600;">TIER ' + report.tier + '</span>';
                    html += '</div>';

                    html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">';
                    html += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);text-transform:uppercase;font-weight:600;">' + (card.domain || '').replace(/_/g, ' ') + '</span>';
                    if (card.simulation_only) {
                        html += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(251,191,36,0.12);color:#fbbf24;border:1px solid rgba(251,191,36,0.25);font-weight:600;">SIM ONLY</span>';
                    }
                    html += '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(34,211,238,0.12);color:#22d3ee;border:1px solid rgba(34,211,238,0.25);font-weight:600;">' + Math.round(report.overall_score * 100) + '% Ready</span>';
                    html += '</div>';

                    var checks = report.checks || [];
                    html += '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px;">';
                    checks.forEach(function(c) {
                        var passed = c.status === 'PASS';
                        var partial = c.status === 'PARTIAL';
                        var col = passed ? '#4ade80' : (partial ? '#f97316' : '#ef4444');
                        var icon = passed ? '\u2705' : (partial ? '\u26A0\uFE0F' : '\u274C');
                        html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:' + col + '15;color:' + col + ';border:1px solid ' + col + '33;">' + icon + ' ' + c.name + '</span>';
                    });
                    html += '</div>';

                    if (card.material && card.material.candidates) {
                        html += '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:3px;">Materials: ' + card.material.candidates.slice(0, 4).join(', ') + '</div>';
                    }
                    if (card.energy) {
                        html += '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:3px;">Energy: ' + (card.energy.source || '-') + (card.energy.watts ? ' (' + card.energy.watts + 'W)' : '') + '</div>';
                    }
                    if (card.intake_notes && card.intake_notes.length > 0) {
                        html += '<div style="font-size:9px;color:var(--text-muted);margin-top:4px;">';
                        card.intake_notes.forEach(function(n) { html += '<div style="margin-bottom:1px;">\u2022 ' + n + '</div>'; });
                        html += '</div>';
                    }
                    html += '</div>';
                });

                resultsDiv.innerHTML = html;
            })
            .catch(function(err) {
                resultsDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">Error: ' + err.message + '</div>';
            });
        };

        function renderIntakeMeta(intake, card) {
            var resultsDiv = document.getElementById('valResults');
            if (!resultsDiv) return;

            var html = '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid #a855f7;">';
            html += '<div style="font-size:13px;font-weight:700;color:#a855f7;margin-bottom:6px;">Intake Analysis</div>';
            html += '<div style="font-size:12px;color:var(--text-primary);margin-bottom:4px;"><strong>Primary Domain:</strong> ' + (intake.matched_domain || '').replace(/_/g, ' ') + '</div>';
            if (intake.secondary_domains && intake.secondary_domains.length > 0) {
                html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;"><strong>Also detected:</strong> ' + intake.secondary_domains.map(function(d) { return d.replace(/_/g, ' '); }).join(', ') + '</div>';
            }
            if (intake.simulation_requested) {
                html += '<div style="font-size:11px;color:#fbbf24;margin-bottom:4px;">Simulation-only mode detected</div>';
            }

            if (card.intake_notes && card.intake_notes.length > 0) {
                html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:6px;"><strong>Constraints Found:</strong></div>';
                html += '<ul style="margin:4px 0 0 16px;padding:0;font-size:11px;color:var(--text-secondary);">';
                card.intake_notes.forEach(function(note) {
                    html += '<li style="margin-bottom:2px;">' + note + '</li>';
                });
                html += '</ul>';
            }

            var scores = intake.domain_scores || {};
            var sortedDomains = Object.keys(scores).sort(function(a, b) { return scores[b] - scores[a]; });
            var topN = sortedDomains.slice(0, 4);
            if (topN.length > 0) {
                html += '<details style="margin-top:8px;"><summary style="cursor:pointer;font-size:11px;color:var(--text-secondary);">Domain Scores</summary>';
                html += '<div style="margin-top:4px;">';
                topN.forEach(function(d) {
                    var s = scores[d];
                    var barWidth = Math.min(s * 10, 100);
                    var isMatch = d === intake.matched_domain;
                    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
                    html += '<span style="font-size:10px;color:' + (isMatch ? '#a855f7' : 'var(--text-secondary)') + ';width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + d.replace(/_/g, ' ') + '</span>';
                    html += '<div style="flex:1;height:6px;background:var(--surface-3);border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + barWidth + '%;background:' + (isMatch ? '#a855f7' : '#64748b') + ';border-radius:3px;"></div></div>';
                    html += '<span style="font-size:10px;color:var(--text-secondary);width:20px;text-align:right;">' + s + '</span>';
                    html += '</div>';
                });
                html += '</div></details>';
            }

            html += '</div>';
            resultsDiv.innerHTML += html;
        }

        var bpEngineCache = null;
        window.renderBlueprintEnginePanel = function() {
            var body = document.getElementById('edgePanelBody');
            body.innerHTML = '<div class="ep-loading">Loading Blueprint Engine\u2026</div>';

            fetch('/blueprint-engine/projects')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var projects = data.projects || [];
                    var html = '<div style="padding:16px;">';
                    html += '<div style="font-size:15px;font-weight:700;color:#ef4444;margin-bottom:4px;">Ajani Blueprint Engine</div>';
                    html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:16px;">Generate validated engineering blueprint packets with materials, architecture, fabrication steps, failure modes, and test plans.</div>';

                    html += '<div style="display:grid;gap:10px;margin-bottom:16px;">';
                    projects.forEach(function(p) {
                        var safetyColors = {LOW:'#4ade80',MEDIUM:'#f97316',HIGH:'#ef4444'};
                        var sc = safetyColors[p.safety] || '#888';
                        var domainColors = {ROBOTICS:'#818cf8',ENERGY:'#fbbf24',MATERIALS:'#22d3ee',UI_SYSTEM:'#a855f7',BIOMED_SIM_ONLY:'#ef4444'};
                        var dc = domainColors[p.domain] || '#888';
                        html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;border-left:3px solid ' + dc + ';cursor:pointer;" onclick="generateBlueprint(\'' + p.key + '\')">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
                        html += '<div style="font-size:12px;font-weight:700;color:var(--text-primary);">' + escapeHtmlEP(p.title) + '</div>';
                        html += '</div>';
                        html += '<div style="display:flex;gap:6px;">';
                        html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:' + dc + '15;color:' + dc + ';border:1px solid ' + dc + '33;font-weight:600;text-transform:uppercase;">' + p.domain.replace(/_/g, ' ') + '</span>';
                        html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:' + sc + '15;color:' + sc + ';border:1px solid ' + sc + '33;font-weight:600;">' + p.safety + ' SAFETY</span>';
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';

                    html += '<details style="margin-bottom:16px;"><summary style="cursor:pointer;font-size:12px;font-weight:600;color:#ef4444;">View Material + Component Libraries</summary>';
                    html += '<div id="bpLibraries" style="margin-top:8px;"><div class="ep-loading">Loading libraries\u2026</div></div>';
                    html += '</details>';

                    html += '<details style="margin-bottom:16px;"><summary style="cursor:pointer;font-size:12px;font-weight:600;color:#4ade80;">Stored Projects</summary>';
                    html += '<div id="bpStoredProjects" style="margin-top:8px;"><div class="ep-loading">Loading\u2026</div></div>';
                    html += '</details>';

                    html += '<div id="bpResult"></div>';
                    html += '</div>';
                    body.innerHTML = html;
                })
                .catch(function(err) {
                    body.innerHTML = '<div style="color:#ef4444;padding:16px;">Error loading blueprint projects: ' + err.message + '</div>';
                });
        };

        window.loadBpLibraries = function() {
            var el = document.getElementById('bpLibraries');
            if (!el || bpEngineCache) {
                if (bpEngineCache) renderBpLibraries(bpEngineCache);
                return;
            }
            fetch('/blueprint-engine/libraries')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    bpEngineCache = data;
                    renderBpLibraries(data);
                })
                .catch(function(err) {
                    el.innerHTML = '<div style="color:#ef4444;">Error: ' + err.message + '</div>';
                });
        };

        function renderBpLibraries(data) {
            var el = document.getElementById('bpLibraries');
            if (!el) return;
            var html = '';

            html += '<div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:6px;">Materials (' + Object.keys(data.materials).length + ')</div>';
            html += '<div style="display:grid;gap:4px;margin-bottom:12px;">';
            Object.keys(data.materials).forEach(function(name) {
                var m = data.materials[name];
                var catColors = {metal:'#818cf8',composite:'#22d3ee',polymer:'#4ade80',fiber:'#f97316',energy:'#fbbf24'};
                var cc = catColors[m.category] || '#888';
                html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;display:flex;justify-content:space-between;align-items:center;">';
                html += '<div style="font-size:10px;color:var(--text-primary);">' + escapeHtmlEP(name) + '</div>';
                html += '<div style="display:flex;gap:4px;align-items:center;">';
                if (m.density_g_cm3) html += '<span style="font-size:9px;color:var(--text-secondary);">' + m.density_g_cm3 + ' g/cm\u00B3</span>';
                html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:' + cc + '15;color:' + cc + ';border:1px solid ' + cc + '33;font-weight:600;text-transform:uppercase;">' + m.category + '</span>';
                html += '</div></div>';
            });
            html += '</div>';

            html += '<div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:6px;">Components (' + Object.keys(data.components).length + ')</div>';
            html += '<div style="display:grid;gap:4px;margin-bottom:12px;">';
            Object.keys(data.components).forEach(function(name) {
                var c = data.components[name];
                html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;display:flex;justify-content:space-between;align-items:center;">';
                html += '<div style="font-size:10px;color:var(--text-primary);">' + escapeHtmlEP(name) + '</div>';
                html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);font-weight:600;text-transform:uppercase;">' + c.domain + '</span>';
                html += '</div>';
            });
            html += '</div>';

            html += '<div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:6px;">Tools (' + Object.keys(data.tools).length + ')</div>';
            html += '<div style="display:grid;gap:4px;">';
            Object.keys(data.tools).forEach(function(name) {
                var t = data.tools[name];
                html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;">';
                html += '<div style="font-size:10px;color:var(--text-primary);">' + escapeHtmlEP(name) + ' <span style="color:var(--text-secondary);font-size:9px;">\u2014 ' + escapeHtmlEP(t.notes) + '</span></div>';
                html += '</div>';
            });
            html += '</div>';

            el.innerHTML = html;
        }

        window.generateBlueprint = function(projectKey) {
            var resultDiv = document.getElementById('bpResult');
            if (!resultDiv) return;
            resultDiv.innerHTML = '<div class="ep-loading">Generating blueprint packet for ' + projectKey.replace(/_/g, ' ') + '\u2026</div>';

            fetch('/blueprint-engine/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_key: projectKey, version: '0.1' })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { resultDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">' + data.error + '</div>'; return; }
                lastGeneratedPacket = data.packet;
                renderBlueprintPacket(data.packet, data.validation, resultDiv);
            })
            .catch(function(err) {
                resultDiv.innerHTML = '<div style="color:#ef4444;padding:8px;">Error: ' + err.message + '</div>';
            });
        };

        function renderBlueprintPacket(pkt, validation, container) {
            var html = '';
            var safetyColors = {LOW:'#4ade80',MEDIUM:'#f97316',HIGH:'#ef4444'};
            var sc = safetyColors[pkt.safety_tier] || '#888';

            html += '<div style="background:var(--surface-2);border-radius:10px;padding:16px;margin-top:12px;border:1px solid ' + sc + '44;">';

            html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">';
            html += '<div style="font-size:14px;font-weight:700;color:var(--text-primary);">' + escapeHtmlEP(pkt.title) + '</div>';
            html += '<span style="font-size:9px;padding:2px 8px;border-radius:3px;background:' + sc + '20;color:' + sc + ';border:1px solid ' + sc + '44;font-weight:700;">' + pkt.safety_tier + '</span>';
            html += '</div>';

            html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">' + escapeHtmlEP(pkt.objective) + '</div>';

            html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">';
            html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);font-weight:600;">' + pkt.domain + '</span>';
            html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(100,116,139,0.12);color:#94a3b8;border:1px solid rgba(100,116,139,0.25);">v' + pkt.version + '</span>';
            html += '<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(100,116,139,0.12);color:#94a3b8;border:1px solid rgba(100,116,139,0.25);">' + pkt.blueprint_id.substring(0, 8) + '</span>';
            html += '</div>';

            if (!validation.ok) {
                html += '<div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:8px;margin-bottom:12px;">';
                html += '<div style="font-size:10px;font-weight:700;color:#ef4444;margin-bottom:4px;">Validation Notes</div>';
                validation.issues.forEach(function(i) {
                    html += '<div style="font-size:10px;color:#fca5a5;margin-bottom:2px;">\u26A0 ' + escapeHtmlEP(i) + '</div>';
                });
                html += '</div>';
            }

            if (pkt.assumptions && pkt.assumptions.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#4ade80;">Assumptions (' + pkt.assumptions.length + ')</summary>';
                html += '<ul style="margin:6px 0 0 16px;padding:0;font-size:10px;color:var(--text-secondary);">';
                pkt.assumptions.forEach(function(a) { html += '<li style="margin-bottom:3px;">' + escapeHtmlEP(a) + '</li>'; });
                html += '</ul></details>';
            }

            if (pkt.requirements && pkt.requirements.length > 0) {
                html += '<details open style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#818cf8;">Requirements (' + pkt.requirements.length + ')</summary>';
                html += '<div style="display:grid;gap:4px;margin-top:6px;">';
                pkt.requirements.forEach(function(r) {
                    html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;">';
                    html += '<div style="font-size:10px;font-weight:600;color:var(--text-primary);">[' + r.id + '] ' + escapeHtmlEP(r.statement) + '</div>';
                    if (r.metric || r.target) {
                        html += '<div style="font-size:9px;color:var(--text-secondary);margin-top:2px;">';
                        if (r.metric) html += 'Metric: ' + escapeHtmlEP(r.metric);
                        if (r.target) html += ' \u2192 ' + escapeHtmlEP(r.target);
                        html += '</div>';
                    }
                    html += '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.architecture && pkt.architecture.length > 0) {
                html += '<details open style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#22d3ee;">Architecture (' + pkt.architecture.length + ' modules)</summary>';
                html += '<div style="display:grid;gap:6px;margin-top:6px;">';
                pkt.architecture.forEach(function(m) {
                    html += '<div style="background:var(--surface-3);border-radius:6px;padding:8px;border-left:2px solid #22d3ee;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#22d3ee;margin-bottom:2px;">' + escapeHtmlEP(m.name) + '</div>';
                    html += '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px;">' + escapeHtmlEP(m.purpose) + '</div>';
                    if (m.inputs && m.inputs.length > 0) html += '<div style="font-size:9px;color:var(--text-muted);">IN: ' + m.inputs.join(', ') + '</div>';
                    if (m.outputs && m.outputs.length > 0) html += '<div style="font-size:9px;color:var(--text-muted);">OUT: ' + m.outputs.join(', ') + '</div>';
                    if (m.components && m.components.length > 0) {
                        html += '<div style="margin-top:4px;">';
                        m.components.forEach(function(c) {
                            html += '<div style="font-size:9px;color:var(--text-secondary);padding:2px 0;">\u2022 ' + escapeHtmlEP(c.name) + (c.qty > 1 ? ' x' + c.qty : '') + ' \u2014 ' + escapeHtmlEP(c.role) + (c.notes ? ' (' + escapeHtmlEP(c.notes) + ')' : '') + '</div>';
                        });
                        html += '</div>';
                    }
                    html += '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.materials && pkt.materials.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#fbbf24;">Materials (' + pkt.materials.length + ')</summary>';
                html += '<div style="display:grid;gap:4px;margin-top:6px;">';
                pkt.materials.forEach(function(m) {
                    html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;">';
                    html += '<div style="font-size:10px;font-weight:600;color:var(--text-primary);">' + escapeHtmlEP(m.name) + '</div>';
                    html += '<div style="font-size:9px;color:var(--text-secondary);">Use: ' + escapeHtmlEP(m.use) + '</div>';
                    html += '<div style="font-size:9px;color:var(--text-muted);">Why: ' + escapeHtmlEP(m.justification) + '</div>';
                    html += '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.power_flow && pkt.power_flow.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#f97316;">Power Flow</summary>';
                html += '<div style="margin-top:6px;">';
                pkt.power_flow.forEach(function(line) {
                    html += '<div style="font-size:10px;color:var(--text-secondary);padding:2px 0;font-family:monospace;">\u26A1 ' + escapeHtmlEP(line) + '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.control_logic && pkt.control_logic.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#a78bfa;">Control Logic</summary>';
                html += '<div style="margin-top:6px;">';
                pkt.control_logic.forEach(function(line) {
                    html += '<div style="font-size:10px;color:var(--text-secondary);padding:2px 0;">\u2699 ' + escapeHtmlEP(line) + '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.fabrication_steps && pkt.fabrication_steps.length > 0) {
                html += '<details open style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#4ade80;">Build Steps (' + pkt.fabrication_steps.length + ')</summary>';
                html += '<div style="display:grid;gap:6px;margin-top:6px;">';
                pkt.fabrication_steps.forEach(function(s) {
                    html += '<div style="background:var(--surface-3);border-radius:6px;padding:8px;border-left:2px solid #4ade80;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#4ade80;margin-bottom:4px;">Step ' + s.step + ': ' + escapeHtmlEP(s.title) + '</div>';
                    s.instructions.forEach(function(i) {
                        html += '<div style="font-size:10px;color:var(--text-secondary);padding:1px 0;padding-left:8px;">\u25B6 ' + escapeHtmlEP(i) + '</div>';
                    });
                    if (s.verification && s.verification.length > 0) {
                        html += '<div style="font-size:9px;color:#4ade80;margin-top:4px;font-weight:600;">Verification:</div>';
                        s.verification.forEach(function(v) {
                            html += '<div style="font-size:9px;color:var(--text-muted);padding-left:8px;">\u2713 ' + escapeHtmlEP(v) + '</div>';
                        });
                    }
                    html += '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.test_plan && pkt.test_plan.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#22d3ee;">Test Plan (' + pkt.test_plan.length + ')</summary>';
                html += '<ul style="margin:6px 0 0 16px;padding:0;font-size:10px;color:var(--text-secondary);">';
                pkt.test_plan.forEach(function(t) { html += '<li style="margin-bottom:3px;">' + escapeHtmlEP(t) + '</li>'; });
                html += '</ul></details>';
            }

            if (pkt.failure_modes && pkt.failure_modes.length > 0) {
                html += '<details open style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#ef4444;">Failure Modes (' + pkt.failure_modes.length + ')</summary>';
                html += '<div style="display:grid;gap:4px;margin-top:6px;">';
                pkt.failure_modes.forEach(function(f) {
                    var sevColors = {LOW:'#4ade80',MED:'#f97316',HIGH:'#ef4444'};
                    var fc = sevColors[f.severity] || '#888';
                    html += '<div style="background:var(--surface-3);border-radius:6px;padding:6px 8px;border-left:2px solid ' + fc + ';">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">';
                    html += '<div style="font-size:10px;font-weight:600;color:var(--text-primary);">' + escapeHtmlEP(f.mode) + '</div>';
                    html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:' + fc + '15;color:' + fc + ';border:1px solid ' + fc + '33;font-weight:700;">' + f.severity + '</span>';
                    html += '</div>';
                    html += '<div style="font-size:9px;color:var(--text-secondary);">Cause: ' + escapeHtmlEP(f.cause) + ' \u2192 Effect: ' + escapeHtmlEP(f.effect) + '</div>';
                    html += '<div style="font-size:9px;color:#4ade80;margin-top:2px;">Fix: ' + escapeHtmlEP(f.mitigation) + '</div>';
                    html += '</div>';
                });
                html += '</div></details>';
            }

            if (pkt.tools && pkt.tools.length > 0) {
                html += '<details style="margin-bottom:10px;"><summary style="cursor:pointer;font-size:11px;font-weight:700;color:#94a3b8;">Required Tools (' + pkt.tools.length + ')</summary>';
                html += '<div style="display:grid;gap:3px;margin-top:6px;">';
                pkt.tools.forEach(function(t) {
                    html += '<div style="font-size:10px;color:var(--text-secondary);padding:2px 0;">\uD83D\uDD27 ' + escapeHtmlEP(t.name) + ' \u2014 ' + escapeHtmlEP(t.purpose) + '</div>';
                });
                html += '</div></details>';
            }

            html += '<div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">';
            html += '<button id="bpStoreBtn" onclick="storeBlueprint()" style="font-size:11px;padding:6px 14px;border-radius:6px;background:#ef444420;color:#ef4444;border:1px solid #ef444444;cursor:pointer;font-weight:700;">Store Project</button>';
            html += '<a href="/viewer/index" target="_blank" style="font-size:11px;padding:6px 14px;border-radius:6px;background:#22d3ee20;color:#22d3ee;border:1px solid #22d3ee44;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block;">Open 3D Studio</a>';
            html += '<span style="font-size:9px;color:var(--text-muted);">Saves project.json + bom.csv to Atlas Storage</span>';
            html += '</div>';
            html += '<div id="bpStoreInfo"></div>';

            html += '</div>';
            container.innerHTML = html;
        }

        window.loadStoredProjects = function() {
            var el = document.getElementById('bpStoredProjects');
            if (!el) return;
            fetch('/atlas/projects')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var projects = data.projects || [];
                    if (projects.length === 0) {
                        el.innerHTML = '<div style="font-size:11px;color:var(--text-muted);padding:4px;">No stored projects yet. Generate a blueprint and click "Store Project" to save it.</div>';
                        return;
                    }
                    var html = '';
                    projects.forEach(function(p) {
                        p.versions.forEach(function(v) {
                            var domainColors = {ROBOTICS:'#818cf8',ENERGY:'#fbbf24',MATERIALS:'#22d3ee',UI_SYSTEM:'#a855f7'};
                            var dc = domainColors[v.domain] || '#888';
                            html += '<div style="background:var(--surface-3);border-radius:6px;padding:10px;margin-bottom:8px;border-left:2px solid ' + dc + ';">';
                            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
                            html += '<div style="font-size:11px;font-weight:700;color:var(--text-primary);">' + escapeHtmlEP(v.title || p.project_slug) + '</div>';
                            html += '<span style="font-size:9px;color:var(--text-secondary);">' + v.version + '</span>';
                            html += '</div>';
                            html += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">';
                            if (v.domain) html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:' + dc + '15;color:' + dc + ';border:1px solid ' + dc + '33;text-transform:uppercase;font-weight:600;">' + v.domain + '</span>';
                            html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(74,222,128,0.12);color:#4ade80;border:1px solid rgba(74,222,128,0.25);">' + (v.has_renders ? 'Renders' : 'No Renders') + '</span>';
                            html += '<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(139,92,246,0.12);color:#a78bfa;border:1px solid rgba(139,92,246,0.25);">' + (v.has_manual ? 'Manual Ready' : 'No Manual') + '</span>';
                            html += '</div>';
                            html += '<div style="display:flex;gap:6px;">';
                            if (!v.has_manual) {
                                html += '<button onclick="buildManual(\'' + p.project_slug + '\',\'' + v.version + '\')" style="font-size:9px;padding:3px 8px;border-radius:4px;background:#a855f720;color:#a855f7;border:1px solid #a855f744;cursor:pointer;">Build PDF Manual</button>';
                            } else {
                                html += '<a href="/atlas/projects/' + p.project_slug + '/' + v.version + '/manual.pdf" target="_blank" style="font-size:9px;padding:3px 8px;border-radius:4px;background:#4ade8020;color:#4ade80;border:1px solid #4ade8044;cursor:pointer;text-decoration:none;">Download Manual</a>';
                            }
                            html += '<a href="/atlas/projects/' + p.project_slug + '/' + v.version + '/export.zip" target="_blank" style="font-size:9px;padding:3px 8px;border-radius:4px;background:#22d3ee20;color:#22d3ee;border:1px solid #22d3ee44;cursor:pointer;text-decoration:none;">Export ZIP</a>';
                            html += '</div>';
                            html += '</div>';
                        });
                    });
                    el.innerHTML = html;
                })
                .catch(function(err) {
                    el.innerHTML = '<div style="color:#ef4444;font-size:11px;">Error: ' + err.message + '</div>';
                });
        };

        var lastGeneratedPacket = null;

        window.storeBlueprint = function() {
            if (!lastGeneratedPacket) { alert('Generate a blueprint first.'); return; }
            var btn = document.getElementById('bpStoreBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Storing\u2026'; }

            fetch('/atlas/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastGeneratedPacket)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (btn) { btn.textContent = 'Stored'; btn.style.background = '#4ade8030'; btn.style.color = '#4ade80'; btn.style.borderColor = '#4ade8044'; }
                var info = document.getElementById('bpStoreInfo');
                if (info) {
                    info.innerHTML = '<div style="font-size:10px;color:#4ade80;margin-top:6px;">Saved as <strong>' + escapeHtmlEP(data.project_slug) + '/' + escapeHtmlEP(data.version_folder) + '</strong> with project.json + bom.csv</div>';
                }
            })
            .catch(function(err) {
                if (btn) { btn.disabled = false; btn.textContent = 'Store Project'; }
                alert('Error storing project: ' + err.message);
            });
        };

        window.buildManual = function(slug, version) {
            fetch('/atlas/projects/' + slug + '/' + version + '/manual', { method: 'POST' })
                .then(function(r) {
                    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'Failed'); });
                    return r.json();
                })
                .then(function(data) {
                    alert('Manual PDF generated! Refreshing\u2026');
                    loadStoredProjects();
                })
                .catch(function(err) {
                    alert('Manual generation: ' + err.message);
                });
        };

        document.addEventListener('click', function(e) {
            if (e.target && e.target.closest && e.target.closest('details summary')) {
                var det = e.target.closest('details');
                var libDiv = document.getElementById('bpLibraries');
                if (det && libDiv && det.contains(libDiv)) {
                    setTimeout(function() { if (det.open) loadBpLibraries(); }, 50);
                }
                var storedDiv = document.getElementById('bpStoredProjects');
                if (det && storedDiv && det.contains(storedDiv)) {
                    setTimeout(function() { if (det.open) loadStoredProjects(); }, 50);
                }
            }
        });

        function renderBuildCard(card) {
            var resultsDiv = document.getElementById('valResults');
            if (!resultsDiv) return;

            var html = '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid #22d3ee;">';
            html += '<div style="font-size:13px;font-weight:700;color:#22d3ee;margin-bottom:4px;">' + (card.title || '') + '</div>';
            html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">Domain: ' + (card.domain || '').replace(/_/g, ' ') + '</div>';

            if (card.scale) {
                html += '<div style="font-size:11px;margin-bottom:6px;"><span style="color:var(--text-secondary);">Scale:</span> ' + (card.scale.size_class || '-') + ' (' + (card.scale.dimensions_cm ? card.scale.dimensions_cm.x + 'x' + card.scale.dimensions_cm.y + 'x' + card.scale.dimensions_cm.z + 'cm' : '-') + ', ' + (card.scale.mass_kg || 0) + 'kg)</div>';
            }
            if (card.energy) {
                html += '<div style="font-size:11px;margin-bottom:6px;"><span style="color:var(--text-secondary);">Energy:</span> ' + (card.energy.source || '-') + (card.energy.watts ? ' (' + card.energy.watts + 'W peak)' : '') + '</div>';
            }
            if (card.material && card.material.candidates) {
                html += '<div style="font-size:11px;margin-bottom:6px;"><span style="color:var(--text-secondary);">Materials:</span> ' + card.material.candidates.join(', ') + '</div>';
            }
            if (card.fabrication && card.fabrication.methods) {
                html += '<div style="font-size:11px;margin-bottom:6px;"><span style="color:var(--text-secondary);">Fabrication:</span> ' + card.fabrication.methods.join(', ') + '</div>';
            }
            if (card.physics && card.physics.mechanism) {
                html += '<div style="font-size:11px;margin-bottom:6px;"><span style="color:var(--text-secondary);">Mechanism:</span> ' + card.physics.mechanism + '</div>';
            }

            if (card.acceptance_tests && card.acceptance_tests.length) {
                html += '<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin:8px 0 4px 0;">Acceptance Tests</div>';
                card.acceptance_tests.forEach(function(t) {
                    html += '<div style="font-size:11px;color:var(--text-secondary);padding:2px 0 2px 8px;border-left:2px solid rgba(34,211,238,0.2);">' + t + '</div>';
                });
            }
            if (card.failure_modes && card.failure_modes.length) {
                html += '<div style="font-size:11px;font-weight:600;color:#fbbf24;margin:8px 0 4px 0;">Failure Modes</div>';
                card.failure_modes.forEach(function(f) {
                    html += '<div style="font-size:11px;color:var(--text-secondary);padding:2px 0 2px 8px;border-left:2px solid rgba(251,191,36,0.2);">' + f + '</div>';
                });
            }
            if (card.team_inputs && card.team_inputs.length) {
                html += '<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin:8px 0 4px 0;">Tri-Core Team</div>';
                card.team_inputs.forEach(function(t) {
                    var agentColors = { Ajani: 'var(--ajani)', Minerva: 'var(--minerva)', Hermes: 'var(--hermes)' };
                    var c = agentColors[t.agent] || 'var(--text-secondary)';
                    html += '<div style="font-size:11px;margin-bottom:4px;"><span style="color:' + c + ';font-weight:600;">' + t.agent + ':</span> <span style="color:var(--text-secondary);">' + t.focus + ' â€” ' + t.stance + '</span></div>';
                });
            }
            html += '</div>';

            resultsDiv.innerHTML += html;
        }

        function renderValidationResults(data) {
            var resultsDiv = document.getElementById('valResults');
            if (!resultsDiv) return;

            var tierColors = { 1: '#fbbf24', 2: '#34d399', 3: '#22d3ee', 4: '#ef4444' };
            var tierColor = tierColors[data.tier] || '#888';
            var scorePercent = Math.round(data.overall_score * 100);

            var html = '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid ' + tierColor + ';">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
            html += '<div style="font-size:14px;font-weight:700;color:' + tierColor + ';">TIER ' + data.tier + '</div>';
            html += '<div style="font-size:12px;color:var(--text-secondary);">' + data.completion + '</div>';
            html += '</div>';
            html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">' + data.tier_label + '</div>';

            html += '<div style="background:var(--surface-3);border-radius:4px;height:8px;overflow:hidden;margin-bottom:4px;">';
            html += '<div style="height:100%;width:' + scorePercent + '%;background:' + tierColor + ';border-radius:4px;transition:width 0.3s;"></div>';
            html += '</div>';
            html += '<div style="font-size:11px;color:var(--text-secondary);text-align:right;">' + scorePercent + '% overall</div>';
            html += '</div>';

            html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
            html += '<div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Checks</div>';
            (data.checks || []).forEach(function(check) {
                var statusColors = { PASS: '#34d399', PARTIAL: '#fbbf24', MISSING: '#888', FAIL: '#ef4444' };
                var sColor = statusColors[check.status] || '#888';
                var checkPercent = Math.round(check.score * 100);

                html += '<div style="margin-bottom:10px;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
                html += '<span style="font-size:12px;font-weight:600;color:var(--text-primary);">' + check.name + '</span>';
                html += '<span style="font-size:11px;font-weight:600;color:' + sColor + ';">' + check.status + ' (' + checkPercent + '%)</span>';
                html += '</div>';
                html += '<div style="background:var(--surface-3);border-radius:3px;height:5px;overflow:hidden;">';
                html += '<div style="height:100%;width:' + checkPercent + '%;background:' + sColor + ';border-radius:3px;"></div>';
                html += '</div>';
                if (check.notes && check.notes.length > 0) {
                    check.notes.forEach(function(n) {
                        html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:3px;padding-left:4px;">' + n + '</div>';
                    });
                }
                html += '</div>';
            });
            html += '</div>';

            if (data.blockers && data.blockers.length > 0) {
                html += '<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:12px;margin-bottom:12px;">';
                html += '<div style="font-size:12px;font-weight:600;color:#ef4444;margin-bottom:6px;">Blockers</div>';
                data.blockers.forEach(function(b) {
                    html += '<div style="font-size:12px;color:#fca5a5;margin-bottom:4px;">' + b + '</div>';
                });
                html += '</div>';
            }

            if (data.missing_fields && data.missing_fields.length > 0) {
                html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
                html += '<div style="font-size:12px;font-weight:600;color:#fbbf24;margin-bottom:6px;">Missing Fields (' + data.missing_fields.length + ')</div>';
                data.missing_fields.forEach(function(f) {
                    html += '<div style="font-size:12px;color:var(--text-secondary);padding:2px 0;font-family:monospace;">' + f + '</div>';
                });
                html += '</div>';
            }

            if (data.recommendations && data.recommendations.length > 0) {
                html += '<div style="background:var(--surface-2);border-radius:8px;padding:12px;margin-bottom:12px;">';
                html += '<div style="font-size:12px;font-weight:600;color:#22d3ee;margin-bottom:6px;">Recommendations</div>';
                data.recommendations.forEach(function(r) {
                    html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;padding-left:8px;border-left:2px solid #22d3ee33;">' + r + '</div>';
                });
                html += '</div>';
            }

            resultsDiv.innerHTML += html;
        }

    })();
    </script>

    <!-- System Status Pane -->
    <div id="systemStatusPane" class="system-status-pane collapsed">
        <div class="pane-header">
            <div class="pane-title">System Status</div>
            <button class="pane-toggle" onclick="toggleSystemPane()">â—€</button>
        </div>

        <!-- Core Metrics -->
        <div class="status-metric">
            <div class="metric-header">
                <span class="metric-label">Stability</span>
                <span class="metric-value" id="metricStability" style="color: var(--stability-color);">78%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill stability" id="metricStabilityBar" style="width: 78%;"></div>
            </div>
        </div>

        <div class="status-metric">
            <div class="metric-header">
                <span class="metric-label">Memory Load</span>
                <span class="metric-value" id="metricMemory" style="color: var(--memory-color);">45%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill memory" id="metricMemoryBar" style="width: 45%;"></div>
            </div>
        </div>

        <div class="status-metric">
            <div class="metric-header">
                <span class="metric-label">Logic Flow</span>
                <span class="metric-value" id="metricLogic" style="color: var(--logic-color);">Calibrating</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill logic" id="metricLogicBar" style="width: 62%;"></div>
            </div>
        </div>

        <div class="status-metric">
            <div class="metric-header">
                <span class="metric-label">Risk Level</span>
                <span class="metric-value" id="metricRisk" style="color: var(--stability-color);">Low</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill risk" id="metricRiskBar" style="width: 15%;"></div>
            </div>
        </div>

        <!-- Memory Visualization -->
        <div class="memory-slots" id="memorySlots">
            <!-- 16 memory slots -->
        </div>

        <!-- AI Presence -->
        <div class="ai-presence">
            <div class="ai-indicator ajani" id="aiAjani" onclick="if(typeof selectPersona==='function')selectPersona('ajani')">
                <div>âš”ï¸</div>
                <div>Ajani</div>
            </div>
            <div class="ai-indicator minerva active" id="aiMinerva" onclick="if(typeof selectPersona==='function')selectPersona('minerva')">
                <div>ğŸ“š</div>
                <div>Minerva</div>
            </div>
            <div class="ai-indicator hermes" id="aiHermes" onclick="if(typeof selectPersona==='function')selectPersona('hermes')">
                <div>âš¡</div>
                <div>Hermes</div>
            </div>
        </div>

        <!-- System Log -->
        <div class="status-log" id="systemLog">
            <div class="log-entry"><span class="log-time">[00:00]</span> <span class="log-msg">Memory Core Initialization...</span></div>
            <div class="log-entry"><span class="log-time">[00:01]</span> <span class="log-msg success">Logic Flow Calibrated</span></div>
            <div class="log-entry"><span class="log-time">[00:02]</span> <span class="log-msg">Function Architecture Ready</span></div>
            <div class="log-entry"><span class="log-time">[00:03]</span> <span class="log-msg">Object-Oriented Systems Online</span></div>
        </div>
    </div>

    <script>
        // === SYSTEM STATUS PANE LOGIC ===
        function toggleSystemPane() {
            const pane = document.getElementById('systemStatusPane');
            pane.classList.toggle('collapsed');
        }

        // Initialize memory slots
        function initMemorySlots() {
            const container = document.getElementById('memorySlots');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'memory-slot';
                slot.id = `memSlot${i}`;
                container.appendChild(slot);
            }
        }

        // Update system metrics based on learning activity
        function updateSystemMetrics(data = {}) {
            const stability = data.stability || Math.floor(70 + Math.random() * 25);
            const memory = data.memory || Math.floor(30 + Math.random() * 40);
            const logic = data.logic || Math.floor(50 + Math.random() * 45);
            const risk = data.risk || Math.floor(Math.random() * 30);

            // Update displays
            document.getElementById('metricStability').textContent = stability + '%';
            document.getElementById('metricStabilityBar').style.width = stability + '%';
            
            document.getElementById('metricMemory').textContent = memory + '%';
            document.getElementById('metricMemoryBar').style.width = memory + '%';
            
            const logicLabels = ['Initializing', 'Calibrating', 'Optimizing', 'Stable', 'Peak'];
            document.getElementById('metricLogic').textContent = logicLabels[Math.floor(logic / 25)];
            document.getElementById('metricLogicBar').style.width = logic + '%';
            
            const riskLabels = ['Minimal', 'Low', 'Moderate', 'Elevated', 'Critical'];
            const riskIndex = Math.floor(risk / 25);
            document.getElementById('metricRisk').textContent = riskLabels[riskIndex];
            document.getElementById('metricRisk').style.color = risk > 60 ? 'var(--risk-color)' : 'var(--stability-color)';
            document.getElementById('metricRiskBar').style.width = risk + '%';

            // Update memory slots
            const filledSlots = Math.floor((memory / 100) * 16);
            for (let i = 0; i < 16; i++) {
                const slot = document.getElementById(`memSlot${i}`);
                if (slot) {
                    slot.classList.toggle('filled', i < filledSlots);
                    slot.classList.toggle('overflow', memory > 90 && i >= 14);
                }
            }
        }

        // Add log entry
        function addSystemLog(message, type = 'normal') {
            const log = document.getElementById('systemLog');
            if (!log) return;
            
            const now = new Date();
            const time = now.toTimeString().slice(0, 5);
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-msg ${type}">${message}</span>`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initMemorySlots();
            updateSystemMetrics();
            
            // Periodic metric updates
            setInterval(() => {
                updateSystemMetrics();
            }, 10000);
        });

        // Hook into learning actions to update metrics
        const originalOpenFullscreenExercise = window.openFullscreenExercise;
        if (typeof originalOpenFullscreenExercise === 'function') {
            window.openFullscreenExercise = function(...args) {
                addSystemLog('Loading exercise module...', 'normal');
                updateSystemMetrics({ memory: 55 + Math.random() * 20, logic: 45 });
                // Expand pane when exercise starts
                document.getElementById('systemStatusPane')?.classList.remove('collapsed');
                return originalOpenFullscreenExercise.apply(this, args);
            };
        }

        // === ENHANCED LEARNING FEEDBACK SYSTEM ===
        window.forgeLearnEvent = function(eventType, data = {}) {
            const pane = document.getElementById('systemStatusPane');
            
            switch(eventType) {
                case 'correct_answer':
                    addSystemLog('Logic path validated âœ“', 'success');
                    updateSystemMetrics({ 
                        stability: Math.min(95, 80 + Math.random() * 15), 
                        logic: Math.min(100, 70 + Math.random() * 25),
                        risk: Math.max(5, 15 - Math.random() * 10)
                    });
                    // Pulse the stability bar
                    document.getElementById('metricStabilityBar')?.classList.add('progress-pulse');
                    setTimeout(() => {
                        document.getElementById('metricStabilityBar')?.classList.remove('progress-pulse');
                    }, 1500);
                    break;

                case 'wrong_answer':
                    addSystemLog('Logic inconsistency detected', 'warning');
                    updateSystemMetrics({ 
                        stability: Math.max(40, 65 - Math.random() * 20),
                        risk: Math.min(75, 35 + Math.random() * 25),
                        memory: 70 + Math.random() * 20
                    });
                    // Add warning glow
                    pane?.classList.add('warning-glow');
                    setTimeout(() => {
                        pane?.classList.remove('warning-glow');
                    }, 2000);
                    break;

                case 'overflow':
                    addSystemLog('VARIABLE OVERFLOW DETECTED', 'warning');
                    updateSystemMetrics({ memory: 95, risk: 80 });
                    // Flash all memory slots
                    for (let i = 0; i < 16; i++) {
                        const slot = document.getElementById(`memSlot${i}`);
                        if (slot) {
                            slot.classList.add('overflow');
                            setTimeout(() => slot.classList.remove('overflow'), 2000);
                        }
                    }
                    break;

                case 'part_placed':
                    addSystemLog(`Component loaded: ${data.part || 'module'}`, 'normal');
                    // Incrementally fill memory
                    const currentMem = parseInt(document.getElementById('metricMemory')?.textContent || '50');
                    updateSystemMetrics({ memory: Math.min(85, currentMem + 5) });
                    break;

                case 'simulation_run':
                    addSystemLog('Simulation executing...', 'normal');
                    updateSystemMetrics({ logic: 90, memory: 75 });
                    break;

                case 'exercise_complete':
                    addSystemLog('MODULE COMPLETE - Knowledge integrated', 'success');
                    updateSystemMetrics({ stability: 95, logic: 95, risk: 5 });
                    break;
            }
        };

        // Override quiz answer handlers to trigger events
        const enhanceQuizListeners = () => {
            document.querySelectorAll('.fs-quiz-option').forEach(btn => {
                if (btn.dataset.forgeEnhanced) return; // Prevent double-binding
                btn.dataset.forgeEnhanced = 'true';
                
                btn.onclick = function(e) {
                    const questionDiv = this.closest('.fs-quiz-question');
                    if (questionDiv.dataset.answered === 'true') return;
                    
                    const isCorrect = this.dataset.correct === 'true';
                    
                    // LOCAL SCORING - No AI call
                    const result = ForgeEngine.scoreAnswer(isCorrect);
                    ForgeEngine.syncToUI();
                    
                    // OPTIMISTIC UI - Instant visual feedback
                    questionDiv.dataset.answered = 'true';
                    this.classList.add(isCorrect ? 'correct' : 'incorrect');
                    
                    // Show correct answer if wrong
                    if (!isCorrect) {
                        questionDiv.querySelector('[data-correct="true"]').classList.add('correct');
                    }
                    
                    // LOCAL FEEDBACK - No AI call
                    const feedback = PreloadedContent.getRandomFeedback(isCorrect ? 'correct' : 'incorrect');
                    const feedbackDiv = questionDiv.querySelector('.fs-quiz-feedback');
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = `<span class="${isCorrect ? 'correct-feedback' : 'wrong-feedback'}">${feedback}</span>`;
                        if (result.bonus > 0) {
                            feedbackDiv.innerHTML += ` <span class="bonus">+${result.bonus} streak bonus!</span>`;
                        }
                    }
                    
                    // Trigger forge event for animations
                    if (isCorrect) {
                        forgeLearnEvent('correct_answer');
                    } else {
                        forgeLearnEvent('wrong_answer');
                    }
                    
                    // Update exercise progress
                    currentExerciseState.completedActions++;
                    updateExerciseProgress();
                };
            });
        };

        // Observe for exercise modal changes
        const exerciseObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    setTimeout(enhanceQuizListeners, 100);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const workspace = document.getElementById('exerciseWorkspace');
            if (workspace) {
                exerciseObserver.observe(workspace, { childList: true, subtree: true });
            }
        });

        var bpModalData = null;
        var bpModalPage = 0;

        function loadBlueprintLab() {
            fetch('/research-tracker/blueprint-handbooks')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var container = document.getElementById('blueprintLabCards');
                    if (!container || !data.handbooks) return;
                    var html = '';
                    data.handbooks.forEach(function(hb) {
                        var color = hb.cover_color || '#888';
                        html += '<div class="bp-lab-card" style="border-color:' + color + '44;" onclick="openBpModal(\'' + hb.project_id + '\')">';
                        html += '<div class="bp-lab-card-header" style="background:linear-gradient(135deg, ' + color + '15, ' + color + '05);">';
                        html += renderBpPreviewSvg(hb.project_id, color);
                        html += '</div>';
                        html += '<div class="bp-lab-card-info">';
                        html += '<div class="bp-lab-card-title" style="color:' + color + ';">' + escapeHtmlEP(hb.title) + '</div>';
                        html += '<div class="bp-lab-card-meta">' + hb.pages + ' blueprint pages \u00B7 Click to explore</div>';
                        html += '<div class="bp-lab-card-tags">';
                        html += '<span class="bp-lab-tag" style="background:' + color + '18;color:' + color + ';border-color:' + color + '33;">SVG Diagrams</span>';
                        html += '<span class="bp-lab-tag" style="background:' + color + '18;color:' + color + ';border-color:' + color + '33;">Interactive</span>';
                        html += '<span class="bp-lab-tag" style="background:' + color + '18;color:' + color + ';border-color:' + color + '33;">Schematics</span>';
                        html += '</div>';
                        html += '</div></div>';
                    });
                    container.innerHTML = html;
                });
        }

        function renderBpPreviewSvg(projectId, color) {
            var svg = '<svg viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:160px;display:block;">';
            svg += '<rect width="320" height="160" fill="transparent"/>';
            if (projectId === 'insert-cell') {
                svg += '<rect x="110" y="20" width="100" height="40" rx="6" fill="' + color + '22" stroke="' + color + '" stroke-width="1.5"/>';
                svg += '<text x="160" y="44" text-anchor="middle" fill="#e0e0e0" font-size="9" font-weight="600">POWER CORE</text>';
                svg += '<rect x="30" y="90" width="80" height="30" rx="4" fill="#4488ff22" stroke="#4488ff" stroke-width="1"/>';
                svg += '<text x="70" y="109" text-anchor="middle" fill="#aaa" font-size="8">USB-C Module</text>';
                svg += '<rect x="120" y="90" width="80" height="30" rx="4" fill="#44cc8822" stroke="#44cc88" stroke-width="1"/>';
                svg += '<text x="160" y="109" text-anchor="middle" fill="#aaa" font-size="8">Solar Input</text>';
                svg += '<rect x="210" y="90" width="80" height="30" rx="4" fill="#ffaa0022" stroke="#ffaa00" stroke-width="1"/>';
                svg += '<text x="250" y="109" text-anchor="middle" fill="#aaa" font-size="8">Induction</text>';
                svg += '<line x1="160" y1="60" x2="70" y2="90" stroke="' + color + '" stroke-width="1" opacity="0.4"/>';
                svg += '<line x1="160" y1="60" x2="160" y2="90" stroke="' + color + '" stroke-width="1" opacity="0.4"/>';
                svg += '<line x1="160" y1="60" x2="250" y2="90" stroke="' + color + '" stroke-width="1" opacity="0.4"/>';
                svg += '<circle cx="160" cy="140" r="4" fill="' + color + '" opacity="0.3"><animate attributeName="r" values="3;6;3" dur="2s" repeatCount="indefinite"/></circle>';
                svg += '<text x="160" y="155" text-anchor="middle" fill="#666" font-size="7">UNIVERSAL POWER PLATFORM</text>';
            } else if (projectId === 'hydra-core') {
                svg += '<rect x="120" y="15" width="80" height="35" rx="6" fill="' + color + '22" stroke="' + color + '" stroke-width="1.5"/>';
                svg += '<text x="160" y="37" text-anchor="middle" fill="#e0e0e0" font-size="9" font-weight="600">H\u2082 STACK</text>';
                svg += '<rect x="30" y="65" width="60" height="25" rx="4" fill="#4488ff22" stroke="#4488ff" stroke-width="1"/>';
                svg += '<text x="60" y="81" text-anchor="middle" fill="#aaa" font-size="7">Electrolyzer</text>';
                svg += '<rect x="100" y="65" width="60" height="25" rx="4" fill="#ff884422" stroke="#ff8844" stroke-width="1"/>';
                svg += '<text x="130" y="81" text-anchor="middle" fill="#aaa" font-size="7">Fuel Cell</text>';
                svg += '<rect x="170" y="65" width="60" height="25" rx="4" fill="#44cc8822" stroke="#44cc88" stroke-width="1"/>';
                svg += '<text x="200" y="81" text-anchor="middle" fill="#aaa" font-size="7">Thermal</text>';
                svg += '<rect x="240" y="65" width="60" height="25" rx="4" fill="#aa44ff22" stroke="#aa44ff" stroke-width="1"/>';
                svg += '<text x="270" y="81" text-anchor="middle" fill="#aaa" font-size="7">Storage</text>';
                svg += '<line x1="160" y1="50" x2="60" y2="65" stroke="' + color + '" stroke-width="1" opacity="0.3"/>';
                svg += '<line x1="160" y1="50" x2="130" y2="65" stroke="' + color + '" stroke-width="1" opacity="0.3"/>';
                svg += '<line x1="160" y1="50" x2="200" y2="65" stroke="' + color + '" stroke-width="1" opacity="0.3"/>';
                svg += '<line x1="160" y1="50" x2="270" y2="65" stroke="' + color + '" stroke-width="1" opacity="0.3"/>';
                svg += '<rect x="80" y="110" width="160" height="25" rx="4" fill="#ffaa0022" stroke="#ffaa00" stroke-width="1"/>';
                svg += '<text x="160" y="126" text-anchor="middle" fill="#aaa" font-size="8">Safety Containment Layer</text>';
                svg += '<text x="160" y="155" text-anchor="middle" fill="#666" font-size="7">HYDROGEN FUEL CELL ENGINE</text>';
            } else if (projectId === 'green-robotics') {
                svg += '<circle cx="60" cy="50" r="18" fill="#44cc4422" stroke="#44cc44" stroke-width="1.5"/>';
                svg += '<text x="60" y="54" text-anchor="middle" fill="#aaa" font-size="7">Grazer</text>';
                svg += '<circle cx="140" cy="35" r="18" fill="#88cc4422" stroke="#88cc44" stroke-width="1.5"/>';
                svg += '<text x="140" y="39" text-anchor="middle" fill="#aaa" font-size="7">Tallneck</text>';
                svg += '<circle cx="220" cy="50" r="18" fill="#44aacc22" stroke="#44aacc" stroke-width="1.5"/>';
                svg += '<text x="220" y="54" text-anchor="middle" fill="#aaa" font-size="7">Watcher</text>';
                svg += '<circle cx="100" cy="100" r="18" fill="#4488ff22" stroke="#4488ff" stroke-width="1.5"/>';
                svg += '<text x="100" y="104" text-anchor="middle" fill="#aaa" font-size="7">Aquatic</text>';
                svg += '<circle cx="200" cy="100" r="18" fill="#cc884422" stroke="#cc8844" stroke-width="1.5"/>';
                svg += '<text x="200" y="104" text-anchor="middle" fill="#aaa" font-size="7">Aerial</text>';
                svg += '<line x1="60" y1="50" x2="140" y2="35" stroke="#44cc44" stroke-width="0.8" opacity="0.3"/>';
                svg += '<line x1="140" y1="35" x2="220" y2="50" stroke="#88cc44" stroke-width="0.8" opacity="0.3"/>';
                svg += '<line x1="60" y1="50" x2="100" y2="100" stroke="#44cc44" stroke-width="0.8" opacity="0.3"/>';
                svg += '<line x1="220" y1="50" x2="200" y2="100" stroke="#44aacc" stroke-width="0.8" opacity="0.3"/>';
                svg += '<line x1="100" y1="100" x2="200" y2="100" stroke="#4488ff" stroke-width="0.8" opacity="0.3"/>';
                svg += '<rect x="100" y="130" width="120" height="18" rx="3" fill="' + color + '15" stroke="' + color + '" stroke-width="0.8"/>';
                svg += '<text x="160" y="143" text-anchor="middle" fill="#888" font-size="7">5 Machine Classes</text>';
                svg += '<text x="160" y="155" text-anchor="middle" fill="#666" font-size="7">ECO-ROBOTICS FLEET</text>';
            } else {
                svg += '<rect x="60" y="30" width="200" height="100" rx="8" fill="' + color + '11" stroke="' + color + '" stroke-width="1.5" stroke-dasharray="4,3"/>';
                svg += '<text x="160" y="85" text-anchor="middle" fill="' + color + '" font-size="11" font-weight="600">' + projectId.toUpperCase() + '</text>';
            }
            svg += '</svg>';
            return svg;
        }

        function openBpModal(projectId) {
            var modal = document.getElementById('blueprintModal');
            var body = document.getElementById('bpModalBody');
            modal.style.display = 'block';
            body.innerHTML = '<div style="color:#888;font-size:14px;">Loading blueprint\u2026</div>';
            fetch('/research-tracker/blueprint-handbook/' + projectId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.handbook) {
                        body.innerHTML = '<div style="color:#666;">No handbook data available</div>';
                        return;
                    }
                    bpModalData = data.handbook;
                    bpModalPage = 0;
                    renderBpModalPage();
                })
                .catch(function() {
                    body.innerHTML = '<div style="color:#ff4444;">Failed to load blueprint</div>';
                });
        }

        function closeBpModal() {
            document.getElementById('blueprintModal').style.display = 'none';
            bpModalData = null;
        }

        function bpNav(delta) {
            if (!bpModalData) return;
            var next = bpModalPage + delta;
            if (next < 0 || next >= bpModalData.pages.length) return;
            bpModalPage = next;
            renderBpModalPage();
        }

        function renderBpModalPage() {
            if (!bpModalData) return;
            var page = bpModalData.pages[bpModalPage];
            var color = bpModalData.cover_color || '#888';
            var title = document.getElementById('bpModalTitle');
            var sub = document.getElementById('bpModalSub');
            var counter = document.getElementById('bpPageCounter');
            var body = document.getElementById('bpModalBody');
            var icon = document.getElementById('bpModalIcon');
            var prevBtn = document.getElementById('bpPrevBtn');
            var nextBtn = document.getElementById('bpNextBtn');

            title.textContent = bpModalData.title;
            sub.textContent = 'Page ' + (bpModalPage + 1) + ' \u2014 ' + (page.type || '').toUpperCase();
            counter.textContent = (bpModalPage + 1) + ' / ' + bpModalData.pages.length;
            icon.style.borderColor = color;
            prevBtn.disabled = bpModalPage === 0;
            nextBtn.disabled = bpModalPage >= bpModalData.pages.length - 1;
            prevBtn.style.opacity = bpModalPage === 0 ? '0.3' : '1';
            nextBtn.style.opacity = bpModalPage >= bpModalData.pages.length - 1 ? '0.3' : '1';

            var html = '<div style="max-width:900px;width:100%;">';
            if (page.type === 'cover') {
                html += renderBpFullCover(page, color);
            } else if (page.type === 'overview') {
                html += renderBpFullOverview(page, color);
            } else if (page.type === 'parts_layout') {
                html += renderBpFullParts(page, color);
            } else if (page.type === 'assembly_step') {
                html += renderBpFullAssembly(page, color);
            } else if (page.type === 'wiring') {
                html += renderBpFullWiring(page, color);
            } else if (page.type === 'final_assembly') {
                html += renderBpFullFinal(page, color);
            } else if (page.type === 'machine_profile') {
                html += renderBpFullMachine(page, color);
            } else if (page.type === 'charter') {
                html += renderBpFullCharter(page, color);
            }
            html += '</div>';
            body.innerHTML = html;
        }

        function renderBpFullCover(page, color) {
            var svg = '<svg viewBox="0 0 900 400" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
            svg += '<rect width="900" height="400" fill="transparent"/>';
            svg += '<rect x="50" y="50" width="800" height="300" rx="12" fill="' + color + '08" stroke="' + color + '" stroke-width="2" stroke-dasharray="8,4"/>';
            svg += '<line x1="80" y1="130" x2="820" y2="130" stroke="' + color + '" stroke-width="1" opacity="0.2"/>';
            svg += '<line x1="80" y1="280" x2="820" y2="280" stroke="' + color + '" stroke-width="1" opacity="0.2"/>';
            svg += '<rect x="370" y="70" width="160" height="40" rx="20" fill="' + color + '22" stroke="' + color + '" stroke-width="1.5"/>';
            svg += '<text x="450" y="95" text-anchor="middle" fill="' + color + '" font-size="12" font-weight="700">ATLAS CORE</text>';
            svg += '<text x="450" y="180" text-anchor="middle" fill="#ffffff" font-size="32" font-weight="900" letter-spacing="3">' + escapeHtmlEP(page.title) + '</text>';
            svg += '<text x="450" y="210" text-anchor="middle" fill="#aaaaaa" font-size="14">' + escapeHtmlEP(page.subtitle) + '</text>';
            svg += '<rect x="360" y="240" width="180" height="24" rx="4" fill="' + color + '15" stroke="' + color + '" stroke-width="1"/>';
            svg += '<text x="450" y="256" text-anchor="middle" fill="' + color + '" font-size="10" font-weight="600">' + escapeHtmlEP(page.version) + '</text>';
            svg += '<text x="450" y="310" text-anchor="middle" fill="#666666" font-size="11">' + escapeHtmlEP(page.classification) + '</text>';
            svg += '<text x="450" y="335" text-anchor="middle" fill="#444444" font-size="10">VISUAL BLUEPRINT HANDBOOK</text>';
            for (var i = 0; i < 4; i++) {
                svg += '<circle cx="' + (380 + i * 45) + '" cy="360" r="3" fill="' + color + '" opacity="' + (0.2 + i * 0.15) + '"/>';
            }
            svg += '</svg>';
            return '<div style="background:rgba(0,0,0,0.3);border-radius:12px;border:1px solid ' + color + '33;overflow:hidden;">' + svg + '</div>';
        }

        function renderBpFullOverview(page, color) {
            var html = '<div style="margin-bottom:16px;"><h3 style="font-size:20px;font-weight:800;color:' + color + ';margin:0 0 8px;">' + escapeHtmlEP(page.title) + '</h3>';
            html += '<p style="font-size:13px;color:#aaa;line-height:1.6;margin:0;">' + escapeHtmlEP(page.desc) + '</p></div>';
            if (page.diagram) {
                html += '<div style="background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid ' + color + '22;overflow:hidden;padding:8px;">';
                html += renderLargeSvgBlockFlow(page.diagram, color);
                html += '</div>';
            }
            return html;
        }

        function renderLargeSvgBlockFlow(diagram, color) {
            var maxX = 0, maxY = 0;
            (diagram.blocks || []).forEach(function(b) {
                if (b.x + b.w > maxX) maxX = b.x + b.w;
                if (b.y + b.h > maxY) maxY = b.y + b.h;
            });
            var vw = Math.max(maxX + 60, 700);
            var vh = Math.max(maxY + 60, 320);
            var svg = '<svg viewBox="0 0 ' + vw + ' ' + vh + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
            svg += '<defs>';
            svg += '<marker id="arrowL" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="' + color + '" opacity="0.6"/></marker>';
            svg += '<filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter>';
            svg += '</defs>';
            svg += '<rect width="' + vw + '" height="' + vh + '" fill="transparent"/>';
            for (var gx = 0; gx < vw; gx += 40) {
                svg += '<line x1="' + gx + '" y1="0" x2="' + gx + '" y2="' + vh + '" stroke="#ffffff" stroke-width="0.3" opacity="0.03"/>';
            }
            for (var gy = 0; gy < vh; gy += 40) {
                svg += '<line x1="0" y1="' + gy + '" x2="' + vw + '" y2="' + gy + '" stroke="#ffffff" stroke-width="0.3" opacity="0.03"/>';
            }
            (diagram.arrows || []).forEach(function(a) {
                var fb = null, tb = null;
                (diagram.blocks || []).forEach(function(b) { if (b.id === a.from) fb = b; if (b.id === a.to) tb = b; });
                if (fb && tb) {
                    var x1 = fb.x + fb.w / 2, y1 = fb.y + fb.h;
                    var x2 = tb.x + tb.w / 2, y2 = tb.y;
                    if (Math.abs(x1 - x2) > fb.w) { x1 = fb.x + fb.w; y1 = fb.y + fb.h / 2; x2 = tb.x; y2 = tb.y + tb.h / 2; }
                    var dash = a.style === 'dashed' ? ' stroke-dasharray="6,4"' : '';
                    var mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                    svg += '<path d="M' + x1 + ',' + y1 + ' Q' + mx + ',' + y1 + ' ' + mx + ',' + my + ' Q' + mx + ',' + y2 + ' ' + x2 + ',' + y2 + '" fill="none" stroke="' + color + '" stroke-width="2" opacity="0.35" marker-end="url(#arrowL)"' + dash + '/>';
                    svg += '<text x="' + mx + '" y="' + (my - 8) + '" text-anchor="middle" fill="' + color + '" font-size="10" opacity="0.7" font-weight="600">' + escapeHtmlEP(a.label) + '</text>';
                }
            });
            (diagram.blocks || []).forEach(function(b) {
                svg += '<rect x="' + b.x + '" y="' + b.y + '" width="' + b.w + '" height="' + b.h + '" rx="8" fill="' + b.color + '22" stroke="' + b.color + '" stroke-width="2"/>';
                svg += '<rect x="' + b.x + '" y="' + b.y + '" width="' + b.w + '" height="' + b.h + '" rx="8" fill="' + b.color + '08" stroke="none">';
                svg += '<animate attributeName="fill-opacity" values="0.3;0.6;0.3" dur="3s" repeatCount="indefinite"/></rect>';
                var lines = b.label.split('\n');
                var ty = b.y + b.h / 2 - (lines.length - 1) * 7;
                lines.forEach(function(line, i) {
                    svg += '<text x="' + (b.x + b.w / 2) + '" y="' + (ty + i * 15) + '" text-anchor="middle" fill="#e0e0e0" font-size="12" font-weight="700">' + escapeHtmlEP(line) + '</text>';
                });
            });
            svg += '</svg>';
            return svg;
        }

        function renderBpFullParts(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:' + color + ';margin:0 0 8px;">' + escapeHtmlEP(page.title) + '</h3>';
            html += '<p style="font-size:12px;color:#888;margin:0 0 12px;">' + escapeHtmlEP(page.desc) + '</p>';
            var parts = page.parts || [];
            var maxX = 0, maxY = 0;
            parts.forEach(function(p) {
                if (p.x + p.w > maxX) maxX = p.x + p.w;
                if (p.y + p.h > maxY) maxY = p.y + p.h;
            });
            var vw = Math.max(maxX + 80, 700);
            var vh = Math.max(maxY + 60, 340);
            var svg = '<svg viewBox="0 0 ' + vw + ' ' + vh + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
            svg += '<text x="' + (vw / 2) + '" y="18" text-anchor="middle" fill="' + color + '" font-size="12" font-weight="700" opacity="0.5" letter-spacing="2">EXPLODED VIEW \u2014 PARTS LAYOUT</text>';
            for (var gx = 0; gx < vw; gx += 40) {
                svg += '<line x1="' + gx + '" y1="0" x2="' + gx + '" y2="' + vh + '" stroke="#ffffff" stroke-width="0.3" opacity="0.03"/>';
            }
            parts.forEach(function(p, i) {
                svg += '<rect x="' + p.x + '" y="' + p.y + '" width="' + p.w + '" height="' + p.h + '" rx="6" fill="' + p.color + '28" stroke="' + p.color + '" stroke-width="2"/>';
                svg += '<rect x="' + p.x + '" y="' + p.y + '" width="' + p.w + '" height="' + p.h + '" rx="6" fill="' + p.color + '08" stroke="none"><animate attributeName="fill-opacity" values="0.1;0.3;0.1" dur="' + (2 + i * 0.3) + 's" repeatCount="indefinite"/></rect>';
                var nameLines = p.name.length > 14 ? [p.name.substring(0, 14), p.name.substring(14)] : [p.name];
                nameLines.forEach(function(nl, li) {
                    svg += '<text x="' + (p.x + p.w / 2) + '" y="' + (p.y + p.h / 2 + li * 12 - (nameLines.length > 1 ? 4 : 3)) + '" text-anchor="middle" fill="#e0e0e0" font-size="10" font-weight="600">' + escapeHtmlEP(nl) + '</text>';
                });
                svg += '<circle cx="' + (p.x + 12) + '" cy="' + (p.y + 12) + '" r="10" fill="' + color + '" opacity="0.85"/>';
                svg += '<text x="' + (p.x + 12) + '" y="' + (p.y + 16) + '" text-anchor="middle" fill="#fff" font-size="9" font-weight="800">' + p.id + '</text>';
                if (p.spec) {
                    svg += '<text x="' + (p.x + p.w / 2) + '" y="' + (p.y + p.h - 6) + '" text-anchor="middle" fill="#888" font-size="8" font-style="italic">' + escapeHtmlEP(p.spec.substring(0, 30)) + '</text>';
                }
            });
            svg += '</svg>';
            html += '<div style="background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid ' + color + '22;overflow:hidden;padding:8px;">' + svg + '</div>';
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:12px;">';
            parts.forEach(function(p) {
                html += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:6px;padding:8px;">';
                html += '<div style="font-size:11px;font-weight:700;color:#e0e0e0;">' + escapeHtmlEP(p.id) + ': ' + escapeHtmlEP(p.name) + '</div>';
                html += '<div style="font-size:10px;color:#888;margin-top:3px;font-style:italic;">' + escapeHtmlEP(p.spec) + '</div>';
                html += '</div>';
            });
            html += '</div>';
            return html;
        }

        function renderBpFullAssembly(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:' + color + ';margin:0 0 4px;">Step ' + page.step_number + ': ' + escapeHtmlEP(page.title.replace(/^Step \d+:\s*/, '')) + '</h3>';
            if (page.diagram && page.diagram.elements) {
                var els = page.diagram.elements;
                var maxX = 0, maxY = 0;
                els.forEach(function(el) {
                    var ex = (el.x || el.x2 || 0) + (el.w || el.r || 0);
                    var ey = (el.y || el.y2 || 0) + (el.h || el.r || el.len || 0);
                    if (ex > maxX) maxX = ex;
                    if (ey > maxY) maxY = ey;
                });
                var vw = Math.max(maxX + 80, 700);
                var vh = Math.max(maxY + 60, 300);
                var svg = '<svg viewBox="0 0 ' + vw + ' ' + vh + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
                svg += '<defs><marker id="arrowA" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#ffaa00"/></marker></defs>';
                for (var gx = 0; gx < vw; gx += 40) {
                    svg += '<line x1="' + gx + '" y1="0" x2="' + gx + '" y2="' + vh + '" stroke="#ffffff" stroke-width="0.3" opacity="0.03"/>';
                }
                els.forEach(function(el) {
                    if (el.shape === 'rect') {
                        svg += '<rect x="' + el.x + '" y="' + el.y + '" width="' + el.w + '" height="' + el.h + '" rx="6" fill="' + el.color + '30" stroke="' + el.color + '" stroke-width="2"/>';
                        if (el.label) svg += '<text x="' + (el.x + el.w / 2) + '" y="' + (el.y + el.h / 2 + 4) + '" text-anchor="middle" fill="#e0e0e0" font-size="11" font-weight="600">' + escapeHtmlEP(el.label) + '</text>';
                    } else if (el.shape === 'circle') {
                        svg += '<circle cx="' + el.x + '" cy="' + el.y + '" r="' + el.r + '" fill="' + el.color + '33" stroke="' + el.color + '" stroke-width="2"/>';
                        if (el.label) svg += '<text x="' + el.x + '" y="' + (el.y + 4) + '" text-anchor="middle" fill="#e0e0e0" font-size="9">' + escapeHtmlEP(el.label) + '</text>';
                    } else if (el.shape === 'wire') {
                        svg += '<line x1="' + el.x1 + '" y1="' + el.y1 + '" x2="' + el.x2 + '" y2="' + el.y2 + '" stroke="' + el.color + '" stroke-width="3" stroke-linecap="round"/>';
                    } else if (el.shape === 'dimension') {
                        svg += '<line x1="' + el.x1 + '" y1="' + el.y1 + '" x2="' + el.x2 + '" y2="' + el.y2 + '" stroke="#888" stroke-width="1.5" stroke-dasharray="4,3"/>';
                        svg += '<text x="' + ((el.x1 + el.x2) / 2) + '" y="' + (el.y1 - 6) + '" text-anchor="middle" fill="#aaa" font-size="11" font-weight="600">' + escapeHtmlEP(el.label) + '</text>';
                    } else if (el.shape === 'arrow_down') {
                        svg += '<line x1="' + el.x + '" y1="' + el.y + '" x2="' + el.x + '" y2="' + (el.y + el.len) + '" stroke="' + el.color + '" stroke-width="3" marker-end="url(#arrowA)"/>';
                    }
                });
                svg += '</svg>';
                html += '<div style="background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid ' + color + '22;overflow:hidden;padding:8px;margin:12px 0;">' + svg + '</div>';
            }
            html += '<div style="font-size:13px;color:#ddd;line-height:1.7;padding:12px 16px;background:rgba(255,255,255,0.03);border-left:4px solid ' + color + ';border-radius:6px;margin:8px 0;">' + escapeHtmlEP(page.instruction) + '</div>';
            if (page.tools && page.tools.length) {
                html += '<div style="margin-top:10px;"><span style="font-size:11px;color:#888;font-weight:700;">TOOLS NEEDED:</span><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">';
                page.tools.forEach(function(t) {
                    html += '<span style="font-size:10px;padding:4px 10px;background:rgba(100,170,255,0.12);color:#66aaff;border-radius:4px;border:1px solid rgba(100,170,255,0.25);">' + escapeHtmlEP(t) + '</span>';
                });
                html += '</div></div>';
            }
            if (page.safety) {
                html += '<div style="margin-top:10px;padding:10px 14px;background:rgba(255,170,0,0.08);border-left:4px solid #ffaa00;border-radius:6px;font-size:12px;color:#ffaa00;">\u26A0\uFE0F ' + escapeHtmlEP(page.safety) + '</div>';
            }
            if (page.checkpoint) {
                html += '<div style="margin-top:8px;padding:10px 14px;background:rgba(0,204,102,0.08);border-left:4px solid #00cc66;border-radius:6px;font-size:12px;color:#00cc66;">\u2705 CHECKPOINT: ' + escapeHtmlEP(page.checkpoint) + '</div>';
            }
            return html;
        }

        function renderBpFullWiring(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:' + color + ';margin:0 0 8px;">' + escapeHtmlEP(page.title) + '</h3>';
            html += '<p style="font-size:12px;color:#888;margin:0 0 12px;">' + escapeHtmlEP(page.desc) + '</p>';
            var conns = page.connections || [];
            var svgH = Math.max(conns.length * 44 + 40, 200);
            var svg = '<svg viewBox="0 0 800 ' + svgH + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
            svg += '<text x="400" y="18" text-anchor="middle" fill="' + color + '" font-size="12" font-weight="700" opacity="0.5" letter-spacing="2">WIRING SCHEMATIC</text>';
            conns.forEach(function(c, i) {
                var y = 30 + i * 44;
                var isPower = c.type === 'power';
                svg += '<rect x="30" y="' + y + '" width="200" height="30" rx="6" fill="' + c.color + '20" stroke="' + c.color + '" stroke-width="1.5"/>';
                svg += '<text x="130" y="' + (y + 19) + '" text-anchor="middle" fill="#e0e0e0" font-size="11" font-weight="600">' + escapeHtmlEP(c.from) + '</text>';
                var lineY = y + 15;
                if (isPower) {
                    svg += '<line x1="230" y1="' + lineY + '" x2="500" y2="' + lineY + '" stroke="' + c.color + '" stroke-width="3"/>';
                } else {
                    svg += '<line x1="230" y1="' + lineY + '" x2="500" y2="' + lineY + '" stroke="' + c.color + '" stroke-width="2" stroke-dasharray="6,3"/>';
                }
                svg += '<circle cx="365" cy="' + (lineY - 10) + '" r="3" fill="' + c.color + '"><animate attributeName="cx" values="260;470;260" dur="2s" repeatCount="indefinite"/></circle>';
                svg += '<text x="365" y="' + (lineY - 14) + '" text-anchor="middle" fill="#999" font-size="9" font-weight="600">' + escapeHtmlEP(c.gauge) + '</text>';
                svg += '<rect x="500" y="' + y + '" width="200" height="30" rx="6" fill="' + c.color + '20" stroke="' + c.color + '" stroke-width="1.5"/>';
                svg += '<text x="600" y="' + (y + 19) + '" text-anchor="middle" fill="#e0e0e0" font-size="11" font-weight="600">' + escapeHtmlEP(c.to) + '</text>';
                svg += '<circle cx="730" cy="' + lineY + '" r="10" fill="' + (isPower ? '#ff444422' : '#4488ff22') + '" stroke="' + (isPower ? '#ff4444' : '#4488ff') + '" stroke-width="1.5"/>';
                svg += '<text x="730" y="' + (lineY + 3) + '" text-anchor="middle" fill="' + (isPower ? '#ff6666' : '#6699ff') + '" font-size="7" font-weight="700">' + (isPower ? 'PWR' : 'SIG') + '</text>';
                svg += '<text x="755" y="' + (lineY + 4) + '" fill="#888" font-size="9">' + escapeHtmlEP(c.type) + '</text>';
            });
            svg += '</svg>';
            html += '<div style="background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid ' + color + '22;overflow:hidden;padding:8px;">' + svg + '</div>';
            return html;
        }

        function renderBpFullFinal(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:' + color + ';margin:0 0 8px;">' + escapeHtmlEP(page.title) + '</h3>';
            html += '<p style="font-size:12px;color:#888;margin:0 0 16px;">' + escapeHtmlEP(page.desc) + '</p>';
            html += '<div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.06);">';
            (page.checklist || []).forEach(function(item, i) {
                var isCrit = item.critical;
                var bg = isCrit ? 'rgba(255,68,68,0.08)' : 'rgba(255,255,255,0.02)';
                var border = isCrit ? '#ff4444' : 'rgba(255,255,255,0.08)';
                html += '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;margin:4px 0;background:' + bg + ';border:1px solid ' + border + ';border-radius:8px;">';
                html += '<div style="font-size:20px;flex-shrink:0;">' + (isCrit ? '\u26A0\uFE0F' : '\u2610') + '</div>';
                html += '<div>';
                if (isCrit) html += '<div style="font-size:10px;font-weight:800;color:#ff4444;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;">CRITICAL CHECK</div>';
                html += '<div style="font-size:13px;color:#ddd;">' + escapeHtmlEP(item.item) + '</div>';
                html += '</div></div>';
            });
            html += '</div>';
            return html;
        }

        function renderBpFullMachine(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:' + color + ';margin:0 0 12px;">' + escapeHtmlEP(page.title) + '</h3>';
            if (page.diagram && page.diagram.components) {
                var comps = page.diagram.components;
                var maxX = 0, maxY = 0;
                comps.forEach(function(c) {
                    if (c.x + c.w > maxX) maxX = c.x + c.w;
                    if (c.y + c.h > maxY) maxY = c.y + c.h;
                });
                var vw = Math.max(maxX + 60, 700);
                var vh = Math.max(maxY + 60, 320);
                var svg = '<svg viewBox="0 0 ' + vw + ' ' + vh + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
                svg += '<text x="' + (vw / 2) + '" y="18" text-anchor="middle" fill="' + color + '" font-size="12" font-weight="700" opacity="0.5" letter-spacing="2">MACHINE SCHEMATIC</text>';
                for (var gx = 0; gx < vw; gx += 40) {
                    svg += '<line x1="' + gx + '" y1="0" x2="' + gx + '" y2="' + vh + '" stroke="#ffffff" stroke-width="0.3" opacity="0.03"/>';
                }
                comps.forEach(function(c, i) {
                    svg += '<rect x="' + c.x + '" y="' + c.y + '" width="' + c.w + '" height="' + c.h + '" rx="6" fill="' + c.color + '28" stroke="' + c.color + '" stroke-width="2"/>';
                    svg += '<rect x="' + c.x + '" y="' + c.y + '" width="' + c.w + '" height="' + c.h + '" rx="6" fill="' + c.color + '08"><animate attributeName="fill-opacity" values="0.2;0.5;0.2" dur="' + (2 + i * 0.4) + 's" repeatCount="indefinite"/></rect>';
                    var fs = c.name.length > 18 ? 9 : 11;
                    svg += '<text x="' + (c.x + c.w / 2) + '" y="' + (c.y + c.h / 2 + 4) + '" text-anchor="middle" fill="#e0e0e0" font-size="' + fs + '" font-weight="700">' + escapeHtmlEP(c.name) + '</text>';
                });
                svg += '</svg>';
                html += '<div style="background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid ' + color + '22;overflow:hidden;padding:8px;">' + svg + '</div>';
            }
            html += '<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 16px;margin-top:16px;padding:14px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">';
            var specs = [['Form', page.form_factor], ['Size', page.dimensions], ['Weight', page.weight], ['Power', page.power], ['Speed', page.speed], ['Endurance', page.endurance]];
            specs.forEach(function(s) {
                html += '<div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">' + s[0] + '</div>';
                html += '<div style="font-size:12px;color:#e0e0e0;">' + escapeHtmlEP(s[1] || 'N/A') + '</div>';
            });
            html += '</div>';
            if (page.sensors && page.sensors.length) {
                html += '<div style="margin-top:12px;"><div style="font-size:11px;color:#888;font-weight:700;margin-bottom:6px;">SENSORS</div><div style="display:flex;flex-wrap:wrap;gap:6px;">';
                page.sensors.forEach(function(s) {
                    html += '<span style="font-size:10px;padding:4px 8px;background:rgba(68,170,170,0.12);color:#44aaaa;border-radius:4px;border:1px solid rgba(68,170,170,0.25);">' + escapeHtmlEP(s) + '</span>';
                });
                html += '</div></div>';
            }
            if (page.tools && page.tools.length) {
                html += '<div style="margin-top:10px;"><div style="font-size:11px;color:#888;font-weight:700;margin-bottom:6px;">TOOLS / ATTACHMENTS</div><div style="display:flex;flex-wrap:wrap;gap:6px;">';
                page.tools.forEach(function(t) {
                    html += '<span style="font-size:10px;padding:4px 8px;background:rgba(100,170,255,0.12);color:#66aaff;border-radius:4px;border:1px solid rgba(100,170,255,0.25);">' + escapeHtmlEP(t) + '</span>';
                });
                html += '</div></div>';
            }
            return html;
        }

        function renderBpFullCharter(page, color) {
            var html = '<h3 style="font-size:18px;font-weight:800;color:#ff4444;margin:0 0 8px;">' + escapeHtmlEP(page.title) + '</h3>';
            html += '<p style="font-size:12px;color:#888;margin:0 0 16px;">' + escapeHtmlEP(page.desc) + '</p>';
            (page.rules || []).forEach(function(r) {
                html += '<div style="padding:14px;margin:8px 0;background:rgba(255,68,68,0.06);border:1px solid rgba(255,68,68,0.15);border-radius:8px;display:flex;gap:14px;align-items:flex-start;">';
                html += '<div style="font-size:28px;font-weight:900;color:#ff4444;line-height:1;flex-shrink:0;">' + r.number + '</div>';
                html += '<div><div style="font-size:12px;font-weight:800;color:#ff6666;text-transform:uppercase;letter-spacing:0.5px;">' + escapeHtmlEP(r.rule) + '</div>';
                html += '<div style="font-size:11px;color:#aaa;margin-top:4px;line-height:1.5;">' + escapeHtmlEP(r.desc) + '</div></div></div>';
            });
            return html;
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadBlueprintLab();
            hephLoadDashboard();
        });

        var hephDomains = [];

        function hephLoadDashboard() {
            fetch('/hephaestus/dashboard')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data || data.status !== 'ok') return;
                    hephDomains = data.domains || [];
                    var container = document.getElementById('hephRunsList');
                    if (!container) return;
                    if (!data.runs || data.runs.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:30px;color:#666;font-size:12px;">No experiment runs yet. Click "+ New Experiment" to start a Discovery Pipeline.</div>';
                        return;
                    }
                    var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;">';
                    data.runs.forEach(function(run) {
                        var phaseColor = run.phase === 'idea' ? '#ffaa00' : run.phase === 'simulate' ? '#4488ff' : run.phase === 'fail_analysis' ? '#ff4444' : run.phase === 'adjust' ? '#00cc66' : run.phase === 'prototype_concept' ? '#aa44ff' : '#888';
                        var levelColors = ['#666','#888','#ffaa00','#ff8844','#ff4444','#aa44ff'];
                        var levelColor = levelColors[run.innovation_level] || '#888';
                        html += '<div style="background:rgba(0,0,0,0.4);border:1px solid ' + phaseColor + '33;border-radius:10px;padding:14px;cursor:pointer;" onclick="hephOpenRun(\'' + run.run_id + '\')">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
                        html += '<div style="font-size:13px;font-weight:800;color:' + phaseColor + ';text-transform:uppercase;letter-spacing:0.5px;">' + escapeHtmlEP(run.project_id) + '</div>';
                        html += '<div style="font-size:9px;padding:3px 8px;background:' + levelColor + '18;color:' + levelColor + ';border:1px solid ' + levelColor + '33;border-radius:3px;font-weight:700;">LVL ' + run.innovation_level + '</div>';
                        html += '</div>';
                        html += '<div style="font-size:10px;color:#aaa;margin-bottom:10px;line-height:1.4;">' + escapeHtmlEP(run.hypothesis.substring(0, 120)) + (run.hypothesis.length > 120 ? '...' : '') + '</div>';
                        html += '<div style="display:flex;gap:3px;margin-bottom:8px;">';
                        var phases = run.pipeline.phases;
                        phases.forEach(function(p) {
                            var bg = p.completed ? phaseColor + '44' : p.current ? phaseColor : 'rgba(255,255,255,0.06)';
                            var border = p.completed || p.current ? phaseColor : 'rgba(255,255,255,0.1)';
                            html += '<div style="flex:1;height:6px;background:' + bg + ';border:1px solid ' + border + ';border-radius:3px;" title="' + p.label + '"></div>';
                        });
                        html += '</div>';
                        html += '<div style="display:flex;justify-content:space-between;font-size:9px;color:#666;">';
                        html += '<span>' + escapeHtmlEP(run.domain_primary_label) + (run.domain_secondary_label ? ' Ã— ' + escapeHtmlEP(run.domain_secondary_label) : '') + '</span>';
                        html += '<span>' + run.phase_label + '</span>';
                        html += '</div>';
                        html += '<div style="display:flex;gap:8px;margin-top:6px;font-size:9px;color:#888;">';
                        html += '<span>Iterations: ' + run.iteration_count + '</span>';
                        html += '<span>Failures: ' + run.failure_modes_total + ' (' + run.failure_modes_resolved + ' resolved)</span>';
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                    container.innerHTML = html;
                });
        }

        function hephShowNewRun() {
            var form = document.getElementById('hephNewRunForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                var selA = document.getElementById('hephDomainA');
                var selB = document.getElementById('hephDomainB');
                fetch('/hephaestus/domains').then(function(r) { return r.json(); }).then(function(data) {
                    selA.innerHTML = '';
                    selB.innerHTML = '<option value="">None (single domain)</option>';
                    (data.domains || []).forEach(function(d) {
                        selA.innerHTML += '<option value="' + d.id + '">' + d.label + '</option>';
                        selB.innerHTML += '<option value="' + d.id + '">' + d.label + '</option>';
                    });
                    selA.onchange = hephCheckIntersection;
                    selB.onchange = hephCheckIntersection;
                    hephCheckConstraints();
                    selA.addEventListener('change', hephCheckConstraints);
                }).catch(function() {
                    selA.innerHTML = '<option value="robotics">Robotics</option>';
                });
            }
        }

        function hephCheckIntersection() {
            var a = document.getElementById('hephDomainA').value;
            var b = document.getElementById('hephDomainB').value;
            var info = document.getElementById('hephIntersectionInfo');
            if (!b) { info.style.display = 'none'; return; }
            fetch('/hephaestus/domains/' + a + '/intersections').then(function(r) { return r.json(); }).then(function(data) {
                var match = (data.intersections || []).find(function(ix) { return ix.partner_domain === b; });
                if (match) {
                    info.style.display = 'block';
                    info.innerHTML = '<strong>' + escapeHtmlEP(match.name) + '</strong>: ' + escapeHtmlEP(match.potential) + '<br><span style="color:#888;font-size:9px;">Constraints: ' + (match.constraints || []).join(', ') + '</span>';
                } else {
                    info.style.display = 'block';
                    info.style.borderColor = '#ffaa00';
                    info.style.color = '#ffaa00';
                    info.style.background = 'rgba(255,170,0,0.08)';
                    info.innerHTML = 'Novel intersection â€” no pre-mapped data. This could be unexplored territory.';
                }
            });
        }

        function hephCheckConstraints() {
            var domain = document.getElementById('hephDomainA').value;
            var preview = document.getElementById('hephConstraintPreview');
            if (!domain) { preview.style.display = 'none'; return; }
            fetch('/hephaestus/domains/' + domain + '/constraints').then(function(r) { return r.json(); }).then(function(data) {
                var c = data.constraints;
                if (!c) { preview.style.display = 'none'; return; }
                preview.style.display = 'block';
                var html = '<div style="font-size:10px;font-weight:700;color:#888;margin-bottom:6px;">CONSTRAINT FRAMEWORK â€” ' + escapeHtmlEP(data.domain_label) + '</div>';
                if (c.physics_laws) {
                    html += '<div style="font-size:9px;color:#ffaa00;font-weight:600;margin-top:4px;">Physics Laws</div>';
                    html += '<div style="font-size:9px;color:#aaa;">' + c.physics_laws.join(' Â· ') + '</div>';
                }
                if (c.materials_available) {
                    html += '<div style="font-size:9px;color:#44aacc;font-weight:600;margin-top:4px;">Materials</div>';
                    html += '<div style="font-size:9px;color:#aaa;">' + c.materials_available.join(' Â· ') + '</div>';
                }
                if (c.safety_profile) {
                    html += '<div style="font-size:9px;color:#ff4444;font-weight:600;margin-top:4px;">Safety Profile</div>';
                    html += '<div style="font-size:9px;color:#aaa;">' + c.safety_profile.join(' Â· ') + '</div>';
                }
                if (c.failure_envelope) {
                    html += '<div style="font-size:9px;color:#ff8844;font-weight:600;margin-top:4px;">Failure Envelope</div>';
                    html += '<div style="font-size:9px;color:#aaa;">' + c.failure_envelope.join(' Â· ') + '</div>';
                }
                preview.innerHTML = html;
            });
        }

        function hephSubmitRun() {
            var projectId = document.getElementById('hephProjectId').value.trim();
            var hypothesis = document.getElementById('hephHypothesis').value.trim();
            var domainA = document.getElementById('hephDomainA').value;
            var domainB = document.getElementById('hephDomainB').value;
            if (!projectId || !hypothesis) { alert('Enter a project ID and hypothesis'); return; }
            fetch('/hephaestus/runs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ project_id: projectId, domain_primary: domainA, domain_secondary: domainB || null, hypothesis: hypothesis })
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.status === 'ok') {
                    document.getElementById('hephNewRunForm').style.display = 'none';
                    document.getElementById('hephProjectId').value = '';
                    document.getElementById('hephHypothesis').value = '';
                    hephLoadDashboard();
                    hephOpenRun(data.run_id);
                }
            });
        }

        function hephOpenRun(runId) {
            fetch('/hephaestus/runs/' + runId).then(function(r) { return r.json(); }).then(function(data) {
                if (!data || data.status !== 'ok') return;
                var run = data.run;
                var color = run.phase === 'idea' ? '#ffaa00' : run.phase === 'simulate' ? '#4488ff' : run.phase === 'fail_analysis' ? '#ff4444' : run.phase === 'adjust' ? '#00cc66' : '#aa44ff';
                var modal = document.getElementById('blueprintModal');
                var body = document.getElementById('bpModalBody');
                var title = document.getElementById('bpModalTitle');
                var sub = document.getElementById('bpModalSub');
                var header = document.getElementById('bpModalHeader');
                document.getElementById('bpPrevBtn').style.display = 'none';
                document.getElementById('bpNextBtn').style.display = 'none';
                document.getElementById('bpPageCounter').textContent = '';
                bpModalData = null;
                title.textContent = 'DISCOVERY PIPELINE â€” ' + run.project_id.toUpperCase();
                sub.textContent = run.domain_primary_label + (run.domain_secondary_label ? ' Ã— ' + run.domain_secondary_label : '') + ' | Innovation Level ' + run.innovation_level;
                modal.style.display = 'block';

                var html = '<div style="max-width:900px;width:100%;">';

                html += '<div style="display:flex;gap:4px;margin-bottom:16px;">';
                (run.pipeline.phases || []).forEach(function(p) {
                    var bg = p.completed ? color + '66' : p.current ? color : 'rgba(255,255,255,0.06)';
                    var border = p.completed || p.current ? color : 'rgba(255,255,255,0.1)';
                    var textColor = p.completed || p.current ? '#fff' : '#666';
                    html += '<div style="flex:1;text-align:center;padding:8px 4px;background:' + bg + ';border:1px solid ' + border + ';border-radius:6px;">';
                    html += '<div style="font-size:8px;font-weight:700;color:' + textColor + ';text-transform:uppercase;letter-spacing:0.3px;">' + escapeHtmlEP(p.label) + '</div>';
                    html += '<div style="font-size:7px;color:#888;margin-top:2px;">' + escapeHtmlEP(p.persona) + '</div>';
                    html += '</div>';
                });
                html += '</div>';

                html += '<div style="background:rgba(0,0,0,0.3);border:1px solid ' + color + '22;border-radius:10px;padding:16px;margin-bottom:12px;">';
                html += '<div style="font-size:11px;font-weight:700;color:' + color + ';margin-bottom:6px;">HYPOTHESIS</div>';
                html += '<div style="font-size:13px;color:#ddd;line-height:1.6;">' + escapeHtmlEP(run.hypothesis) + '</div>';
                if (run.intersection_hypothesis) {
                    html += '<div style="margin-top:8px;padding:8px;background:rgba(0,204,102,0.08);border-left:3px solid #00cc66;border-radius:4px;font-size:10px;color:#00cc66;">' + escapeHtmlEP(run.intersection_hypothesis) + '</div>';
                }
                html += '</div>';

                if (data.constraints) {
                    html += '<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:16px;margin-bottom:12px;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#ff8844;margin-bottom:8px;">CONSTRAINT FRAMEWORK</div>';
                    var c = data.constraints;
                    if (c.physics_laws) html += '<div style="font-size:9px;color:#ffaa00;font-weight:600;">Physics Laws</div><div style="font-size:10px;color:#aaa;margin-bottom:6px;">' + c.physics_laws.join(' Â· ') + '</div>';
                    if (c.materials_available) html += '<div style="font-size:9px;color:#44aacc;font-weight:600;">Materials</div><div style="font-size:10px;color:#aaa;margin-bottom:6px;">' + c.materials_available.join(' Â· ') + '</div>';
                    if (c.manufacturing_tools) html += '<div style="font-size:9px;color:#66aaff;font-weight:600;">Manufacturing Tools</div><div style="font-size:10px;color:#aaa;margin-bottom:6px;">' + c.manufacturing_tools.join(' Â· ') + '</div>';
                    if (c.safety_profile) html += '<div style="font-size:9px;color:#ff4444;font-weight:600;">Safety Profile</div><div style="font-size:10px;color:#aaa;margin-bottom:6px;">' + c.safety_profile.join(' Â· ') + '</div>';
                    if (c.failure_envelope) html += '<div style="font-size:9px;color:#ff8844;font-weight:600;">Failure Envelope</div><div style="font-size:10px;color:#aaa;margin-bottom:6px;">' + c.failure_envelope.join(' Â· ') + '</div>';
                    html += '</div>';
                }

                var innovationColors = {1:'#666',2:'#888',3:'#ffaa00',4:'#ff8844',5:'#aa44ff'};
                var innovationNames = {1:'Creative Remix',2:'Optimization',3:'New Configuration',4:'New Material/Method',5:'Paradigm Shift'};
                html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:12px;">';
                for (var lvl = 1; lvl <= 5; lvl++) {
                    var isActive = lvl <= run.innovation_level;
                    var lc = innovationColors[lvl];
                    html += '<div style="text-align:center;padding:8px 4px;background:' + (isActive ? lc + '22' : 'rgba(255,255,255,0.03)') + ';border:1px solid ' + (isActive ? lc + '66' : 'rgba(255,255,255,0.06)') + ';border-radius:6px;">';
                    html += '<div style="font-size:16px;font-weight:900;color:' + (isActive ? lc : '#333') + ';">' + lvl + '</div>';
                    html += '<div style="font-size:7px;color:' + (isActive ? '#aaa' : '#444') + ';margin-top:2px;">' + innovationNames[lvl] + '</div>';
                    html += '</div>';
                }
                html += '</div>';

                if (data.failure_modes && data.failure_modes.length > 0) {
                    html += '<div style="background:rgba(255,68,68,0.05);border:1px solid rgba(255,68,68,0.15);border-radius:10px;padding:16px;margin-bottom:12px;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#ff4444;margin-bottom:8px;">FAILURE MODES (' + data.failure_modes.length + ')</div>';
                    data.failure_modes.forEach(function(fm) {
                        var sevColor = fm.severity === 'critical' ? '#ff4444' : fm.severity === 'high' ? '#ff8844' : fm.severity === 'medium' ? '#ffaa00' : '#888';
                        html += '<div style="padding:8px;margin:4px 0;background:rgba(0,0,0,0.2);border-left:3px solid ' + sevColor + ';border-radius:4px;">';
                        html += '<div style="display:flex;justify-content:space-between;">';
                        html += '<span style="font-size:10px;font-weight:700;color:#ddd;">' + escapeHtmlEP(fm.failure_type) + '</span>';
                        html += '<span style="font-size:8px;padding:2px 6px;background:' + sevColor + '22;color:' + sevColor + ';border-radius:3px;font-weight:700;">' + fm.severity.toUpperCase() + (fm.resolved ? ' âœ“' : '') + '</span>';
                        html += '</div>';
                        html += '<div style="font-size:9px;color:#aaa;margin-top:3px;">' + escapeHtmlEP(fm.description) + '</div>';
                        if (fm.mitigation) html += '<div style="font-size:9px;color:#00cc66;margin-top:3px;">Mitigation: ' + escapeHtmlEP(fm.mitigation) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                if (data.iterations && data.iterations.length > 0) {
                    html += '<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:16px;margin-bottom:12px;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#66aaff;margin-bottom:8px;">ITERATION LOG (' + data.iterations.length + ')</div>';
                    data.iterations.slice(0, 10).forEach(function(it) {
                        var pColor = it.persona === 'ajani' ? '#dc143c' : it.persona === 'hermes' ? '#f5f5dc' : '#00d4aa';
                        html += '<div style="padding:6px 8px;margin:3px 0;background:rgba(255,255,255,0.02);border-left:3px solid ' + pColor + ';border-radius:4px;font-size:9px;">';
                        html += '<span style="color:' + pColor + ';font-weight:700;">#' + it.iteration_number + ' ' + it.persona.toUpperCase() + '</span>';
                        html += '<span style="color:#888;margin-left:6px;">' + escapeHtmlEP(it.action) + '</span>';
                        if (it.notes) html += '<div style="color:#aaa;margin-top:2px;">' + escapeHtmlEP(it.notes) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                if (data.available_intersections && data.available_intersections.length > 0) {
                    html += '<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:16px;">';
                    html += '<div style="font-size:11px;font-weight:700;color:#00cc66;margin-bottom:8px;">AVAILABLE CROSS-DOMAIN INTERSECTIONS</div>';
                    data.available_intersections.forEach(function(ix) {
                        html += '<div style="padding:6px;margin:3px 0;background:rgba(0,204,102,0.05);border:1px solid rgba(0,204,102,0.15);border-radius:4px;">';
                        html += '<div style="font-size:10px;font-weight:700;color:#00cc66;">' + escapeHtmlEP(ix.name) + '</div>';
                        html += '<div style="font-size:9px;color:#aaa;">' + escapeHtmlEP(ix.partner_label) + ' â€” ' + escapeHtmlEP(ix.potential) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                html += '<div style="display:flex;gap:8px;margin-top:16px;">';
                html += '<button onclick="hephAdvancePhase(\'' + runId + '\')" style="background:rgba(255,170,0,0.12);border:1px solid rgba(255,170,0,0.3);color:#ffaa00;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;">Advance Phase</button>';
                html += '<button onclick="closeBpModal()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#888;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:11px;">Close</button>';
                html += '</div>';

                html += '</div>';
                body.innerHTML = html;
            });
        }

        function hephAdvancePhase(runId) {
            fetch('/hephaestus/runs/' + runId + '/advance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({notes: 'Phase advanced by supervisor'})
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.status === 'ok') {
                    hephOpenRun(runId);
                    hephLoadDashboard();
                }
            });
        }

        document.addEventListener('keydown', function(e) {
            if (!bpModalData) return;
            if (e.key === 'Escape') closeBpModal();
            if (e.key === 'ArrowLeft') bpNav(-1);
            if (e.key === 'ArrowRight') bpNav(1);
        });

        // Enhanced AI persona presence - update based on current persona
        function updateAIPresence(persona) {
            ['ajani', 'minerva', 'hermes'].forEach(p => {
                document.getElementById(`ai${p.charAt(0).toUpperCase() + p.slice(1)}`)?.classList.remove('active');
            });
            const activeId = `ai${persona.charAt(0).toUpperCase() + persona.slice(1)}`;
            document.getElementById(activeId)?.classList.add('active');
            
            // Log persona switch
            const personaLabels = {
                ajani: 'TACTICAL MODE ENGAGED',
                minerva: 'CULTURAL LENS ACTIVE',
                hermes: 'SYSTEMS ANALYSIS ONLINE'
            };
            addSystemLog(personaLabels[persona] || `Switched to ${persona}`, 'success');
        }

        // Hook into persona switch
        const originalSwitchPersona = window.switchPersona;
        if (typeof originalSwitchPersona === 'function') {
            window.switchPersona = function(persona) {
                updateAIPresence(persona);
                return originalSwitchPersona(persona);
            };
        }
    </script>
</body>
</html>
